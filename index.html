<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ledger">
<meta name="theme-color" content="#0A0F1E">
<title>School Ledger</title>
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Syne+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0A0F1E;--bg2:#111827;--bg3:#1A2236;--surface:#1E2D40;--surf2:#243347;
  --border:rgba(255,255,255,.08);--border2:rgba(255,255,255,.14);
  --blue:#3B82F6;--blue-d:#1D4ED8;--blue-gl:rgba(59,130,246,.15);
  --teal:#14B8A6;--teal-gl:rgba(20,184,166,.12);
  --red:#F87171;--red-gl:rgba(248,113,113,.12);
  --amber:#FBBF24;--amb-gl:rgba(251,191,36,.12);
  --green:#34D399;--grn-gl:rgba(52,211,153,.12);
  --pink:#F472B6;--pink-gl:rgba(244,114,182,.12);
  --purple:#A78BFA;
  --text:#F1F5F9;--text2:#94A3B8;--text3:#475569;
  --serif:'Syne',sans-serif;--mono:'Syne Mono',monospace;
  --sat:env(safe-area-inset-top,44px);--sab:env(safe-area-inset-bottom,34px);
  --sal:env(safe-area-inset-left,0px);--sar:env(safe-area-inset-right,0px);
  --tab-h:60px;--radius:16px;--r-sm:10px;--shadow:0 8px 32px rgba(0,0,0,.4);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{font-family:var(--serif);background:var(--bg);color:var(--text);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;padding-top:var(--sat);padding-left:var(--sal);padding-right:var(--sar)}
#app{display:flex;flex-direction:column;height:100%;position:relative}
.status-blur{position:fixed;top:0;left:0;right:0;height:calc(var(--sat) + 2px);background:rgba(10,15,30,.85);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);z-index:200}
.header{padding:14px 20px 10px;display:flex;align-items:flex-end;justify-content:space-between;flex-shrink:0}
.header-title{font-size:28px;font-weight:800;letter-spacing:-.5px}
.header-sub{font-size:11px;color:var(--text2);margin-top:1px;letter-spacing:.3px}
.yr-pill{display:flex;align-items:center;gap:4px;background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:5px 12px;font-size:13px;font-weight:600;color:var(--blue)}
.yr-pill select{appearance:none;background:none;border:none;outline:none;font-family:var(--serif);font-size:13px;font-weight:700;color:var(--blue);cursor:pointer;padding-right:4px}
.yr-pill select option{background:var(--bg2);color:var(--text)}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:0 16px;padding-bottom:calc(var(--tab-h) + var(--sab) + 16px)}
.scroll::-webkit-scrollbar{display:none}
.tabbar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab-h) + var(--sab));padding-bottom:var(--sab);background:rgba(17,24,39,.92);backdrop-filter:saturate(180%) blur(24px);-webkit-backdrop-filter:saturate(180%) blur(24px);border-top:1px solid var(--border);display:flex;align-items:stretch;z-index:100}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;padding-top:8px;color:var(--text3);transition:color .2s;font-size:9.5px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;border:none;background:none;font-family:var(--serif)}
.tab.active{color:var(--blue)}
.tab svg{width:22px;height:22px;transition:transform .2s}
.tab.active svg{transform:scale(1.05)}
.page{display:none}
.page.active{display:block;animation:slideUp .25s cubic-bezier(.34,1.12,.64,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.kpi-scroll{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px 4px;scrollbar-width:none}
.kpi-scroll::-webkit-scrollbar{display:none}
.kpi{min-width:150px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;flex-shrink:0;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.25;filter:blur(20px)}
.kpi.k-blue::before{background:var(--blue)}.kpi.k-teal::before{background:var(--teal)}.kpi.k-red::before{background:var(--red)}.kpi.k-amber::before{background:var(--amber)}
.kpi-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin-bottom:6px;font-weight:600}
.kpi-val{font-family:var(--mono);font-size:20px;font-weight:400;line-height:1}
.kpi.k-blue .kpi-val{color:var(--blue)}.kpi.k-teal .kpi-val{color:var(--teal)}.kpi.k-red .kpi-val{color:var(--red)}.kpi.k-amber .kpi-val{color:var(--amber)}
.kpi-sub{font-size:9px;color:var(--text3);margin-top:5px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin:20px 0 10px}
.sec-title{font-size:16px;font-weight:700;letter-spacing:-.2px}
.sec-action{font-size:12px;color:var(--blue);font-weight:600;cursor:pointer}
.chart-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.chart-ttl{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px}
.donuts-row{display:flex;gap:10px}
.donut-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px}
.donut-sub{font-size:10px;color:var(--text2);font-weight:600;text-align:center}
.donut-leg{width:100%;display:flex;flex-direction:column;gap:4px}
.leg-row{display:flex;align-items:center;gap:5px;font-size:9px;color:var(--text2)}
.leg-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.leg-val{font-family:var(--mono);margin-left:auto;font-size:9px}
.tx-list{display:flex;flex-direction:column;gap:8px}
.tx-row{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background .15s;-webkit-tap-highlight-color:transparent}
.tx-row:active{background:var(--surf2)}
.tx-icon{width:38px;height:38px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px}
.tx-body{flex:1;min-width:0}
.tx-cat{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-meta{font-size:10px;color:var(--text2);margin-top:2px}
.tx-amt{text-align:right;flex-shrink:0}
.tx-amt-val{font-family:var(--mono);font-size:14px;font-weight:500}
.tx-amt-val.out{color:var(--red)}.tx-amt-val.inp{color:var(--teal)}
.tx-late{font-size:9px;color:var(--red);margin-top:2px;font-weight:700}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;color:var(--text3);text-align:center;gap:10px}
.empty-ic{font-size:40px;opacity:.4}
.empty-txt{font-size:13px}
.form-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.form-title{font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:14px}
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.fg:last-child{margin-bottom:0}
.fg label{font-size:11px;font-weight:700;color:var(--text2);letter-spacing:.4px}
.fg input,.fg select,.fg textarea{background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--r-sm);padding:11px 13px;font-size:15px;font-family:var(--serif);color:var(--text);outline:none;transition:border-color .15s;width:100%;-webkit-appearance:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--blue)}
.fg input.ai-fill{border-color:var(--teal);background:var(--teal-gl)}
.fg select option{background:var(--bg2)}
.fg textarea{resize:none;line-height:1.5}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-row .fg{margin-bottom:0}
.tog-row{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:var(--r-sm);padding:12px 14px;cursor:pointer;margin-bottom:14px}
.tog-row:active{background:var(--surf2)}
.tog{width:44px;height:26px;background:var(--text3);border-radius:13px;position:relative;flex-shrink:0;transition:background .25s}
.tog.on{background:var(--blue)}
.tog::after{content:'';position:absolute;left:3px;top:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);transition:transform .25s cubic-bezier(.34,1.12,.64,1)}
.tog.on::after{transform:translateX(18px)}
.tog-lbl{font-size:13px;font-weight:600}
.tog-desc{font-size:10px;color:var(--text2)}
.btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:15px;border-radius:var(--r-sm);font-size:15px;font-weight:700;font-family:var(--serif);border:none;cursor:pointer;transition:all .15s}
.btn:active{transform:scale(.97);opacity:.9}
.btn-primary{background:var(--blue);color:#fff}
.btn-ghost{background:var(--bg2);color:var(--text2);border:1.5px solid var(--border2)}
.btn-danger{background:var(--red-gl);color:var(--red);border:1.5px solid rgba(248,113,113,.3)}
.btn-teal{background:var(--teal);color:#fff}
.btn-ai{background:linear-gradient(135deg,var(--blue-d),#0D9488);color:#fff;width:auto;padding:12px 20px;border-radius:24px;font-size:14px}
.btn-ai:disabled{background:var(--surface);color:var(--text3);cursor:not-allowed}
.btn-sm{padding:10px 18px;font-size:13px;width:auto;border-radius:20px}
.report-year-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.report-yr-hdr{padding:12px 16px;background:linear-gradient(135deg,var(--bg2),var(--surface));font-size:14px;font-weight:700;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.report-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.rtbl{width:100%;border-collapse:collapse;font-size:11px;white-space:nowrap}
.rtbl th{background:rgba(255,255,255,.04);padding:8px 10px;text-align:right;font-size:9px;font-weight:700;color:var(--text3);border-bottom:1px solid var(--border);letter-spacing:.4px;text-transform:uppercase}
.rtbl th:first-child{text-align:left;padding-left:14px}
.rtbl td{padding:7px 10px;text-align:right;border-bottom:1px solid rgba(255,255,255,.04);font-family:var(--mono);color:var(--text2)}
.rtbl td:first-child{text-align:left;font-family:var(--serif);font-weight:600;color:var(--text);padding-left:14px}
.rtbl tr:last-child td{border-bottom:none}
.rtbl tr.rt-total td{background:rgba(59,130,246,.1);color:var(--text);font-weight:700}
.td-neg{color:var(--red)!important}.td-recv{color:var(--teal)!important}
.td-pct-r{color:var(--red)!important}.td-pct-a{color:var(--amber)!important}.td-pct-g{color:var(--green)!important}
.late-m{color:var(--red)}
.set-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.set-hdr{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
.set-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.04)}
.set-row:last-child{border-bottom:none}
.set-lbl{font-size:13px;font-weight:600}
.set-desc{font-size:11px;color:var(--text3);margin-top:2px}
.set-val{font-family:var(--mono);font-size:12px;color:var(--text2)}
.set-chip{background:var(--bg2);border:1px solid var(--border2);padding:3px 9px;border-radius:20px;font-size:10px;color:var(--text2);font-weight:600}
.import-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:30px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg2)}
.import-zone.drag-over{border-color:var(--teal);background:var(--teal-gl)}
.import-zone.has-file{border-color:var(--teal);border-style:solid}
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.sheet-bg.open{display:flex}
.sheet{background:var(--bg2);border-radius:24px 24px 0 0;width:100%;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px calc(var(--sab) + 20px);animation:sheetUp .3s cubic-bezier(.34,1.12,.64,1)}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:10px auto 18px}
.sheet-title{font-size:18px;font-weight:800;margin-bottom:18px}
.ai-banner{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(20,184,166,.1));border:1px solid rgba(59,130,246,.3);border-radius:var(--r-sm);padding:12px 14px;margin-bottom:14px;display:none}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
.toast{position:fixed;bottom:calc(var(--tab-h) + var(--sab) + 12px);left:50%;transform:translateX(-50%);background:rgba(30,45,64,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border2);border-radius:24px;padding:10px 18px;font-size:13px;font-weight:600;white-space:nowrap;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;box-shadow:var(--shadow)}
.toast.show{opacity:1}
.loading-wrap{display:flex;align-items:center;justify-content:center;padding:40px;gap:10px}
.gt-strip{background:linear-gradient(135deg,var(--blue-d),#0D5B4F);border-radius:var(--radius);padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.gt-item{text-align:center}
.gt-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.7px;color:rgba(255,255,255,.5);margin-bottom:4px}
.gt-val{font-family:var(--mono);font-size:15px;color:#fff}
.gt-val.or{color:var(--amber)}.gt-val.re{color:var(--red)}
.cat-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.04)}
.cat-item:last-child{border-bottom:none}
.cat-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.cat-nm{font-size:13px;font-weight:600;flex:1}
.cat-key{font-size:10px;color:var(--text3);font-family:var(--mono)}
</style>
</head>
<body>
<div class="status-blur"></div>
<div id="app">
  <div class="header">
    <div>
      <div class="header-title" id="hdr-title">Dashboard</div>
      <div class="header-sub" id="hdr-sub">Lara &amp; Chloe</div>
    </div>
    <div class="yr-pill">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <select id="year-filter"></select>
    </div>
  </div>

  <div class="scroll" id="scroll-area">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dash">
      <div class="kpi-scroll" id="kpi-row"><div class="loading-wrap" style="width:100%"><div class="spinner" style="border-top-color:var(--blue);border-color:var(--bg3)"></div></div></div>
      <div id="charts-area"></div>
      <div class="sec-hdr">
        <div class="sec-title">Recentes</div>
        <div class="sec-action" onclick="goTab('txs')">Ver todas</div>
      </div>
      <div class="tx-list" id="recent-list"><div class="loading-wrap"><div class="spinner" style="border-top-color:var(--blue);border-color:var(--bg3)"></div></div></div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="page" id="page-txs">
      <div style="display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px">
        <select id="tx-type" onchange="renderTxPage()" style="background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:7px 14px;font-size:12px;font-family:var(--serif);color:var(--text2);outline:none;-webkit-appearance:none;flex-shrink:0">
          <option value="">Todos os tipos</option><option value="PAID">Pago</option><option value="RECEIVED">Recebido</option>
        </select>
        <select id="tx-cat" onchange="renderTxPage()" style="background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:7px 14px;font-size:12px;font-family:var(--serif);color:var(--text2);outline:none;-webkit-appearance:none;flex-shrink:0">
          <option value="">Todas categorias</option>
        </select>
      </div>
      <div class="tx-list" id="tx-list"></div>
    </div>

    <!-- ADD -->
    <div class="page" id="page-add">
      <div class="form-card" style="margin-bottom:12px">
        <div class="chart-ttl">‚ú¶ Preencher com IA</div>
        <div id="drop-zone" style="border:1.5px dashed var(--border2);border-radius:var(--r-sm);padding:20px;text-align:center;cursor:pointer;margin-bottom:12px" onclick="document.getElementById('file-in').click()" ondragover="event.preventDefault()" ondrop="onFileDrop(event)">
          <input type="file" id="file-in" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onFileSelect(event)">
          <div id="dz-idle"><div style="font-size:24px;margin-bottom:6px">üìÑ</div><div style="font-size:12px;color:var(--text2)">Boleto ou comprovante</div><div style="font-size:10px;color:var(--text3);margin-top:3px">PDF ¬∑ JPG ¬∑ PNG</div></div>
          <div id="dz-prev" style="display:none;align-items:center;gap:10px">
            <span id="dz-ic" style="font-size:24px"></span>
            <div style="flex:1;text-align:left;min-width:0"><div id="dz-nm" style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div><div id="dz-sz" style="font-size:10px;color:var(--text3);margin-top:2px"></div></div>
            <button class="btn btn-ghost btn-sm" onclick="clearAiFile(event)" style="padding:7px 12px;font-size:11px">‚úï</button>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <button id="ai-btn" class="btn btn-ai" disabled onclick="runAI()"><span id="ai-ic">‚ú¶</span> <span id="ai-txt">Interpretar com IA</span></button>
          <span id="ai-st" style="font-size:11px;color:var(--text2)"></span>
        </div>
        <div class="ai-banner" id="ai-banner"><div style="font-size:11px;font-weight:700;color:var(--teal);margin-bottom:4px">‚úÖ Campos preenchidos</div><div id="ai-sum" style="font-size:11px;color:var(--text2);line-height:1.5"></div></div>
      </div>
      <div class="form-card">
        <div class="form-title" id="form-title-lbl">Nova Transa√ß√£o</div>
        <input type="hidden" id="f-id">
        <div class="form-row">
          <div class="fg"><label>Valor (R$) *</label><input id="f-amount" type="number" inputmode="decimal" step="0.01" placeholder="0,00"></div>
          <div class="fg"><label>Tipo *</label><select id="f-type"><option value="PAID">Pago</option><option value="RECEIVED">Recebido</option></select></div>
        </div>
        <div class="fg"><label>Categoria *</label><select id="f-cat"></select></div>
        <div class="fg"><label>Pagante / Recebedor *</label><select id="f-party"><option value="Me">Eu</option><option value="Father">Pai</option><option value="School">Escola</option><option value="Store">Loja</option><option value="Other">Outro</option></select></div>
        <div class="form-row">
          <div class="fg"><label>Data *</label><input id="f-date" type="date"></div>
          <div class="fg"><label>Ano Letivo</label><select id="f-year"></select></div>
        </div>
        <div class="fg"><label>M√™s Letivo</label>
          <select id="f-month"><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option></select>
        </div>
        <div class="tog-row" onclick="document.getElementById('tog-late').classList.toggle('on')">
          <div class="tog" id="tog-late"></div>
          <div><div class="tog-lbl">Recebido ap√≥s dia 5 ‚ñ†</div><div class="tog-desc">Marca como pagamento com atraso</div></div>
        </div>
        <div class="fg"><label>Notas</label><textarea id="f-notes" rows="2" placeholder="Observa√ß√µes..."></textarea></div>
        <div class="fg" style="margin-bottom:18px"><label>Tags</label><input id="f-tags" placeholder="boleto, pontual..."></div>
        <button class="btn btn-primary" style="margin-bottom:10px" onclick="saveTx()">üíæ Salvar Transa√ß√£o</button>
        <button id="del-btn" class="btn btn-danger" style="display:none" onclick="deleteTx()">üóë Excluir</button>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="page" id="page-rpt">
      <div id="rpt-content"><div class="loading-wrap"><div class="spinner" style="border-top-color:var(--blue);border-color:var(--bg3)"></div></div></div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-cfg">
      <div class="set-card">
        <div class="set-hdr"><span>üìÇ Dados (JSON)</span><button class="btn btn-ghost btn-sm" onclick="exportJSON()" style="font-size:11px;padding:7px 13px">üíæ Exportar</button></div>
        <div style="padding:16px">
          <div id="imp-zone" class="import-zone" onclick="document.getElementById('json-in').click()" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="onJsonDrop(event)">
            <input type="file" id="json-in" accept=".json" style="display:none" onchange="onJsonSelect(event)">
            <div id="imp-idle"><div style="font-size:28px;margin-bottom:8px">üìÅ</div><div style="font-size:13px;font-weight:600;color:var(--text2)">Arraste o backup JSON</div><div style="font-size:11px;color:var(--text3);margin-top:4px">ou toque para selecionar</div></div>
            <div id="imp-prev" style="display:none;align-items:center;gap:12px">
              <span style="font-size:28px">üìã</span>
              <div style="flex:1;text-align:left"><div id="imp-nm" style="font-size:13px;font-weight:700;color:var(--text)"></div><div id="imp-info" style="font-size:11px;color:var(--teal);margin-top:3px;font-weight:600"></div></div>
              <button class="btn btn-ghost btn-sm" onclick="clearJsonFile(event)" style="padding:7px 12px;font-size:11px">‚úï</button>
            </div>
          </div>
          <div id="imp-result" style="display:none;margin-top:12px;background:var(--grn-gl);border:1px solid rgba(52,211,153,.3);border-radius:var(--r-sm);padding:12px 14px;font-size:12px;color:var(--green);font-weight:600"></div>
          <div id="imp-error"  style="display:none;margin-top:12px;background:var(--red-gl);border:1px solid rgba(248,113,113,.3);border-radius:var(--r-sm);padding:12px 14px;font-size:12px;color:var(--red)"></div>
          <button id="imp-btn" class="btn btn-teal" style="margin-top:12px;display:none" onclick="doImport()">üìÇ Carregar dados</button>
        </div>
      </div>
      <div class="set-card">
        <div class="set-hdr"><span>üè∑ Categorias</span><button class="btn btn-ghost btn-sm" onclick="document.getElementById('cat-sheet').classList.add('open')" style="font-size:11px;padding:7px 13px">+ Nova</button></div>
        <div id="cat-list"></div>
      </div>
      <div class="set-card">
        <div class="set-hdr"><span>‚öôÔ∏è Geral</span></div>
        <div class="set-row"><div><div class="set-lbl">Total de Transa√ß√µes</div></div><div class="set-val" id="tx-count">‚Äî</div></div>
        <div class="set-row"><div><div class="set-lbl">Anos com dados</div></div><div class="set-val" id="yrs-info">‚Äî</div></div>
        <div class="set-row"><div><div class="set-lbl">Armazenamento</div></div><span class="set-chip">IndexedDB ¬∑ iPhone</span></div>
        <div class="set-row" style="cursor:pointer" onclick="if(confirm('Limpar TODOS os dados?'))clearAllData()"><div><div class="set-lbl" style="color:var(--red)">Limpar Todos os Dados</div><div class="set-desc">Remove tudo do iPhone</div></div><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="set-card">
        <div class="set-hdr"><span>üì± Instalar no iPhone</span></div>
        <div style="padding:14px 16px;font-size:12px;color:var(--text2);line-height:2">
          1. Abra no <strong>Safari</strong><br>
          2. Toque em <strong>‚¨ÜÔ∏è Compartilhar</strong><br>
          3. Toque em <strong>"Adicionar √† Tela de In√≠cio"</strong><br>
          4. Toque em <strong>Adicionar</strong>
        </div>
      </div>
    </div>

  </div>

  <div class="tabbar">
    <button class="tab active" id="tab-dash" onclick="goTab('dash')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </button>
    <button class="tab" id="tab-txs" onclick="goTab('txs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      Transa√ß√µes
    </button>
    <button class="tab" id="tab-add" onclick="goTab('add')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      Novo
    </button>
    <button class="tab" id="tab-rpt" onclick="goTab('rpt')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Relat√≥rio
    </button>
    <button class="tab" id="tab-cfg" onclick="goTab('cfg')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Config
    </button>
  </div>
</div>

<!-- TX DETAIL SHEET -->
<div class="sheet-bg" id="tx-sheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheet-title">Detalhes</div>
    <div id="sheet-body"></div>
  </div>
</div>

<!-- NEW CATEGORY SHEET -->
<div class="sheet-bg" id="cat-sheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Nova Categoria</div>
    <div class="fg"><label>Chave *</label><input id="nc-key" placeholder="ex: excursao"></div>
    <div class="fg"><label>Nome *</label><input id="nc-label" placeholder="ex: Excurs√£o"></div>
    <div class="fg" style="margin-bottom:20px"><label>Cor</label><input id="nc-color" type="color" value="#6366F1" style="height:44px;padding:4px;border-radius:8px"></div>
    <button class="btn btn-primary" onclick="saveCat()" style="margin-bottom:10px">Criar Categoria</button>
    <button class="btn btn-ghost" onclick="document.getElementById('cat-sheet').classList.remove('open')">Cancelar</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
'use strict';
// ‚ïê‚ïê IndexedDB ‚ïê‚ïê
const DB_NAME='school-ledger',DB_VER=1;
let _db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('transactions'))d.createObjectStore('transactions',{keyPath:'id',autoIncrement:true});if(!d.objectStoreNames.contains('categories'))d.createObjectStore('categories',{keyPath:'key'})};r.onsuccess=e=>{_db=e.target.result;res(_db)};r.onerror=e=>rej(e.target.error)})}
function dbAll(s){return new Promise((res,rej)=>{const r=_db.transaction(s,'readonly').objectStore(s).getAll();r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})}
function dbPut(s,v){return new Promise((res,rej)=>{const r=_db.transaction(s,'readwrite').objectStore(s).put(v);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})}
function dbDel(s,k){return new Promise((res,rej)=>{const r=_db.transaction(s,'readwrite').objectStore(s).delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})}
function dbClear(s){return new Promise((res,rej)=>{const r=_db.transaction(s,'readwrite').objectStore(s).clear();r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})}

// ‚ïê‚ïê STATE ‚ïê‚ïê
const APP={year:new Date().getFullYear(),tab:'dash',cats:[],editId:null};
const MONTHS=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MF=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CAT_ORDER=['mensalidade','matricula','material','uniforme','extra','pensao'];
const PAGE_META={dash:{title:'Dashboard',sub:'Lara & Chloe'},txs:{title:'Transa√ß√µes',sub:'Hist√≥rico'},add:{title:'Nova Transa√ß√£o',sub:'Registrar'},rpt:{title:'Relat√≥rios',sub:'Exportar e imprimir'},cfg:{title:'Configura√ß√µes',sub:'Dados e importa√ß√£o'}};

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
function fmt(v){if(!v&&v!==0)return '‚Äî';return Math.abs(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}
function fmtK(v){return v>=1000?(v/1000).toFixed(1)+'k':v.toFixed(0)}
function fmtDate(iso){if(!iso)return '‚Äî';const[y,m,d]=iso.split('-');return `${d}/${m}/${y}`}
function showToast(msg,dur=2500){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur)}
function catMeta(k){return APP.cats.find(c=>c.key===k)||{key:k,label:k,color:'#475569',system:false}}
function catIcon(k){const ic={mensalidade:'üè´',matricula:'üìù',material:'üìö',uniforme:'üëï',extra:'üé≠',pensao:'üí∞'};return ic[k]||'üìå'}

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function goTab(tab){
  APP.tab=tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('scroll-area').scrollTop=0;
  const m=PAGE_META[tab]||{};
  document.getElementById('hdr-title').textContent=m.title||tab;
  document.getElementById('hdr-sub').textContent=m.sub||'';
  if(tab==='dash')renderDash();
  if(tab==='txs')renderTxPage();
  if(tab==='add'){APP.editId=null;resetForm()}
  if(tab==='rpt')renderReport();
  if(tab==='cfg')renderSettings();
}

// ‚ïê‚ïê YEAR FILTER ‚ïê‚ïê
async function initYearFilter(){
  const txs=await dbAll('transactions');
  const years=[...new Set(txs.map(t=>t.academicYear))].filter(Boolean).sort();
  const cur=new Date().getFullYear();
  if(!years.includes(cur))years.push(cur);
  if(!years.includes(cur+1))years.push(cur+1);
  years.sort();
  const sel=document.getElementById('year-filter');
  sel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  APP.year=years.includes(cur)?cur:Math.max(...years);
  sel.value=APP.year;
  sel.addEventListener('change',async e=>{APP.year=parseInt(e.target.value);if(APP.tab==='dash')renderDash();if(APP.tab==='txs')renderTxPage();if(APP.tab==='rpt')renderReport()});
  const fy=document.getElementById('f-year');
  fy.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  fy.value=APP.year;
}

// ‚ïê‚ïê SUMMARY ‚ïê‚ïê
async function getSummary(year){
  const all=await dbAll('transactions');
  const txs=all.filter(t=>t.academicYear===year);
  const totalPaid=txs.filter(t=>t.type==='PAID').reduce((a,t)=>a+t.amount,0);
  const totalReceived=txs.filter(t=>t.type==='RECEIVED').reduce((a,t)=>a+t.amount,0);
  const lateCount=txs.filter(t=>t.isLate).length;
  const byCat={};txs.forEach(t=>{byCat[t.categoryKey]=(byCat[t.categoryKey]||0)+t.amount});
  const catByMonth=Array.from({length:12},()=>({}));
  txs.forEach(t=>{const mi=t.academicMonth-1;catByMonth[mi][t.categoryKey]=(catByMonth[mi][t.categoryKey]||0)+t.amount});
  return{totalPaid,totalReceived,deficit:totalPaid-totalReceived,lateCount,byCat,catByMonth}
}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê
async function renderDash(){
  const d=await getSummary(APP.year);
  const pct=d.totalPaid>0?(d.totalReceived/d.totalPaid*100).toFixed(1):0;
  document.getElementById('kpi-row').innerHTML=`
    <div class="kpi k-blue"><div class="kpi-lbl">Pago ${APP.year}</div><div class="kpi-val">R$ ${fmtK(d.totalPaid)}</div><div class="kpi-sub">${fmt(d.totalPaid)}</div></div>
    <div class="kpi k-teal"><div class="kpi-lbl">Pens√£o ${APP.year}</div><div class="kpi-val">R$ ${fmtK(d.totalReceived)}</div><div class="kpi-sub">${pct}% coberto ¬∑ ${d.lateCount} atr.</div></div>
    <div class="kpi k-red"><div class="kpi-lbl">D√©ficit ${APP.year}</div><div class="kpi-val">‚ÄìR$ ${fmtK(d.deficit)}</div><div class="kpi-sub">n√£o coberto pelo pai</div></div>
    <div class="kpi k-amber"><div class="kpi-lbl">Maior Custo</div><div class="kpi-val" style="font-size:15px">${(()=>{const top=Object.entries(d.byCat||{}).filter(([k])=>k!=='pensao').sort((a,b)=>b[1]-a[1])[0];return top?catMeta(top[0]).label:'‚Äî'})()}</div><div class="kpi-sub">${APP.year}</div></div>`;
  requestAnimationFrame(()=>requestAnimationFrame(()=>renderCharts(d)));
  const all=await dbAll('transactions');
  const recent=all.filter(t=>t.academicYear===APP.year).sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).slice(0,5);
  renderTxList(recent,'recent-list',true);
}

function renderCharts(d){
  const def=d.totalPaid-d.totalReceived,bc=d.byCat||{},gt=Object.values(bc).reduce((a,b)=>a+b,0);
  const p0=d.totalPaid>0?(def/d.totalPaid*100).toFixed(1):0,p1=d.totalPaid>0?(d.totalReceived/d.totalPaid*100).toFixed(1):0;
  document.getElementById('charts-area').innerHTML=`
    <div class="chart-wrap">
      <div class="chart-ttl">Vis√£o Geral</div>
      <div class="donuts-row">
        <div class="donut-wrap"><canvas id="pie1" style="width:120px;height:120px"></canvas><div class="donut-sub">Participa√ß√£o</div>
          <div class="donut-leg"><div class="leg-row"><div class="leg-dot" style="background:var(--blue)"></div>Eu<span class="leg-val">${p0}%</span></div><div class="leg-row"><div class="leg-dot" style="background:var(--pink)"></div>Pai<span class="leg-val">${p1}%</span></div></div>
        </div>
        <div class="donut-wrap"><canvas id="pie2" style="width:120px;height:120px"></canvas><div class="donut-sub">Categorias</div>
          <div class="donut-leg" id="pie2-leg"></div>
        </div>
      </div>
    </div>
    <div class="chart-wrap">
      <div class="chart-ttl">Por M√™s ‚Äî ${APP.year}</div>
      <canvas id="bar1" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">${CAT_ORDER.map(k=>`<div class="leg-row"><div class="leg-dot" style="background:${catMeta(k).color}"></div><span style="font-size:9px">${catMeta(k).label}</span></div>`).join('')}</div>
    </div>`;
  drawDonut('pie1',[{v:def,c:'#3B82F6'},{v:d.totalReceived,c:'#F472B6'}],'Total',fmtK(d.totalPaid),120);
  drawDonut('pie2',CAT_ORDER.map(k=>({v:bc[k]||0,c:catMeta(k).color})),'Total',fmtK(gt),120);
  document.getElementById('pie2-leg').innerHTML=CAT_ORDER.map(k=>{const v=bc[k]||0;if(!v)return '';const p=gt>0?(v/gt*100).toFixed(0):0;return `<div class="leg-row"><div class="leg-dot" style="background:${catMeta(k).color}"></div>${catMeta(k).label}<span class="leg-val">${p}%</span></div>`}).join('');
  drawBar('bar1',d);
}

function drawDonut(id,slices,cLabel,cVal,SZ=120){
  const c=document.getElementById(id);if(!c)return;
  const dpr=devicePixelRatio||1;c.width=SZ*dpr;c.height=SZ*dpr;c.style.width=SZ+'px';c.style.height=SZ+'px';
  const ctx=c.getContext('2d');ctx.scale(dpr,dpr);
  const cx=SZ/2,cy=SZ/2,R=SZ/2-8,r=SZ/2-26;
  const tot=slices.reduce((a,s)=>a+s.v,0);if(!tot)return;
  let a=-Math.PI/2;
  slices.forEach(s=>{if(!s.v)return;const sw=s.v/tot*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a,a+sw);ctx.closePath();ctx.fillStyle=s.c;ctx.fill();a+=sw});
  a=-Math.PI/2;slices.forEach(s=>{if(!s.v)return;const sw=s.v/tot*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a,a+sw);ctx.closePath();ctx.strokeStyle='rgba(10,15,30,.8)';ctx.lineWidth=2.5;ctx.stroke();a+=sw});
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#111827';ctx.fill();
  ctx.textAlign='center';ctx.fillStyle='#475569';ctx.font=`500 8px 'Syne',sans-serif`;ctx.fillText(cLabel,cx,cy-5);
  ctx.fillStyle='#F1F5F9';ctx.font=`500 11px 'Syne Mono',monospace`;ctx.fillText(cVal,cx,cy+8);
}

function drawBar(id,d){
  const c=document.getElementById(id);if(!c)return;
  const par=c.parentElement;const pW=Math.max(par?Math.max(par.getBoundingClientRect().width,par.offsetWidth):320,200);
  const W=Math.floor(pW)-32,H=110,dpr=devicePixelRatio||1;
  c.width=W*dpr;c.height=H*dpr;c.style.width=W+'px';c.style.height=H+'px';
  const ctx=c.getContext('2d');ctx.scale(dpr,dpr);
  const barData=(d.catByMonth||[]).map(m=>CAT_ORDER.map(k=>m[k]||0));
  const colors=CAT_ORDER.map(k=>catMeta(k).color);
  const padL=32,padB=16,padT=8,padR=4,cW=W-padL-padR,cH=H-padT-padB;
  const maxV=Math.max(...barData.map(r=>r.reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/2000)*2000||2000;
  for(let i=0;i<=3;i++){const y=padT+cH-(i/3)*cH;ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=.7;ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(padL+cW,y);ctx.stroke();ctx.fillStyle='#475569';ctx.textAlign='right';ctx.font=`8px 'Syne Mono',monospace`;ctx.fillText(fmtK(scale/3*i),padL-3,y+3)}
  const mW=cW/12,bW=mW*.7,bOff=(mW-bW)/2;
  barData.forEach((cats,mi)=>{
    const gx=padL+mi*mW+bOff;let yBase=padT+cH;
    cats.forEach((v,ci)=>{if(v<=0)return;const bH=Math.max(1,(v/scale)*cH);yBase-=bH;ctx.fillStyle=colors[ci];ctx.fillRect(gx,yBase,bW,bH)});
    ctx.fillStyle='#475569';ctx.textAlign='center';ctx.font=`6.5px 'Syne',sans-serif`;ctx.fillText(MONTHS[mi],padL+mi*mW+mW/2,H-2);
  });
}

// ‚ïê‚ïê TRANSACTIONS ‚ïê‚ïê
function renderTxList(txs,containerId,clickable){
  const el=document.getElementById(containerId);
  if(!txs.length){el.innerHTML=`<div class="empty"><div class="empty-ic">üì≠</div><div class="empty-txt">Nenhuma transa√ß√£o em ${APP.year}</div></div>`;return}
  el.innerHTML=txs.map(t=>{const m=catMeta(t.categoryKey),isOut=t.type==='PAID';return`<div class="tx-row" ${clickable?`onclick="openTxSheet(${t.id})"`:''}><div class="tx-icon" style="background:${m.color}22">${catIcon(t.categoryKey)}</div><div class="tx-body"><div class="tx-cat">${m.label}</div><div class="tx-meta">${fmtDate(t.date)} ¬∑ ${MONTHS[t.academicMonth-1]}/${t.academicYear} ¬∑ ${t.party==='Father'?'Pai':'Eu'}</div>${t.notes?`<div class="tx-meta" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px">${t.notes}</div>`:''}</div><div class="tx-amt"><div class="tx-amt-val ${isOut?'out':'inp'}">${isOut?'‚Äì':'+'}${fmtK(t.amount)}</div><div class="tx-late">${t.isLate?'‚ñ† atrasado':''}</div></div></div>`}).join('');
}

async function renderTxPage(){
  const type=document.getElementById('tx-type').value,cat=document.getElementById('tx-cat').value;
  let txs=(await dbAll('transactions')).filter(t=>t.academicYear===APP.year);
  if(type)txs=txs.filter(t=>t.type===type);
  if(cat)txs=txs.filter(t=>t.categoryKey===cat);
  txs.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  renderTxList(txs,'tx-list',true);
}

async function openTxSheet(id){
  const txs=await dbAll('transactions');const t=txs.find(t=>t.id===id);if(!t)return;
  const m=catMeta(t.categoryKey),isOut=t.type==='PAID';
  document.getElementById('sheet-title').textContent=m.label;
  document.getElementById('sheet-body').innerHTML=`
    <div style="text-align:center;padding:10px 0 20px"><div style="font-size:40px;margin-bottom:6px">${catIcon(t.categoryKey)}</div><div style="font-family:var(--mono);font-size:28px;font-weight:400;color:${isOut?'var(--red)':'var(--teal)'}">${isOut?'‚Äì':'+'} R$ ${fmt(t.amount)}</div></div>
    <div style="background:var(--bg3);border-radius:var(--r-sm);overflow:hidden;margin-bottom:16px">
      ${row('Data',fmtDate(t.date))}${row('M√™s',MF[t.academicMonth-1]+' / '+t.academicYear)}${row('Tipo',isOut?'üí∏ Pago':'üí∞ Recebido')}${row('Parte',t.party==='Father'?'Pai':'Eu')}${row('Atraso',t.isLate?'‚ñ† Sim':'‚úì N√£o')}${t.notes?row('Notas',t.notes):''}${t.tags?row('Tags',t.tags):''}
    </div>
    <button class="btn btn-primary" style="margin-bottom:10px" onclick="editTx(${t.id});document.getElementById('tx-sheet').classList.remove('open')">‚úèÔ∏è Editar</button>
    <button class="btn btn-danger" onclick="if(confirm('Excluir?'))delTxById(${t.id})">üóë Excluir</button>`;
  document.getElementById('tx-sheet').classList.add('open');
}
function row(lbl,val){return `<div style="display:flex;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04)"><span style="font-size:12px;color:var(--text2)">${lbl}</span><span style="font-size:12px;font-weight:600">${val}</span></div>`}
async function delTxById(id){await dbDel('transactions',id);document.getElementById('tx-sheet').classList.remove('open');showToast('üóë Exclu√≠do');await initYearFilter();if(APP.tab==='dash')renderDash();if(APP.tab==='txs')renderTxPage()}

// ‚ïê‚ïê FORM ‚ïê‚ïê
function resetForm(){
  APP.editId=null;
  ['f-id','f-amount','f-notes','f-tags'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=''});
  document.getElementById('f-type').value='PAID';document.getElementById('f-cat').value=APP.cats[0]?.key||'mensalidade';
  document.getElementById('f-party').value='Me';document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-year').value=APP.year;document.getElementById('f-month').value=new Date().getMonth()+1;
  document.getElementById('tog-late').classList.remove('on');document.getElementById('del-btn').style.display='none';
  document.getElementById('form-title-lbl').textContent='Nova Transa√ß√£o';document.getElementById('ai-banner').style.display='none';
  document.getElementById('ai-st').textContent='';document.getElementById('ai-btn').disabled=true;document.getElementById('ai-btn').style.cssText='';
  document.getElementById('ai-ic').textContent='‚ú¶';document.getElementById('ai-txt').textContent='Interpretar com IA';
  document.getElementById('dz-idle').style.display='block';document.getElementById('dz-prev').style.display='none';
  document.querySelectorAll('.ai-fill').forEach(e=>e.classList.remove('ai-fill'));
  _aif=null;_aib64=null;_aimime=null;
}
function editTx(id){
  goTab('add');
  dbAll('transactions').then(txs=>{const t=txs.find(t=>t.id===id);if(!t)return;
    APP.editId=id;document.getElementById('f-id').value=t.id;document.getElementById('f-amount').value=t.amount;
    document.getElementById('f-type').value=t.type;document.getElementById('f-cat').value=t.categoryKey;
    document.getElementById('f-party').value=t.party;document.getElementById('f-date').value=t.date;
    document.getElementById('f-year').value=t.academicYear;document.getElementById('f-month').value=t.academicMonth;
    document.getElementById('f-notes').value=t.notes||'';document.getElementById('f-tags').value=t.tags||'';
    if(t.isLate)document.getElementById('tog-late').classList.add('on');
    document.getElementById('del-btn').style.display='flex';document.getElementById('form-title-lbl').textContent='Editar Transa√ß√£o'});
}
async function saveTx(){
  const amount=parseFloat(document.getElementById('f-amount').value);
  if(!amount||isNaN(amount)){showToast('‚ö†Ô∏è Valor inv√°lido');return}
  const date=document.getElementById('f-date').value;if(!date){showToast('‚ö†Ô∏è Informe a data');return}
  const t={amount,type:document.getElementById('f-type').value,categoryKey:document.getElementById('f-cat').value,party:document.getElementById('f-party').value,date,academicYear:parseInt(document.getElementById('f-year').value),academicMonth:parseInt(document.getElementById('f-month').value),isLate:document.getElementById('tog-late').classList.contains('on'),notes:document.getElementById('f-notes').value,tags:document.getElementById('f-tags').value,updatedAt:new Date().toISOString()};
  if(APP.editId)t.id=APP.editId;else t.createdAt=new Date().toISOString();
  await dbPut('transactions',t);showToast(APP.editId?'‚úÖ Atualizado!':'‚úÖ Transa√ß√£o salva!');
  await initYearFilter();goTab('txs');
}
async function deleteTx(){if(!APP.editId)return;if(!confirm('Excluir esta transa√ß√£o?'))return;await dbDel('transactions',APP.editId);showToast('üóë Exclu√≠do');await initYearFilter();goTab('txs')}

// ‚ïê‚ïê REPORTS ‚ïê‚ïê
async function renderReport(){
  const all=await dbAll('transactions');const years=[...new Set(all.map(t=>t.academicYear))].filter(Boolean).sort();
  if(!years.length){document.getElementById('rpt-content').innerHTML=`<div class="empty"><div class="empty-ic">üìã</div><div class="empty-txt">Sem dados</div></div>`;return}
  let html='',gP=0,gR=0;
  for(const yr of years){
    const txs=all.filter(t=>t.academicYear===yr);const byMonth={},pByM={},lByM={};
    txs.filter(t=>t.type==='PAID').forEach(t=>{const m=t.academicMonth;if(!byMonth[m])byMonth[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};if(byMonth[m][t.categoryKey]!==undefined)byMonth[m][t.categoryKey]+=t.amount});
    txs.filter(t=>t.categoryKey==='pensao').forEach(t=>{pByM[t.academicMonth]=(pByM[t.academicMonth]||0)+t.amount});
    txs.filter(t=>t.isLate&&t.categoryKey==='pensao').forEach(t=>{lByM[t.academicMonth]=true});
    let rows='',tot={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0,sub:0,recv:0,diff:0};
    for(let m=1;m<=12;m++){
      const cats=byMonth[m]||{},recv=pByM[m]||0,late=lByM[m],sub=Object.values(cats).reduce((a,b)=>a+b,0),diff=sub-recv;
      const pct=sub>0?(recv/sub*100):0,pc=pct===0?'':pct<50?'td-pct-r':pct<70?'td-pct-a':'td-pct-g';
      if(sub>0||recv>0){['mensalidade','matricula','material','uniforme','extra'].forEach(k=>{tot[k]+=(cats[k]||0)});tot.sub+=sub;tot.recv+=recv;tot.diff+=diff}
      if(sub===0&&recv===0)continue;
      rows+=`<tr><td>${MONTHS[m-1]}</td><td>${fmt(cats.mensalidade||0)}</td><td>${fmt(cats.matricula||0)}</td><td class="td-recv">${fmt(recv)||'‚Äî'}</td><td class="td-neg">${diff>0?'‚Äì':'+'}${fmt(Math.abs(diff))||'‚Äî'}</td><td class="${pc}">${sub>0?pct.toFixed(1)+'%':'‚Äî'}${late?'<span class="late-m"> ‚ñ†</span>':''}</td></tr>`;
    }
    const tPct=tot.sub>0?(tot.recv/tot.sub*100).toFixed(1)+'%':'‚Äî';gP+=tot.sub;gR+=tot.recv;
    html+=`<div class="report-year-card"><div class="report-yr-hdr"><span>${yr}</span><span style="font-family:var(--mono);font-size:12px;color:var(--text2)">R$ ${fmt(tot.sub)}</span></div><div class="report-table-wrap"><table class="rtbl"><thead><tr><th>M√™s</th><th>Mensalidade</th><th>Matr√≠cula</th><th>Pens√£o</th><th>Diferen√ßa</th><th>% Pai</th></tr></thead><tbody>${rows}<tr class="rt-total"><td>TOTAL</td><td>${fmt(tot.mensalidade)}</td><td>${fmt(tot.matricula)}</td><td class="td-recv">${fmt(tot.recv)}</td><td class="td-neg">‚Äì${fmt(tot.diff)}</td><td class="td-neg">${tPct}</td></tr></tbody></table></div></div>`;
  }
  const gD=gP-gR,gPct=gP>0?(gR/gP*100).toFixed(1):0;
  html+=`<div class="gt-strip"><div class="gt-item"><div class="gt-lbl">Total Pago</div><div class="gt-val">${fmt(gP)}</div></div><div class="gt-item"><div class="gt-lbl">Pens√£o</div><div class="gt-val or">${fmt(gR)}</div></div><div class="gt-item"><div class="gt-lbl">D√©ficit</div><div class="gt-val re">‚Äì${fmt(gD)}</div></div><div class="gt-item"><div class="gt-lbl">Cobertura</div><div class="gt-val or">${gPct}%</div></div></div><div style="font-size:10px;color:var(--text3);padding:0 0 20px"><strong style="color:var(--red)">‚ñ†</strong> Recebido ap√≥s dia 5</div>`;
  document.getElementById('rpt-content').innerHTML=html;
}

// ‚ïê‚ïê SETTINGS ‚ïê‚ïê
async function renderSettings(){
  const cats=await dbAll('categories'),all=await dbAll('transactions');
  const years=[...new Set(all.map(t=>t.academicYear))].sort();APP.cats=cats;
  document.getElementById('cat-list').innerHTML=cats.map(c=>`<div class="cat-item"><div class="cat-dot" style="background:${c.color}"></div><div style="flex:1"><div class="cat-nm">${c.label}</div><div class="cat-key">${c.key}</div></div>${!c.system?`<button onclick="deleteCat('${c.key}')" style="background:none;border:none;color:var(--red);font-size:18px;cursor:pointer;padding:4px">üóë</button>`:'<span class="set-chip">Sistema</span>'}</div>`).join('');
  document.getElementById('tx-count').textContent=all.length+' registros';
  document.getElementById('yrs-info').textContent=years.length?years.join(', '):'‚Äî';
}
async function saveCat(){const key=document.getElementById('nc-key').value.trim().toLowerCase().replace(/\s+/g,'_'),label=document.getElementById('nc-label').value.trim(),color=document.getElementById('nc-color').value;if(!key||!label){showToast('‚ö†Ô∏è Preencha chave e nome');return}await dbPut('categories',{key,label,color,system:false});showToast('‚úÖ Categoria criada!');document.getElementById('cat-sheet').classList.remove('open');await loadCategories();renderSettings()}
async function deleteCat(key){if(!confirm('Excluir categoria "'+key+'"?'))return;await dbDel('categories',key);await loadCategories();renderSettings()}
async function clearAllData(){await dbClear('transactions');await initYearFilter();renderSettings();showToast('üóë Dados removidos')}

// ‚ïê‚ïê EXPORT / IMPORT JSON ‚ïê‚ïê
async function exportJSON(){
  const txs=await dbAll('transactions'),cats=await dbAll('categories');
  const payload={meta:{version:'3.0',school:'Col√©gio Objectivo',exportedAt:new Date().toISOString()},categories:cats,transactions:txs};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download=`school-ledger-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast('üíæ JSON exportado!');
}
let _jsonParsed=null;
function onJsonDrop(e){e.preventDefault();document.getElementById('imp-zone').classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)loadJsonFile(f)}
function onJsonSelect(e){const f=e.target.files[0];if(f)loadJsonFile(f)}
function loadJsonFile(file){
  const r=new FileReader();r.onload=e=>{try{_jsonParsed=JSON.parse(e.target.result);if(!Array.isArray(_jsonParsed.transactions))throw new Error('"transactions" deve ser um array');const n=_jsonParsed.transactions.length,years=[...new Set(_jsonParsed.transactions.map(t=>t.academicYear))].filter(Boolean).sort();document.getElementById('imp-idle').style.display='none';const pv=document.getElementById('imp-prev');pv.style.display='flex';document.getElementById('imp-nm').textContent=file.name;document.getElementById('imp-info').textContent=`${n} transa√ß√µes ¬∑ Anos: ${years.join(', ')||'‚Äî'}`;document.getElementById('imp-zone').classList.add('has-file');document.getElementById('imp-btn').style.display='flex';document.getElementById('imp-result').style.display='none';document.getElementById('imp-error').style.display='none'}catch(err){document.getElementById('imp-error').textContent='Erro: '+err.message;document.getElementById('imp-error').style.display='block'}};r.readAsText(file)
}
function clearJsonFile(e){e.stopPropagation();_jsonParsed=null;document.getElementById('json-in').value='';document.getElementById('imp-idle').style.display='block';document.getElementById('imp-prev').style.display='none';document.getElementById('imp-zone').classList.remove('has-file');document.getElementById('imp-btn').style.display='none';document.getElementById('imp-result').style.display='none';document.getElementById('imp-error').style.display='none'}
async function doImport(){
  if(!_jsonParsed)return;if(!confirm(`Substituir os dados atuais por ${_jsonParsed.transactions.length} transa√ß√µes?\n\nOs dados atuais ser√£o perdidos.`))return;
  try{await dbClear('transactions');for(const t of _jsonParsed.transactions)await dbPut('transactions',t);if(Array.isArray(_jsonParsed.categories))for(const c of _jsonParsed.categories)await dbPut('categories',c);const n=_jsonParsed.transactions.length;document.getElementById('imp-result').textContent=`‚úÖ ${n} transa√ß√µes importadas!`;document.getElementById('imp-result').style.display='block';document.getElementById('imp-btn').style.display='none';await loadCategories();await initYearFilter();showToast('‚úÖ '+n+' transa√ß√µes importadas!',3500)}catch(err){document.getElementById('imp-error').textContent='Erro: '+err.message;document.getElementById('imp-error').style.display='block'}
}

// ‚ïê‚ïê AI ‚ïê‚ïê
let _aif=null,_aib64=null,_aimime=null;
function onFileDrop(e){e.preventDefault();const f=e.dataTransfer.files[0];if(f)loadAiFile(f)}
function onFileSelect(e){const f=e.target.files[0];if(f)loadAiFile(f)}
function loadAiFile(file){
  if(!['application/pdf','image/jpeg','image/jpg','image/png'].includes(file.type)){showToast('‚ùå Use PDF, JPG ou PNG');return}
  if(file.size>10*1024*1024){showToast('‚ùå Arquivo maior que 10MB');return}
  _aif=file;_aimime=file.type;document.getElementById('dz-idle').style.display='none';const pv=document.getElementById('dz-prev');pv.style.display='flex';
  const ic={'application/pdf':'üìÑ','image/jpeg':'üñºÔ∏è','image/jpg':'üñºÔ∏è','image/png':'üñºÔ∏è'};
  document.getElementById('dz-ic').textContent=ic[file.type]||'üìé';document.getElementById('dz-nm').textContent=file.name;document.getElementById('dz-sz').textContent=(file.size/1024).toFixed(1)+' KB';
  document.getElementById('ai-btn').disabled=false;const r=new FileReader();r.onload=e=>{_aib64=e.target.result.split(',')[1]};r.readAsDataURL(file);
}
function clearAiFile(e){e.stopPropagation();_aif=null;_aib64=null;_aimime=null;document.getElementById('file-in').value='';document.getElementById('dz-idle').style.display='block';document.getElementById('dz-prev').style.display='none';document.getElementById('ai-btn').disabled=true;document.getElementById('ai-banner').style.display='none';document.getElementById('ai-st').textContent=''}
async function runAI(){
  if(!_aib64||!_aimime)return;const btn=document.getElementById('ai-btn');btn.disabled=true;
  document.getElementById('ai-ic').innerHTML='<span class="spinner" style="width:13px;height:13px;border-width:2px"></span>';document.getElementById('ai-txt').textContent='Analisando...';document.getElementById('ai-st').textContent='IA lendo...';
  const catKeys=APP.cats.map(c=>c.key).join('|');
  const prompt=`Analise este documento financeiro brasileiro (escola Col√©gio Objectivo, alunas Lara e Chloe). Retorne APENAS JSON sem markdown:{"amount":<n>,"type":"PAID"|"RECEIVED","categoryKey":"${catKeys}","party":"Me"|"Father"|"School"|"Store"|"Other","date":"YYYY-MM-DD"|null,"academicYear":<n>,"academicMonth":<1-12>,"isLate":false,"notes":"","tags":"","confidence":"high"|"medium"|"low","summary":"<pt-BR>"}\nUse "pensao" para valores do pai.`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:[_aimime.startsWith('image/')?{type:'image',source:{type:'base64',media_type:_aimime,data:_aib64}}:{type:'document',source:{type:'base64',media_type:'application/pdf',data:_aib64}},{type:'text',text:prompt}]}]})});
    if(!res.ok)throw new Error('HTTP '+res.status);const data=await res.json();const txt=data.content?.find(b=>b.type==='text')?.text||'';const parsed=JSON.parse(txt.replace(/```json|```/g,'').trim());applyAI(parsed);
  }catch(err){showToast('‚ùå Erro IA: '+err.message);btn.disabled=false;document.getElementById('ai-ic').textContent='‚ú¶';document.getElementById('ai-txt').textContent='Tentar novamente';document.getElementById('ai-st').textContent=''}
}
function applyAI(data){
  document.getElementById('ai-ic').textContent='‚úì';document.getElementById('ai-txt').textContent='Preenchido';document.getElementById('ai-btn').style.cssText='background:var(--green);color:#fff;opacity:1';
  const cf=data.confidence||'medium',cfC={high:'var(--teal)',medium:'var(--amber)',low:'var(--red)'};
  document.getElementById('ai-st').innerHTML=`<span style="color:${cfC[cf]};font-weight:700">‚óè ${cf==='high'?'Alta':cf==='medium'?'M√©dia':'Baixa'}</span>`;
  document.getElementById('ai-sum').textContent=data.summary||'Interpretado.';document.getElementById('ai-banner').style.display='block';
  const map=[['f-amount',data.amount?.toString()],['f-type',data.type],['f-cat',data.party==='Father'&&data.type==='RECEIVED'?'pensao':data.categoryKey],['f-party',data.party],['f-date',data.date],['f-year',data.academicYear?.toString()],['f-month',data.academicMonth?.toString()],['f-notes',data.notes],['f-tags',data.tags]];
  map.forEach(([id,v],i)=>{if(!v)return;setTimeout(()=>{const el=document.getElementById(id);if(!el)return;if(el.tagName==='SELECT'){const o=[...el.options].find(o=>o.value===v);if(o)el.value=o.value}else el.value=v;el.classList.add('ai-fill')},i*50)});
  if(data.isLate||data.party==='Father')setTimeout(()=>document.getElementById('tog-late').classList.add('on'),350);
}

// ‚ïê‚ïê CATEGORIES ‚ïê‚ïê
async function loadCategories(){
  APP.cats=await dbAll('categories');
  ['f-cat','tx-cat'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML=id==='tx-cat'?'<option value="">Todas categorias</option>':'';APP.cats.forEach(c=>{const o=document.createElement('option');o.value=c.key;o.textContent=c.label;el.appendChild(o)});if(cur)el.value=cur});
}

// ‚ïê‚ïê SEED ‚ïê‚ïê
async function seedIfEmpty(){
  const existing=await dbAll('transactions');if(existing.length>0)return;
  const CATS=[{key:'mensalidade',label:'Mensalidade',color:'#3B82F6',system:true},{key:'pensao',label:'Pens√£o Aliment√≠cia',color:'#F472B6',system:true},{key:'matricula',label:'Matr√≠cula',color:'#FBBF24',system:true},{key:'material',label:'Material',color:'#14B8A6',system:true},{key:'uniforme',label:'Uniforme',color:'#A78BFA',system:true},{key:'extra',label:'Extra',color:'#34D399',system:true}];
  for(const c of CATS)await dbPut('categories',c);
  let id=1;const mk=o=>({id:id++,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),...o});
  const m25=[4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.40];
  const d25=['2025-01-05','2025-02-05','2025-03-05','2025-04-05','2025-05-05','2025-06-05','2025-07-05','2025-08-05','2025-09-05','2025-10-05','2025-11-05','2025-12-05'];
  for(let i=0;i<12;i++)await dbPut('transactions',mk({amount:m25[i],type:'PAID',categoryKey:'mensalidade',party:'Me',date:d25[i],academicYear:2025,academicMonth:i+1,isLate:false,notes:`Mensalidade ${MF[i]}/2025`,tags:'mensalidade,2025'}));
  await dbPut('transactions',mk({amount:4256.88,type:'PAID',categoryKey:'matricula',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'Matr√≠cula anual 2025',tags:'matricula,2025'}));
  for(const[m,d]of[[1,'2025-01-05'],[4,'2025-04-05'],[7,'2025-07-05'],[9,'2025-09-05']])await dbPut('transactions',mk({amount:724.50,type:'PAID',categoryKey:'material',party:'Me',date:d,academicYear:2025,academicMonth:m,isLate:false,notes:`Material ${MF[m-1]}/2025`,tags:'material,2025'}));
  await dbPut('transactions',mk({amount:1084.23,type:'PAID',categoryKey:'extra',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'‚òÖ Extra Jan/2025',tags:'extra,2025'}));
  const p25=[[1,'2025-01-05',2000,false],[2,'2025-02-05',2000,false],[3,'2025-03-05',2000,false],[4,'2025-04-05',2000,false],[5,'2025-05-06',1000,true],[6,'2025-06-05',2000,false],[7,'2025-07-03',1000,false],[7,'2025-07-17',1000,true],[8,'2025-08-05',2000,false],[9,'2025-09-05',2000,false],[10,'2025-10-04',2000,false],[11,'2025-11-05',2000,false],[11,'2025-11-22',1500,true],[12,'2025-12-05',3500,false]];
  for(const[m,d,amt,late]of p25)await dbPut('transactions',mk({amount:amt,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:d,academicYear:2025,academicMonth:m,isLate:late,notes:`Pens√£o ${MF[m-1]}/2025`,tags:'pensao,2025'}));
  for(const[m,d]of[[1,'2026-01-05'],[2,'2026-02-05']])await dbPut('transactions',mk({amount:5666.85,type:'PAID',categoryKey:'mensalidade',party:'Me',date:d,academicYear:2026,academicMonth:m,isLate:false,notes:`Mensalidade ${MF[m-1]}/2026`,tags:'mensalidade,2026'}));
  await dbPut('transactions',mk({amount:1491.29,type:'PAID',categoryKey:'matricula',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'Matr√≠cula 2026',tags:'matricula,2026'}));
  await dbPut('transactions',mk({amount:1047.33,type:'PAID',categoryKey:'material',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'Material Jan/2026',tags:'material,2026'}));
  await dbPut('transactions',mk({amount:1503.41,type:'PAID',categoryKey:'extra',party:'Me',date:'2026-02-05',academicYear:2026,academicMonth:2,isLate:false,notes:'Excurs√£o parcela 1',tags:'extra,2026'}));
  for(let i=0;i<6;i++){const m=i+3;await dbPut('transactions',mk({amount:429,type:'PAID',categoryKey:'extra',party:'Me',date:`2026-0${m<10?m:m}-05`,academicYear:2026,academicMonth:m,isLate:false,notes:`Excurs√£o ${MF[m-1]}/2026`,tags:'extra,excursao,2026'}))}
  await dbPut('transactions',mk({amount:2000,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-01-12',academicYear:2026,academicMonth:1,isLate:true,notes:'‚ñ† Pens√£o Jan/2026 ‚Äî atraso',tags:'pensao,2026'}));
  await dbPut('transactions',mk({amount:2500,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-02-07',academicYear:2026,academicMonth:2,isLate:true,notes:'‚ñ† Pens√£o Fev/2026 ‚Äî atraso',tags:'pensao,2026'}));
}

// ‚ïê‚ïê SHEETS CLOSE ON BG TAP ‚ïê‚ïê
document.querySelectorAll('.sheet-bg').forEach(bg=>{bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open')})});

// ‚ïê‚ïê SERVICE WORKER ‚ïê‚ïê
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});

// ‚ïê‚ïê INIT ‚ïê‚ïê
async function init(){
  await openDB();await seedIfEmpty();await loadCategories();await initYearFilter();renderDash();
}
window.addEventListener('load',init);
</script>
</body>
</html>
