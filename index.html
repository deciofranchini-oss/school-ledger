<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ledger">
<meta name="theme-color" content="#F2F2F7">
<title>School Ledger</title>
<link rel="manifest" href="./manifest.json">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS â€” iOS Light Mode
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:          #F2F2F7;
  --card:        #FFFFFF;
  --sep:         rgba(60,60,67,.18);
  --sep-light:   rgba(60,60,67,.08);
  --fill:        rgba(120,120,128,.12);
  --fill2:       rgba(120,120,128,.08);

  --blue:        #007AFF;
  --blue-bg:     rgba(0,122,255,.10);
  --green:       #34C759;
  --green-bg:    rgba(52,199,89,.10);
  --red:         #FF3B30;
  --red-bg:      rgba(255,59,48,.10);
  --orange:      #FF9500;
  --orange-bg:   rgba(255,149,0,.10);
  --purple:      #AF52DE;
  --teal:        #32ADE6;
  --indigo:      #5856D6;
  --pink:        #FF2D55;

  --label:       #000000;
  --label2:      rgba(60,60,67,.60);
  --label3:      rgba(60,60,67,.30);
  --label4:      rgba(60,60,67,.18);

  --f:     -apple-system, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --f-mono:'SF Mono','Menlo','Courier New',monospace;

  --sat: env(safe-area-inset-top,44px);
  --sab: env(safe-area-inset-bottom,34px);
  --r:   10px;
  --r2:  14px;
  --tab: 49px;
  --s1:  0 1px 0 rgba(0,0,0,.04), 0 2px 8px rgba(0,0,0,.06);
}

/* â”€â”€ RESET â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{font-family:var(--f);background:var(--bg);color:var(--label);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;padding-top:var(--sat)}

/* â”€â”€ SCAFFOLD â”€â”€ */
#app{display:flex;flex-direction:column;height:100%}
.scroller{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--tab) + var(--sab) + 16px)}
.scroller::-webkit-scrollbar{display:none}

/* â”€â”€ NAV BAR â”€â”€ */
.navbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px 10px;flex-shrink:0;min-height:44px;
  background:rgba(242,242,247,.92);
  backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-bottom:0.5px solid var(--sep);
  position:sticky;top:0;z-index:50;
}
.navbar-title{font-size:17px;font-weight:600;letter-spacing:-.2px}
.yr-badge{
  display:flex;align-items:center;gap:4px;
  background:var(--blue);border-radius:100px;padding:5px 13px;
  cursor:pointer;
}
.yr-badge select{
  appearance:none;background:none;border:none;outline:none;
  font:600 15px/1 var(--f);color:#fff;cursor:pointer;
  padding:0;margin:0;
}
.yr-badge select option{background:#fff;color:var(--label)}

/* â”€â”€ LARGE TITLE â”€â”€ */
.pg-title{font-size:34px;font-weight:700;letter-spacing:-.5px;padding:8px 16px 0;line-height:1.1}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none}
.page.active{display:block;animation:pgfade .18s ease}
@keyframes pgfade{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TAB BAR â”€â”€ */
.tabbar{
  position:fixed;bottom:0;left:0;right:0;
  height:calc(var(--tab) + var(--sab));
  padding-bottom:var(--sab);
  background:rgba(249,249,249,.94);
  backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-top:0.5px solid var(--sep);
  display:flex;z-index:100;
}
.tab{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding-top:5px;cursor:pointer;border:none;background:none;
  font:500 10px/1 var(--f);color:var(--label3);letter-spacing:.1px;
  transition:color .15s;
}
.tab.on{color:var(--blue)}
.tab svg{width:25px;height:25px;margin-bottom:1px}

/* â”€â”€ KPI ROW â”€â”€ */
.kpi-row{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:12px 16px 0;scrollbar-width:none}
.kpi-row::-webkit-scrollbar{display:none}
.kpi{
  min-width:148px;flex-shrink:0;background:var(--card);border-radius:var(--r2);
  padding:14px 15px;box-shadow:var(--s1);
}
.kpi-label{font-size:11px;font-weight:500;color:var(--label2);margin-bottom:5px;letter-spacing:.1px}
.kpi-value{font:600 22px/1 var(--f-mono)}
.kpi-sub{font-size:11px;color:var(--label3);margin-top:4px;line-height:1.3}
.kpi.blue  .kpi-value{color:var(--blue)}
.kpi.green .kpi-value{color:var(--green)}
.kpi.red   .kpi-value{color:var(--red)}
.kpi.ora   .kpi-value{color:var(--orange)}

/* â”€â”€ SECTION HEADER â”€â”€ */
.s-hdr{display:flex;align-items:baseline;justify-content:space-between;padding:20px 16px 8px}
.s-title{font-size:20px;font-weight:700;letter-spacing:-.3px}
.s-link{font-size:15px;color:var(--blue);cursor:pointer;font-weight:400}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border-radius:var(--r2);margin:0 16px;box-shadow:var(--s1);overflow:hidden}
.card+.card{margin-top:10px}

/* â”€â”€ INSET LIST (iOS grouped) â”€â”€ */
.list-row{
  display:flex;align-items:center;gap:12px;
  padding:11px 16px;border-bottom:0.5px solid var(--sep-light);
  min-height:44px;cursor:pointer;
}
.list-row:last-child{border-bottom:none}
.list-row:active{background:rgba(0,0,0,.04)}
.list-icon{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.list-label{font-size:16px;flex:1}
.list-value{font-size:15px;color:var(--label2)}
.list-chevron{color:var(--label3);flex-shrink:0}
.list-chevron svg{width:12px;height:12px}

/* â”€â”€ TX ROW â”€â”€ */
.tx-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.tx-main{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-sub{font-size:12px;color:var(--label2);margin-top:2px}
.tx-amount{font:600 15px/1 var(--f-mono)}
.tx-amount.out{color:var(--red)}
.tx-amount.in{color:var(--green)}
.tx-late{font-size:10px;color:var(--red);font-weight:600;margin-top:2px}

/* â”€â”€ CHART CARD â”€â”€ */
.chart-title{font-size:13px;font-weight:600;color:var(--label2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px}
.donut-pair{display:flex;gap:10px}
.donut-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:7px}
.donut-name{font-size:11px;font-weight:600;color:var(--label2)}
.legend{width:100%;display:flex;flex-direction:column;gap:4px}
.leg-item{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--label2)}
.leg-swatch{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.leg-pct{font:500 10px/1 var(--f-mono);margin-left:auto;color:var(--label)}

/* â”€â”€ FORM â”€â”€ */
.form-section{margin:20px 16px 0}
.form-label{font-size:13px;font-weight:500;color:var(--label2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;padding:0 4px}
.form-card{background:var(--card);border-radius:var(--r2);overflow:hidden;box-shadow:var(--s1)}
.field{display:flex;align-items:center;gap:10px;padding:0 16px;border-bottom:0.5px solid var(--sep-light);min-height:44px}
.field:last-child{border-bottom:none}
.field-label{font-size:16px;min-width:96px;flex-shrink:0;color:var(--label)}
.field input,.field select,.field textarea{
  flex:1;border:none;background:none;font:400 16px/1 var(--f);color:var(--label);
  outline:none;padding:12px 0;-webkit-appearance:none;text-align:right;
}
.field input::placeholder{color:var(--label3)}
.field select option{text-align:left;background:#fff}
.field textarea{text-align:left;resize:none;line-height:1.4;padding:11px 0}
.field.tall{align-items:flex-start;flex-direction:column;padding:11px 16px}
.field.tall .field-label{font-size:13px;color:var(--label2);margin-bottom:5px}
.field.tall textarea{padding:0;width:100%}

/* Toggle field */
.tog-field{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;border-bottom:0.5px solid var(--sep-light);min-height:44px;cursor:pointer}
.tog-field:last-child{border-bottom:none}
.tog-label{font-size:16px;color:var(--label)}
.toggle{width:51px;height:31px;background:rgba(120,120,128,.3);border-radius:16px;position:relative;flex-shrink:0;transition:background .22s}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;left:2px;top:2px;width:27px;height:27px;border-radius:50%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.22);transition:transform .24s cubic-bezier(.34,1.12,.64,1)}
.toggle.on::after{transform:translateX(20px)}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:14px;border-radius:var(--r2);
  font:600 16px/1 var(--f);border:none;cursor:pointer;transition:opacity .15s;
}
.btn:active{opacity:.75}
.btn.primary{background:var(--blue);color:#fff}
.btn.destructive{background:var(--red-bg);color:var(--red)}
.btn.secondary{background:var(--fill);color:var(--label)}
.btn.green-btn{background:var(--green);color:#fff}
.btns{display:flex;flex-direction:column;gap:10px;padding:16px 16px 4px}

/* â”€â”€ INLINE ACTION BUTTON â”€â”€ */
.pill-btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 16px;border-radius:100px;
  font:600 14px/1 var(--f);border:none;cursor:pointer;transition:opacity .15s;
}
.pill-btn:active{opacity:.75}
.pill-btn:disabled{opacity:.4;cursor:default}
.pill-btn.blue{background:var(--blue);color:#fff}
.pill-btn.gray{background:var(--fill);color:var(--label2)}
.pill-btn.green{background:var(--green);color:#fff}

/* â”€â”€ AI SECTION â”€â”€ */
.ai-drop{
  border:1.5px dashed var(--sep);border-radius:var(--r2);background:var(--fill2);
  padding:22px 16px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px;
}
.ai-drop.hover{border-color:var(--blue);background:var(--blue-bg)}
.ai-drop.filled{border-style:solid;border-color:var(--green)}

.api-key-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.api-key-input{
  flex:1;background:var(--fill2);border:1px solid var(--sep);border-radius:var(--r);
  padding:10px 12px;font:400 14px/1 var(--f-mono);color:var(--label);outline:none;-webkit-appearance:none;
}
.api-key-input:focus{border-color:var(--blue)}

.ai-result{
  display:none;background:var(--green-bg);border:1px solid rgba(52,199,89,.3);
  border-radius:var(--r);padding:12px 14px;margin-top:10px;
}

/* â”€â”€ REPORTS â”€â”€ */
.rpt-year-card{background:var(--card);border-radius:var(--r2);margin:0 16px 12px;overflow:hidden;box-shadow:var(--s1)}
.rpt-year-hdr{
  background:var(--blue);color:#fff;
  padding:13px 16px;display:flex;justify-content:space-between;align-items:center;
}
.rpt-year-hdr h3{font-size:17px;font-weight:700}
.rpt-year-hdr span{font:500 13px/1 var(--f-mono);opacity:.85}
.rpt-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.rpt-tbl,.rtbl{width:100%;border-collapse:collapse;white-space:nowrap}
.rpt-tbl th,.rtbl th{padding:8px 12px;text-align:right;font-size:10px;font-weight:600;color:var(--label2);text-transform:uppercase;letter-spacing:.3px;background:rgba(0,0,0,.02);border-bottom:0.5px solid var(--sep-light)}
.rpt-tbl th:first-child,.rtbl th:first-child{text-align:left;padding-left:14px}
.rpt-tbl td,.rtbl td{padding:9px 12px;text-align:right;border-bottom:0.5px solid var(--sep-light);font:400 12px/1 var(--f-mono);color:var(--label2)}
.rpt-tbl td:first-child,.rtbl td:first-child{text-align:left;font:500 13px/1 var(--f);color:var(--label);padding-left:14px}
.rpt-tbl tr:last-child td,.rtbl tr:last-child td{border-bottom:none}
.rpt-tbl tr.total-row td,.rtbl tr.total-row td{background:rgba(0,122,255,.06);font-weight:700;color:var(--label);border-top:0.5px solid rgba(0,122,255,.2)}
/* Report utility classes */
.r{text-align:right!important}
.neg{color:var(--red)!important}
.recv{color:var(--green)!important}
.pct-ok{color:var(--green)!important;font-weight:700}
.late-sym{color:var(--red)}
/* AI highlight flash */
@keyframes aiFlash{0%{background:rgba(52,199,89,.18)}100%{background:transparent}}
.ai-hi{animation:aiFlash 3s ease forwards}
/* Category list */
.list-row{display:flex;align-items:center;gap:12px;padding:11px 16px;border-bottom:0.5px solid var(--sep-light);cursor:pointer}
.list-row:last-child{border-bottom:none}
.list-row:active{background:rgba(0,0,0,.04)}
.list-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.list-body{flex:1;min-width:0}
.list-name{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-neg{color:var(--red)!important}
.c-pos{color:var(--green)!important}
.c-pct-r{color:var(--red)!important;font-weight:700}
.c-pct-o{color:var(--orange)!important;font-weight:700}
.c-pct-g{color:var(--green)!important;font-weight:700}
.c-late{color:var(--red)}

.grand-total{
  background:var(--blue);border-radius:var(--r2);margin:0 16px 12px;
  padding:18px 16px;display:grid;grid-template-columns:1fr 1fr;gap:14px;box-shadow:var(--s1);
}
.gt-item{text-align:center}
.gt-label{font-size:10px;font-weight:500;color:rgba(255,255,255,.65);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.gt-value{font:600 16px/1 var(--f-mono);color:#fff}
.gt-value.warn{color:#FFD60A}
.gt-value.danger{color:#FF8080}

/* â”€â”€ BOTTOM SHEET â”€â”€ */
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:400;display:none;align-items:flex-end}
.sheet-bg.open{display:flex;animation:bgfade .2s ease}
@keyframes bgfade{from{opacity:0}to{opacity:1}}
.sheet{
  background:var(--card);border-radius:14px 14px 0 0;
  width:100%;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding:0 0 calc(var(--sab) + 8px);
  animation:sheetup .3s cubic-bezier(.34,1.12,.64,1);
}
@keyframes sheetup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-grip{width:36px;height:4px;background:var(--sep);border-radius:2px;margin:8px auto 0}
.sheet-hdr{padding:14px 20px 12px;border-bottom:0.5px solid var(--sep-light);display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-size:17px;font-weight:600}
.sheet-close{font-size:16px;color:var(--blue);background:none;border:none;font-family:var(--f);cursor:pointer;padding:0}

/* â”€â”€ SPINNER / TOAST â”€â”€ */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:18px;height:18px;border:2.5px solid var(--label4);border-top-color:var(--blue);border-radius:50%;animation:spin .55s linear infinite;display:inline-block;vertical-align:middle}

.toast{
  position:fixed;bottom:calc(var(--tab) + var(--sab) + 12px);left:50%;transform:translateX(-50%);
  background:rgba(50,50,50,.93);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-radius:100px;padding:11px 20px;font:500 14px/1 var(--f);color:#fff;
  white-space:nowrap;z-index:999;opacity:0;transition:opacity .22s;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.2);
}
.toast.show{opacity:1}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 24px;gap:8px}
.empty-icon{font-size:44px;margin-bottom:2px}
.empty-text{font-size:15px;color:var(--label2);text-align:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT / PDF STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  /* Force light background, remove UI chrome */
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  html, body {
    height: auto !important; overflow: visible !important; background: #fff !important;
    padding: 0 !important; font-size: 11pt;
  }
  #app { display: block !important; height: auto !important; overflow: visible !important; }
  .scroller { overflow: visible !important; height: auto !important; padding: 0 !important; }

  /* Hide everything except the report content */
  .navbar, .tabbar, .sheet-bg, #rpt-actions-bar,
  .page:not(#page-rpt) { display: none !important; }
  #page-rpt { display: block !important; }
  .pg-title { font-size: 22pt; padding: 0 0 6pt; }

  /* Report cards â€” match JS-generated class names */
  .rpt-card { margin: 0 0 14pt; break-inside: avoid; box-shadow: none !important; border: 1px solid #ddd; border-radius: 6pt; }
  .rpt-yr-hdr { background: #1a56db !important; padding: 10pt 12pt; border-radius: 0; }
  .rpt-yr-hdr h3, .rpt-yr-hdr span { color: #fff !important; }
  .rtbl th { background: #f5f5f5 !important; font-size: 8pt; padding: 6pt 10pt; }
  .rtbl td { font-size: 9pt; padding: 7pt 10pt; }
  .rtbl tr.total-row td { background: rgba(0,100,255,.08) !important; }
  .rpt-table-wrap { overflow: visible !important; }
  .gt-row { background: #1a56db !important; margin: 0 0 14pt; break-inside: avoid; border-radius: 6pt; padding: 14pt; }
  #rpt-content { padding: 0 !important; }
  #rpt-actions { display: none !important; }

  @page { margin: 15mm 12mm; }
}
</style>
</head>
<body>
<div id="app">

  <!-- NAV BAR -->
  <div class="navbar" id="navbar">
    <div class="navbar-title" id="nav-title">InÃ­cio</div>
    <div id="nav-yr" class="yr-badge"><select id="yr-sel"></select></div>
  </div>

  <!-- SCROLL AREA -->
  <div class="scroller" id="scroller">

    <!-- â–‘â–‘ DASHBOARD â–‘â–‘ -->
    <div class="page active" id="page-dash">
      <div class="pg-title">Dashboard</div>
      <div class="kpi-row" id="kpi-row"></div>
      <div id="chart-area" style="margin-top:12px"></div>
      <div class="s-hdr"><span class="s-title">Recentes</span><span class="s-link" onclick="nav('txs')">Ver todas â†’</span></div>
      <div class="card" id="recent-card"><div class="empty-state"><span class="spinner"></span></div></div>
      <div style="height:8px"></div>
    </div>

    <!-- â–‘â–‘ TRANSACTIONS â–‘â–‘ -->
    <div class="page" id="page-txs">
      <div class="pg-title">TransaÃ§Ãµes</div>
      <div style="display:flex;gap:8px;padding:10px 16px 4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none">
        <select id="fil-type" onchange="refreshTx()" style="background:var(--card);border:1px solid var(--sep-light);border-radius:100px;padding:7px 14px;font:500 13px/1 var(--f);color:var(--label);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:var(--s1)">
          <option value="">Todos os tipos</option>
          <option value="PAID">Pago</option>
          <option value="RECEIVED">Recebido</option>
        </select>
        <select id="fil-cat" onchange="refreshTx()" style="background:var(--card);border:1px solid var(--sep-light);border-radius:100px;padding:7px 14px;font:500 13px/1 var(--f);color:var(--label);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:var(--s1)">
          <option value="">Todas categorias</option>
        </select>
      </div>
      <div id="tx-wrap" style="margin:4px 0"></div>
    </div>

    <!-- â–‘â–‘ ADD / EDIT â–‘â–‘ -->
    <div class="page" id="page-add">
      <div class="pg-title" id="add-title">Nova TransaÃ§Ã£o</div>

      <!-- AI: API KEY + FILE -->
      <div class="form-section">
        <div class="form-label">âœ¦ Preencher com IA</div>
        <div class="form-card" style="padding:14px 16px">

          <div style="margin-bottom:12px">
            <div style="font-size:13px;font-weight:500;color:var(--label2);margin-bottom:6px">Chave Anthropic API</div>
            <div class="api-key-row">
              <input class="api-key-input" id="api-key" type="password" autocomplete="off" spellcheck="false" placeholder="sk-ant-api03-â€¦">
              <button class="pill-btn gray" onclick="toggleKeyVis()" style="padding:10px 14px;font-size:13px">ğŸ‘</button>
            </div>
            <p style="font-size:11px;color:var(--label3);line-height:1.5;margin-top:4px">
              Obtenha em <strong>console.anthropic.com</strong> â†’ API Keys.<br>
              A chave Ã© salva no iPhone e nunca compartilhada.
            </p>
          </div>

          <div id="ai-drop" class="ai-drop" onclick="document.getElementById('ai-file').click()">
            <input type="file" id="ai-file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onAiFile(event)">
            <div id="ai-idle">
              <div style="font-size:30px;margin-bottom:6px">ğŸ“„</div>
              <div style="font-size:14px;font-weight:500;color:var(--label2)">Toque para escolher arquivo</div>
              <div style="font-size:12px;color:var(--label3);margin-top:3px">Boleto Â· Comprovante Â· PDF Â· Imagem</div>
            </div>
            <div id="ai-file-info" style="display:none;align-items:center;gap:12px">
              <span id="ai-file-ic" style="font-size:28px"></span>
              <div style="flex:1;text-align:left;min-width:0">
                <div id="ai-file-nm" style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
                <div id="ai-file-sz" style="font-size:12px;color:var(--label3);margin-top:2px"></div>
              </div>
              <button onclick="clearAiFile(event)" style="background:var(--fill);border:none;border-radius:100px;padding:6px 12px;font:500 13px/1 var(--f);color:var(--label2);cursor:pointer;flex-shrink:0">Remover</button>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <button id="ai-run-btn" class="pill-btn blue" disabled onclick="runAI()">
              <span id="ai-run-ic">âœ¦</span>&nbsp;<span id="ai-run-txt">Interpretar com IA</span>
            </button>
            <span id="ai-status" style="font-size:12px;color:var(--label3)"></span>
          </div>

          <div class="ai-result" id="ai-result">
            <div style="display:flex;gap:10px">
              <span style="font-size:20px">âœ…</span>
              <div>
                <div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:3px">Campos preenchidos</div>
                <div id="ai-summary" style="font-size:12px;color:var(--label2);line-height:1.5"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FORM FIELDS -->
      <div class="form-section" style="margin-top:20px">
        <div class="form-label">Dados</div>
        <div class="form-card" id="form-fields">
          <input type="hidden" id="f-id">
          <div class="field">
            <span class="field-label">Valor (R$)</span>
            <input id="f-val" type="number" inputmode="decimal" step="0.01" placeholder="0,00">
          </div>
          <div class="field">
            <span class="field-label">Tipo</span>
            <select id="f-type">
              <option value="PAID">SaÃ­da (pago)</option>
              <option value="RECEIVED">Entrada (recebido)</option>
            </select>
          </div>
          <div class="field">
            <span class="field-label">Categoria</span>
            <select id="f-cat"></select>
          </div>
          <div class="field">
            <span class="field-label">Parte</span>
            <select id="f-party">
              <option value="Me">Eu</option>
              <option value="Father">Pai</option>
              <option value="School">Escola</option>
              <option value="Store">Loja</option>
              <option value="Other">Outro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-label">ReferÃªncia</div>
        <div class="form-card">
          <div class="field">
            <span class="field-label">Data</span>
            <input id="f-date" type="date">
          </div>
          <div class="field">
            <span class="field-label">Ano Letivo</span>
            <select id="f-year"></select>
          </div>
          <div class="field">
            <span class="field-label">MÃªs</span>
            <select id="f-month">
              <option value="1">Janeiro</option><option value="2">Fevereiro</option>
              <option value="3">MarÃ§o</option><option value="4">Abril</option>
              <option value="5">Maio</option><option value="6">Junho</option>
              <option value="7">Julho</option><option value="8">Agosto</option>
              <option value="9">Setembro</option><option value="10">Outubro</option>
              <option value="11">Novembro</option><option value="12">Dezembro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-label">Detalhes</div>
        <div class="form-card">
          <div class="tog-field" onclick="document.getElementById('tog').classList.toggle('on')">
            <span class="tog-label">Recebido apÃ³s dia 5 &nbsp;â– </span>
            <div class="toggle" id="tog"></div>
          </div>
          <div class="field tall">
            <span class="field-label">Notas</span>
            <textarea id="f-notes" rows="2" placeholder="ObservaÃ§Ãµesâ€¦"></textarea>
          </div>
          <div class="field">
            <span class="field-label">Tags</span>
            <input id="f-tags" type="text" placeholder="opcional">
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" onclick="saveTx()">ğŸ’¾&nbsp; Salvar TransaÃ§Ã£o</button>
        <button id="del-btn" class="btn destructive" style="display:none" onclick="deleteTx()">ğŸ—‘&nbsp; Excluir TransaÃ§Ã£o</button>
      </div>
      <div style="height:8px"></div>
    </div>

    <!-- â–‘â–‘ REPORTS â–‘â–‘ -->
    <div class="page" id="page-rpt">
      <div class="pg-title">RelatÃ³rio</div>

      <!-- Action bar â€” hidden during print -->
      <div id="rpt-actions-bar" style="display:flex;gap:8px;padding:10px 16px 4px;flex-wrap:wrap">
        <button class="pill-btn blue" onclick="doPrint()">ğŸ–¨ï¸&nbsp; Imprimir / Salvar PDF</button>
        <button class="pill-btn gray" onclick="doCSV()">ğŸ“¥&nbsp; Exportar CSV</button>
      </div>

      <div id="rpt-content">
        <div class="empty-state"><span class="spinner"></span></div>
      </div>

      <div id="rpt-hint" style="padding:0 16px 16px;font-size:11px;color:var(--label3);line-height:1.6">
        <strong style="color:var(--red)">â– </strong>&nbsp;Recebido apÃ³s o dia 5 (atraso)&nbsp;Â·&nbsp;
        Para PDF: Imprimir â†’ <em>Compartilhar</em> â†’ <em>Salvar como PDF</em>
      </div>
    </div>

    <!-- â–‘â–‘ SETTINGS â–‘â–‘ -->
    <div class="page" id="page-cfg">
      <div class="pg-title">ConfiguraÃ§Ãµes</div>

      <div class="form-section">
        <div class="form-label">Backup</div>
        <div class="form-card">
          <div class="list-row" onclick="doExportJSON()">
            <div class="list-icon" style="background:var(--blue-bg)">ğŸ’¾</div>
            <div class="list-label">Exportar backup JSON</div>
            <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
          </div>
          <div class="list-row" onclick="document.getElementById('imp-file').click()">
            <div class="list-icon" style="background:var(--green-bg)">ğŸ“‚</div>
            <div class="list-label">Importar backup JSON</div>
            <input type="file" id="imp-file" accept=".json" style="display:none" onchange="doImport(event)">
            <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
          </div>
        </div>
        <div id="imp-msg" style="display:none;margin-top:8px;padding:12px 14px;border-radius:var(--r);font-size:13px;font-weight:500"></div>
      </div>

      <div class="form-section">
        <div class="form-label">Categorias</div>
        <div class="form-card" id="cat-list-wrap"></div>
        <div style="margin-top:8px">
          <button class="btn secondary" style="border-radius:var(--r2)" onclick="document.getElementById('cat-sheet').classList.add('open')">+ Nova Categoria</button>
        </div>
      </div>

      <div class="form-section">
        <div class="form-label">Dados</div>
        <div class="form-card">
          <div class="list-row">
            <div class="list-icon" style="background:var(--blue-bg)">ğŸ“Š</div>
            <div class="list-label">Total de transaÃ§Ãµes</div>
            <div class="list-value" id="stat-count">â€”</div>
          </div>
          <div class="list-row">
            <div class="list-icon" style="background:var(--orange-bg)">ğŸ“…</div>
            <div class="list-label">Anos com dados</div>
            <div class="list-value" id="stat-years">â€”</div>
          </div>
          <div class="list-row">
            <div class="list-icon" style="background:var(--green-bg)">ğŸ“±</div>
            <div class="list-label">Armazenamento</div>
            <div class="list-value">iPhone (local)</div>
          </div>
          <div class="list-row" onclick="doWipe()" style="cursor:pointer">
            <div class="list-icon" style="background:var(--red-bg)">âš ï¸</div>
            <div class="list-label" style="color:var(--red)">Apagar todos os dados</div>
            <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
          </div>
        </div>
      </div>

      <div class="form-section" style="margin-bottom:20px">
        <div class="form-label">Instalar no iPhone</div>
        <div class="form-card" style="padding:14px 16px">
          <p style="font-size:15px;color:var(--label2);line-height:2">
            1. Abra esta pÃ¡gina no <strong style="color:var(--label)">Safari</strong><br>
            2. Toque em <strong style="color:var(--label)">â¬†ï¸ Compartilhar</strong><br>
            3. Toque em <strong style="color:var(--label)">"Adicionar Ã  Tela de InÃ­cio"</strong><br>
            4. Toque em <strong style="color:var(--label)">Adicionar</strong>
          </p>
        </div>
      </div>

    </div>
  </div><!-- /scroller -->

  <!-- TAB BAR -->
  <div class="tabbar">
    <button class="tab on" id="t-dash" onclick="nav('dash')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
      InÃ­cio
    </button>
    <button class="tab" id="t-txs" onclick="nav('txs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>
      TransaÃ§Ãµes
    </button>
    <button class="tab" id="t-add" onclick="nav('add')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      Novo
    </button>
    <button class="tab" id="t-rpt" onclick="nav('rpt')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>
      RelatÃ³rio
    </button>
    <button class="tab" id="t-cfg" onclick="nav('cfg')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Config
    </button>
  </div>
</div>

<!-- TX DETAIL SHEET -->
<div class="sheet-bg" id="tx-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title" id="sh-title">TransaÃ§Ã£o</div>
      <button class="sheet-close" onclick="document.getElementById('tx-sheet').classList.remove('open')">Fechar</button>
    </div>
    <div id="sh-body"></div>
  </div>
</div>

<!-- NEW CAT SHEET -->
<div class="sheet-bg" id="cat-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title">Nova Categoria</div>
      <button class="sheet-close" onclick="document.getElementById('cat-sheet').classList.remove('open')">Cancelar</button>
    </div>
    <div style="padding:16px">
      <div class="form-card">
        <div class="field"><span class="field-label">Chave</span><input id="nc-key" placeholder="ex: excursao"></div>
        <div class="field"><span class="field-label">Nome</span><input id="nc-label" placeholder="ex: ExcursÃ£o"></div>
        <div class="field"><span class="field-label">Cor</span><input id="nc-color" type="color" value="#007AFF" style="width:44px;height:30px;border:none;background:none;cursor:pointer;-webkit-appearance:none;padding:0;margin-left:auto"></div>
      </div>
      <div style="margin-top:12px"><button class="btn primary" onclick="saveCat()">Criar Categoria</button></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IndexedDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB='school-ledger'; let db;
function openDB(){
  return new Promise((ok,fail)=>{
    const r=indexedDB.open(DB,2);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('txs')) d.createObjectStore('txs',{keyPath:'id',autoIncrement:true});
      if(!d.objectStoreNames.contains('cats')) d.createObjectStore('cats',{keyPath:'key'});
      if(!d.objectStoreNames.contains('cfg')) d.createObjectStore('cfg',{keyPath:'k'});
    };
    r.onsuccess=e=>{db=e.target.result;ok()};
    r.onerror=e=>fail(e.target.error);
  });
}
const all=s=>new Promise((ok,fail)=>{const r=db.transaction(s,'readonly').objectStore(s).getAll();r.onsuccess=()=>ok(r.result);r.onerror=()=>fail(r.error)});
const getOne=(s,k)=>new Promise((ok,fail)=>{const r=db.transaction(s,'readonly').objectStore(s).get(k);r.onsuccess=()=>ok(r.result);r.onerror=()=>fail(r.error)});
const put=(s,v)=>new Promise((ok,fail)=>{const r=db.transaction(s,'readwrite').objectStore(s).put(v);r.onsuccess=()=>ok(r.result);r.onerror=()=>fail(r.error)});
const del=(s,k)=>new Promise((ok,fail)=>{const r=db.transaction(s,'readwrite').objectStore(s).delete(k);r.onsuccess=()=>ok();r.onerror=()=>fail(r.error)});
const clr=s=>new Promise((ok,fail)=>{const r=db.transaction(s,'readwrite').objectStore(s).clear();r.onsuccess=()=>ok();r.onerror=()=>fail(r.error)});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// App State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={year:new Date().getFullYear(), tab:'dash', cats:[], editId:null};
const MO=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MF=['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CAT_ORDER=['mensalidade','matricula','material','uniforme','extra','pensao'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const brl=v=>Math.abs(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const brlK=v=>v>=1000?(v/1000).toFixed(1)+'k':Math.round(v||0).toString();
const fmtD=iso=>{if(!iso)return'â€”';const[y,m,d]=iso.split('-');return`${d}/${m}/${y}`};
function toast(msg,ms=2800){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),ms)}
function catInfo(k){return S.cats.find(c=>c.key===k)||{key:k,label:k,color:'#8E8E93'}}
function catEmoji(k){return{mensalidade:'ğŸ«',matricula:'ğŸ“',material:'ğŸ“š',uniforme:'ğŸ‘•',extra:'ğŸ­',pensao:'ğŸ’°'}[k]||'ğŸ“Œ'}
function el(id){return document.getElementById(id)}
const $ = el;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(tab){
  S.tab=tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  $('page-'+tab).classList.add('on');
  $('t-'+tab).classList.add('on');
  $('scroller').scrollTop=0;
  // Year badge visibility
  $('nav-yr').style.display=(tab==='rpt'||tab==='cfg')?'none':'flex';
  // Update nav title
  $('nav-title').textContent={dash:'School Ledger',txs:'TransaÃ§Ãµes',add:S.editId?'Editar':'Nova TransaÃ§Ã£o',rpt:'RelatÃ³rio',cfg:'ConfiguraÃ§Ãµes'}[tab]||'';
  if(tab==='dash') renderDash();
  if(tab==='txs')  renderTxList();
  if(tab==='add'&&!S.editId) resetForm();
  if(tab==='rpt')  renderReport();
  if(tab==='cfg')  renderCfg();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Year filter
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initYearFilter(){
  const rows=await all('txs');
  let years=[...new Set(rows.map(r=>r.academicYear))].filter(Boolean).sort();
  const now=new Date().getFullYear();
  if(!years.includes(now)) years.push(now);
  if(!years.includes(now+1)) years.push(now+1);
  years.sort();
  const sel=$('yr-sel');
  sel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  S.year=years.includes(now)?now:Math.max(...years);
  sel.value=S.year;
  sel.onchange=e=>{S.year=+e.target.value;if(S.tab==='dash')renderDash();if(S.tab==='txs')renderTxList();if(S.tab==='rpt')renderReport()};
  // form year select
  const fy=$('f-year');
  fy.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  fy.value=S.year;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Summary calc
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcSummary(year){
  const rows=await all('txs');
  const txs=rows.filter(r=>r.academicYear===year);
  const paid=txs.filter(r=>r.type==='PAID').reduce((a,r)=>a+r.amount,0);
  const recv=txs.filter(r=>r.type==='RECEIVED').reduce((a,r)=>a+r.amount,0);
  const late=txs.filter(r=>r.isLate).length;
  const byCat={};txs.forEach(r=>{byCat[r.categoryKey]=(byCat[r.categoryKey]||0)+r.amount});
  const byMonth=Array.from({length:12},()=>({}));
  txs.forEach(r=>{const m=r.academicMonth-1;byMonth[m][r.categoryKey]=(byMonth[m][r.categoryKey]||0)+r.amount});
  return{paid,recv,deficit:paid-recv,late,byCat,byMonth};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Dashboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDash(){
  const d=await calcSummary(S.year);
  const pct=d.paid>0?(d.recv/d.paid*100).toFixed(1):0;
  $('kpi-row').innerHTML=`
    <div class="kpi blue">
      <div class="kpi-label">Pago ${S.year}</div>
      <div class="kpi-value">R$&thinsp;${brlK(d.paid)}</div>
      <div class="kpi-sub">${brl(d.paid)}</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">PensÃ£o ${S.year}</div>
      <div class="kpi-value">R$&thinsp;${brlK(d.recv)}</div>
      <div class="kpi-sub">${pct}% coberto Â· ${d.late} atr.</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">DÃ©ficit ${S.year}</div>
      <div class="kpi-value">â€“R$&thinsp;${brlK(d.deficit)}</div>
      <div class="kpi-sub">descoberto</div>
    </div>
    <div class="kpi orange">
      <div class="kpi-label">Maior custo</div>
      <div class="kpi-value" style="font-size:16px">${(()=>{const top=Object.entries(d.byCat).filter(([k])=>k!=='pensao').sort((a,b)=>b[1]-a[1])[0];return top?catInfo(top[0]).label:'â€”'})()}</div>
      <div class="kpi-sub">${S.year}</div>
    </div>`;
  requestAnimationFrame(()=>requestAnimationFrame(()=>drawCharts(d)));
  const rows=await all('txs');
  const recent=rows.filter(r=>r.academicYear===S.year).sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).slice(0,5);
  $('recent-card').innerHTML=recent.length?recent.map(txHTML).join('')
    :`<div class="empty"><div style="font-size:38px">ğŸ“­</div><div style="margin-top:6px">Sem transaÃ§Ãµes em ${S.year}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Charts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawCharts(d){
  const bc=d.byCat||{}, gt=Object.values(bc).reduce((a,v)=>a+v,0);
  const def=d.paid-d.recv;
  const p0=d.paid>0?(def/d.paid*100).toFixed(1):0;
  const p1=d.paid>0?(d.recv/d.paid*100).toFixed(1):0;
  $('chart-area').innerHTML=`
    <div class="card" style="margin:0 16px 12px;padding:16px">
      <div class="chart-title">VisÃ£o Geral â€” ${S.year}</div>
      <div style="display:flex;gap:10px">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv1" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Financiamento</div>
          <div style="width:100%;display:flex;flex-direction:column;gap:4px">
            <div class="leg-item"><div class="leg-dot" style="background:#007AFF"></div>Eu<span class="leg-pct">${p0}%</span></div>
            <div class="leg-item"><div class="leg-dot" style="background:#FF2D55"></div>Pai<span class="leg-pct">${p1}%</span></div>
          </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv2" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Categorias</div>
          <div id="pie2-leg" style="width:100%;display:flex;flex-direction:column;gap:4px"></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin:0 16px 12px;padding:16px">
      <div class="chart-title">Despesas por MÃªs</div>
      <canvas id="cv3" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
        ${CAT_ORDER.map(k=>`<div class="leg-item"><div class="leg-dot" style="background:${catInfo(k).color}"></div><span>${catInfo(k).label}</span></div>`).join('')}
      </div>
    </div>`;
  donut('cv1',[{v:def,c:'#007AFF'},{v:d.recv,c:'#FF2D55'}],'Total',brlK(d.paid),110);
  donut('cv2',CAT_ORDER.map(k=>({v:bc[k]||0,c:catInfo(k).color})),'Total',brlK(gt),110);
  $('pie2-leg').innerHTML=CAT_ORDER.map(k=>{
    const v=bc[k]||0; if(!v)return'';
    const p=gt>0?(v/gt*100).toFixed(0):0;
    return`<div class="leg-item"><div class="leg-dot" style="background:${catInfo(k).color}"></div>${catInfo(k).label}<span class="leg-pct">${p}%</span></div>`;
  }).join('');
  bar('cv3',d);
}

function donut(id,slices,lbl,val,SZ){
  const c=$(id); if(!c)return;
  const dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=SZ*dpr; c.height=SZ*dpr; c.style.width=SZ+'px'; c.style.height=SZ+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const cx=SZ/2, cy=SZ/2, R=SZ/2-7, r=SZ/2-23;
  const tot=slices.reduce((a,s)=>a+(s.v||0),0); if(!tot)return;
  let a=-Math.PI/2;
  slices.forEach(s=>{if(!s.v)return;const sw=s.v/tot*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a,a+sw);ctx.closePath();ctx.fillStyle=s.c;ctx.fill();a+=sw});
  a=-Math.PI/2;
  slices.forEach(s=>{if(!s.v)return;const sw=s.v/tot*Math.PI*2;ctx.beginPath();ctx.arc(cx,cy,R,a,a+sw,false);ctx.strokeStyle='rgba(242,242,247,1)';ctx.lineWidth=2.5;ctx.stroke();a+=sw});
  ctx.beginPath();ctx.arc(cx,cy,r,0,2*Math.PI);ctx.fillStyle='#fff';ctx.fill();
  ctx.textAlign='center';
  ctx.fillStyle='rgba(60,60,67,.5)';ctx.font=`500 8px -apple-system,sans-serif`;ctx.fillText(lbl,cx,cy-5);
  ctx.fillStyle='#000';ctx.font=`600 11px 'SF Mono','Menlo',monospace`;ctx.fillText(val,cx,cy+7);
}

function bar(id,d){
  const c=$(id); if(!c)return;
  const par=c.parentElement;
  const W=Math.max((par?par.getBoundingClientRect().width||par.offsetWidth:320)-32,200);
  const H=100, dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const data=(d.byMonth||[]).map(m=>CAT_ORDER.map(k=>m[k]||0));
  const cols=CAT_ORDER.map(k=>catInfo(k).color);
  const pL=30,pB=16,pT=6,pR=2,cW=W-pL-pR,cH=H-pT-pB;
  const maxV=Math.max(...data.map(r=>r.reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/2000)*2000||2000;
  for(let i=0;i<=3;i++){
    const y=pT+cH*(1-i/3);
    ctx.strokeStyle='rgba(0,0,0,.06)';ctx.lineWidth=.6;ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(pL+cW,y);ctx.stroke();
    ctx.fillStyle='rgba(60,60,67,.4)';ctx.textAlign='right';ctx.font=`7.5px 'SF Mono','Menlo',monospace`;ctx.fillText(brlK(scale/3*i),pL-3,y+3);
  }
  const mW=cW/12, bW=mW*.72, bOff=(mW-bW)/2;
  data.forEach((cats,mi)=>{
    const gx=pL+mi*mW+bOff; let yBase=pT+cH;
    cats.forEach((v,ci)=>{if(!v)return; const bH=Math.max(1,(v/scale)*cH);yBase-=bH;ctx.fillStyle=cols[ci];ctx.fillRect(gx,yBase,bW,bH)});
    ctx.fillStyle='rgba(60,60,67,.4)';ctx.textAlign='center';ctx.font=`7px -apple-system,sans-serif`;ctx.fillText(MO[mi],pL+mi*mW+mW/2,H-2);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Transactions list
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function txHTML(r){
  const ci=catInfo(r.categoryKey);
  const out=r.type==='PAID';
  return`<div class="list-row" onclick="openTxSheet(${r.id})">
    <div class="list-icon" style="background:${ci.color}1A">${catEmoji(r.categoryKey)}</div>
    <div class="list-body">
      <div class="list-name">${ci.label}</div>
      <div class="tx-sub">${fmtD(r.date)} Â· ${MO[r.academicMonth-1]}/${r.academicYear} Â· ${r.party==='Father'?'Pai':'Eu'}</div>
      ${r.notes?`<div class="tx-sub" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">${r.notes}</div>`:''}
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div class="tx-amount ${out?'out':'in'}">${out?'â€“':'+'}${brlK(r.amount)}</div>
      ${r.isLate?`<div class="tx-late">â–  atraso</div>`:''}
    </div>
  </div>`;
}

async function renderTxList(){
  const type=$('fil-type').value, cat=$('fil-cat').value;
  let rows=(await all('txs')).filter(r=>r.academicYear===S.year);
  if(type) rows=rows.filter(r=>r.type===type);
  if(cat)  rows=rows.filter(r=>r.categoryKey===cat);
  rows.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const w=$('tx-wrap');
  if(!rows.length){w.innerHTML=`<div class="empty"><div style="font-size:38px">ğŸ“­</div><div style="margin-top:6px">Nenhuma transaÃ§Ã£o</div></div>`;return}
  w.innerHTML=`<div class="card" style="margin:0 16px 16px;overflow:hidden">${rows.map(txHTML).join('')}</div>`;
}

async function openTxSheet(id){
  const rows=await all('txs'); const r=rows.find(r=>r.id===id); if(!r)return;
  const ci=catInfo(r.categoryKey); const out=r.type==='PAID';
  $('sh-title').textContent=ci.label;
  const shRow=(l,v)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-bottom:0.5px solid var(--sep-light)"><span style="font-size:15px;color:var(--label2)">${l}</span><span style="font-size:15px;font-weight:500">${v}</span></div>`;
  $('sh-body').innerHTML=`
    <div style="text-align:center;padding:20px 0 14px">
      <div style="font-size:44px;margin-bottom:8px">${catEmoji(r.categoryKey)}</div>
      <div style="font:600 30px/1 var(--f-mono);color:${out?'var(--red)':'var(--green)'}">${out?'â€“':'+'}R$&nbsp;${brl(r.amount)}</div>
      <div style="font-size:13px;color:var(--label2);margin-top:6px">${ci.label}</div>
    </div>
    <div style="margin:0 16px;background:var(--fill2);border-radius:12px;overflow:hidden">
      ${shRow('Data',fmtD(r.date))}
      ${shRow('PerÃ­odo',MF[r.academicMonth-1]+' / '+r.academicYear)}
      ${shRow('Tipo',out?'Pago (saÃ­da)':'Recebido')}
      ${shRow('Parte',r.party==='Father'?'Pai':'Eu')}
      ${shRow('Atraso',r.isLate?'â–  Sim':'âœ“ No prazo')}
      ${r.notes?shRow('Notas',r.notes):''}
      ${r.tags?shRow('Tags',r.tags):''}
    </div>
    <div style="padding:16px 16px 0;display:flex;flex-direction:column;gap:10px">
      <button class="btn primary" onclick="editTx(${r.id});$('tx-sheet').classList.remove('open')">âœï¸  Editar</button>
      <button class="btn danger" onclick="if(confirm('Excluir?'))delTxById(${r.id})">ğŸ—‘  Excluir</button>
    </div>`;
  $('tx-sheet').classList.add('open');
}

async function delTxById(id){
  await del('txs',id);
  $('tx-sheet').classList.remove('open');
  toast('ğŸ—‘ ExcluÃ­do');
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Add / Edit form
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetForm(){
  S.editId=null;
  $('f-id').value=''; $('f-val').value=''; $('f-notes').value=''; $('f-tags').value='';
  $('f-type').value='PAID'; $('f-party').value='Me';
  $('f-date').value=new Date().toISOString().split('T')[0];
  $('f-year').value=S.year; $('f-month').value=new Date().getMonth()+1;
  if(S.cats.length) $('f-cat').value=S.cats[0].key;
  $('tog').classList.remove('on');
  $('del-btn').style.display='none';
  $('add-title').textContent='Nova TransaÃ§Ã£o';
  resetAI();
}

function editTx(id){
  S.editId=id; nav('add');
  all('txs').then(rows=>{
    const r=rows.find(r=>r.id===id); if(!r)return;
    $('f-id').value=r.id; $('f-val').value=r.amount; $('f-type').value=r.type;
    $('f-cat').value=r.categoryKey; $('f-party').value=r.party;
    $('f-date').value=r.date; $('f-year').value=r.academicYear;
    $('f-month').value=r.academicMonth; $('f-notes').value=r.notes||'';
    $('f-tags').value=r.tags||'';
    if(r.isLate) $('tog').classList.add('on');
    $('del-btn').style.display='flex';
    $('add-title').textContent='Editar TransaÃ§Ã£o';
  });
}

async function saveTx(){
  const amount=parseFloat($('f-val').value);
  if(!amount||isNaN(amount)){toast('âš ï¸ Informe o valor');return}
  const date=$('f-date').value; if(!date){toast('âš ï¸ Informe a data');return}
  const tx={amount,type:$('f-type').value,categoryKey:$('f-cat').value,party:$('f-party').value,
    date,academicYear:+$('f-year').value,academicMonth:+$('f-month').value,
    isLate:$('tog').classList.contains('on'),notes:$('f-notes').value,tags:$('f-tags').value,
    updatedAt:new Date().toISOString()};
  if(S.editId) tx.id=S.editId; else tx.createdAt=new Date().toISOString();
  await put('txs',tx);
  toast(S.editId?'âœ… Atualizado!':'âœ… Salvo!');
  S.editId=null; await initYearFilter(); nav('txs');
}

async function deleteTx(){
  if(!S.editId) return;
  if(!confirm('Excluir esta transaÃ§Ã£o?')) return;
  await del('txs',S.editId); toast('ğŸ—‘ ExcluÃ­do');
  S.editId=null; await initYearFilter(); nav('txs');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Reports
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderReport(){
  const rows=await all('txs');
  const years=[...new Set(rows.map(r=>r.academicYear))].filter(Boolean).sort();
  if(!years.length){$('rpt-content').innerHTML=`<div class="empty"><div style="font-size:38px">ğŸ“‹</div><div style="margin-top:6px">Sem dados</div></div>`;return}
  let html='', gP=0, gR=0;
  for(const yr of years){
    const txs=rows.filter(r=>r.academicYear===yr);
    const byMonth={}, pensaoByMonth={}, lateByMonth={};
    txs.filter(r=>r.type==='PAID').forEach(r=>{
      const m=r.academicMonth;
      if(!byMonth[m]) byMonth[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};
      if(byMonth[m][r.categoryKey]!==undefined) byMonth[m][r.categoryKey]+=r.amount;
    });
    txs.filter(r=>r.categoryKey==='pensao').forEach(r=>{pensaoByMonth[r.academicMonth]=(pensaoByMonth[r.academicMonth]||0)+r.amount});
    txs.filter(r=>r.isLate&&r.categoryKey==='pensao').forEach(r=>{lateByMonth[r.academicMonth]=true});
    let rows_html='', tot={mensalidade:0,matricula:0,material:0,extra:0,sub:0,recv:0,diff:0};
    for(let m=1;m<=12;m++){
      const cats=byMonth[m]||{}, recv=pensaoByMonth[m]||0, late=lateByMonth[m];
      const sub=(cats.mensalidade||0)+(cats.matricula||0)+(cats.material||0)+(cats.uniforme||0)+(cats.extra||0);
      const diff=sub-recv, pct=sub>0?(recv/sub*100):0;
      if(sub===0&&recv===0) continue;
      const pc=pct===0?'':pct<50?'neg':'pct-ok';
      tot.mensalidade+=(cats.mensalidade||0); tot.matricula+=(cats.matricula||0);
      tot.material+=(cats.material||0); tot.extra+=(cats.extra||0);
      tot.sub+=sub; tot.recv+=recv; tot.diff+=diff;
      rows_html+=`<tr>
        <td>${MF[m-1]}</td>
        <td class="r">${brl(cats.mensalidade||0)}</td>
        <td class="r">${cats.matricula?brl(cats.matricula):'â€”'}</td>
        <td class="r">${cats.material?brl(cats.material):'â€”'}</td>
        <td class="r">${cats.extra?brl(cats.extra):'â€”'}</td>
        <td class="r recv">${recv?brl(recv):'â€”'}</td>
        <td class="r ${diff>0?'neg':'recv'}">${diff>0?'â€“':'+'}${brl(Math.abs(diff))||'â€”'}</td>
        <td class="r ${pc}">${sub>0?pct.toFixed(1)+'%':'â€”'}${late?` <span class="late-sym">â– </span>`:''}</td>
      </tr>`;
    }
    gP+=tot.sub; gR+=tot.recv;
    const tPct=tot.sub>0?(tot.recv/tot.sub*100).toFixed(1)+'%':'â€”';
    html+=`<div class="rpt-card">
      <div class="rpt-yr-hdr"><h3>${yr}</h3><span>R$&nbsp;${brl(tot.sub)}</span></div>
      <div class="rpt-table-wrap"><table class="rtbl">
        <thead><tr><th>MÃªs</th><th>Mensalidade</th><th>MatrÃ­cula</th><th>Material</th><th>Extra</th><th>PensÃ£o</th><th>DiferenÃ§a</th><th>% Pai</th></tr></thead>
        <tbody>${rows_html}
          <tr class="total-row">
            <td>TOTAL ${yr}</td>
            <td class="r">${brl(tot.mensalidade)}</td>
            <td class="r">${tot.matricula?brl(tot.matricula):'â€”'}</td>
            <td class="r">${tot.material?brl(tot.material):'â€”'}</td>
            <td class="r">${tot.extra?brl(tot.extra):'â€”'}</td>
            <td class="r recv">${brl(tot.recv)}</td>
            <td class="r neg">â€“${brl(tot.diff)}</td>
            <td class="r ${tot.recv/tot.sub<.5?'neg':tot.recv/tot.sub<.7?'':'pct-ok'}">${tPct}</td>
          </tr>
        </tbody>
      </table></div>
    </div>`;
  }
  const gD=gP-gR, gPct=gP>0?(gR/gP*100).toFixed(1):0;
  $('rpt-content').innerHTML=`
    <div class="gt-row">
      <div class="gt-cell"><div class="gt-label">Total Pago</div><div class="gt-value">${brl(gP)}</div></div>
      <div class="gt-cell"><div class="gt-label">PensÃ£o</div><div class="gt-value warn">${brl(gR)}</div></div>
      <div class="gt-cell"><div class="gt-label">DÃ©ficit</div><div class="gt-value danger">â€“${brl(gD)}</div></div>
      <div class="gt-cell"><div class="gt-label">Cobertura Pai</div><div class="gt-value warn">${gPct}%</div></div>
    </div>${html}`;
}

function printReport(){
  if(!$('rpt-content').querySelector('.rpt-card')){
    renderReport().then(()=>setTimeout(()=>window.print(),400));
  } else { window.print(); }
}

async function exportCSV(){
  const rows=await all('txs');
  const txs=rows.filter(r=>r.academicYear===S.year).sort((a,b)=>b.date.localeCompare(a.date));
  const hdr='Data,Ano,Mes,Tipo,Categoria,Parte,Valor,Atraso,Notas,Tags';
  const lines=txs.map(r=>[r.date,r.academicYear,r.academicMonth,r.type,r.categoryKey,r.party,r.amount,r.isLate?'Sim':'Nao',`"${(r.notes||'').replace(/"/g,'""')}"`,r.tags||''].join(','));
  const blob=new Blob(['\uFEFF'+[hdr,...lines].join('\r\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`ledger-${S.year}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ“¥ CSV exportado!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderCfg(){
  const cats=await all('cats'), rows=await all('txs');
  S.cats=cats;
  const years=[...new Set(rows.map(r=>r.academicYear))].sort();
  $('cat-list-wrap').innerHTML=cats.length?cats.map(c=>`
    <div class="list-row">
      <div class="list-icon" style="background:${c.color}1A">
        <div style="width:14px;height:14px;border-radius:4px;background:${c.color}"></div>
      </div>
      <div class="list-body">
        <div class="list-name">${c.label}</div>
        <div class="tx-sub" style="font-family:var(--f-mono)">${c.key}</div>
      </div>
      ${!c.system?`<button onclick="delCat('${c.key}')" style="border:none;background:none;color:var(--red);font-size:16px;padding:6px 8px;cursor:pointer">ğŸ—‘</button>`:'<span style="font-size:11px;color:var(--label3);background:var(--fill2);border-radius:8px;padding:3px 8px">Sistema</span>'}
    </div>`).join('')
    :`<div style="padding:14px 16px;font-size:14px;color:var(--label3)">Nenhuma categoria</div>`;
  $('stat-count').textContent=rows.length+' transaÃ§Ãµes';
  $('stat-years').textContent=years.length?years.join(', '):'â€”';
  populateCatSelects();
}

function populateCatSelects(){
  ['f-cat','fil-cat'].forEach(id=>{
    const s=$(id); if(!s)return;
    const cur=s.value;
    s.innerHTML=id==='fil-cat'?'<option value="">Todas categorias</option>':'';
    S.cats.forEach(c=>{const o=document.createElement('option');o.value=c.key;o.textContent=c.label;s.appendChild(o)});
    if(cur) s.value=cur;
  });
}

async function loadCats(){S.cats=await all('cats');populateCatSelects()}

async function saveCat(){
  const key=$('nc-key').value.trim().toLowerCase().replace(/\s+/g,'_');
  const label=$('nc-label').value.trim();
  const color=$('nc-color').value;
  if(!key||!label){toast('âš ï¸ Preencha chave e nome');return}
  await put('cats',{key,label,color,system:false});
  toast('âœ… Categoria criada!');
  $('cat-sheet').classList.remove('open');
  $('nc-key').value=''; $('nc-label').value='';
  await loadCats(); renderCfg();
}

async function delCat(key){
  if(!confirm(`Excluir categoria "${key}"?`)) return;
  await del('cats',key);
  await loadCats(); renderCfg();
}

async function clearAll(){await clr('txs');await initYearFilter();renderCfg();toast('ğŸ—‘ Dados removidos')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JSON Export / Import
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportJSON(){
  const txs=await all('txs'), cats=await all('cats');
  const payload={meta:{version:'3.0',school:'ColÃ©gio Objectivo',exportedAt:new Date().toISOString()},categories:cats,transactions:txs};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob), a=document.createElement('a');
  a.href=url; a.download=`school-ledger-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ’¾ Backup exportado!');
}

async function importJSON(file){
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const p=JSON.parse(e.target.result);
      if(!Array.isArray(p.transactions)) throw new Error('"transactions" deve ser um array');
      if(!confirm(`Importar ${p.transactions.length} transaÃ§Ãµes?\nOs dados atuais serÃ£o substituÃ­dos.`)) return;
      await clr('txs');
      for(const tx of p.transactions) await put('txs',tx);
      if(Array.isArray(p.categories)) for(const c of p.categories) await put('cats',c);
      const n=p.transactions.length;
      $('imp-msg').textContent=`âœ… ${n} transaÃ§Ãµes importadas!`;
      $('imp-msg').style.display='block';
      await loadCats(); await initYearFilter();
      toast('âœ… '+n+' transaÃ§Ãµes importadas!',3500);
      renderCfg();
    }catch(err){
      $('imp-msg').textContent='âŒ Erro: '+err.message;
      $('imp-msg').style.display='block';
    }
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI â€” Safari compatible
// Anthropic supports direct browser access via
// 'anthropic-dangerous-direct-browser-access' header
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _aiFile=null, _aiB64=null, _aiMime=null;

function resetAI(){
  _aiFile=null; _aiB64=null; _aiMime=null;
  $('ai-file').value='';
  $('ai-idle').style.display='block';
  $('ai-file-info').style.display='none';
  const btn=$('ai-run-btn'); btn.disabled=true; btn.style.cssText='';
  $('ai-run-ic').textContent='âœ¦'; $('ai-run-txt').textContent='Interpretar com IA';
  $('ai-status').textContent='';
  $('ai-result').style.display='none';
  document.querySelectorAll('.ai-hi').forEach(e=>e.classList.remove('ai-hi'));
}

function onAiFileSelect(e){const f=e.target.files[0];if(f)loadAiFile(f)}
function onAiDrop(e){e.preventDefault();$('ai-drop').classList.remove('drag');const f=e.dataTransfer.files[0];if(f)loadAiFile(f)}
function loadAiFile(f){
  const ok=['application/pdf','image/jpeg','image/jpg','image/png'];
  if(!ok.includes(f.type)){toast('âŒ Use PDF, JPG ou PNG');return}
  if(f.size>8*1024*1024){toast('âŒ Arquivo > 8 MB');return}
  _aiFile=f; _aiMime=f.type;
  $('ai-idle').style.display='none';
  $('ai-file-info').style.display='flex';
  $('ai-file-ic').textContent={pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸'}[f.name.split('.').pop().toLowerCase()]||'ğŸ“';
  $('ai-file-nm').textContent=f.name;
  $('ai-file-sz').textContent=(f.size/1024).toFixed(1)+' KB';
  $('ai-run-btn').disabled=false;
  const reader=new FileReader(); reader.onload=e=>{_aiB64=e.target.result.split(',')[1]}; reader.readAsDataURL(f);
}
function clearAiFile(e){e.stopPropagation();resetAI()}

async function runAI(){
  const apiKey=($('api-key').value||'').trim();
  if(!apiKey){toast('âš ï¸ Informe a chave de API');$('api-key').focus();return}
  if(!_aiB64){toast('âš ï¸ Selecione um arquivo');return}
  // persist key
  await put('cfg',{k:'apiKey',v:apiKey});

  const btn=$('ai-run-btn'); btn.disabled=true;
  $('ai-run-ic').innerHTML='<span class="spinner"></span>';
  $('ai-run-txt').textContent='Analisandoâ€¦';
  $('ai-status').textContent='Enviando para a IAâ€¦';

  const catKeys=S.cats.map(c=>c.key).join('|');
  const prompt=`VocÃª Ã© especialista em documentos financeiros brasileiros. Analise este documento da escola ColÃ©gio Objectivo (alunas Lara e Chloe). Retorne APENAS JSON vÃ¡lido (sem markdown, sem texto adicional):\n{"amount":<nÃºmero>,"type":"PAID","categoryKey":"${catKeys}","party":"Me","date":"YYYY-MM-DD","academicYear":<ano>,"academicMonth":<1-12>,"isLate":false,"notes":"<resumo>","tags":"","confidence":"high","summary":"<frase curta em portuguÃªs>"}\nRegras importantes: type="RECEIVED" somente para valores pagos pelo pai. categoryKey="pensao" para recebimento de pensÃ£o. Responda SOMENTE com o objeto JSON.`;

  try{
    const content=[
      _aiMime==='application/pdf'
        ?{type:'document',source:{type:'base64',media_type:'application/pdf',data:_aiB64}}
        :{type:'image',source:{type:'base64',media_type:_aiMime,data:_aiB64}},
      {type:'text',text:prompt}
    ];
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:700,messages:[{role:'user',content}]})
    });
    if(!res.ok){
      const err=await res.json().catch(()=>({}));
      throw new Error(err?.error?.message||'HTTP '+res.status);
    }
    const data=await res.json();
    const raw=(data.content?.find(b=>b.type==='text')?.text||'').trim();
    const match=raw.match(/\{[\s\S]*\}/); if(!match) throw new Error('Resposta invÃ¡lida da IA');
    const parsed=JSON.parse(match[0]);
    applyAI(parsed);
  }catch(err){
    let msg=err.message;
    if(msg.includes('401')||msg.includes('authentication')) msg='Chave de API invÃ¡lida';
    else if(msg.includes('Failed to fetch')||msg.includes('NetworkError')) msg='Sem conexÃ£o â€” verifique o Wi-Fi';
    toast('âŒ '+msg, 4000);
    btn.disabled=false;
    $('ai-run-ic').textContent='âœ¦'; $('ai-run-txt').textContent='Tentar novamente';
    $('ai-status').textContent='';
  }
}

function applyAI(d){
  const btn=$('ai-run-btn'); btn.disabled=false;
  btn.style.background='var(--green)'; btn.style.color='#fff';
  $('ai-run-ic').textContent='âœ“'; $('ai-run-txt').textContent='Preenchido';
  const cf=d.confidence||'medium';
  const cfC={high:'var(--green)',medium:'var(--orange)',low:'var(--red)'};
  $('ai-status').innerHTML=`<span style="color:${cfC[cf]};font-weight:600">â— ${{high:'Alta confianÃ§a',medium:'Verificar campos',low:'Revisar tudo'}[cf]}</span>`;
  $('ai-summary').textContent=d.summary||'Documento analisado.';
  $('ai-result').style.display='flex';
  const catKey=(d.party==='Father'&&d.type==='RECEIVED')?'pensao':(d.categoryKey||'');
  const fieldMap=[
    ['f-val',d.amount?.toString()],['f-type',d.type],['f-cat',catKey],
    ['f-party',d.party],['f-date',d.date],
    ['f-year',d.academicYear?.toString()],['f-month',d.academicMonth?.toString()],
    ['f-notes',d.notes],['f-tags',d.tags]
  ];
  fieldMap.forEach(([id,v],i)=>{
    if(v==null||v==='') return;
    setTimeout(()=>{
      const el=$(id); if(!el) return;
      if(el.tagName==='SELECT'){const opt=[...el.options].find(o=>o.value===String(v));if(opt)el.value=opt.value}
      else el.value=v;
      el.classList.add('ai-hi');
      setTimeout(()=>el.classList.remove('ai-hi'),3000);
    },i*70);
  });
  if(d.isLate) setTimeout(()=>$('tog').classList.add('on'),600);
}

async function loadSavedApiKey(){
  try{const s=await getOne('cfg','apiKey');if(s?.v)$('api-key').value=s.v}catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Seed data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function seedIfEmpty(){
  const existing=await all('txs'); if(existing.length>0)return;
  const CATS=[
    {key:'mensalidade',label:'Mensalidade',color:'#007AFF',system:true},
    {key:'pensao',     label:'PensÃ£o AlimentÃ­cia',color:'#FF2D55',system:true},
    {key:'matricula',  label:'MatrÃ­cula', color:'#FF9500',system:true},
    {key:'material',   label:'Material',  color:'#30B0C7',system:true},
    {key:'uniforme',   label:'Uniforme',  color:'#AF52DE',system:true},
    {key:'extra',      label:'Extra',     color:'#34C759',system:true},
  ];
  for(const c of CATS) await put('cats',c);
  let id=1;
  const mk=o=>({id:id++,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),...o});
  // 2025 mensalidades
  const m25=[4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.40];
  for(let i=0;i<12;i++) await put('txs',mk({amount:m25[i],type:'PAID',categoryKey:'mensalidade',party:'Me',date:`2025-${String(i+1).padStart(2,'0')}-05`,academicYear:2025,academicMonth:i+1,isLate:false,notes:`Mensalidade ${MF[i]}/2025`,tags:'mensalidade'}));
  await put('txs',mk({amount:4256.88,type:'PAID',categoryKey:'matricula',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'MatrÃ­cula anual 2025',tags:'matricula'}));
  for(const[m,d]of[[1,'2025-01-05'],[4,'2025-04-05'],[7,'2025-07-05'],[9,'2025-09-05']])
    await put('txs',mk({amount:724.50,type:'PAID',categoryKey:'material',party:'Me',date:d,academicYear:2025,academicMonth:m,isLate:false,notes:`Material ${MF[m-1]}/2025`,tags:'material'}));
  await put('txs',mk({amount:1084.23,type:'PAID',categoryKey:'extra',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'Extra Jan/2025',tags:'extra'}));
  const p25=[[1,'2025-01-05',2000,false],[2,'2025-02-05',2000,false],[3,'2025-03-05',2000,false],[4,'2025-04-05',2000,false],[5,'2025-05-06',1000,true],[6,'2025-06-05',2000,false],[7,'2025-07-03',1000,false],[7,'2025-07-17',1000,true],[8,'2025-08-05',2000,false],[9,'2025-09-05',2000,false],[10,'2025-10-04',2000,false],[11,'2025-11-05',2000,false],[11,'2025-11-22',1500,true],[12,'2025-12-05',3500,false]];
  for(const[m,d,amt,late]of p25) await put('txs',mk({amount:amt,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:d,academicYear:2025,academicMonth:m,isLate:late,notes:`PensÃ£o ${MF[m-1]}/2025`,tags:'pensao'}));
  // 2026
  for(const[m,d]of[[1,'2026-01-05'],[2,'2026-02-05']]) await put('txs',mk({amount:5666.85,type:'PAID',categoryKey:'mensalidade',party:'Me',date:d,academicYear:2026,academicMonth:m,isLate:false,notes:`Mensalidade ${MF[m-1]}/2026`,tags:'mensalidade'}));
  await put('txs',mk({amount:1491.29,type:'PAID',categoryKey:'matricula',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'MatrÃ­cula 2026',tags:'matricula'}));
  await put('txs',mk({amount:1047.33,type:'PAID',categoryKey:'material',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'Material Jan/2026',tags:'material'}));
  await put('txs',mk({amount:1503.41,type:'PAID',categoryKey:'extra',party:'Me',date:'2026-02-05',academicYear:2026,academicMonth:2,isLate:false,notes:'ExcursÃ£o parcela 1',tags:'extra'}));
  for(let i=0;i<6;i++){const m=i+3;await put('txs',mk({amount:429,type:'PAID',categoryKey:'extra',party:'Me',date:`2026-${String(m).padStart(2,'0')}-05`,academicYear:2026,academicMonth:m,isLate:false,notes:`ExcursÃ£o ${MF[m-1]}/2026`,tags:'extra,excursao'}))}
  await put('txs',mk({amount:2000,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-01-12',academicYear:2026,academicMonth:1,isLate:true,notes:'PensÃ£o Jan/2026 â€” atraso',tags:'pensao'}));
  await put('txs',mk({amount:2500,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-02-07',academicYear:2026,academicMonth:2,isLate:true,notes:'PensÃ£o Fev/2026 â€” atraso',tags:'pensao'}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Bottom sheet close on bg tap
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.sheet-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open')}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Service Worker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker'in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Boot
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function boot(){
  await openDB();
  await seedIfEmpty();
  await loadCats();
  await initYearFilter();
  await loadSavedApiKey();
  renderDash();
}
window.addEventListener('load', boot);
</script>
</body>
</html>
