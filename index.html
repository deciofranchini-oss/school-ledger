<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ledger">
<meta name="theme-color" content="#FAFAF9">
<title>School Ledger v5</title>
<link rel="manifest" href="./manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHOOL LEDGER v5 â€” Design System
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#FAFAF9;--bg-2:#F5F4F2;--card:#FFF;
  --sep:rgba(0,0,0,.10);--sep-l:rgba(0,0,0,.06);
  --fill:rgba(0,0,0,.055);--fill-2:rgba(0,0,0,.035);
  --accent:#3B5BDB;--accent-l:rgba(59,91,219,.10);
  --green:#2E7D55;--green-l:rgba(46,125,85,.10);
  --red:#C0392B;--red-l:rgba(192,57,43,.10);
  --orange:#C05C1A;--orange-l:rgba(192,92,26,.10);
  --violet:#7C3AED;--violet-l:rgba(124,58,237,.09);--violet-d:rgba(124,58,237,.22);
  --amber:#D97706;--amber-l:rgba(217,119,6,.12);
  --t-1:#18181B;--t-2:#3F3F46;--t-3:#71717A;--t-4:#A1A1AA;--t-5:#D4D4D8;
  --f:'Inter',-apple-system,sans-serif;
  --mono:'SF Mono','Menlo','Consolas',monospace;
  --sat:env(safe-area-inset-top,44px);--sab:env(safe-area-inset-bottom,34px);
  --r:10px;--r2:14px;--r3:18px;
  --tab:49px;--sidebar:230px;
  --s1:0 1px 3px rgba(0,0,0,.06),0 1px 8px rgba(0,0,0,.04);
  --s2:0 2px 8px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.05);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{font-family:var(--f);font-size:16px;line-height:1.5;background:var(--bg);color:var(--t-1);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;padding-top:var(--sat);letter-spacing:-.01em}

/* â”€â”€ SCAFFOLD â”€â”€ */
#app{display:flex;flex-direction:column;height:100%}
#shell{display:flex;flex:1;overflow:hidden}
.scroller{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--tab) + var(--sab) + 20px)}
.scroller::-webkit-scrollbar{display:none}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{display:none;width:var(--sidebar);flex-shrink:0;background:rgba(250,250,249,.97);border-right:1px solid var(--sep-l);flex-direction:column;padding:16px 0 calc(var(--sab)+12px);overflow-y:auto}
.sb-brand{padding:12px 18px 18px;border-bottom:1px solid var(--sep-l);margin-bottom:8px}
.sb-app{font-size:15px;font-weight:700;letter-spacing:-.03em}
.sb-sub{font-size:11px;color:var(--t-3);margin-top:1px}
.sb-yr{padding:8px 12px 6px}
.sb-nav{display:flex;flex-direction:column;gap:2px;padding:4px 10px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r);border:none;background:none;cursor:pointer;font:500 14px/1 var(--f);color:var(--t-3);text-align:left;width:100%;transition:background .12s,color .12s;letter-spacing:-.01em}
.sb-item:hover{background:var(--fill-2);color:var(--t-2)}
.sb-item.on{background:var(--accent-l);color:var(--accent)}
.sb-item svg{width:18px;height:18px;flex-shrink:0}
.sb-spacer{flex:1}
.sb-foot{padding:12px 18px 0;border-top:1px solid var(--sep-l);font-size:11px;color:var(--t-4)}

/* â”€â”€ ALERT BADGE on sidebar item â”€â”€ */
.sb-badge{margin-left:auto;background:var(--amber);color:#fff;font-size:10px;font-weight:700;border-radius:100px;padding:2px 6px;min-width:18px;text-align:center}

/* â”€â”€ IPAD â”€â”€ */
@media(min-width:768px){
  .sidebar{display:flex}
  .tabbar{display:none!important}
  .navbar{display:none!important}
  .scroller{padding-bottom:calc(var(--sab)+24px)!important}
  .pg-title{padding:24px 28px 4px!important;font-size:32px!important}
  .form-section,.card,.btns{margin-left:28px!important;margin-right:28px!important}
  .kpi-row{padding:16px 28px 4px!important;flex-wrap:wrap}
  .kpi{min-width:160px!important}
  .s-hdr{padding:20px 28px 10px!important}
  #rpt-actions-bar,#rpt-hint,.alert-bar{padding-left:28px!important;padding-right:28px!important}
  .toast{bottom:28px}
  .sheet-bg{align-items:center;justify-content:center}
  .sheet{border-radius:var(--r3)!important;max-width:540px;width:92vw;animation:ipad-sheet .22s ease!important}
  @keyframes ipad-sheet{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
}

/* â”€â”€ NAVBAR â”€â”€ */
.navbar{display:flex;align-items:center;justify-content:space-between;padding:11px 20px;flex-shrink:0;min-height:48px;background:rgba(250,250,249,.95);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--sep-l)}
.navbar-title{font-size:16px;font-weight:600;letter-spacing:-.02em}
.yr-badge{display:flex;align-items:center;background:var(--accent);border-radius:100px;padding:5px 12px 5px 14px;cursor:pointer;gap:2px}
.yr-badge select{appearance:none;background:none;border:none;outline:none;font:600 14px/1 var(--f);color:#fff;cursor:pointer}
.yr-badge select option{background:#fff;color:var(--t-1)}
.yr-badge::after{content:'â–¾';color:rgba(255,255,255,.7);font-size:11px;pointer-events:none}

/* â”€â”€ PAGES â”€â”€ */
.pg-title{font-size:30px;font-weight:700;letter-spacing:-.04em;padding:18px 20px 2px;line-height:1.1}
.page{display:none}
.page.on{display:block;animation:pgfade .18s ease}
@keyframes pgfade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TABBAR â”€â”€ */
.tabbar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab)+var(--sab));padding-bottom:var(--sab);background:rgba(250,250,249,.96);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--sep-l);display:flex;z-index:100}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding-top:5px;cursor:pointer;border:none;background:none;font:500 9.5px/1 var(--f);color:var(--t-4);text-transform:uppercase;letter-spacing:.02em;transition:color .15s;position:relative}
.tab.on{color:var(--accent)}
.tab svg{width:24px;height:24px}
.tab-badge{position:absolute;top:2px;right:calc(50% - 22px);background:var(--amber);color:#fff;font-size:9px;font-weight:700;border-radius:100px;padding:1px 5px;min-width:16px;text-align:center}

/* â”€â”€ KPI â”€â”€ */
.kpi-row{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:16px 20px 4px;scrollbar-width:none}
.kpi-row::-webkit-scrollbar{display:none}
.kpi{min-width:150px;flex-shrink:0;background:var(--card);border-radius:var(--r2);padding:15px 16px;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.kpi-label{font-size:10.5px;font-weight:500;color:var(--t-3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.06em}
.kpi-value{font:600 21px/1 var(--mono);letter-spacing:-.02em}
.kpi-sub{font-size:11px;color:var(--t-4);margin-top:5px;line-height:1.4}
.kpi.blue .kpi-value{color:var(--accent)}
.kpi.green .kpi-value{color:var(--green)}
.kpi.red .kpi-value{color:var(--red)}
.kpi.ora .kpi-value{color:var(--orange)}
.kpi.violet .kpi-value{color:var(--violet)}
.kpi.amber .kpi-value{color:var(--amber)}
.kpi.fcst-kpi{border-left:3px solid var(--violet)}

/* â”€â”€ ALERT BAR â”€â”€ */
.alert-bar{padding:10px 20px;margin-bottom:4px}
.alert-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--amber-l);border:1.5px solid rgba(217,119,6,.3);border-radius:var(--r2);margin-bottom:8px;cursor:pointer;transition:opacity .15s}
.alert-item:active{opacity:.75}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-body{flex:1;min-width:0}
.alert-title{font-size:13px;font-weight:600;color:var(--amber)}
.alert-desc{font-size:12px;color:var(--t-2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.alert-cta{font-size:12px;color:var(--accent);font-weight:600;flex-shrink:0}

/* â”€â”€ SECTION HEADER â”€â”€ */
.s-hdr{display:flex;align-items:baseline;justify-content:space-between;padding:22px 20px 10px}
.s-title{font-size:18px;font-weight:700;letter-spacing:-.03em}
.s-link{font-size:14px;color:var(--accent);cursor:pointer;font-weight:500}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border-radius:var(--r2);margin:0 20px;box-shadow:var(--s1);overflow:hidden;border:1px solid var(--sep-l)}
.card+.card{margin-top:12px}

/* â”€â”€ LIST ROW â”€â”€ */
.list-row{display:flex;align-items:center;gap:14px;padding:12px 16px;border-bottom:1px solid var(--sep-l);min-height:48px;cursor:pointer;transition:background .12s}
.list-row:last-child{border-bottom:none}
.list-row:active{background:var(--fill-2)}
.list-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.list-label{font-size:15px;font-weight:400;flex:1;color:var(--t-2)}
.list-value{font-size:14px;color:var(--t-3)}
.list-chevron{color:var(--t-5);flex-shrink:0}
.list-chevron svg{width:12px;height:12px}
.list-body{flex:1;min-width:0}
.list-name{font-size:15px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--t-2)}

/* â”€â”€ TX ROWS â”€â”€ */
.tx-sub{font-size:12px;color:var(--t-3);margin-top:2px;line-height:1.4}
.tx-amount{font:600 15px/1 var(--mono);letter-spacing:-.02em}
.tx-amount.out{color:var(--red)}
.tx-amount.in{color:var(--green)}
.tx-amount.fcst{color:var(--violet);opacity:.8}
.tx-late{font-size:10px;color:var(--red);font-weight:600;margin-top:3px;letter-spacing:.02em}
.tx-alert{font-size:10px;color:var(--amber);font-weight:600;margin-top:3px}
.row-fcst{opacity:.7}
.fcst-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--violet);background:var(--violet-l);border:1px solid var(--violet-d);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:5px}
.alert-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--amber);background:var(--amber-l);border:1px solid rgba(217,119,6,.3);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:5px}
.student-badge{display:inline-block;font-size:9px;font-weight:600;color:var(--t-3);background:var(--fill);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:4px}

/* â”€â”€ CHARTS â”€â”€ */
.chart-title{font-size:11px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:16px}
.donut-name{font-size:11px;font-weight:500;color:var(--t-3);letter-spacing:.02em}
.leg-item{display:flex;align-items:center;gap:7px;font-size:10.5px;color:var(--t-3)}
.leg-swatch{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.leg-pct{font:500 10px/1 var(--mono);margin-left:auto;color:var(--t-1)}

/* â”€â”€ FORM â”€â”€ */
.form-section{margin:20px 20px 0}
.form-label{font-size:11px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding:0 2px}
.form-card{background:var(--card);border-radius:var(--r2);overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.field{display:flex;align-items:center;gap:12px;padding:0 16px;border-bottom:1px solid var(--sep-l);min-height:46px}
.field:last-child{border-bottom:none}
.field-label{font-size:15px;font-weight:400;min-width:90px;flex-shrink:0;color:var(--t-2)}
.field input,.field select,.field textarea{flex:1;border:none;background:none;outline:none;font:400 15px/1 var(--f);color:var(--t-1);text-align:right;-webkit-appearance:none;letter-spacing:-.01em}
.field input::placeholder{color:var(--t-5)}
.field.tall{align-items:flex-start;padding:12px 16px}
.field.tall .field-label{font-size:13px;color:var(--t-3);font-weight:500;padding-top:2px;min-width:auto}
.field.tall textarea{text-align:left;resize:none;line-height:1.5;padding:0;font-size:14px}

/* Inline party add */
.party-inline{display:flex;gap:8px;padding:10px 16px;background:var(--bg-2);border-top:1px solid var(--sep-l)}
.party-inline input{flex:1;border:1.5px solid var(--sep);border-radius:var(--r);padding:8px 10px;font:400 13px/1 var(--f);background:var(--card);outline:none}
.party-inline input:focus{border-color:var(--accent)}
.party-inline button{padding:8px 14px;border-radius:var(--r);border:none;background:var(--accent);color:#fff;font:500 13px/1 var(--f);cursor:pointer}

/* Toggle */
.tog-field{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--sep-l);min-height:46px;cursor:pointer}
.tog-label{font-size:15px;color:var(--t-2)}
.toggle{width:51px;height:31px;border-radius:16px;background:var(--t-5);position:relative;flex-shrink:0;transition:background .2s;cursor:pointer}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;left:2px;top:2px;width:27px;height:27px;border-radius:50%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:transform .22s cubic-bezier(.34,1.12,.64,1)}
.toggle.on::after{transform:translateX(20px)}

/* Forecast notice */
.fcst-notice{background:var(--violet-l);border:1.5px dashed var(--violet-d);border-radius:var(--r2);padding:12px 14px;margin:12px 20px 0;display:none}
.fcst-notice.show{display:block}
.fcst-notice b{color:var(--violet)}

/* Student selector */
.student-sel{display:flex;gap:8px;padding:10px 16px}
.student-btn{flex:1;padding:9px 8px;border-radius:var(--r);border:1.5px solid var(--sep);background:var(--bg-2);font:500 13px/1 var(--f);color:var(--t-3);cursor:pointer;text-align:center;transition:all .15s}
.student-btn.on{background:var(--accent-l);border-color:var(--accent);color:var(--accent)}

/* â”€â”€ SEARCH BAR â”€â”€ */
.search-wrap{padding:10px 20px 4px;position:relative}
.search-input{width:100%;padding:10px 38px 10px 14px;border:1.5px solid var(--sep);border-radius:var(--r2);font:400 15px/1 var(--f);color:var(--t-1);background:var(--card);outline:none;-webkit-appearance:none;box-shadow:var(--s1)}
.search-input:focus{border-color:var(--accent)}
.search-clear{position:absolute;right:28px;top:50%;transform:translateY(-50%);background:var(--t-5);border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center;color:var(--t-2)}
.search-clear.show{display:flex}

/* â”€â”€ FILTER PILLS â”€â”€ */
.filter-row{display:flex;gap:6px;padding:4px 20px 6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-sel{background:var(--card);border:1px solid var(--sep-l);border-radius:100px;padding:7px 14px;font:500 13px/1 var(--f);color:var(--t-2);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.04)}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;border-radius:var(--r2);font:600 15px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s,transform .1s}
.btn:active{opacity:.8;transform:scale(.99)}
.btn.primary{background:var(--accent);color:#fff}
.btn.destructive{background:var(--red-l);color:var(--red)}
.btn.secondary{background:var(--fill);color:var(--t-2)}
.btn.amber{background:var(--amber-l);color:var(--amber)}
.btns{display:flex;flex-direction:column;gap:10px;padding:18px 20px 4px}
.pill-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:100px;font:500 14px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s;white-space:nowrap}
.pill-btn:active{opacity:.75}
.pill-btn:disabled{opacity:.35;cursor:default}
.pill-btn.blue{background:var(--accent);color:#fff}
.pill-btn.gray{background:var(--fill);color:var(--t-2)}
.pill-btn.green{background:var(--green);color:#fff}
.pill-btn.violet{background:var(--violet);color:#fff}
.pill-btn.amber{background:var(--amber);color:#fff}

/* â”€â”€ AI SECTION â”€â”€ */
.ai-drop{border:1.5px dashed var(--sep);border-radius:var(--r);background:var(--bg-2);padding:22px 16px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px}
.ai-drop.drag{border-color:var(--accent);background:var(--accent-l)}
.ai-drop.filled{border-style:solid;border-color:var(--green);background:var(--green-l)}
.ai-result{display:none;background:var(--green-l);border:1px solid rgba(46,125,85,.25);border-radius:var(--r);padding:12px 14px;margin-top:12px}
@keyframes aiFlash{0%{background:rgba(46,125,85,.15)}100%{background:transparent}}
.ai-hi{animation:aiFlash 2.5s ease forwards}

/* â”€â”€ REPORTS â”€â”€ */
.rpt-card{background:var(--card);border-radius:var(--r2);margin:0 20px 14px;overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.rpt-yr-hdr{background:var(--accent);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.rpt-yr-hdr h3{font-size:16px;font-weight:700;letter-spacing:-.02em}
.rpt-yr-hdr span{font:500 13px/1 var(--mono);opacity:.8}
.rpt-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.rtbl{width:100%;border-collapse:collapse;white-space:nowrap}
.rtbl th{padding:9px 12px;text-align:right;font-size:10px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.06em;background:var(--bg-2);border-bottom:1px solid var(--sep-l)}
.rtbl th:first-child{text-align:left;padding-left:16px}
.rtbl th.fcst-h{color:var(--violet)}
.rtbl th.accord-h{color:var(--green)}
.rtbl td{padding:9px 12px;text-align:right;border-bottom:1px solid var(--sep-l);font:400 12px/1.4 var(--mono);color:var(--t-3);vertical-align:top}
.rtbl td:first-child{text-align:left;font:500 13px/1 var(--f);color:var(--t-2);padding-left:16px;letter-spacing:-.01em}
.rtbl tr:last-child td{border-bottom:none}
.rtbl tr.total-row td{background:rgba(59,91,219,.05);font-weight:700;color:var(--t-1);border-top:1px solid rgba(59,91,219,.18)}
.r{text-align:right!important}
.neg{color:var(--red)!important}
.recv{color:var(--green)!important}
.pct-ok{color:var(--green)!important;font-weight:600}
.pct-bad{color:var(--red)!important;font-weight:600}
.pct-equal{color:var(--accent)!important;font-weight:600}
.late-tag{display:block;font-size:9.5px;font-weight:700;color:var(--red);letter-spacing:.03em;margin-top:3px}
.fcst-col{color:var(--violet)!important;font-style:italic}
.accord-col{color:var(--green)!important}
.subtotal-col{font-weight:600;color:var(--t-1)!important;border-left:2px solid var(--sep)!important}
.gt-strip{border-radius:var(--r2);margin:0 20px 12px;padding:16px 18px;display:grid;grid-template-columns:repeat(4,1fr);gap:14px;box-shadow:var(--s2)}
.gt-strip.confirmed{background:var(--accent)}
.gt-strip.forecast{background:var(--violet)}
.gt-cell{text-align:center}
.gt-label{font-size:9.5px;font-weight:600;color:rgba(255,255,255,.65);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px}
.gt-value{font:600 15px/1 var(--mono);color:#fff;letter-spacing:-.02em}
.gt-value.warn{color:#FBBF24}
.gt-value.danger{color:#FCA5A5}

/* â”€â”€ SHEET â”€â”€ */
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:400;display:none;align-items:flex-end}
.sheet-bg.open{display:flex;animation:bgfade .2s ease}
@keyframes bgfade{from{opacity:0}to{opacity:1}}
.sheet{background:var(--card);border-radius:18px 18px 0 0;width:100%;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 calc(var(--sab)+8px);animation:sheetup .3s cubic-bezier(.34,1.12,.64,1);border-top:1px solid var(--sep-l)}
@keyframes sheetup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-grip{width:36px;height:4px;background:var(--sep);border-radius:2px;margin:10px auto 0}
.sheet-hdr{padding:14px 20px 13px;border-bottom:1px solid var(--sep-l);display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-size:17px;font-weight:600;letter-spacing:-.02em}
.sheet-close{font-size:15px;color:var(--accent);background:none;border:none;font-family:var(--f);cursor:pointer;font-weight:500}

/* â”€â”€ EMOJI PICKER â”€â”€ */
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;padding:8px}
.emoji-btn{font-size:22px;padding:6px;border:none;background:none;cursor:pointer;border-radius:6px;transition:background .1s;text-align:center}
.emoji-btn:hover{background:var(--fill)}
.emoji-btn.on{background:var(--accent-l)}

/* â”€â”€ MISC â”€â”€ */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:20px;height:20px;border:2px solid var(--sep-l);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite;display:inline-block;vertical-align:middle}
.toast{position:fixed;bottom:calc(var(--tab)+var(--sab)+14px);left:50%;transform:translateX(-50%);background:rgba(24,24,27,.9);backdrop-filter:blur(16px);border-radius:100px;padding:11px 22px;font:500 13.5px/1 var(--f);color:#fff;white-space:nowrap;z-index:999;opacity:0;transition:opacity .2s;pointer-events:none;box-shadow:var(--s2)}
.toast.on{opacity:1}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 24px;gap:10px;text-align:center;color:var(--t-3);font-size:15px}
.empty-state .ic{font-size:44px;margin-bottom:4px}
.seg-ctrl{display:flex;background:var(--bg-2);border-radius:var(--r);padding:3px;gap:2px}
.seg-opt{flex:1;padding:7px 12px;border-radius:8px;border:none;background:none;font:500 13px/1 var(--f);color:var(--t-3);cursor:pointer;text-align:center;transition:all .15s}
.seg-opt.on{background:var(--card);color:var(--t-1);box-shadow:0 1px 3px rgba(0,0,0,.08)}

/* â”€â”€ PRINT â”€â”€ */
@media print{
  @page{ size:A4 landscape; margin:10mm 8mm; }
  *{ -webkit-print-color-adjust:exact!important; print-color-adjust:exact!important; color-adjust:exact!important; }

  html,body{ height:auto!important; overflow:visible!important; background:#fff!important; padding:0!important; font-size:8.5pt; }

  /* Show report, hide everything else â€” use body class set by printReport() */
  body.printing #app{ display:block!important; height:auto!important; overflow:visible!important; }
  body.printing #shell{ display:block!important; height:auto!important; overflow:visible!important; }
  body.printing .scroller{ display:block!important; overflow:visible!important; height:auto!important; padding:0!important; max-height:none!important; }
  body.printing .sidebar,
  body.printing .tabbar,
  body.printing .navbar,
  body.printing .sheet-bg,
  body.printing #rpt-actions-bar,
  body.printing #rpt-hint,
  body.printing .alert-bar{ display:none!important; }
  /* Force ALL .page hidden, then force rpt visible */
  body.printing .page{ display:none!important; }
  body.printing #page-rpt{ display:block!important; }

  /* Without body.printing fallback (browser direct print) */
  #app{ display:block!important; height:auto!important; overflow:visible!important; }
  #shell{ display:block!important; height:auto!important; overflow:visible!important; }
  .scroller{ display:block!important; overflow:visible!important; height:auto!important; padding:0!important; max-height:none!important; }
  .sidebar,.tabbar,.navbar,.sheet-bg,#rpt-actions-bar,#rpt-hint,.alert-bar{ display:none!important; }
  .page{ display:none!important; }
  #page-rpt{ display:block!important; }

  .pg-title{ font-size:16pt!important; padding:0 0 6pt!important; font-weight:700; }
  .gt-strip{ margin:0 0 8pt!important; border-radius:4pt!important; padding:8pt 10pt!important; box-shadow:none!important; }
  .gt-strip.confirmed{ background:#3B5BDB!important; }
  .gt-strip.forecast{ background:#7C3AED!important; }
  .gt-label{ font-size:6.5pt!important; }
  .gt-value{ font-size:10pt!important; }
  .rpt-card{ margin:0 0 10pt!important; break-inside:avoid; box-shadow:none!important; border:1px solid #d0d0d0!important; border-radius:4pt!important; overflow:visible!important; page-break-inside:avoid; }
  .rpt-yr-hdr{ background:#3B5BDB!important; padding:7pt 10pt!important; }
  .rpt-yr-hdr h3{ color:#fff!important; font-size:11pt!important; }
  .rpt-yr-hdr span{ color:rgba(255,255,255,.85)!important; font-size:9pt!important; }
  .rpt-scroll{ overflow:visible!important; max-width:none!important; width:100%!important; display:block!important; }
  .rtbl{ width:100%!important; table-layout:fixed!important; white-space:normal!important; border-collapse:collapse!important; }
  .rtbl th{ background:#f0f0f0!important; font-size:6.5pt!important; padding:3pt 4pt!important; text-align:right!important; font-weight:700; color:#333!important; border-bottom:1.5px solid #999!important; border-right:1px solid #ddd!important; }
  .rtbl th:first-child{ text-align:left!important; padding-left:6pt!important; }
  .rtbl td{ font-size:7pt!important; padding:3pt 4pt!important; text-align:right!important; border-bottom:0.5px solid #e0e0e0!important; border-right:0.5px solid #eee!important; white-space:nowrap!important; vertical-align:middle!important; }
  .rtbl td:first-child{ text-align:left!important; padding-left:6pt!important; font-size:7.5pt!important; font-weight:500; }
  .rtbl tr.total-row td{ background:#e8eeff!important; font-weight:700!important; border-top:1.5px solid #3B5BDB!important; }
  .rtbl col.c-mes{ width:11%!important; }
  .rtbl col.c-val{ width:6.5%!important; }
  .rtbl col.c-sub{ width:7%!important; }
  .rtbl col.c-pens{ width:6.5%!important; }
  .rtbl col.c-date{ width:9%!important; }
  .rtbl col.c-diff{ width:6.5%!important; }
  .rtbl col.c-pct{ width:5.5%!important; }
  .rtbl col.c-acc{ width:6.5%!important; }
  .rtbl col.c-fcst{ width:6.5%!important; }
  .neg{ color:#C0392B!important; }
  .recv{ color:#2E7D55!important; }
  .pct-ok{ color:#2E7D55!important; }
  .pct-bad{ color:#C0392B!important; }
  .pct-equal{ color:#3B5BDB!important; }
  .fcst-col{ color:#7C3AED!important; }
  .accord-col{ color:#2E7D55!important; }
  .subtotal-col{ font-weight:700!important; background:#fafafa!important; }
  .late-tag{ font-size:6pt!important; color:#C0392B!important; }
  #page-rpt::after{ content:'School Ledger â€” Impresso em ' attr(data-print-date); display:block; font-size:6pt; color:#999; text-align:right; padding-top:6pt; border-top:0.5px solid #ddd; margin-top:8pt; }
}
</style>
</head>
<body>
<div id="app">

<!-- PHONE NAVBAR -->
<div class="navbar" id="navbar">
  <div class="navbar-title" id="nav-title">School Ledger</div>
  <div class="yr-badge"><select id="yr-sel"></select></div>
</div>

<div id="shell">
<!-- â•â•â• SIDEBAR â•â•â• -->
<aside class="sidebar" id="sidebar">
  <div class="sb-brand"><div class="sb-app">School Ledger</div><div class="sb-sub">ColÃ©gio Objectivo Â· Lara &amp; Chloe</div></div>
  <div class="sb-yr"><div class="yr-badge"><select id="yr-sel-sb"></select></div></div>
  <nav class="sb-nav">
    <button class="sb-item on" id="si-dash" onclick="nav('dash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>Dashboard<span id="sb-alert-badge" class="sb-badge" style="display:none">!</span></button>
    <button class="sb-item" id="si-txs" onclick="nav('txs')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>TransaÃ§Ãµes</button>
    <button class="sb-item" id="si-add" onclick="nav('add')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Nova TransaÃ§Ã£o</button>
    <button class="sb-item" id="si-rpt" onclick="nav('rpt')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>RelatÃ³rio</button>
    <button class="sb-item" id="si-cfg" onclick="nav('cfg')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>ConfiguraÃ§Ãµes</button>
  </nav>
  <div class="sb-spacer"></div>
  <div class="sb-foot">v5.0 â€” Local PWA</div>
</aside>

<!-- â•â•â• SCROLLER â•â•â• -->
<div class="scroller" id="scroller">

<!-- â–‘â–‘ DASHBOARD â–‘â–‘ -->
<div class="page on" id="page-dash">
  <div class="pg-title">Dashboard</div>
  <div id="dash-alerts" class="alert-bar" style="display:none"></div>
  <div class="kpi-row" id="kpi-row"></div>
  <div id="accord-kpi-wrap"></div>
  <div id="fcst-kpi-wrap"></div>
  <div id="chart-area" style="margin-top:12px"></div>
  <div class="s-hdr"><span class="s-title">Recentes</span><span class="s-link" onclick="nav('txs')">Ver todas â†’</span></div>
  <div class="card" id="recent-card"><div class="empty-state"><span class="spinner"></span></div></div>
  <div style="height:8px"></div>
</div>

<!-- â–‘â–‘ TRANSACTIONS â–‘â–‘ -->
<div class="page" id="page-txs">
  <div class="pg-title">TransaÃ§Ãµes</div>
  <div id="tx-alerts" class="alert-bar" style="display:none"></div>
  <div class="search-wrap">
    <input class="search-input" id="tx-search" placeholder="ğŸ”  Buscar por valor, nota, categoriaâ€¦" oninput="onSearch()">
    <button class="search-clear" id="search-clear" onclick="clearSearch()">Ã—</button>
  </div>
  <div class="filter-row">
    <select id="fil-type" class="filter-sel" onchange="renderTxList()">
      <option value="">Todos os tipos</option>
      <option value="PAID">Pago</option>
      <option value="RECEIVED">Recebido</option>
      <option value="FORECAST">â—† PrevisÃ£o</option>
    </select>
    <select id="fil-cat" class="filter-sel" onchange="renderTxList()">
      <option value="">Todas categorias</option>
    </select>
    <select id="fil-student" class="filter-sel" onchange="renderTxList()">
      <option value="">Todos alunos</option>
      <option value="Lara">Lara</option>
      <option value="Chloe">Chloe</option>
      <option value="Ambas">Ambas</option>
    </select>
  </div>
  <div id="tx-wrap" style="margin:4px 0"></div>
</div>

<!-- â–‘â–‘ ADD / EDIT â–‘â–‘ -->
<div class="page" id="page-add">
  <div class="pg-title" id="add-title">Nova TransaÃ§Ã£o</div>

  <!-- AI LOCAL -->
  <div class="form-section">
    <div class="form-label">âœ¦ Interpretar com IA Local</div>
    <div class="form-card" style="padding:14px 16px">
      <p style="font-size:12px;color:var(--t-3);line-height:1.65;margin-bottom:10px">LÃª PDF de relatÃ³rio de pagamento escolar. Preenche formulÃ¡rio automaticamente.<br>Sem API Â· Offline Â· Safari/iOS compatÃ­vel</p>
      <div id="ai-drop" class="ai-drop" onclick="document.getElementById('ai-file').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="onAiDrop(event)">
        <input type="file" id="ai-file" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" onchange="loadAiFile(event.target.files[0])">
        <div id="ai-idle"><div style="font-size:30px;margin-bottom:6px">ğŸ“„</div><div style="font-size:14px;font-weight:500;color:var(--t-2)">Toque para escolher arquivo</div><div style="font-size:12px;color:var(--t-3);margin-top:3px">Boleto Â· Comprovante Â· RelatÃ³rio de Pagamento</div></div>
        <div id="ai-file-info" style="display:none;align-items:center;gap:12px">
          <span id="ai-file-ic" style="font-size:28px"></span>
          <div style="flex:1;text-align:left;min-width:0"><div id="ai-file-nm" style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div><div id="ai-file-sz" style="font-size:12px;color:var(--t-3);margin-top:2px"></div></div>
          <button onclick="clearAiFile(event)" style="background:var(--fill);border:none;border-radius:100px;padding:6px 12px;font:500 13px/1 var(--f);color:var(--t-2);cursor:pointer;flex-shrink:0">Remover</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="ai-run-btn" class="pill-btn blue" disabled onclick="runAI()"><span id="ai-run-ic">âœ¦</span>&nbsp;<span id="ai-run-txt">Interpretar com IA</span></button>
        <span id="ai-status" style="font-size:12px;color:var(--t-3)"></span>
      </div>
      <div class="ai-result" id="ai-result">
        <div style="display:flex;gap:10px"><span style="font-size:20px">âœ…</span><div><div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:3px">Campos preenchidos</div><div id="ai-summary" style="font-size:12px;color:var(--t-2);line-height:1.5"></div></div></div>
      </div>
    </div>
  </div>

  <!-- EXISTING FILE BANNER (shown when editing a tx that already has a document) -->
  <div id="existing-file-banner" style="display:none;margin:10px 20px 0">
    <div style="display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--accent-l);border:1.5px solid rgba(59,91,219,.2);border-radius:var(--r2)">
      <span id="efb-ic" style="font-size:22px">ğŸ“</span>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;color:var(--accent)" id="efb-name">Documento anexado</div>
        <div style="font-size:11px;color:var(--t-3);margin-top:1px" id="efb-meta"></div>
      </div>
      <button onclick="downloadTxFile(S._existingFileId)" style="border:none;background:var(--accent);color:#fff;border-radius:var(--r);padding:6px 12px;font:500 12px/1 var(--f);cursor:pointer;flex-shrink:0">â¬‡ Ver</button>
    </div>
  </div>

  <!-- DADOS -->
  <div class="form-section" style="margin-top:20px">
    <div class="form-label">Dados</div>
    <div class="form-card">
      <input type="hidden" id="f-id">
      <div class="field">
        <span class="field-label">Valor (R$)</span>
        <input id="f-val" type="number" inputmode="decimal" step="0.01" placeholder="0,00">
      </div>
      <div class="field">
        <span class="field-label">Tipo</span>
        <select id="f-type" onchange="onTypeChange()">
          <option value="PAID">SaÃ­da (pago)</option>
          <option value="RECEIVED">Entrada (recebido)</option>
          <option value="FORECAST">â—† PrevisÃ£o futura</option>
        </select>
      </div>
      <div class="field">
        <span class="field-label">Categoria</span>
        <select id="f-cat"></select>
      </div>
      <div class="field">
        <span class="field-label">Parte</span>
        <select id="f-party"></select>
      </div>
    </div>
    <!-- Inline: criar nova parte -->
    <div class="party-inline">
      <input id="f-new-party" type="text" placeholder="Nova parteâ€¦ (ex: AvÃ³)" maxlength="40" onkeydown="if(event.key==='Enter'){event.preventDefault();addPartyInline()}">
      <button onclick="addPartyInline()">+ Adicionar</button>
    </div>
  </div>

  <!-- Aluna -->
  <div class="form-section">
    <div class="form-label">Aluna</div>
    <div class="form-card">
      <div class="student-sel">
        <button class="student-btn on" id="sb-lara" onclick="setStudent('Lara')">ğŸ’ Lara</button>
        <button class="student-btn" id="sb-chloe" onclick="setStudent('Chloe')">ğŸ’ Chloe</button>
        <button class="student-btn" id="sb-both" onclick="setStudent('Ambas')">ğŸ‘¯ Ambas</button>
      </div>
      <input type="hidden" id="f-student" value="Ambas">
    </div>
  </div>

  <!-- Forecast notice -->
  <div class="fcst-notice" id="fcst-notice">
    <b>â—† PrevisÃ£o futura</b> â€” este lanÃ§amento <strong>nÃ£o entra nos totais realizados</strong>. Aparece em violeta separado dos valores pagos.
  </div>

  <!-- DATA FUTURA notice -->
  <div id="future-date-notice" style="display:none;background:var(--amber-l);border:1.5px solid rgba(217,119,6,.3);border-radius:var(--r2);padding:12px 14px;margin:12px 20px 0">
    <b style="color:var(--amber)">ğŸ“… Data futura detectada</b> â€” tipo alterado para <strong>PrevisÃ£o</strong> automaticamente.
  </div>

  <!-- REFERÃŠNCIA -->
  <div class="form-section">
    <div class="form-label">ReferÃªncia</div>
    <div class="form-card">
      <div class="field"><span class="field-label">Data pgto.</span><input id="f-date" type="date" onchange="onDateChange()"></div>
      <div class="field"><span class="field-label">Ano Letivo</span><select id="f-year"></select></div>
      <div class="field"><span class="field-label">MÃªs</span>
        <select id="f-month">
          <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">MarÃ§o</option>
          <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
          <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
          <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
      </div>
    </div>
  </div>

  <!-- DETALHES -->
  <div class="form-section">
    <div class="form-label">Detalhes</div>
    <div class="form-card">
      <div class="tog-field" onclick="document.getElementById('tog').classList.toggle('on')">
        <span class="tog-label">Recebido com atraso</span>
        <div class="toggle" id="tog"></div>
      </div>
      <div class="field tall"><span class="field-label">Notas</span><textarea id="f-notes" rows="2" placeholder="ObservaÃ§Ãµesâ€¦"></textarea></div>
      <div class="field"><span class="field-label">Tags</span><input id="f-tags" type="text" placeholder="opcional"></div>
    </div>
  </div>

  <div class="btns">
    <button class="btn primary" onclick="saveTx()">ğŸ’¾&nbsp; Salvar TransaÃ§Ã£o</button>
    <button id="del-btn" class="btn destructive" style="display:none" onclick="deleteTx()">ğŸ—‘&nbsp; Excluir TransaÃ§Ã£o</button>
  </div>
  <div style="height:8px"></div>
</div>

<!-- â–‘â–‘ REPORTS â–‘â–‘ -->
<div class="page" id="page-rpt">
  <div class="pg-title">RelatÃ³rio</div>
  <div id="rpt-actions-bar" style="display:flex;gap:8px;padding:12px 20px 4px;flex-wrap:wrap">
    <button class="pill-btn blue" onclick="printReport()">ğŸ–¨ï¸&nbsp; Imprimir / PDF</button>
    <button class="pill-btn gray" onclick="exportCSV()">ğŸ“¥&nbsp; CSV</button>
  </div>
  <div id="rpt-content"><div class="empty-state"><span class="spinner"></span></div></div>
  <div id="rpt-hint" style="padding:0 20px 20px;font-size:11px;color:var(--t-4);line-height:2">
    <span style="color:var(--red)">â–  atraso</span> â€” apenas ao lado da data &nbsp;Â·&nbsp;
    <span style="color:var(--violet)">â—† PrevisÃ£o</span> â€” nÃ£o entra nos totais &nbsp;Â·&nbsp;
    <span style="color:var(--green)">Acordo</span> â€” meta cobertura Pai
  </div>
</div>

<!-- â–‘â–‘ SETTINGS â–‘â–‘ -->
<div class="page" id="page-cfg">
  <div class="pg-title">ConfiguraÃ§Ãµes</div>

  <!-- Acordo Pai -->
  <div class="form-section">
    <div class="form-label">âš–ï¸ Acordo com o Pai</div>
    <div class="form-card">
      <div class="field">
        <span class="field-label">Tipo</span>
        <select id="cfg-accord-type" onchange="onAccordTypeChange()">
          <option value="pct">Percentual (%)</option>
          <option value="fixed">Valor fixo (R$)</option>
        </select>
      </div>
      <div class="field" id="cfg-accord-pct-row">
        <span class="field-label">Percentual</span>
        <input id="cfg-accord-pct" type="number" step="0.1" min="0" max="100" placeholder="50" style="max-width:80px">
        <span style="font-size:15px;color:var(--t-3);margin-left:-8px">%</span>
      </div>
      <div class="field" id="cfg-accord-val-row" style="display:none">
        <span class="field-label">Valor (R$)</span>
        <input id="cfg-accord-val" type="number" step="0.01" placeholder="2000,00">
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn primary" onclick="saveAccordConfig()">Salvar Acordo</button></div>
  </div>

  <!-- Gerar PrevisÃµes -->
  <div class="form-section">
    <div class="form-label">ğŸ”® Gerar PrevisÃµes AutomÃ¡ticas</div>
    <div class="form-card" style="padding:16px">
      <p style="font-size:13px;color:var(--t-2);line-height:1.65;margin-bottom:12px">Gera previsÃµes de <strong>Mensalidade</strong> e <strong>PensÃ£o</strong> para os meses restantes do ano letivo atual.</p>
      <div class="field" style="margin:-16px -16px 12px;border-radius:0;background:var(--bg-2)">
        <span class="field-label">Tipo</span>
        <select id="gen-type" style="text-align:right">
          <option value="both">Mensalidade + PensÃ£o</option>
          <option value="mensalidade">Apenas Mensalidade</option>
          <option value="pensao">Apenas PensÃ£o</option>
        </select>
      </div>
      <div style="margin-bottom:12px">
        <div class="form-label" style="margin-bottom:8px">Base de valor</div>
        <div class="seg-ctrl">
          <button class="seg-opt on" id="gen-base-last" onclick="setGenBase('last')">Ãšltimo pago</button>
          <button class="seg-opt" id="gen-base-avg" onclick="setGenBase('avg')">MÃ©dia do ano</button>
        </div>
      </div>
      <button class="btn violet" style="border-radius:var(--r2)" onclick="generateForecasts()">â—†&nbsp; Gerar PrevisÃµes</button>
    </div>
  </div>

  <!-- Backup -->
  <div class="form-section">
    <div class="form-label">ğŸ’¾ Backup</div>
    <div class="form-card">
      <div class="list-row" onclick="exportJSON()">
        <div class="list-icon" style="background:var(--accent-l)">ğŸ’¾</div>
        <div class="list-label">Exportar backup JSON</div>
        <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="list-row" onclick="document.getElementById('imp-file').click()">
        <div class="list-icon" style="background:var(--green-l)">ğŸ“‚</div>
        <div class="list-label">Importar backup JSON</div>
        <input type="file" id="imp-file" accept=".json" style="display:none" onchange="importJSON(event.target.files[0])">
        <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
    </div>
    <div id="imp-msg" style="display:none;margin-top:8px;padding:12px 14px;border-radius:var(--r);font-size:13px;font-weight:500;line-height:1.5"></div>
  </div>

  <!-- Partes -->
  <div class="form-section">
    <div class="form-label">ğŸ‘¥ Partes</div>
    <div class="form-card" id="party-list-wrap"></div>
    <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="openPartySheet(null)">+ Nova Parte</button></div>
  </div>

  <!-- Categorias -->
  <div class="form-section">
    <div class="form-label">ğŸ·ï¸ Categorias</div>
    <div class="form-card" id="cat-list-wrap"></div>
    <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="document.getElementById('cat-sheet').classList.add('open')">+ Nova Categoria</button></div>
  </div>

  <!-- Dados -->
  <div class="form-section">
    <div class="form-label">ğŸ“Š Dados</div>
    <div class="form-card">
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--accent-l)">ğŸ“Š</div><div class="list-label">Total transaÃ§Ãµes</div><div class="list-value" id="stat-count">â€”</div></div>
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--orange-l)">ğŸ“…</div><div class="list-label">Anos com dados</div><div class="list-value" id="stat-years">â€”</div></div>
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--violet-l)">ğŸ“</div><div class="list-label">Arquivos IA armazenados</div><div class="list-value" id="stat-files">â€”</div></div>
      <div class="list-row" onclick="clearAll()"><div class="list-icon" style="background:var(--red-l)">âš ï¸</div><div class="list-label" style="color:var(--red)">Apagar todos os dados</div><div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div></div>
    </div>
  </div>

  <div class="form-section" style="margin-bottom:20px">
    <div class="form-label">ğŸ“± Instalar no iPhone / iPad</div>
    <div class="form-card" style="padding:14px 16px">
      <p style="font-size:15px;color:var(--t-2);line-height:2.1">1. Abra no <strong>Safari</strong><br>2. Toque em <strong>â¬†ï¸ Compartilhar</strong><br>3. <strong>"Adicionar Ã  Tela de InÃ­cio"</strong></p>
    </div>
  </div>
</div><!-- /page-cfg -->

</div><!-- /scroller -->
</div><!-- /shell -->

<!-- PHONE TABBAR -->
<div class="tabbar">
  <button class="tab on" id="t-dash" onclick="nav('dash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>InÃ­cio<span id="tb-alert-badge" class="tab-badge" style="display:none">!</span></button>
  <button class="tab" id="t-txs" onclick="nav('txs')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>TransaÃ§Ãµes</button>
  <button class="tab" id="t-add" onclick="nav('add')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Novo</button>
  <button class="tab" id="t-rpt" onclick="nav('rpt')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>RelatÃ³rio</button>
  <button class="tab" id="t-cfg" onclick="nav('cfg')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Config</button>
</div>
</div><!-- /app -->

<!-- â•â•â• SHEETS â•â•â• -->
<!-- TX DETAIL SHEET -->
<div class="sheet-bg" id="tx-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title" id="sh-title">TransaÃ§Ã£o</div><button class="sheet-close" onclick="closeSheet('tx-sheet')">Fechar</button></div>
    <div id="sh-body"></div>
  </div>
</div>

<!-- CAT SHEET -->
<div class="sheet-bg" id="cat-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title">Nova Categoria</div><button class="sheet-close" onclick="closeSheet('cat-sheet')">Cancelar</button></div>
    <div style="padding:16px">
      <div class="form-card">
        <div class="field"><span class="field-label">Chave</span><input id="nc-key" placeholder="ex: excursao"></div>
        <div class="field"><span class="field-label">Nome</span><input id="nc-label" placeholder="ex: ExcursÃ£o"></div>
        <div class="field"><span class="field-label">Cor</span><input id="nc-color" type="color" value="#3B5BDB" style="width:44px;height:30px;border:none;background:none;cursor:pointer;-webkit-appearance:none;padding:0;margin-left:auto"></div>
      </div>
      <div style="margin-top:12px"><button class="btn primary" onclick="saveCat()">Criar Categoria</button></div>
    </div>
  </div>
</div>

<!-- PARTY SHEET -->
<div class="sheet-bg" id="party-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title" id="ps-title">Nova Parte</div><button class="sheet-close" onclick="closeSheet('party-sheet')">Cancelar</button></div>
    <div style="padding:16px">
      <input type="hidden" id="ps-id">
      <div class="form-card" style="margin-bottom:12px">
        <div class="field"><span class="field-label">Nome</span><input id="ps-name" placeholder="ex: AvÃ³, Tioâ€¦" maxlength="40"></div>
        <div class="field"><span class="field-label">Emoji</span>
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">
            <span id="ps-emoji-preview" style="font-size:22px">ğŸ‘¤</span>
            <button onclick="toggleEmojiPicker()" style="border:1px solid var(--sep);border-radius:var(--r);padding:5px 10px;background:var(--bg-2);font:500 12px/1 var(--f);cursor:pointer;color:var(--t-2)">Escolher</button>
          </div>
        </div>
      </div>
      <!-- Emoji Picker -->
      <div id="emoji-picker" style="display:none;background:var(--card);border:1px solid var(--sep-l);border-radius:var(--r2);margin-bottom:12px;overflow:hidden">
        <div style="padding:8px 12px;font-size:11px;font-weight:600;color:var(--t-3);border-bottom:1px solid var(--sep-l)">Escolher Ã­cone</div>
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>
      <input type="hidden" id="ps-emoji" value="ğŸ‘¤">
      <button class="btn primary" onclick="saveParty()">Salvar Parte</button>
      <div id="ps-del-wrap" style="margin-top:8px;display:none"><button class="btn destructive" onclick="deleteParty()">Excluir Parte</button></div>
    </div>
  </div>
</div>

<!-- FORECAST CONVERT SHEET -->
<div class="sheet-bg" id="convert-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title">âš¡ Converter PrevisÃ£o</div><button class="sheet-close" onclick="closeSheet('convert-sheet')">Cancelar</button></div>
    <div style="padding:16px">
      <p style="font-size:14px;color:var(--t-2);line-height:1.65;margin-bottom:16px">Confirme a data de pagamento e converta esta previsÃ£o em transaÃ§Ã£o realizada.</p>
      <div class="form-card" style="margin-bottom:16px">
        <div class="field"><span class="field-label">Data pgto.</span><input id="conv-date" type="date"></div>
        <div class="field"><span class="field-label">Valor (R$)</span><input id="conv-val" type="number" step="0.01"></div>
      </div>
      <input type="hidden" id="conv-id">
      <button class="btn green" onclick="confirmConvert()">âœ…&nbsp; Confirmar Pagamento</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â• JAVASCRIPT â•â•â• -->
<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHOOL LEDGER v5 â€” Engine
   IndexedDB v4: txs, cats, cfg, parties, ai_files
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ DB â”€â”€â”€ */
const DB_NAME = 'school-ledger-v5';
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, 4);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      ['txs','cats','cfg','parties','ai_files'].forEach(s => {
        if (!d.objectStoreNames.contains(s)) {
          const opts = (s === 'cats' || s === 'cfg') ? { keyPath: s==='cfg'?'k':'key' } : { keyPath:'id', autoIncrement:true };
          d.createObjectStore(s, opts);
        }
      });
    };
    req.onsuccess = e => { db = e.target.result; res(); };
    req.onerror   = e => rej(e.target.error);
  });
}

const dbAll   = s     => new Promise((res,rej) => { const r=db.transaction(s,'readonly').objectStore(s).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbGet   = (s,k) => new Promise((res,rej) => { const r=db.transaction(s,'readonly').objectStore(s).get(k); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbPut   = (s,v) => new Promise((res,rej) => { const r=db.transaction(s,'readwrite').objectStore(s).put(v); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbDel   = (s,k) => new Promise((res,rej) => { const r=db.transaction(s,'readwrite').objectStore(s).delete(k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
const dbClear = s     => new Promise((res,rej) => { const r=db.transaction(s,'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });

/* â”€â”€â”€ STATE â”€â”€â”€ */
const S = { year: new Date().getFullYear(), tab:'dash', cats:[], parties:[], editId:null, genBase:'last', accord:{type:'pct',pct:50,val:0} };
const MO = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MF = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CAT_PAID  = ['mensalidade','matricula','material','uniforme','extra'];
const CAT_RECV  = ['pensao'];
const CAT_ORDER = [...CAT_PAID,'pensao'];
const TODAY = new Date().toISOString().split('T')[0];
/* Forecast chart uses lighter pastel versions */
const FCST_COLORS = { mensalidade:'#818CF8', matricula:'#FB923C', material:'#2DD4BF', uniforme:'#A78BFA', extra:'#34D399', pensao:'#F87171' };

/* â”€â”€â”€ HELPERS â”€â”€â”€ */
const brl    = v => Math.abs(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const brlFmt = v => 'R$\u202F' + brl(v);  // full format for lists/reports
const brlK   = v => 'R$\u202F' + (Math.abs(v||0) >= 10000 ? (v/1000).toFixed(0)+'k' : Math.round(Math.abs(v||0)).toLocaleString('pt-BR')); // dashboard: no decimals, K only for large
const fmtD   = iso => { if(!iso)return 'â€”'; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
const $      = id => document.getElementById(id);
const isFuture = iso => iso && iso > TODAY;

function toast(msg, ms=2800){ const t=$('toast'); t.textContent=msg; t.classList.add('on'); clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('on'),ms); }
function catInfo(k){ return S.cats.find(c=>c.key===k)||{key:k,label:k,color:'#8E8E93'}; }
function catEmoji(k){ return {mensalidade:'ğŸ«',matricula:'ğŸ“',material:'ğŸ“š',uniforme:'ğŸ‘•',extra:'ğŸ­',pensao:'ğŸ’°'}[k]||'ğŸ“Œ'; }
function closeSheet(id){ $(id).classList.remove('open'); }

function partyLabel(tx){
  if(tx.partyId){ const p=S.parties.find(p=>Number(p.id)===Number(tx.partyId)); if(p) return (p.emoji?p.emoji+' ':'')+p.name; }
  const m={Me:'ğŸ‘¤ Eu',Father:'ğŸ‘¨ Pai',School:'ğŸ« Escola',Store:'ğŸª Loja',Other:'ğŸ‘¥ Outro'};
  return m[tx.party]||tx.party||'â€”';
}

function getAccordTarget(subtotal){
  const a = S.accord;
  if(a.type==='pct') return subtotal * (a.pct/100);
  return a.val || 0;
}

/* â”€â”€â”€ ALERTS: find overdue forecasts â”€â”€â”€ */
async function getOverdueForecasts(){
  const all = await dbAll('txs');
  return all.filter(r => r.type==='FORECAST' && r.date && r.date <= TODAY);
}

async function renderAlerts(containerId){
  const overdues = await getOverdueForecasts();
  const filtered = (S.year==='all') ? overdues : overdues.filter(r=>r.academicYear===S.year);
  const wrap = $(containerId); if(!wrap) return;
  // update badges
  const count = filtered.length;
  [$('tb-alert-badge'),$('sb-alert-badge')].forEach(el=>{ if(el){ el.style.display=count?'inline':'none'; el.textContent=count||''; } });
  if(!count){ wrap.style.display='none'; wrap.innerHTML=''; return; }
  wrap.style.display='block';
  wrap.innerHTML = filtered.slice(0,3).map(r => `
    <div class="alert-item" onclick="openConvertSheet(${r.id})">
      <div class="alert-icon">âš¡</div>
      <div class="alert-body">
        <div class="alert-title">PrevisÃ£o vencida â€” converter em pagamento</div>
        <div class="alert-desc">${catInfo(r.categoryKey).label} Â· ${fmtD(r.date)} Â· ${brlFmt(r.amount)}</div>
      </div>
      <div class="alert-cta">Converter â†’</div>
    </div>`).join('') +
    (filtered.length > 3 ? `<div style="padding:8px 14px;font-size:12px;color:var(--t-3)">+${filtered.length-3} outras previsÃµes vencidas</div>` : '');
}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€ */
function nav(tab){
  S.tab=tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('on'));
  $('page-'+tab).classList.add('on');
  const tb=$('t-'+tab); if(tb) tb.classList.add('on');
  const si=$('si-'+tab); if(si) si.classList.add('on');
  $('scroller').scrollTop=0;
  const hideYr = tab==='rpt'||tab==='cfg';
  const navYr = document.querySelector('.navbar .yr-badge'); if(navYr) navYr.style.display = hideYr?'none':'flex';
  $('nav-title').textContent = {dash:'School Ledger',txs:'TransaÃ§Ãµes',add:S.editId?'Editar':'Nova TransaÃ§Ã£o',rpt:'RelatÃ³rio',cfg:'ConfiguraÃ§Ãµes'}[tab]||'';
  if(tab==='dash'){ renderDash(); }
  if(tab==='txs') { renderTxList(); renderAlerts('tx-alerts'); }
  if(tab==='add' && !S.editId) resetForm();
  if(tab==='rpt') renderReport();
  if(tab==='cfg') renderCfg();
}

/* â”€â”€â”€ YEAR FILTER â”€â”€â”€ */
async function initYearFilter(){
  const rows = await dbAll('txs');
  const now  = new Date().getFullYear();
  let years = [...new Set(rows.map(r=>r.academicYear))].filter(Boolean);
  if(!years.includes(now)) years.push(now);
  years.sort((a,b)=>a-b);

  const opts = `<option value="all">Todos os anos</option>`+years.map(y=>`<option value="${y}">${y===now?y+' (atual)':y}</option>`).join('');
  const onChange = e => {
    S.year = e.target.value==='all' ? 'all' : +e.target.value;
    ['yr-sel','yr-sel-sb'].forEach(id=>{ const s=$(id); if(s) s.value=String(S.year); });
    if(S.tab==='dash') renderDash();
    if(S.tab==='txs')  renderTxList();
    if(S.tab==='rpt')  renderReport();
  };

  [$('yr-sel'),$('yr-sel-sb')].forEach(sel=>{ if(!sel) return; sel.innerHTML=opts; sel.value=String(now); sel.onchange=onChange; });

  const fy=$('f-year');
  if(fy){ fy.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); fy.value=now; }
  S.year=now;
}

/* â”€â”€â”€ CALC SUMMARY â”€â”€â”€ */
async function calcSummary(year){
  const rows = await dbAll('txs');
  const txs  = (year==='all'?rows:rows.filter(r=>r.academicYear===year)).filter(r=>r.type!=='FORECAST');
  const paid  = txs.filter(r=>r.type==='PAID').reduce((a,r)=>a+r.amount,0);
  const recv  = txs.filter(r=>r.type==='RECEIVED').reduce((a,r)=>a+r.amount,0);
  const late  = txs.filter(r=>r.isLate).length;
  const byCat = {};
  txs.forEach(r=>{ byCat[r.categoryKey]=(byCat[r.categoryKey]||0)+r.amount; });
  const byMonth = Array.from({length:12},()=>({}));
  txs.forEach(r=>{ const m=r.academicMonth-1; byMonth[m][r.categoryKey]=(byMonth[m][r.categoryKey]||0)+r.amount; });
  return {paid,recv,deficit:paid-recv,late,byCat,byMonth};
}

/* â”€â”€â”€ CALC FORECAST â”€â”€â”€ */
async function calcForecast(year){
  const rows = await dbAll('txs');
  const txs  = (year==='all'?rows:rows.filter(r=>r.academicYear===year)).filter(r=>r.type==='FORECAST');
  const total=txs.reduce((a,r)=>a+r.amount,0), count=txs.length;
  const byCat={}, byMonth=Array(12).fill(null).map(()=>({}));
  txs.forEach(r=>{ byCat[r.categoryKey]=(byCat[r.categoryKey]||0)+r.amount; byMonth[r.academicMonth-1][r.categoryKey]=(byMonth[r.academicMonth-1][r.categoryKey]||0)+r.amount; });
  return {total,count,byCat,byMonth};
}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
async function renderDash(){
  const [d,fc] = await Promise.all([calcSummary(S.year),calcForecast(S.year)]);
  const yrL = S.year==='all'?'Todos':S.year;

  // Accord
  const a = S.accord;
  const subtotal = (d.byCat.mensalidade||0)+(d.byCat.matricula||0)+(d.byCat.material||0)+(d.byCat.extra||0);
  const accordTarget = getAccordTarget(subtotal);
  const accordReal   = d.recv;
  const accordDiff   = accordReal - accordTarget;
  const accordPct    = subtotal>0?(accordReal/subtotal*100).toFixed(1):0;
  const agreedPct    = a.type==='pct'?a.pct:subtotal>0?(a.val/subtotal*100).toFixed(1):0;

  $('kpi-row').innerHTML=`
    <div class="kpi blue"><div class="kpi-label">Pago â€” ${yrL}</div><div class="kpi-value">${brlK(d.paid)}</div><div class="kpi-sub">${brlFmt(d.paid)}</div></div>
    <div class="kpi green"><div class="kpi-label">PensÃ£o â€” ${yrL}</div><div class="kpi-value">${brlK(d.recv)}</div><div class="kpi-sub">${d.late} com atraso</div></div>
    <div class="kpi ${d.deficit>0?'red':'green'}"><div class="kpi-label">DÃ©ficit â€” ${yrL}</div><div class="kpi-value">${d.deficit>0?'â€“':''}${brlK(d.deficit)}</div><div class="kpi-sub">descoberto</div></div>`;

  $('accord-kpi-wrap').innerHTML = accordTarget>0 ? `
    <div style="padding:12px 20px 0"><div style="font-size:10px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.07em">âš–ï¸ Acordo com o Pai</div></div>
    <div class="kpi-row" style="padding-top:6px">
      <div class="kpi green"><div class="kpi-label">Meta acordo</div><div class="kpi-value">${brlK(accordTarget)}</div><div class="kpi-sub">${a.type==='pct'?agreedPct+'% do subtotal':'Valor fixo acordado'}</div></div>
      <div class="kpi ${accordDiff>=0?'green':'red'}"><div class="kpi-label">Desvio acordo</div><div class="kpi-value">${accordDiff>=0?'+':'-'}${brlK(Math.abs(accordDiff))}</div><div class="kpi-sub">${accordPct}% real vs ${agreedPct}% meta</div></div>
    </div>` : '';

  const fw=$('fcst-kpi-wrap');
  if(fc.count>0){
    const topF=Object.entries(fc.byCat).sort((a,b)=>b[1]-a[1])[0];
    fw.innerHTML=`
      <div style="padding:12px 20px 0"><div style="font-size:10px;font-weight:600;color:var(--violet);text-transform:uppercase;letter-spacing:.07em">â—† PrevisÃµes Futuras</div></div>
      <div class="kpi-row" style="padding-top:6px">
        <div class="kpi violet fcst-kpi"><div class="kpi-label">â—† Total Previsto</div><div class="kpi-value">${brlK(fc.total)}</div><div class="kpi-sub">${fc.count} lanÃ§amento${fc.count>1?'s':''}</div></div>
        ${topF?`<div class="kpi violet fcst-kpi"><div class="kpi-label">â—† Maior PrevisÃ£o</div><div class="kpi-value" style="font-size:16px">${catInfo(topF[0]).label}</div><div class="kpi-sub">${brlK(topF[1])}</div></div>`:''}
      </div>`;
  } else fw.innerHTML='';

  requestAnimationFrame(()=>requestAnimationFrame(()=>drawCharts(d,fc)));
  await renderAlerts('dash-alerts');

  const allRows = await dbAll('txs');
  const recent  = (S.year==='all'?allRows:allRows.filter(r=>r.academicYear===S.year))
    .sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id).slice(0,5);
  $('recent-card').innerHTML = recent.length ? recent.map(txHTML).join('') : '<div class="empty-state"><div class="ic">ğŸ“­</div>Sem transaÃ§Ãµes</div>';
}

/* â”€â”€â”€ CHARTS â”€â”€â”€ */
function drawCharts(d,fc){
  const bc=d.byCat||{};
  const gt=Object.values(bc).reduce((a,v)=>a+v,0);
  const def=d.paid-d.recv;
  const hasFcst=fc&&fc.count>0;

  $('chart-area').innerHTML=`
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">VisÃ£o Geral â€” ${S.year==='all'?'Todos os anos':S.year}</div>
      <div style="display:flex;gap:10px">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv1" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Financiamento</div>
          <div style="width:100%;display:flex;flex-direction:column;gap:4px">
            <div class="leg-item"><div class="leg-swatch" style="background:#3B5BDB"></div>Eu<span class="leg-pct">${d.paid>0?(def/d.paid*100).toFixed(0):0}%</span></div>
            <div class="leg-item"><div class="leg-swatch" style="background:#C0392B"></div>Pai<span class="leg-pct">${d.paid>0?(d.recv/d.paid*100).toFixed(0):0}%</span></div>
          </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv2" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Categorias</div>
          <div id="pie2-leg" style="width:100%;display:flex;flex-direction:column;gap:4px"></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">Despesas Realizadas por MÃªs</div>
      <canvas id="cv3" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
        ${CAT_ORDER.map(k=>`<div class="leg-item"><div class="leg-swatch" style="background:${catInfo(k).color}"></div><span>${catInfo(k).label}</span></div>`).join('')}
      </div>
    </div>
    ${hasFcst?`<div class="card" style="margin:0 20px 12px;padding:16px;border-left:3px solid var(--violet)">
      <div class="chart-title" style="color:var(--violet)">â—† PrevisÃµes por Categoria / MÃªs</div>
      <canvas id="cv4" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
        ${CAT_ORDER.map(k=>`<div class="leg-item"><div class="leg-swatch" style="background:${FCST_COLORS[k]||'#ccc'}"></div><span>${catInfo(k).label}</span></div>`).join('')}
      </div>
    </div>`:''}`;

  donut('cv1',[{v:def,c:'#3B5BDB'},{v:d.recv,c:'#C0392B'}],'Total',brlK(d.paid).replace('R$\u202F',''),110);
  donut('cv2',CAT_ORDER.map(k=>({v:bc[k]||0,c:catInfo(k).color})),'Total',brlK(gt).replace('R$\u202F',''),110);
  $('pie2-leg').innerHTML=CAT_ORDER.map(k=>{ const v=bc[k]||0; if(!v)return ''; const p=gt>0?(v/gt*100).toFixed(0):0; return `<div class="leg-item"><div class="leg-swatch" style="background:${catInfo(k).color}"></div>${catInfo(k).label}<span class="leg-pct">${p}%</span></div>`; }).join('');
  barChart('cv3',d);
  if(hasFcst) barForecast('cv4',fc);
}

function donut(id,slices,lbl,val,SZ){
  const c=$(id); if(!c)return;
  const dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=SZ*dpr; c.height=SZ*dpr; c.style.width=SZ+'px'; c.style.height=SZ+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const cx=SZ/2,cy=SZ/2,R=SZ/2-7,r=SZ/2-23;
  const tot=slices.reduce((a,s)=>a+(s.v||0),0); if(!tot)return;
  let a=-Math.PI/2;
  slices.forEach(s=>{ if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a,a+sw); ctx.closePath(); ctx.fillStyle=s.c; ctx.fill(); a+=sw; });
  a=-Math.PI/2;
  slices.forEach(s=>{ if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.arc(cx,cy,R,a,a+sw); ctx.strokeStyle='#FAFAF9'; ctx.lineWidth=2.5; ctx.stroke(); a+=sw; });
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fillStyle='#FFF'; ctx.fill();
  ctx.textAlign='center';
  ctx.fillStyle='#71717A'; ctx.font=`500 8px Inter,sans-serif`; ctx.fillText(lbl,cx,cy-5);
  ctx.fillStyle='#000'; ctx.font=`600 11px 'SF Mono','Menlo','Consolas',monospace`; ctx.fillText(val,cx,cy+7);
}

function barChart(id,d){
  const c=$(id); if(!c)return;
  const par=c.parentElement, W=Math.max((par?(par.getBoundingClientRect().width||par.offsetWidth):320)-32,200);
  const H=100,dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const data=(d.byMonth||[]).map(m=>CAT_ORDER.map(k=>m[k]||0));
  const cols=CAT_ORDER.map(k=>catInfo(k).color);
  const pL=32,pB=16,pT=6,pR=2,cW=W-pL-pR,cH=H-pT-pB;
  const maxV=Math.max(...data.map(r=>r.reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/2000)*2000||2000;
  for(let i=0;i<=3;i++){ const y=pT+cH*(1-i/3); ctx.strokeStyle='rgba(0,0,0,.05)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke(); ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7px 'SF Mono','Menlo',monospace`; ctx.fillText((scale/3*i/1000).toFixed(0)+'k',pL-3,y+3); }
  const mW=cW/12,bW=mW*.72,bOff=(mW-bW)/2;
  data.forEach((cats,mi)=>{ const gx=pL+mi*mW+bOff; let yBase=pT+cH; cats.forEach((v,ci)=>{ if(!v)return; const bH=Math.max(1,(v/scale)*cH); yBase-=bH; ctx.fillStyle=cols[ci]; ctx.fillRect(gx,yBase,bW,bH); }); ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi],pL+mi*mW+mW/2,H-2); });
}

function barForecast(id,fc){
  const c=$(id); if(!c)return;
  const par=c.parentElement, W=Math.max((par?(par.getBoundingClientRect().width||par.offsetWidth):320)-32,200);
  const H=110,dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const data=fc.byMonth||Array(12).fill(null).map(()=>({}));
  const pL=32,pB=16,pT=6,pR=2,cW=W-pL-pR,cH=H-pT-pB;
  const maxV=Math.max(...data.map(m=>Object.values(m).reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/1000)*1000||1000;
  for(let i=0;i<=2;i++){ const y=pT+cH*(1-i/2); ctx.strokeStyle='rgba(124,58,237,.08)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke(); ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7px 'SF Mono','Menlo',monospace`; ctx.fillText((scale/2*i/1000).toFixed(0)+'k',pL-3,y+3); }
  const mW=cW/12,bW=mW*.72,bOff=(mW-bW)/2;
  data.forEach((cats,mi)=>{
    const gx=pL+mi*mW+bOff; let yBase=pT+cH;
    CAT_ORDER.forEach(k=>{ const v=cats[k]||0; if(!v)return; const bH=Math.max(1,(v/scale)*cH); yBase-=bH; ctx.fillStyle=FCST_COLORS[k]||'#aaa'; ctx.fillRect(gx,yBase,bW,bH); });
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi],pL+mi*mW+mW/2,H-2);
  });
}

/* â”€â”€â”€ TX LIST â”€â”€â”€ */
function txHTML(r){
  const ci=catInfo(r.categoryKey);
  const isFcst=r.type==='FORECAST';
  const out=r.type==='PAID';
  const pLabel=partyLabel(r);
  const isOverdue=isFcst&&r.date<=TODAY;
  const student=r.student&&r.student!=='Ambas'?`<span class="student-badge">${r.student}</span>`:'';
  const hasDoc=r.fileId?`<span title="Documento anexado" style="font-size:12px;color:var(--accent);margin-left:4px">ğŸ“</span>`:'';
  return `<div class="list-row${isFcst?' row-fcst':''}" onclick="openTxSheet(${r.id})">
    <div class="list-icon" style="background:${isFcst?'var(--violet-l)':ci.color+'1A'}">${isFcst?'â—†':catEmoji(r.categoryKey)}</div>
    <div class="list-body">
      <div class="list-name">${ci.label}${isFcst?'<span class="fcst-badge">PREV</span>':''}${isOverdue?'<span class="alert-badge">VENCIDA</span>':''}${student}${hasDoc}</div>
      <div class="tx-sub">${fmtD(r.date)} Â· ${MO[r.academicMonth-1]}/${r.academicYear} Â· ${pLabel}</div>
      ${r.notes?`<div class="tx-sub" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:240px">${r.notes}</div>`:''}
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div class="tx-amount ${isFcst?'fcst':out?'out':'in'}">${isFcst?'â‰ˆ':out?'â€“':'+'}${brl(r.amount)}</div>
      ${(!isFcst&&r.isLate)?`<div class="tx-late">â–  atraso</div>`:''}
      ${isOverdue?`<div class="tx-alert">âš¡ converter</div>`:''}
    </div>
  </div>`;
}

async function renderTxList(){
  const search = ($('tx-search').value||'').toLowerCase().trim();
  const type   = $('fil-type').value;
  const cat    = $('fil-cat').value;
  const student= $('fil-student').value;
  const allRows= await dbAll('txs');
  let rows = S.year==='all' ? allRows : allRows.filter(r=>r.academicYear===S.year);
  if(type)    rows=rows.filter(r=>r.type===type);
  if(cat)     rows=rows.filter(r=>r.categoryKey===cat);
  if(student) rows=rows.filter(r=>r.student===student||(student==='Ambas'&&(!r.student||r.student==='Ambas')));
  if(search)  rows=rows.filter(r=>{
    const ci=catInfo(r.categoryKey);
    return brl(r.amount).includes(search)||
      (r.notes||'').toLowerCase().includes(search)||
      ci.label.toLowerCase().includes(search)||
      partyLabel(r).toLowerCase().includes(search)||
      fmtD(r.date).includes(search)||
      (r.student||'').toLowerCase().includes(search);
  });
  rows.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const w=$('tx-wrap');
  if(!rows.length){ w.innerHTML='<div class="empty-state"><div class="ic">ğŸ“­</div>Nenhuma transaÃ§Ã£o encontrada</div>'; return; }
  // Group by month
  const groups={};
  rows.forEach(r=>{ const k=`${r.academicYear}-${String(r.academicMonth).padStart(2,'0')}`; (groups[k]=groups[k]||[]).push(r); });
  const sortedKeys=Object.keys(groups).sort((a,b)=>b.localeCompare(a));
  w.innerHTML=sortedKeys.map(k=>{
    const [yr,mo]=k.split('-');
    const total=groups[k].filter(r=>r.type!=='FORECAST').reduce((a,r)=>(r.type==='PAID'?a-r.amount:a+r.amount),0);
    return `<div style="padding:8px 20px 4px;font-size:11px;font-weight:600;color:var(--t-3);letter-spacing:.05em;text-transform:uppercase">${MF[+mo-1]} ${yr}</div>
    <div class="card" style="margin:0 20px 10px">${groups[k].map(txHTML).join('')}</div>`;
  }).join('');
}

function onSearch(){ $('search-clear').classList.toggle('show', !!$('tx-search').value); renderTxList(); }
function clearSearch(){ $('tx-search').value=''; $('search-clear').classList.remove('show'); renderTxList(); }

async function openTxSheet(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  const ci=catInfo(r.categoryKey);
  const isFcst=r.type==='FORECAST', out=r.type==='PAID';
  const pLabel=partyLabel(r);
  const isOverdue=isFcst&&r.date<=TODAY;
  $('sh-title').textContent=ci.label+(isFcst?' â—†':'')+(r.fileId?' ğŸ“':'');
  const shRow=(l,v)=>`<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 20px;border-bottom:.5px solid var(--sep-l)"><span style="font-size:14px;color:var(--t-3)">${l}</span><span style="font-size:14px;font-weight:500;text-align:right;max-width:60%">${v}</span></div>`;

  // Build document section HTML â€” filled in async below
  const docSectionId = 'sh-doc-'+id;

  $('sh-body').innerHTML=`
    <div style="text-align:center;padding:20px 0 14px">
      <div style="font-size:44px;margin-bottom:8px">${isFcst?'â—†':catEmoji(r.categoryKey)}</div>
      <div style="font:600 28px/1 var(--mono);color:${isFcst?'var(--violet)':out?'var(--red)':'var(--green)'}">${isFcst?'â‰ˆ':out?'â€“':'+'}${brlFmt(r.amount)}</div>
      <div style="font-size:13px;color:var(--t-2);margin-top:6px">${ci.label}${isFcst?' <span style="color:var(--violet);font-weight:600">PrevisÃ£o</span>':''}${r.student&&r.student!=='Ambas'?` Â· <span style="font-weight:600">${r.student}</span>`:''}</div>
      ${isOverdue?`<div style="margin-top:8px;padding:6px 14px;background:var(--amber-l);border-radius:100px;display:inline-block;font-size:12px;font-weight:600;color:var(--amber)">âš¡ PrevisÃ£o vencida â€” converter</div>`:''}
    </div>
    <div style="margin:0 20px;background:var(--bg-2);border-radius:12px;overflow:hidden">
      ${shRow('Data pagamento',r.isLate?`${fmtD(r.date)}<br><span style="font-size:10px;color:var(--red);font-weight:700">â–  Recebido com atraso</span>`:fmtD(r.date))}
      ${shRow('PerÃ­odo',MF[r.academicMonth-1]+' / '+r.academicYear)}
      ${shRow('Tipo',isFcst?'PrevisÃ£o futura':out?'Pago (saÃ­da)':'Recebido')}
      ${shRow('Parte',pLabel)}
      ${r.student?shRow('Aluna',r.student):''}
      ${r.notes?shRow('Notas',r.notes):''}
    </div>
    ${r.fileId ? `<div id="${docSectionId}" style="margin:12px 20px 0;border-radius:var(--r2);border:1.5px solid var(--sep-l);overflow:hidden;background:var(--card)">
      <div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-2);border-bottom:1px solid var(--sep-l)">
        <span id="${docSectionId}-ic" style="font-size:20px">ğŸ“</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--t-2)" id="${docSectionId}-name">Carregandoâ€¦</div>
          <div style="font-size:11px;color:var(--t-3);margin-top:1px" id="${docSectionId}-meta"></div>
        </div>
        <button id="${docSectionId}-dl" onclick="downloadTxFile(${r.fileId})" class="pill-btn blue" style="padding:7px 12px;font-size:12px">â¬‡ Baixar</button>
      </div>
      <div id="${docSectionId}-preview" style="max-height:320px;overflow-y:auto"></div>
    </div>` : ''}
    <div style="padding:16px;display:flex;flex-direction:column;gap:10px">
      ${isOverdue?`<button class="btn amber" onclick="openConvertSheet(${r.id});closeSheet('tx-sheet')">âš¡&nbsp; Converter em Pagamento</button>`:''}
      <button class="btn primary" onclick="editTx(${r.id});closeSheet('tx-sheet')">âœï¸&nbsp; Editar</button>
      <button class="btn secondary" onclick="copyTx(${r.id});closeSheet('tx-sheet')">ğŸ“‹&nbsp; Copiar / Duplicar</button>
      <button class="btn destructive" onclick="if(confirm('Excluir esta transaÃ§Ã£o?'))delTxById(${r.id})">ğŸ—‘&nbsp; Excluir</button>
    </div>`;

  $('tx-sheet').classList.add('open');

  // Async: load and render attached document
  if(r.fileId){
    try{
      const f = await dbGet('ai_files', Number(r.fileId));
      if(f){
        const icMap={pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',txt:'ğŸ“'};
        const ic=$(docSectionId+'-ic'); if(ic) ic.textContent=icMap[f.ext]||'ğŸ“';
        const nm=$(docSectionId+'-name'); if(nm) nm.textContent=f.name;
        const mt=$(docSectionId+'-meta'); if(mt) mt.textContent=(f.size/1024).toFixed(1)+' KB Â· '+new Date(f.storedAt).toLocaleDateString('pt-BR');
        const pv=$(docSectionId+'-preview');
        if(pv){
          if(f.ext==='pdf'){
            pv.innerHTML=`<embed src="${f.data}" type="application/pdf" style="width:100%;height:300px;border:none">`;
          } else if(['jpg','jpeg','png'].includes(f.ext)){
            pv.innerHTML=`<img src="${f.data}" style="width:100%;max-height:300px;object-fit:contain;display:block;padding:8px">`;
          } else if(f.ext==='txt'){
            // Show plain text content
            const raw=atob(f.data.split(',')[1]||'');
            pv.innerHTML=`<pre style="font:400 11px/1.6 var(--mono);padding:12px;white-space:pre-wrap;word-break:break-word;color:var(--t-2);max-height:260px;overflow-y:auto">${raw.replace(/</g,'&lt;').substring(0,3000)}${raw.length>3000?'\nâ€¦':''}</pre>`;
          }
        }
      }
    }catch(e){ console.warn('Doc load error:',e); }
  }
}

async function downloadTxFile(fileId){
  try{
    const f=await dbGet('ai_files', Number(fileId)); if(!f)return;
    const a=document.createElement('a');
    a.href=f.data; a.download=f.name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    toast('â¬‡ Download iniciado');
  }catch(e){ toast('âŒ Erro ao baixar arquivo'); }
}

async function delTxById(id){
  await dbDel('txs',id); closeSheet('tx-sheet'); toast('ğŸ—‘ ExcluÃ­do');
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

/* â”€â”€â”€ COPY TX â”€â”€â”€ */
async function copyTx(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r) return;
  // Check for exact duplicate (same type, amount, date, party/partyId)
  const dup=rows.find(x=>x.id!==id && x.amount===r.amount && x.type===r.type && x.date===r.date && (x.partyId===r.partyId && x.party===r.party));
  if(dup){ toast('âš ï¸ TransaÃ§Ã£o idÃªntica jÃ¡ existe!',3500); return; }
  // Clone without id (so new id is assigned), clear date to force review
  const clone={...r}; delete clone.id;
  clone.notes=(clone.notes?clone.notes+' ':'')+' (cÃ³pia)';
  clone.createdAt=new Date().toISOString(); clone.updatedAt=new Date().toISOString();
  S.editId=null;
  S.copyFrom=clone;
  nav('add');
}

/* â”€â”€â”€ CONVERT FORECAST SHEET â”€â”€â”€ */
async function openConvertSheet(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  $('conv-id').value=id;
  $('conv-date').value=TODAY;
  $('conv-val').value=r.amount;
  $('convert-sheet').classList.add('open');
}

async function confirmConvert(){
  const id=+$('conv-id').value;
  const date=$('conv-date').value; if(!date){toast('âš ï¸ Informe a data');return;}
  const amount=parseFloat($('conv-val').value); if(!amount){toast('âš ï¸ Informe o valor');return;}
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  const updated={...r, type:'PAID', date, amount, updatedAt:new Date().toISOString()};
  await dbPut('txs',updated);
  closeSheet('convert-sheet');
  toast('âœ… Convertida em pagamento!');
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

/* â”€â”€â”€ STUDENT SELECTOR â”€â”€â”€ */
function setStudent(v){
  $('f-student').value=v;
  ['lara','chloe','both'].forEach(k=>$('sb-'+k).classList.remove('on'));
  const map={Lara:'lara',Chloe:'chloe',Ambas:'both'};
  if(map[v]) $('sb-'+map[v]).classList.add('on');
}

/* â”€â”€â”€ FORM â”€â”€â”€ */
function onTypeChange(){
  const v=$('f-type').value;
  $('fcst-notice').classList.toggle('show',v==='FORECAST');
}

function onDateChange(){
  const d=$('f-date').value;
  if(!d) return;
  const notice=$('future-date-notice');
  if(isFuture(d)){
    $('f-type').value='FORECAST'; onTypeChange();
    notice.style.display='block';
  } else {
    notice.style.display='none';
    // Only reset if it was auto-set
    if($('f-type').value==='FORECAST' && notice.style.display==='none'){
      // Don't force-change back â€” user may have intentionally chosen FORECAST
    }
  }
}

async function resetForm(){
  S.editId=null;
  S._pendingFileId=null;
  S._existingFileId=null;
  const banner=$('existing-file-banner'); if(banner) banner.style.display='none';
  const clone=S.copyFrom; S.copyFrom=null;

  $('f-id').value=''; $('f-notes').value=''; $('f-tags').value='';
  $('fcst-notice').classList.remove('show');
  $('future-date-notice').style.display='none';
  $('del-btn').style.display='none';
  $('add-title').textContent='Nova TransaÃ§Ã£o';
  $('tog').classList.remove('on');

  if(clone){
    $('f-val').value=clone.amount;
    $('f-type').value=clone.type; onTypeChange();
    $('f-date').value=clone.date||TODAY;
    const fy=$('f-year'); if(fy) fy.value=clone.academicYear;
    $('f-month').value=clone.academicMonth;
    $('f-notes').value=clone.notes||'';
    $('f-tags').value=clone.tags||'';
    setStudent(clone.student||'Ambas');
    if(clone.isLate) $('tog').classList.add('on');
    await refreshPartySelect();
    if(clone.categoryKey) $('f-cat').value=clone.categoryKey;
    if(clone.partyId) $('f-party').value=String(clone.partyId);
    else if(clone.party) $('f-party').value=clone.party;
    toast('ğŸ“‹ TransaÃ§Ã£o copiada â€” revise e salve');
  } else {
    $('f-val').value='';
    $('f-type').value='PAID'; onTypeChange();
    $('f-date').value=TODAY;
    const yr=(S.year==='all')?new Date().getFullYear():S.year;
    const fy=$('f-year'); if(fy) fy.value=yr;
    $('f-month').value=new Date().getMonth()+1;
    setStudent('Ambas');
    await refreshPartySelect();
    if(S.cats.length) $('f-cat').value=S.cats[0].key;
  }
  resetAI();
}

async function editTx(id){
  S.editId=id; nav('add');
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  $('f-id').value=r.id; $('f-val').value=r.amount;
  $('f-type').value=r.type; onTypeChange();
  $('f-cat').value=r.categoryKey;
  $('f-date').value=r.date;
  const fy=$('f-year'); if(fy) fy.value=r.academicYear;
  $('f-month').value=r.academicMonth;
  $('f-notes').value=r.notes||''; $('f-tags').value=r.tags||'';
  if(r.isLate) $('tog').classList.add('on');
  $('del-btn').style.display='flex';
  $('add-title').textContent='Editar TransaÃ§Ã£o';
  setStudent(r.student||'Ambas');
  await refreshPartySelect();
  if(r.partyId) $('f-party').value=String(r.partyId);
  else if(r.party) $('f-party').value=r.party;
  $('future-date-notice').style.display='none';

  // Show existing file banner if tx has attached document
  S._existingFileId = r.fileId || null;
  const banner = $('existing-file-banner');
  if(r.fileId && banner){
    banner.style.display='block';
    try{
      const f = await dbGet('ai_files', Number(r.fileId));
      if(f){
        const icMap={pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',txt:'ğŸ“'};
        $('efb-ic').textContent = icMap[f.ext]||'ğŸ“';
        $('efb-name').textContent = f.name;
        $('efb-meta').textContent = (f.size/1024).toFixed(1)+' KB Â· '+new Date(f.storedAt).toLocaleDateString('pt-BR');
      }
    }catch(e){}
  } else if(banner){
    banner.style.display='none';
  }
}

async function saveTx(){
  const amount=parseFloat($('f-val').value);
  if(!amount||isNaN(amount)){toast('âš ï¸ Informe o valor');return;}
  const date=$('f-date').value; if(!date){toast('âš ï¸ Informe a data');return;}

  const partyVal=$('f-party').value;
  const partyId=/^\d+$/.test(partyVal)?+partyVal:null;
  const type=$('f-type').value;
  const student=$('f-student').value||'Ambas';

  // Duplicate check (for new TX only)
  if(!S.editId){
    const existing=await dbAll('txs');
    const dup=existing.find(x=>
      Math.abs(x.amount-amount)<0.01 && x.type===type && x.date===date &&
      (partyId ? x.partyId===partyId : x.party===partyVal) &&
      x.categoryKey===$('f-cat').value
    );
    if(dup){toast('âš ï¸ TransaÃ§Ã£o idÃªntica jÃ¡ existe! Verifique.',4000);return;}
  }

  const tx={
    amount, type, categoryKey:$('f-cat').value,
    partyId, party:partyId?null:partyVal,
    date, academicYear:+$('f-year').value, academicMonth:+$('f-month').value,
    isLate:$('tog').classList.contains('on'),
    student, notes:$('f-notes').value, tags:$('f-tags').value,
    fileId: S._pendingFileId || (S.editId ? undefined : null) || undefined,
    updatedAt:new Date().toISOString()
  };
  // Preserve existing fileId when editing (don't overwrite with null unless new file loaded)
  if(S.editId && !S._pendingFileId){
    const existing=await dbAll('txs');
    const orig=existing.find(x=>x.id===S.editId);
    if(orig?.fileId) tx.fileId=orig.fileId;
  }
  if(S.editId) tx.id=S.editId;
  else tx.createdAt=new Date().toISOString();

  await dbPut('txs',tx);
  S._pendingFileId = null;
  toast(S.editId?'âœ… Atualizado!':'âœ… Salvo!');
  S.editId=null; await initYearFilter(); nav('txs');
}

async function deleteTx(){
  if(!S.editId)return;
  if(!confirm('Excluir esta transaÃ§Ã£o?'))return;
  await dbDel('txs',S.editId); toast('ğŸ—‘ ExcluÃ­do'); S.editId=null;
  await initYearFilter(); nav('txs');
}

/* â”€â”€â”€ PARTIES CRUD â”€â”€â”€ */
async function loadParties(){ S.parties=await dbAll('parties'); }

async function refreshPartySelect(){
  await loadParties();
  const sel=$('f-party'); if(!sel)return;
  const cur=sel.value; sel.innerHTML='';
  [['Me','ğŸ‘¤ Eu (legado)'],['Father','ğŸ‘¨ Pai'],['School','ğŸ« Escola'],['Store','ğŸª Loja'],['Other','ğŸ‘¥ Outro']].forEach(([v,l])=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); });
  S.parties.forEach(p=>{ const o=document.createElement('option'); o.value=String(p.id); o.textContent=(p.emoji||'ğŸ‘¤')+' '+p.name; sel.appendChild(o); });
  if(cur) sel.value=cur;
}

async function addPartyInline(){
  const inp=$('f-new-party'), name=inp.value.trim();
  if(!name){toast('âš ï¸ Digite o nome');return;}
  await loadParties();
  if(S.parties.find(p=>p.name.toLowerCase()===name.toLowerCase())){toast('âš ï¸ Parte jÃ¡ existe');return;}
  const newId=await dbPut('parties',{name,emoji:'ğŸ‘¤',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
  inp.value=''; toast(`âœ… "${name}" adicionado`);
  await refreshPartySelect();
  $('f-party').value=String(newId);
}

/* â”€â”€ EMOJI PICKER â”€â”€ */
const EMOJI_SET=['ğŸ‘¤','ğŸ‘¨','ğŸ‘©','ğŸ‘´','ğŸ‘µ','ğŸ‘¦','ğŸ‘§','ğŸ§‘','ğŸ‘¶','ğŸ¤±','ğŸ‘ª','ğŸ‘¨â€ğŸ‘©â€ğŸ‘§','ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦','ğŸ«','ğŸ ','ğŸª','ğŸ¦','ğŸ¥','ğŸ­','ğŸ’','ğŸ“š','ğŸ“','ğŸ’°','ğŸ’³','ğŸ“','â­','ğŸŒŸ','âœ¨','ğŸ¤','ğŸ†','ğŸ¯','ğŸ“Œ','ğŸ“','ğŸ”‘','ğŸ…','ğŸŒº','ğŸŒ¸','ğŸ¦‹','ğŸ£','ğŸŒˆ'];

function toggleEmojiPicker(){
  const ep=$('emoji-picker');
  if(ep.style.display==='none'||!ep.style.display){
    if(!ep.querySelector('.emoji-btn')){
      $('emoji-grid').innerHTML=EMOJI_SET.map(e=>`<button class="emoji-btn" onclick="selectEmoji('${e}')">${e}</button>`).join('');
    }
    ep.style.display='block';
  } else {
    ep.style.display='none';
  }
}

function selectEmoji(e){
  $('ps-emoji').value=e;
  $('ps-emoji-preview').textContent=e;
  document.querySelectorAll('.emoji-btn').forEach(b=>b.classList.toggle('on',b.textContent===e));
  $('emoji-picker').style.display='none';
}

async function openPartySheet(editId){
  await loadParties();
  // editId may arrive as number (from JS call) or string (from onclick attr)
  const id = (editId !== null && editId !== undefined && editId !== '') ? Number(editId) : null;
  $('ps-id').value = (id != null) ? String(id) : '';
  $('ps-title').textContent = id ? 'Editar Parte' : 'Nova Parte';
  $('ps-del-wrap').style.display = id ? 'block' : 'none';
  $('emoji-picker').style.display = 'none';
  if(id){
    // Compare as numbers â€” IDB autoIncrement returns numbers
    const p = S.parties.find(p => Number(p.id) === id);
    if(p){
      $('ps-name').value = p.name;
      $('ps-emoji').value = p.emoji || 'ğŸ‘¤';
      $('ps-emoji-preview').textContent = p.emoji || 'ğŸ‘¤';
    } else {
      toast('âš ï¸ Parte nÃ£o encontrada');
      return;
    }
  } else {
    $('ps-name').value = '';
    $('ps-emoji').value = 'ğŸ‘¤';
    $('ps-emoji-preview').textContent = 'ğŸ‘¤';
  }
  $('party-sheet').classList.add('open');
}

async function saveParty(){
  const name = $('ps-name').value.trim();
  if(!name){ toast('âš ï¸ Informe o nome da parte'); return; }
  const emoji  = $('ps-emoji').value || 'ğŸ‘¤';
  const rawId  = $('ps-id').value;
  const editId = rawId ? Number(rawId) : null;
  const rec    = { name, emoji, updatedAt: new Date().toISOString() };
  if(editId) rec.id = editId;
  else rec.createdAt = new Date().toISOString();
  await dbPut('parties', rec);
  toast(editId ? 'âœ… Parte atualizada!' : 'âœ… Parte criada!');
  closeSheet('party-sheet');
  await loadParties(); await refreshPartySelect(); renderCfg();
}

async function deleteParty(){
  const rawId = $('ps-id').value;
  if(!rawId){ toast('âš ï¸ Nenhuma parte selecionada'); return; }
  const editId = Number(rawId);
  if(!editId || isNaN(editId)){ toast('âš ï¸ ID invÃ¡lido'); return; }
  if(!confirm('Excluir esta parte?')) return;
  try{
    await dbDel('parties', editId);
    toast('ğŸ—‘ Parte removida');
    closeSheet('party-sheet');
    await loadParties(); await refreshPartySelect(); renderCfg();
  } catch(e){
    console.error('deleteParty:', e);
    toast('âŒ Erro: ' + (e.message || e));
  }
}

/* â”€â”€â”€ REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Columns: MÃªs | Mensalidade | MatrÃ­cula | Material | Uniforme | Extra | SUBTOTAL | PensÃ£o | Data Pgto | DiferenÃ§a | %Pai | Acordo | â—†Prev.Pago | â—†Prev.Recv
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderReport(){
  const allRows=await dbAll('txs');
  const accord=S.accord;
  let years;
  if(S.year==='all') years=[...new Set(allRows.map(r=>r.academicYear))].filter(Boolean).sort((a,b)=>a-b);
  else years=[S.year];
  if(!years.length){$('rpt-content').innerHTML='<div class="empty-state"><div class="ic">ğŸ“‹</div>Sem dados</div>';return;}

  let html='', gP=0, gR=0, gFcstP=0, gFcstR=0;

  for(const yr of years){
    const yrTxs=allRows.filter(r=>r.academicYear===yr);
    const confirmed=yrTxs.filter(r=>r.type!=='FORECAST');
    const forecasts=yrTxs.filter(r=>r.type==='FORECAST');

    const byMonth={};      // paid cats per month
    const pensaoByM={};    // recv per month
    const lateByM={};      // late flag per month
    const payDateByM={};   // latest payment date per month
    const fcstPaidByM={};  // forecast paid per month (per cat)
    const fcstRecvByM={};  // forecast recv per month

    confirmed.filter(r=>r.type==='PAID').forEach(r=>{
      const m=r.academicMonth;
      if(!byMonth[m]) byMonth[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};
      if(byMonth[m][r.categoryKey]!==undefined) byMonth[m][r.categoryKey]+=r.amount;
    });
    confirmed.filter(r=>r.categoryKey==='pensao'&&r.type==='RECEIVED').forEach(r=>{
      const m=r.academicMonth;
      pensaoByM[m]=(pensaoByM[m]||0)+r.amount;
      if(r.isLate) lateByM[m]=true;
      if(!payDateByM[m]||r.date>payDateByM[m]) payDateByM[m]=r.date;
    });
    forecasts.filter(r=>r.type==='FORECAST'&&r.categoryKey!=='pensao').forEach(r=>{
      const m=r.academicMonth;
      if(!fcstPaidByM[m]) fcstPaidByM[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};
      if(fcstPaidByM[m][r.categoryKey]!==undefined) fcstPaidByM[m][r.categoryKey]+=r.amount;
    });
    forecasts.filter(r=>r.type==='FORECAST'&&r.categoryKey==='pensao').forEach(r=>{
      const m=r.academicMonth;
      fcstRecvByM[m]=(fcstRecvByM[m]||0)+r.amount;
    });

    let rowsHtml='';
    let tot={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0,sub:0,recv:0,diff:0};
    let yrFcstP=0, yrFcstR=0;

    for(let m=1;m<=12;m++){
      const cats=byMonth[m]||{};
      const recv=pensaoByM[m]||0;
      const late=lateByM[m]||false;
      const payD=payDateByM[m];
      const fcP=fcstPaidByM[m]||{};
      const fcR=fcstRecvByM[m]||0;
      const sub=(cats.mensalidade||0)+(cats.matricula||0)+(cats.material||0)+(cats.uniforme||0)+(cats.extra||0);
      const diff=sub-recv;
      const pct=sub>0?(recv/sub*100):0;
      const accordTarget=getAccordTarget(sub);
      const accordDiff=recv-accordTarget;

      if(S.year==='all'&&sub===0&&recv===0&&Object.values(fcP).every(v=>v===0)&&!fcR) continue;

      tot.mensalidade+=(cats.mensalidade||0); tot.matricula+=(cats.matricula||0);
      tot.material+=(cats.material||0); tot.uniforme+=(cats.uniforme||0);
      tot.extra+=(cats.extra||0); tot.sub+=sub; tot.recv+=recv; tot.diff+=diff;
      const fcPtot=Object.values(fcP).reduce((a,b)=>a+b,0);
      yrFcstP+=fcPtot; yrFcstR+=fcR;

      const dateCell=recv>0?`${fmtD(payD||'')}${late?`<span class="late-tag">â–  atraso</span>`:''}`:'â€”';
      // %Pai coloring: red if below accord, green if above, blue if equal (within 0.5%)
      let pctClass='';
      if(accordTarget>0){
        const diff2=pct-(accordTarget/sub*100);
        if(diff2>0.5) pctClass='pct-ok';
        else if(diff2<-0.5) pctClass='pct-bad';
        else pctClass='pct-equal';
      }
      const pctCell=sub>0?`<span class="${pctClass}">${pct.toFixed(1)}%</span>`:'â€”';
      const accordCell=accordTarget>0?`<span class="${recv>=accordTarget?'recv':'neg'}">${brl(accordTarget)}</span>`:'â€”';

      rowsHtml+=`<tr>
        <td>${MF[m-1]}</td>
        <td class="r">${cats.mensalidade?brl(cats.mensalidade):'â€”'}</td>
        <td class="r">${cats.matricula?brl(cats.matricula):'â€”'}</td>
        <td class="r">${cats.material?brl(cats.material):'â€”'}</td>
        <td class="r">${cats.uniforme?brl(cats.uniforme):'â€”'}</td>
        <td class="r">${cats.extra?brl(cats.extra):'â€”'}</td>
        <td class="r subtotal-col">${sub?brl(sub):'â€”'}</td>
        <td class="r recv">${recv?brl(recv):'â€”'}</td>
        <td class="r" style="min-width:110px">${dateCell}</td>
        <td class="r ${diff>0?'neg':'recv'}">${diff!==0?(diff>0?'â€“':'+')+brl(Math.abs(diff)):'â€”'}</td>
        <td class="r">${pctCell}</td>
        <td class="r accord-col">${accordCell}</td>
        <td class="r fcst-col">${fcPtot?'â‰ˆ'+brl(fcPtot):'<span style="color:var(--t-5)">â€”</span>'}</td>
        <td class="r fcst-col">${fcR?'â‰ˆ'+brl(fcR):'<span style="color:var(--t-5)">â€”</span>'}</td>
      </tr>`;
    }

    gP+=tot.sub; gR+=tot.recv; gFcstP+=yrFcstP; gFcstR+=yrFcstR;
    const tPct=tot.sub>0?(tot.recv/tot.sub*100).toFixed(1)+'%':'â€”';
    const tAccord=getAccordTarget(tot.sub);

    html+=`<div class="rpt-card">
      <div class="rpt-yr-hdr"><h3>${yr}</h3><span>${brl(tot.sub)}</span></div>
      <div class="rpt-scroll"><table class="rtbl">
      <colgroup>
        <col class="c-mes"><col class="c-val"><col class="c-val"><col class="c-val"><col class="c-val"><col class="c-val">
        <col class="c-sub"><col class="c-pens"><col class="c-date"><col class="c-diff"><col class="c-pct">
        <col class="c-acc"><col class="c-fcst"><col class="c-fcst">
      </colgroup>
      <thead><tr>
        <th>MÃªs</th><th>Mensalidade</th><th>MatrÃ­cula</th><th>Material</th><th>Uniforme</th><th>Extra</th>
        <th class="subtotal-col" style="border-left:2px solid rgba(255,255,255,.2)">Subtotal</th>
        <th>PensÃ£o</th><th>Data Pagamento</th><th>DiferenÃ§a</th><th>% Pai</th>
        <th class="accord-h">Acordado</th>
        <th class="fcst-h">â—† Prev. Pago</th>
        <th class="fcst-h">â—† Prev. Recv.</th>
      </tr></thead>
      <tbody>${rowsHtml}
        <tr class="total-row">
          <td>TOTAL ${yr}</td>
          <td class="r">${brl(tot.mensalidade)}</td>
          <td class="r">${tot.matricula?brl(tot.matricula):'â€”'}</td>
          <td class="r">${tot.material?brl(tot.material):'â€”'}</td>
          <td class="r">${tot.uniforme?brl(tot.uniforme):'â€”'}</td>
          <td class="r">${tot.extra?brl(tot.extra):'â€”'}</td>
          <td class="r subtotal-col">${brl(tot.sub)}</td>
          <td class="r recv">${brl(tot.recv)}</td><td class="r">â€”</td>
          <td class="r neg">â€“${brl(Math.abs(tot.diff))}</td>
          <td class="r ${tPct!=='â€”'?((tot.recv/tot.sub)>=(tAccord/tot.sub||.5)?'pct-ok':'pct-bad'):''}">${tPct}</td>
          <td class="r accord-col">${tAccord?brl(tAccord):'â€”'}</td>
          <td class="r fcst-col">${yrFcstP?'â‰ˆ'+brl(yrFcstP):'â€”'}</td>
          <td class="r fcst-col">${yrFcstR?'â‰ˆ'+brl(yrFcstR):'â€”'}</td>
        </tr>
      </tbody></table></div>
    </div>`;
  }

  const gD=gP-gR, gPct=gP>0?(gR/gP*100).toFixed(1):0;
  const gtHtml=`<div class="gt-strip confirmed">
    <div class="gt-cell"><div class="gt-label">Total Pago</div><div class="gt-value">${brl(gP)}</div></div>
    <div class="gt-cell"><div class="gt-label">PensÃ£o Recebida</div><div class="gt-value warn">${brl(gR)}</div></div>
    <div class="gt-cell"><div class="gt-label">DÃ©ficit</div><div class="gt-value danger">â€“${brl(gD)}</div></div>
    <div class="gt-cell"><div class="gt-label">Cobertura Pai</div><div class="gt-value warn">${gPct}%</div></div>
  </div>`;
  const fcHtml=(gFcstP+gFcstR)>0?`<div class="gt-strip forecast">
    <div class="gt-cell"><div class="gt-label">â—† Prev. Pago</div><div class="gt-value">â‰ˆ${brl(gFcstP)}</div></div>
    <div class="gt-cell"><div class="gt-label">â—† Prev. Recebido</div><div class="gt-value">â‰ˆ${brl(gFcstR)}</div></div>
    <div class="gt-cell"><div class="gt-label">â—† Total Previsto</div><div class="gt-value">â‰ˆ${brl(gFcstP+gFcstR)}</div></div>
    <div class="gt-cell"><div class="gt-label">LanÃ§amentos</div><div class="gt-value">${allRows.filter(r=>r.type==='FORECAST'&&(S.year==='all'||r.academicYear===S.year)).length}</div></div>
  </div>`:'';
  $('rpt-content').innerHTML=gtHtml+fcHtml+html;
}

async function printReport(){
  // Navigate to report tab so it's rendered and visible
  if(S.tab !== 'rpt'){
    nav('rpt');
    await new Promise(r=>setTimeout(r,400));
  } else if(!$('rpt-content').querySelector('.rpt-card')){
    await renderReport();
    await new Promise(r=>setTimeout(r,300));
  }
  $('page-rpt').setAttribute('data-print-date', new Date().toLocaleDateString('pt-BR'));
  // Add body class that print CSS uses to ensure correct page visibility
  document.body.classList.add('printing');
  await new Promise(r=>setTimeout(r,100));
  window.print();
  // Remove class after print dialog closes
  setTimeout(()=>document.body.classList.remove('printing'), 1000);
}

async function exportCSV(){
  const rows=await dbAll('txs');
  const txs=rows.filter(r=>S.year==='all'||r.academicYear===S.year).sort((a,b)=>b.date.localeCompare(a.date));
  const hdr='Data,Tipo,PrevisÃ£o,Categoria,Parte,Aluna,Valor,Atraso,Ano,Mes,Notas,Tags';
  const lines=txs.map(r=>[r.date,r.type,r.type==='FORECAST'?'Sim':'NÃ£o',r.categoryKey,partyLabel(r),r.student||'',r.amount,r.isLate?'Sim':'NÃ£o',r.academicYear,r.academicMonth,`"${(r.notes||'').replace(/"/g,'""')}"`,r.tags||''].join(','));
  const blob=new Blob(['\uFEFF'+[hdr,...lines].join('\r\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`ledger-${S.year}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ“¥ CSV exportado!');
}

/* â”€â”€â”€ SETTINGS â”€â”€â”€ */
async function renderCfg(){
  const [cats,rows,parties,aiFiles]=[await dbAll('cats'),await dbAll('txs'),await dbAll('parties'),await dbAll('ai_files')];
  S.cats=cats; S.parties=parties;
  const years=[...new Set(rows.map(r=>r.academicYear))].filter(Boolean).sort((a,b)=>a-b);

  $('party-list-wrap').innerHTML=S.parties.length
    ? S.parties.map(p=>`<div class="list-row">
        <div class="list-icon" style="background:var(--accent-l);font-size:18px">${p.emoji||'ğŸ‘¤'}</div>
        <div class="list-body"><div class="list-name">${p.name}</div><div class="tx-sub">${p.emoji||'ğŸ‘¤'}</div></div>
        <button onclick="openPartySheet(${p.id})" style="border:none;background:none;color:var(--accent);font-size:17px;padding:6px 10px;cursor:pointer">âœï¸</button>
      </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-3)">Nenhuma parte cadastrada</div>';

  $('cat-list-wrap').innerHTML=cats.length
    ? cats.map(c=>`<div class="list-row" id="cat-row-${c.key}">
        <label title="Alterar cor" style="cursor:pointer;position:relative;flex-shrink:0">
          <div class="list-icon" style="background:${c.color}1A;border:2px solid ${c.color};transition:transform .15s" onmouseenter="this.style.transform='scale(1.15)'" onmouseleave="this.style.transform=''">
            <div style="width:14px;height:14px;border-radius:4px;background:${c.color}"></div>
          </div>
          <input type="color" value="${c.color}" title="Alterar cor"
            style="position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer"
            oninput="previewCatColor('${c.key}',this.value)"
            onchange="saveCatColor('${c.key}',this.value)">
        </label>
        <div class="list-body">
          <div class="list-name">${c.label}${c.system?'<span style="font-size:10px;color:var(--t-4);background:var(--fill);border-radius:6px;padding:2px 6px;margin-left:6px;font-weight:400">sistema</span>':''}</div>
          <div class="tx-sub" style="font-family:var(--mono)">${c.color}</div>
        </div>
        ${!c.system?`<button onclick="delCat('${c.key}')" style="border:none;background:none;color:var(--red);font-size:17px;padding:6px 10px;cursor:pointer">ğŸ—‘</button>`:''}
      </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-3)">Nenhuma categoria</div>';

  $('stat-count').textContent=rows.length+' transaÃ§Ãµes';
  $('stat-years').textContent=years.length?years.join(', '):'â€”';
  $('stat-files').textContent=aiFiles.length+' arquivo'+( aiFiles.length!==1?'s':'' );

  // Accord config UI
  const a=S.accord;
  $('cfg-accord-type').value=a.type||'pct';
  $('cfg-accord-pct').value=a.pct||50;
  $('cfg-accord-val').value=a.val||0;
  onAccordTypeChange();
  populateCatSelects();
}

function onAccordTypeChange(){
  const t=$('cfg-accord-type').value;
  $('cfg-accord-pct-row').style.display=t==='pct'?'flex':'none';
  $('cfg-accord-val-row').style.display=t==='fixed'?'flex':'none';
}

async function saveAccordConfig(){
  const type=$('cfg-accord-type').value;
  const pct=parseFloat($('cfg-accord-pct').value)||50;
  const val=parseFloat($('cfg-accord-val').value)||0;
  S.accord={type,pct,val};
  await dbPut('cfg',{k:'accord',type,pct,val});
  toast('âœ… Acordo salvo!');
  if(S.tab==='dash') renderDash();
  if(S.tab==='rpt')  renderReport();
}

async function loadAccordConfig(){
  const rec=await dbGet('cfg','accord');
  if(rec) S.accord={type:rec.type||'pct',pct:rec.pct||50,val:rec.val||0};
}

/* â”€â”€â”€ GENERATE FORECASTS â”€â”€â”€ */
let _genBase='last';
function setGenBase(v){
  _genBase=v;
  $('gen-base-last').classList.toggle('on',v==='last');
  $('gen-base-avg').classList.toggle('on',v==='avg');
}

async function generateForecasts(){
  const genType=$('gen-type').value;
  const now=new Date(); const curYear=now.getFullYear(); const curMonth=now.getMonth()+1;
  const all=await dbAll('txs');
  const yrTxs=all.filter(r=>r.academicYear===curYear);

  async function getBaseValue(catKey){
    const paid=yrTxs.filter(r=>r.categoryKey===catKey&&r.type!=='FORECAST'&&(catKey==='pensao'?r.type==='RECEIVED':r.type==='PAID'));
    if(!paid.length) return null;
    if(_genBase==='last'){
      const sorted=paid.sort((a,b)=>b.date.localeCompare(a.date));
      return sorted[0].amount;
    }
    return paid.reduce((s,r)=>s+r.amount,0)/paid.length;
  }

  const cats=[];
  if(genType==='both'||genType==='mensalidade') cats.push({key:'mensalidade',type:'PAID'});
  if(genType==='both'||genType==='pensao')     cats.push({key:'pensao',type:'RECEIVED'});

  // Resolve party ids
  const decio = S.parties.find(p=>p.name==='DÃ©cio e Bruna');
  const father = S.parties.find(p=>p.name==='Pai')||null;

  let created=0, skipped=0;
  for(const {key,type} of cats){
    const baseAmt=await getBaseValue(key);
    if(!baseAmt){toast(`âš ï¸ Sem histÃ³rico para ${key}`);continue;}

    // Party assignment: mensalidade â†’ DÃ©cio e Bruna, pensÃ£o â†’ Father legacy
    const partyId = key==='pensao' ? (father?.id||null) : (decio?.id||null);
    const partyStr = key==='pensao' ? (father?null:'Father') : (decio?null:'Me');

    for(let m=curMonth+1;m<=12;m++){
      const exists=all.find(r=>r.type==='FORECAST'&&r.categoryKey===key&&r.academicYear===curYear&&r.academicMonth===m);
      if(exists){skipped++;continue;}
      const date=`${curYear}-${String(m).padStart(2,'0')}-05`;
      await dbPut('txs',{
        amount:Math.round(baseAmt*100)/100, type:'FORECAST', categoryKey:key,
        partyId, party: partyId ? null : partyStr,
        date, academicYear:curYear, academicMonth:m,
        isLate:false, student:'Ambas',
        notes:`${catInfo(key).label} ${MF[m-1]}/${curYear} (previsÃ£o auto)`,
        tags:`${key},forecast,auto`,
        createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
      });
      created++;
    }
  }
  toast(`â—† ${created} previsÃ£o(Ãµes) criada(s)${skipped?`, ${skipped} jÃ¡ existia(m)`:''}`);
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

function populateCatSelects(){
  ['f-cat','fil-cat'].forEach(id=>{
    const s=$(id); if(!s)return;
    const cur=s.value;
    s.innerHTML=id==='fil-cat'?'<option value="">Todas categorias</option>':'';
    S.cats.forEach(c=>{ const o=document.createElement('option'); o.value=c.key; o.textContent=c.label; s.appendChild(o); });
    if(cur) s.value=cur;
  });
}

async function loadCats(){ S.cats=await dbAll('cats'); populateCatSelects(); }

async function saveCat(){
  const key=($('nc-key').value||'').trim().toLowerCase().replace(/\s+/g,'_');
  const label=($('nc-label').value||'').trim();
  const color=$('nc-color').value;
  if(!key||!label){toast('âš ï¸ Preencha chave e nome');return;}
  await dbPut('cats',{key,label,color,system:false});
  toast('âœ… Categoria criada!'); closeSheet('cat-sheet');
  $('nc-key').value=''; $('nc-label').value='';
  await loadCats(); renderCfg();
}

async function delCat(key){
  if(!confirm(`Excluir categoria "${key}"?`))return;
  await dbDel('cats',key); await loadCats(); renderCfg();
}

/* Live-preview color while dragging the picker */
function previewCatColor(key, color){
  const row = $('cat-row-'+key); if(!row) return;
  const icon  = row.querySelector('.list-icon');
  const swatch= row.querySelector('.list-icon div');
  const sub   = row.querySelector('.tx-sub');
  if(icon)  { icon.style.background=color+'1A'; icon.style.borderColor=color; }
  if(swatch){ swatch.style.background=color; }
  if(sub)   { sub.textContent=color; }
}

/* Persist color on picker close */
async function saveCatColor(key, color){
  const cat = S.cats.find(c=>c.key===key); if(!cat) return;
  cat.color = color;
  await dbPut('cats', cat);
  await loadCats();
  toast(`ğŸ¨ Cor de "${cat.label}" atualizada`);
  // Refresh charts/dashboard if visible
  if(S.tab==='dash') renderDash();
  if(S.tab==='rpt')  renderReport();
}

async function clearAll(){
  if(!confirm('Apagar TODOS os dados? NÃ£o pode ser desfeito.'))return;
  await dbClear('txs'); await initYearFilter(); renderCfg(); toast('ğŸ—‘ Dados removidos');
}

/* â”€â”€â”€ JSON EXPORT / IMPORT â”€â”€â”€ */
async function exportJSON(){
  const [txs,cats,parties]=[await dbAll('txs'),await dbAll('cats'),await dbAll('parties')];
  const cfg=await dbGet('cfg','accord');
  const payload={meta:{version:'5.0',school:'ColÃ©gio Objectivo',exportedAt:new Date().toISOString()},config:{accord:cfg||{}},categories:cats,parties,transactions:txs};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`school-ledger-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ’¾ Backup exportado!');
}

async function importJSON(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const p=JSON.parse(e.target.result);
      if(!Array.isArray(p.transactions)) throw new Error('"transactions" ausente');
      if(!confirm(`Importar ${p.transactions.length} transaÃ§Ãµes? Os dados atuais serÃ£o substituÃ­dos.`))return;
      await dbClear('txs');
      for(const tx of p.transactions) await dbPut('txs',tx);
      if(Array.isArray(p.categories)) for(const c of p.categories) await dbPut('cats',c);
      if(Array.isArray(p.parties))    for(const pt of p.parties)   await dbPut('parties',pt);
      if(p.config?.accord) await dbPut('cfg',{k:'accord',...p.config.accord});
      const msg=$('imp-msg');
      msg.textContent=`âœ… ${p.transactions.length} transaÃ§Ãµes importadas!`;
      msg.style.cssText='display:block;background:var(--green-l);color:var(--green);border-radius:var(--r);padding:12px 14px;font-size:13px;font-weight:500';
      await loadAccordConfig(); await loadCats(); await loadParties(); await initYearFilter();
      renderCfg(); toast('âœ… ImportaÃ§Ã£o concluÃ­da!',3500);
    }catch(err){
      const msg=$('imp-msg');
      msg.textContent='âŒ Erro: '+err.message;
      msg.style.cssText='display:block;background:var(--red-l);color:var(--red);border-radius:var(--r);padding:12px 14px;font-size:13px;font-weight:500';
    }
  };
  reader.readAsText(file);
}

/* â”€â”€â”€ AI â€” LOCAL PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LÃª relatÃ³rio de pagamento escolar ColÃ©gio Objectivo.
   Mapeamento especÃ­fico do documento PDF:
     "Valor pago" â†’ amount
     "Data de processamento" (linha Aprovado) â†’ date (Data do Pagamento)
     "Ano/MÃªs" â†’ academicYear + academicMonth
     "Aluno" â†’ student (Lara / Chloe / Ambas)
     Tipo â†’ sempre PAID (SaÃ­da)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _aiFile=null, _aiText=null;

function resetAI(){
  _aiFile=null; _aiText=null;
  $('ai-file').value='';
  $('ai-idle').style.display='block'; $('ai-file-info').style.display='none';
  const btn=$('ai-run-btn'); btn.disabled=true; btn.style.cssText='';
  $('ai-run-ic').textContent='âœ¦'; $('ai-run-txt').textContent='Interpretar com IA';
  $('ai-status').textContent=''; $('ai-result').style.display='none';
  document.querySelectorAll('.ai-hi').forEach(e=>e.classList.remove('ai-hi'));
}

function onAiDrop(e){ e.preventDefault(); $('ai-drop').classList.remove('drag'); const f=e.dataTransfer.files[0]; if(f) loadAiFile(f); }

async function loadAiFile(f){
  if(!f)return;
  const ext=(f.name.split('.').pop()||'').toLowerCase();
  if(!['pdf','jpg','jpeg','png','txt'].includes(ext)){toast('âŒ Use PDF, JPG, PNG ou TXT');return;}
  if(f.size>15*1024*1024){toast('âŒ Arquivo > 15 MB');return;}
  _aiFile=f;
  $('ai-idle').style.display='none'; $('ai-file-info').style.display='flex';
  $('ai-file-ic').textContent={pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',txt:'ğŸ“'}[ext]||'ğŸ“';
  $('ai-file-nm').textContent=f.name; $('ai-file-sz').textContent=(f.size/1024).toFixed(1)+' KB';
  $('ai-run-btn').disabled=false;
  // Pre-read text for PDF/TXT so we can parse it
  if(ext==='txt'||ext==='pdf'){
    await new Promise(resolve=>{
      const reader=new FileReader();
      reader.onload=ev=>{ _aiText=ev.target.result; resolve(); };
      reader.readAsText(f,'utf-8');
    });
  }
  // Store file in ai_files and capture the generated id
  try{
    const reader=new FileReader();
    reader.onload=async ev=>{
      const newId=await dbPut('ai_files',{name:f.name,size:f.size,type:f.type,ext,data:ev.target.result,storedAt:new Date().toISOString()});
      S._pendingFileId=newId; // link to transaction on save
    };
    reader.readAsDataURL(f);
  }catch(e){}
}

function clearAiFile(e){ e.stopPropagation(); resetAI(); }

async function runAI(){
  if(!_aiFile){toast('âš ï¸ Selecione um arquivo');return;}
  const btn=$('ai-run-btn'); btn.disabled=true;
  $('ai-run-ic').innerHTML='<span class="spinner"></span>'; $('ai-run-txt').textContent='Analisandoâ€¦';
  $('ai-status').textContent='Processando localmenteâ€¦';
  await new Promise(r=>setTimeout(r,40));
  try{
    const result=localAIParse(_aiText||'',_aiFile.name);
    applyAI(result);
  }catch(err){
    toast('âŒ '+err.message,4000);
    btn.disabled=false; $('ai-run-ic').textContent='âœ¦'; $('ai-run-txt').textContent='Tentar novamente';
    $('ai-status').textContent='';
  }
}

function localAIParse(text,filename){
  const t=text||'';

  /* â”€â”€ RelatÃ³rio de Pagamento ColÃ©gio Objectivo â”€â”€
     Estrutura esperada:
       Valor pago: [Bandeira] [final] [parcelas] [VALOR]
       SituaÃ§Ã£o: Aprovado [data] - ...
       CobranÃ§a Aluno ... [Ano/MÃªs]
  */

  // â”€â”€ Valor pago â€” linha do cartÃ£o: "[bandeira] [final] [parcelas] VALOR"
  let amount=null;
  const vpLine=t.match(/(?:\d+\s+[\d,\.]+\s*$|\-\s+\d{4}\s+\d+\s+([\d,\.]+))/m);
  if(vpLine) amount=parseFloat(vpLine[1]?.replace(',','.'));
  if(!amount){
    // fallback: "Valor pago ... VALOR" or any R$ pattern
    const rMatch=t.match(/(?:Valor pago|valor\s+total)[^\n\d]*([\d]{1,4}[.,][\d]{2})/i);
    if(rMatch) amount=parseFloat(rMatch[1].replace(',','.'));
  }
  if(!amount){
    // find last decimal number that looks like a price (4+ digits or with R$)
    const mAll=[...t.matchAll(/R\$\s*([\d.,]+)/gi)];
    if(mAll.length){ const last=mAll[mAll.length-1]; amount=parseFloat(last[1].replace(/\./g,'').replace(',','.')); }
  }
  if(!amount){
    const mGeneral=t.match(/([\d]{1,6}[.,][\d]{2})\s*$/m);
    if(mGeneral) amount=parseFloat(mGeneral[1].replace(',','.'));
  }

  // â”€â”€ Data do Pagamento = "Data de processamento" (Aprovado linha)
  // Pattern: "Aprovado DD/MM/YYYY - HH..."
  let date=null;
  const aprovadoM=t.match(/Aprovado\s+(\d{2})\/(\d{2})\/(\d{4})/i);
  if(aprovadoM) date=`${aprovadoM[3]}-${aprovadoM[2]}-${aprovadoM[1]}`;
  if(!date){
    // fallback: any date pattern
    const dBR=t.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if(dBR) date=`${dBR[3]}-${dBR[2]}-${dBR[1]}`;
  }
  if(!date) date=TODAY;

  // â”€â”€ Ano/MÃªs de referÃªncia â€” "YYYY/M" or "YYYY/MM"
  let academicYear=new Date(date+'T12:00:00').getFullYear();
  let academicMonth=new Date(date+'T12:00:00').getMonth()+1;
  const anoMesM=t.match(/Ano\/M[eÃª]s[^\d]*(\d{4})\/(\d{1,2})/i)||(t.match(/(\d{4})\/(\d{1,2})(?!\d)/));
  if(anoMesM){ academicYear=+anoMesM[1]; academicMonth=+anoMesM[2]; }

  // â”€â”€ Aluno â†’ student
  let student='Ambas';
  if(/\bLARA\b/i.test(t)) student='Lara';
  else if(/\bCHLOE\b|CHLOÃ‰/i.test(t)) student='Chloe';

  // â”€â”€ Categoria â€” relatÃ³rio de pagamento escolar â†’ mensalidade
  // If filename contains "mensalidade" or document has "cobranÃ§as"/"vencimento"
  let categoryKey='mensalidade';
  if(/matr[Ã­i]cula/i.test(t)||/matr[Ã­i]cula/i.test(filename)) categoryKey='matricula';
  else if(/material/i.test(t)) categoryKey='material';
  else if(/uniforme/i.test(t)) categoryKey='uniforme';
  else if(/excurs[Ã£a]o/i.test(t)||filename.toLowerCase().includes('excurs')) categoryKey='extra';

  // â”€â”€ Tipo â†’ sempre PAID para relatÃ³rio de pagamento
  const type='PAID';

  // â”€â”€ isLate
  const isLate=/atraso|atrasado|vencido|overdue/i.test(t);

  // â”€â”€ Confidence
  let hits=0;
  if(amount&&amount>10) hits++;
  if(date&&date!==TODAY) hits++;
  if(anoMesM) hits++;
  if(student!=='Ambas') hits++;
  const confidence=hits>=3?'high':hits>=2?'medium':'low';

  const notes=`${MF[academicMonth-1]}/${academicYear} â€” ${student}`;
  const summary=`${catInfo(categoryKey).label} â€” ${brl(amount||0)} â€” ${fmtD(date)} â€” Ref: ${MF[academicMonth-1]}/${academicYear} â€” ${student}`;

  return {amount:amount||0,type,categoryKey,party:'Me',isLate,date,academicYear,academicMonth,student,notes,tags:categoryKey,confidence,summary};
}

function applyAI(d){
  const btn=$('ai-run-btn'); btn.disabled=false;
  btn.style.background='var(--green)'; btn.style.color='#fff';
  $('ai-run-ic').textContent='âœ“'; $('ai-run-txt').textContent='Preenchido';
  const cfC={high:'var(--green)',medium:'var(--orange)',low:'var(--red)'};
  $('ai-status').innerHTML=`<span style="color:${cfC[d.confidence||'medium']};font-weight:600">â— ${{high:'Alta confianÃ§a',medium:'Verificar campos',low:'Revisar tudo'}[d.confidence||'medium']}</span>`;
  $('ai-summary').textContent=d.summary||'Documento analisado.';
  $('ai-result').style.display='flex';

  const fieldMap=[
    ['f-val',d.amount?.toString()],['f-type',d.type],['f-cat',d.categoryKey],
    ['f-party',d.party],['f-date',d.date],
    ['f-year',d.academicYear?.toString()],['f-month',d.academicMonth?.toString()],
    ['f-notes',d.notes],['f-tags',d.tags]
  ];
  fieldMap.forEach(([id,v],i)=>{
    if(v==null||v==='')return;
    setTimeout(()=>{
      const el=$(id); if(!el)return;
      if(el.tagName==='SELECT'){ const opt=[...el.options].find(o=>o.value===String(v)); if(opt) el.value=opt.value; }
      else el.value=v;
      el.classList.add('ai-hi'); setTimeout(()=>el.classList.remove('ai-hi'),3000);
    },i*60);
  });
  if(d.isLate) setTimeout(()=>$('tog').classList.add('on'),600);
  if(d.student) setTimeout(()=>setStudent(d.student),200);
}

/* â”€â”€â”€ SEED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function seedIfEmpty(){
  const existing=await dbAll('txs'); if(existing.length>0) return;

  const CATS=[
    {key:'mensalidade',label:'Mensalidade',color:'#3B5BDB',system:true},
    {key:'pensao',label:'PensÃ£o AlimentÃ­cia',color:'#C0392B',system:true},
    {key:'matricula',label:'MatrÃ­cula',color:'#C05C1A',system:true},
    {key:'material',label:'Material',color:'#1A7F7A',system:true},
    {key:'uniforme',label:'Uniforme',color:'#6B4FBB',system:true},
    {key:'extra',label:'Extra',color:'#2E7D55',system:true},
  ];
  for(const c of CATS) await dbPut('cats',c);
  await dbPut('cfg',{k:'accord',type:'pct',pct:50,val:0});

  let id=1;
  const mk=o=>({id:id++,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),student:'Ambas',...o});

  // 2025 mensalidades
  const m25=[4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.40];
  for(let i=0;i<12;i++) await dbPut('txs',mk({amount:m25[i],type:'PAID',categoryKey:'mensalidade',party:'Me',date:`2025-${String(i+1).padStart(2,'0')}-05`,academicYear:2025,academicMonth:i+1,isLate:false,notes:`Mensalidade ${MF[i]}/2025`,tags:'mensalidade'}));
  await dbPut('txs',mk({amount:4256.88,type:'PAID',categoryKey:'matricula',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'MatrÃ­cula anual 2025',tags:'matricula'}));
  for(const [m,d]of[[1,'2025-01-05'],[4,'2025-04-05'],[7,'2025-07-05'],[9,'2025-09-05']])
    await dbPut('txs',mk({amount:724.50,type:'PAID',categoryKey:'material',party:'Me',date:d,academicYear:2025,academicMonth:m,isLate:false,notes:`Material ${MF[m-1]}/2025`,tags:'material'}));
  await dbPut('txs',mk({amount:1084.23,type:'PAID',categoryKey:'extra',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,isLate:false,notes:'Extra Jan/2025',tags:'extra'}));

  // 2025 pensÃ£o
  const p25=[[1,'2025-01-05',2000,false],[2,'2025-02-05',2000,false],[3,'2025-03-05',2000,false],[4,'2025-04-05',2000,false],[5,'2025-05-06',1000,true],[6,'2025-06-05',2000,false],[7,'2025-07-03',1000,false],[7,'2025-07-17',1000,true],[8,'2025-08-05',2000,false],[9,'2025-09-05',2000,false],[10,'2025-10-04',2000,false],[11,'2025-11-05',2000,false],[11,'2025-11-22',1500,true],[12,'2025-12-05',3500,false]];
  for(const[m,d,amt,late]of p25) await dbPut('txs',mk({amount:amt,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:d,academicYear:2025,academicMonth:m,isLate:late,notes:`PensÃ£o ${MF[m-1]}/2025`,tags:'pensao'}));

  // 2026 confirmed
  for(const[m,d]of[[1,'2026-01-05'],[2,'2026-02-05']])
    await dbPut('txs',mk({amount:5666.85,type:'PAID',categoryKey:'mensalidade',party:'Me',date:d,academicYear:2026,academicMonth:m,isLate:false,notes:`Mensalidade ${MF[m-1]}/2026`,tags:'mensalidade'}));
  // New: Lara mensalidade marÃ§o (from uploaded PDF)
  await dbPut('txs',mk({amount:2778.76,type:'PAID',categoryKey:'mensalidade',party:'Me',date:'2026-02-27',academicYear:2026,academicMonth:3,isLate:false,student:'Lara',notes:'Mensalidade Mar/2026 â€” Lara (PDF)',tags:'mensalidade'}));
  await dbPut('txs',mk({amount:1491.29,type:'PAID',categoryKey:'matricula',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'MatrÃ­cula 2026',tags:'matricula'}));
  await dbPut('txs',mk({amount:1047.33,type:'PAID',categoryKey:'material',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,isLate:false,notes:'Material Jan/2026',tags:'material'}));
  await dbPut('txs',mk({amount:1503.41,type:'PAID',categoryKey:'extra',party:'Me',date:'2026-02-05',academicYear:2026,academicMonth:2,isLate:false,notes:'ExcursÃ£o parcela 1 (entrada)',tags:'extra,excursao'}));
  await dbPut('txs',mk({amount:2000,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-01-12',academicYear:2026,academicMonth:1,isLate:true,notes:'PensÃ£o Jan/2026 â€” com atraso',tags:'pensao'}));
  await dbPut('txs',mk({amount:2500,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-02-07',academicYear:2026,academicMonth:2,isLate:true,notes:'PensÃ£o Fev/2026 â€” com atraso',tags:'pensao'}));

  // 2026 FORECAST: Mensalidades Marâ€“Dez
  for(let i=2;i<12;i++){
    const m=i+1;
    await dbPut('txs',mk({amount:5666.85,type:'FORECAST',categoryKey:'mensalidade',party:'Me',date:`2026-${String(m).padStart(2,'0')}-05`,academicYear:2026,academicMonth:m,isLate:false,notes:`Mensalidade ${MF[i]}/2026 (previsÃ£o)`,tags:'mensalidade,forecast'}));
  }
  // 2026 FORECAST: PensÃ£o (2000/mÃªs) â€” Pai â€” Marâ€“Dez
  for(let i=2;i<12;i++){
    const m=i+1;
    await dbPut('txs',mk({amount:2000,type:'FORECAST',categoryKey:'pensao',party:'Father',date:`2026-${String(m).padStart(2,'0')}-10`,academicYear:2026,academicMonth:m,isLate:false,notes:`PensÃ£o ${MF[i]}/2026 (previsÃ£o)`,tags:'pensao,forecast'}));
  }
  // 2026 FORECAST: ExcursÃ£o Marâ€“Ago
  for(let i=2;i<8;i++){
    const m=i+1;
    await dbPut('txs',mk({amount:429,type:'FORECAST',categoryKey:'extra',party:'Me',date:`2026-${String(m).padStart(2,'0')}-05`,academicYear:2026,academicMonth:m,isLate:false,notes:`ExcursÃ£o ${MF[i]}/2026 (previsÃ£o)`,tags:'extra,excursao,forecast'}));
  }
}

/* â”€â”€â”€ SHEET CLOSE ON BG â”€â”€â”€ */
document.querySelectorAll('.sheet-bg').forEach(bg=>bg.addEventListener('click',e=>{ if(e.target===bg) bg.classList.remove('open'); }));

/* â”€â”€â”€ MIGRATION: party 'Me' â†’ parte real "DÃ©cio e Bruna" â”€â”€â”€â”€â”€â”€
   Cria (ou localiza) a parte "DÃ©cio e Bruna" na store parties,
   depois reescreve TODOS os txs com party:'Me' para usar o
   partyId correto. Roda toda vez que o app abre â€” Ã© idempotente.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function migratePartyMe(){
  // Ensure parties are loaded
  await loadParties();

  // Find or create "DÃ©cio e Bruna" party
  let party = S.parties.find(p => p.name === 'DÃ©cio e Bruna');
  if(!party){
    const newId = await dbPut('parties', {
      name: 'DÃ©cio e Bruna', emoji: 'ğŸ‘¨â€ğŸ‘©',
      createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
    });
    await loadParties();
    party = S.parties.find(p => p.id === newId) || S.parties.find(p => p.name === 'DÃ©cio e Bruna');
  }
  if(!party) return;

  // Rewrite every tx that still has party:'Me' and no partyId
  const all = await dbAll('txs');
  const toFix = all.filter(r => r.party === 'Me' && !r.partyId);
  for(const tx of toFix){
    await dbPut('txs', {
      ...tx,
      partyId: party.id,
      party: null,
      updatedAt: new Date().toISOString()
    });
  }
  if(toFix.length) console.log(`[migration] ${toFix.length} txs migrated â†’ DÃ©cio e Bruna (id ${party.id})`);

  // Also fix seed default party in generateForecasts references
  await loadParties();
}

/* â”€â”€â”€ SERVICE WORKER â”€â”€â”€ */
if('serviceWorker'in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});

/* â”€â”€â”€ BOOT â”€â”€â”€ */
async function boot(){
  await openDB();
  await seedIfEmpty();
  await migratePartyMe();
  await loadAccordConfig();
  await loadCats();
  await loadParties();
  await initYearFilter();
  renderDash();
}
window.addEventListener('load',boot);
</script>
</body>
</html>
