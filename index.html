<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Pag. D&B">
<meta name="theme-color" content="#FAFAF9">
<title>Gerenciamento de Pagamentos ‚Äî D√©cio &amp; Bruna</title>
<link rel="manifest" href="./manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCHOOL LEDGER v5 ‚Äî Design System
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root{
  --bg:#FAFAF9;--bg-2:#F5F4F2;--card:#FFF;
  --sep:rgba(0,0,0,.10);--sep-l:rgba(0,0,0,.06);
  --fill:rgba(0,0,0,.055);--fill-2:rgba(0,0,0,.035);
  --accent:#3B5BDB;--accent-l:rgba(59,91,219,.10);
  --green:#2E7D55;--green-l:rgba(46,125,85,.10);
  --red:#C0392B;--red-l:rgba(192,57,43,.10);
  --orange:#C05C1A;--orange-l:rgba(192,92,26,.10);
  --violet:#7C3AED;--violet-l:rgba(124,58,237,.09);--violet-d:rgba(124,58,237,.22);
  --amber:#D97706;--amber-l:rgba(217,119,6,.12);
  --t-1:#18181B;--t-2:#3F3F46;--t-3:#71717A;--t-4:#A1A1AA;--t-5:#D4D4D8;
  --f:'Inter',-apple-system,sans-serif;
  --mono:'SF Mono','Menlo','Consolas',monospace;
  --sat:env(safe-area-inset-top,44px);--sab:env(safe-area-inset-bottom,34px);
  --r:10px;--r2:14px;--r3:18px;
  --tab:49px;--sidebar:230px;
  --s1:0 1px 3px rgba(0,0,0,.06),0 1px 8px rgba(0,0,0,.04);
  --s2:0 2px 8px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.05);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{font-family:var(--f);font-size:16px;line-height:1.5;background:var(--bg);color:var(--t-1);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;padding-top:var(--sat);letter-spacing:-.01em}

/* ‚îÄ‚îÄ SCAFFOLD ‚îÄ‚îÄ */
#app{display:flex;flex-direction:column;height:100%}
#shell{display:flex;flex:1;overflow:hidden}
.scroller{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--tab) + var(--sab) + 20px)}
.scroller::-webkit-scrollbar{display:none}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{display:none;width:var(--sidebar);flex-shrink:0;background:rgba(250,250,249,.97);border-right:1px solid var(--sep-l);flex-direction:column;padding:16px 0 calc(var(--sab)+12px);overflow-y:auto}
.sb-brand{padding:12px 18px 18px;border-bottom:1px solid var(--sep-l);margin-bottom:8px}
.sb-app{font-size:15px;font-weight:700;letter-spacing:-.03em}
.sb-sub{font-size:11px;color:var(--t-3);margin-top:1px}
.sb-yr{padding:8px 12px 6px}
.sb-nav{display:flex;flex-direction:column;gap:2px;padding:4px 10px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r);border:none;background:none;cursor:pointer;font:500 14px/1 var(--f);color:var(--t-3);text-align:left;width:100%;transition:background .12s,color .12s;letter-spacing:-.01em}
.sb-item:hover{background:var(--fill-2);color:var(--t-2)}
.sb-item.on{background:var(--accent-l);color:var(--accent)}
#sb-conn-status[data-state="ok"]   { background:#dcfce7; color:#166534; border-color:#86efac; }
#sb-conn-status[data-state="err"]  { background:#fee2e2; color:#991b1b; border-color:#fca5a5; }
#sb-conn-status[data-state="ok"]   #sb-conn-dot { background:#22c55e; }
#sb-conn-status[data-state="err"]  #sb-conn-dot { background:#ef4444; animation:pulse-dot 1s infinite; }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.3} }
.sb-item svg{width:18px;height:18px;flex-shrink:0}
.sb-spacer{flex:1}
.sb-foot{padding:12px 18px 0;border-top:1px solid var(--sep-l);font-size:11px;color:var(--t-4)}

/* ‚îÄ‚îÄ ALERT BADGE on sidebar item ‚îÄ‚îÄ */
.sb-badge{margin-left:auto;background:var(--amber);color:#fff;font-size:10px;font-weight:700;border-radius:100px;padding:2px 6px;min-width:18px;text-align:center}

/* ‚îÄ‚îÄ IPAD ‚îÄ‚îÄ */
@media(min-width:768px){
  .sidebar{display:flex}
  .tabbar{display:none!important}
  .navbar{display:none!important}
  .scroller{padding-bottom:calc(var(--sab)+24px)!important}
  .pg-title{padding:24px 28px 4px!important;font-size:32px!important}
  .form-section,.card,.btns{margin-left:28px!important;margin-right:28px!important}
  .kpi-row{padding:16px 28px 4px!important;flex-wrap:wrap}
  .kpi{min-width:160px!important}
  .s-hdr{padding:20px 28px 10px!important}
  #rpt-actions-bar,#rpt-hint,.alert-bar{padding-left:28px!important;padding-right:28px!important}
  .toast{bottom:28px}
  .sheet-bg{align-items:center;justify-content:center}
  .sheet{border-radius:var(--r3)!important;max-width:540px;width:92vw;animation:ipad-sheet .22s ease!important}
  @keyframes ipad-sheet{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
}

/* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
.navbar{display:flex;align-items:center;justify-content:space-between;padding:11px 20px;flex-shrink:0;min-height:48px;background:rgba(250,250,249,.95);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--sep-l)}
.navbar-title{font-size:16px;font-weight:600;letter-spacing:-.02em}
.yr-badge{display:flex;align-items:center;background:var(--accent);border-radius:100px;padding:5px 12px 5px 14px;cursor:pointer;gap:2px}
.yr-badge select{appearance:none;background:none;border:none;outline:none;font:600 14px/1 var(--f);color:#fff;cursor:pointer}
.yr-badge select option{background:#fff;color:var(--t-1)}
.yr-badge::after{content:'‚ñæ';color:rgba(255,255,255,.7);font-size:11px;pointer-events:none}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pg-title{font-size:30px;font-weight:700;letter-spacing:-.04em;padding:18px 20px 2px;line-height:1.1}
.page{display:none}
.page.on{display:block;animation:pgfade .18s ease}
@keyframes pgfade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ TABBAR ‚îÄ‚îÄ */
.tabbar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab)+var(--sab));padding-bottom:var(--sab);background:rgba(250,250,249,.96);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--sep-l);display:flex;z-index:100}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding-top:5px;cursor:pointer;border:none;background:none;font:500 9.5px/1 var(--f);color:var(--t-4);text-transform:uppercase;letter-spacing:.02em;transition:color .15s;position:relative}
.tab.on{color:var(--accent)}
.tab svg{width:24px;height:24px}
.tab-badge{position:absolute;top:2px;right:calc(50% - 22px);background:var(--amber);color:#fff;font-size:9px;font-weight:700;border-radius:100px;padding:1px 5px;min-width:16px;text-align:center}

/* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
.kpi-row{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:16px 20px 4px;scrollbar-width:none}
.kpi-row::-webkit-scrollbar{display:none}
.kpi{min-width:150px;flex-shrink:0;background:var(--card);border-radius:var(--r2);padding:15px 16px;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.kpi-label{font-size:10.5px;font-weight:500;color:var(--t-3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.06em}
.kpi-value{font:600 21px/1 var(--mono);letter-spacing:-.02em}
.kpi-sub{font-size:11px;color:var(--t-4);margin-top:5px;line-height:1.4}
.kpi.blue .kpi-value{color:var(--accent)}
.kpi.green .kpi-value{color:var(--green)}
.kpi.red .kpi-value{color:var(--red)}
.kpi.ora .kpi-value{color:var(--orange)}
.kpi.violet .kpi-value{color:var(--violet)}
.kpi.amber .kpi-value{color:var(--amber)}
.kpi.fcst-kpi{border-left:3px solid var(--violet)}

/* ‚îÄ‚îÄ ALERT BAR ‚îÄ‚îÄ */
.alert-bar{padding:10px 20px;margin-bottom:4px}
.alert-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--amber-l);border:1.5px solid rgba(217,119,6,.3);border-radius:var(--r2);margin-bottom:8px;cursor:pointer;transition:opacity .15s}
.alert-item:active{opacity:.75}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-body{flex:1;min-width:0}
.alert-title{font-size:13px;font-weight:600;color:var(--amber)}
.alert-desc{font-size:12px;color:var(--t-2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.alert-cta{font-size:12px;color:var(--accent);font-weight:600;flex-shrink:0}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.s-hdr{display:flex;align-items:baseline;justify-content:space-between;padding:22px 20px 10px}
.s-title{font-size:18px;font-weight:700;letter-spacing:-.03em}
.s-link{font-size:14px;color:var(--accent);cursor:pointer;font-weight:500}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--card);border-radius:var(--r2);margin:0 20px;box-shadow:var(--s1);overflow:hidden;border:1px solid var(--sep-l)}
.card+.card{margin-top:12px}

/* ‚îÄ‚îÄ LIST ROW ‚îÄ‚îÄ */
.list-row{display:flex;align-items:center;gap:14px;padding:12px 16px;border-bottom:1px solid var(--sep-l);min-height:48px;cursor:pointer;transition:background .12s}
.list-row:last-child{border-bottom:none}
.list-row:active{background:var(--fill-2)}
.list-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.list-label{font-size:15px;font-weight:400;flex:1;color:var(--t-2)}
.list-value{font-size:14px;color:var(--t-3)}
.list-chevron{color:var(--t-5);flex-shrink:0}
.list-chevron svg{width:12px;height:12px}
.list-body{flex:1;min-width:0}
.list-name{font-size:15px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--t-2)}

/* ‚îÄ‚îÄ TX ROWS ‚îÄ‚îÄ */
.tx-sub{font-size:12px;color:var(--t-3);margin-top:2px;line-height:1.4}
.tx-amount{font:600 15px/1 var(--mono);letter-spacing:-.02em}
.tx-amount.out{color:var(--red)}
.tx-amount.in{color:var(--green)}
.tx-amount.fcst{color:var(--violet);opacity:.8}
.tx-late{font-size:10px;color:var(--red);font-weight:600;margin-top:3px;letter-spacing:.02em}
.tx-alert{font-size:10px;color:var(--amber);font-weight:600;margin-top:3px}
.row-fcst{opacity:.7}
.fcst-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--violet);background:var(--violet-l);border:1px solid var(--violet-d);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:5px}
.alert-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;color:var(--amber);background:var(--amber-l);border:1px solid rgba(217,119,6,.3);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:5px}
.student-badge{display:inline-block;font-size:9px;font-weight:600;color:var(--t-3);background:var(--fill);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:4px}

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.chart-title{font-size:11px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:16px}
.donut-name{font-size:11px;font-weight:500;color:var(--t-3);letter-spacing:.02em}
.leg-item{display:flex;align-items:center;gap:7px;font-size:10.5px;color:var(--t-3)}
.leg-swatch{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.leg-pct{font:500 10px/1 var(--mono);margin-left:auto;color:var(--t-1)}
.leg-toggle{cursor:pointer;padding:3px 8px;border-radius:100px;transition:opacity .15s,background .1s;user-select:none}
.leg-toggle:hover{background:var(--fill)}
.leg-off{opacity:.38}
.leg-off .leg-swatch{filter:grayscale(1)}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-section{margin:20px 20px 0}
.form-label{font-size:11px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding:0 2px}
.form-card{background:var(--card);border-radius:var(--r2);overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.field{display:flex;align-items:center;gap:12px;padding:0 16px;border-bottom:1px solid var(--sep-l);min-height:46px}
.field:last-child{border-bottom:none}
.field-label{font-size:15px;font-weight:400;min-width:90px;flex-shrink:0;color:var(--t-2)}
.field input,.field select,.field textarea{flex:1;border:none;background:none;outline:none;font:400 15px/1 var(--f);color:var(--t-1);text-align:right;-webkit-appearance:none;letter-spacing:-.01em}
.field input::placeholder{color:var(--t-5)}
.field.tall{align-items:flex-start;padding:12px 16px}
.field.tall .field-label{font-size:13px;color:var(--t-3);font-weight:500;padding-top:2px;min-width:auto}
.field.tall textarea{text-align:left;resize:none;line-height:1.5;padding:0;font-size:14px}

/* Inline party add */
.party-inline{display:flex;gap:8px;padding:10px 16px;background:var(--bg-2);border-top:1px solid var(--sep-l)}
.party-inline input{flex:1;border:1.5px solid var(--sep);border-radius:var(--r);padding:8px 10px;font:400 13px/1 var(--f);background:var(--card);outline:none}
.party-inline input:focus{border-color:var(--accent)}
.party-inline button{padding:8px 14px;border-radius:var(--r);border:none;background:var(--accent);color:#fff;font:500 13px/1 var(--f);cursor:pointer}

/* Toggle */
.tog-field{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--sep-l);min-height:46px;cursor:pointer}
.tog-label{font-size:15px;color:var(--t-2)}
.toggle{width:51px;height:31px;border-radius:16px;background:var(--t-5);position:relative;flex-shrink:0;transition:background .2s;cursor:pointer}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;left:2px;top:2px;width:27px;height:27px;border-radius:50%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:transform .22s cubic-bezier(.34,1.12,.64,1)}
.toggle.on::after{transform:translateX(20px)}

/* Forecast notice */
.fcst-notice{background:var(--violet-l);border:1.5px dashed var(--violet-d);border-radius:var(--r2);padding:12px 14px;margin:12px 20px 0;display:none}
.fcst-notice.show{display:block}
.fcst-notice b{color:var(--violet)}

/* Student selector */
.student-sel{display:flex;gap:8px;padding:10px 16px}
.student-btn{flex:1;padding:9px 8px;border-radius:var(--r);border:1.5px solid var(--sep);background:var(--bg-2);font:500 13px/1 var(--f);color:var(--t-3);cursor:pointer;text-align:center;transition:all .15s}
.student-btn.on{background:var(--accent-l);border-color:var(--accent);color:var(--accent)}

/* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
.search-wrap{padding:10px 20px 4px;position:relative}
.search-input{width:100%;padding:10px 38px 10px 14px;border:1.5px solid var(--sep);border-radius:var(--r2);font:400 15px/1 var(--f);color:var(--t-1);background:var(--card);outline:none;-webkit-appearance:none;box-shadow:var(--s1)}
.search-input:focus{border-color:var(--accent)}
.search-clear{position:absolute;right:28px;top:50%;transform:translateY(-50%);background:var(--t-5);border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center;color:var(--t-2)}
.search-clear.show{display:flex}

/* ‚îÄ‚îÄ FILTER PILLS ‚îÄ‚îÄ */
.filter-row{display:flex;gap:6px;padding:4px 20px 6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-sel{background:var(--card);border:1px solid var(--sep-l);border-radius:100px;padding:7px 14px;font:500 13px/1 var(--f);color:var(--t-2);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.04)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;border-radius:var(--r2);font:600 15px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s,transform .1s}
.btn:active{opacity:.8;transform:scale(.99)}
.btn.primary{background:var(--accent);color:#fff}
.btn.destructive{background:var(--red-l);color:var(--red)}
.btn.secondary{background:var(--fill);color:var(--t-2)}
.btn.amber{background:var(--amber-l);color:var(--amber)}
.btns{display:flex;flex-direction:column;gap:10px;padding:18px 20px 4px}
.pill-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:100px;font:500 14px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s;white-space:nowrap}
.pill-btn:active{opacity:.75}
.pill-btn:disabled{opacity:.35;cursor:default}
.pill-btn.blue{background:var(--accent);color:#fff}
.pill-btn.gray{background:var(--fill);color:var(--t-2)}
.pill-btn.green{background:var(--green);color:#fff}
.pill-btn.violet{background:var(--violet);color:#fff}
.pill-btn.amber{background:var(--amber);color:#fff}

/* ‚îÄ‚îÄ AI SECTION ‚îÄ‚îÄ */
@keyframes aiFlash{0%{background:rgba(46,125,85,.15)}100%{background:transparent}}
.ai-hi{animation:aiFlash 2.5s ease forwards}

/* ‚îÄ‚îÄ DOC UPLOAD ‚îÄ‚îÄ */
.doc-drop{border:1.5px dashed var(--sep);border-radius:var(--r);background:var(--bg-2);padding:16px;text-align:center;cursor:pointer;transition:all .2s}
.doc-drop.drag{border-color:var(--accent);background:var(--accent-l)}

/* ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ */
.rpt-card{background:var(--card);border-radius:var(--r2);margin:0 20px 14px;overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-l)}
.rpt-yr-hdr{background:var(--accent);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.rpt-yr-hdr h3{font-size:16px;font-weight:700;letter-spacing:-.02em}
.rpt-yr-hdr span{font:500 13px/1 var(--mono);opacity:.8}
.rpt-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.rtbl{width:100%;border-collapse:collapse;white-space:nowrap}
.rtbl th{padding:9px 12px;text-align:right;font-size:10px;font-weight:600;color:var(--t-3);text-transform:uppercase;letter-spacing:.06em;background:var(--bg-2);border-bottom:1px solid var(--sep-l)}
.rtbl th:first-child{text-align:left;padding-left:16px}
.rtbl th.fcst-h{color:var(--violet)}
.rtbl th.accord-h{color:var(--green)}
.rtbl td{padding:9px 12px;text-align:right;border-bottom:1px solid var(--sep-l);font:400 12px/1.4 var(--mono);color:var(--t-3);vertical-align:top}
.rtbl td:first-child{text-align:left;font:500 13px/1 var(--f);color:var(--t-2);padding-left:16px;letter-spacing:-.01em}
.rtbl tr:last-child td{border-bottom:none}
.rtbl tr.total-row td{background:rgba(59,91,219,.05);font-weight:700;color:var(--t-1);border-top:1px solid rgba(59,91,219,.18)}
.r{text-align:right!important}
.neg{color:var(--red)!important}
.recv{color:var(--green)!important}
.pct-ok{color:var(--green)!important;font-weight:600}
.pct-bad{color:var(--red)!important;font-weight:600}
.pct-equal{color:var(--accent)!important;font-weight:600}
.late-tag{display:block;font-size:9.5px;font-weight:700;color:var(--red);letter-spacing:.03em;margin-top:3px}
.fcst-col{color:var(--violet)!important;font-style:italic}
.accord-col{color:var(--green)!important}
.subtotal-col{font-weight:600;color:var(--t-1)!important;border-left:2px solid var(--sep)!important}
.gt-strip{border-radius:var(--r2);margin:0 20px 12px;padding:16px 18px;display:grid;grid-template-columns:repeat(4,1fr);gap:14px;box-shadow:var(--s2)}
.gt-strip.confirmed{background:var(--accent)}
.gt-strip.forecast{background:var(--violet)}
.gt-cell{text-align:center}
.gt-label{font-size:9.5px;font-weight:600;color:rgba(255,255,255,.65);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px}
.gt-value{font:600 15px/1 var(--mono);color:#fff;letter-spacing:-.02em}
.gt-value.warn{color:#FBBF24}
.gt-value.danger{color:#FCA5A5}

/* ‚îÄ‚îÄ SHEET ‚îÄ‚îÄ */
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:400;display:none;align-items:flex-end}
.sheet-bg.open{display:flex;animation:bgfade .2s ease}
@keyframes bgfade{from{opacity:0}to{opacity:1}}
.sheet{background:var(--card);border-radius:18px 18px 0 0;width:100%;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 calc(var(--sab)+8px);animation:sheetup .3s cubic-bezier(.34,1.12,.64,1);border-top:1px solid var(--sep-l)}
@keyframes sheetup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-grip{width:36px;height:4px;background:var(--sep);border-radius:2px;margin:10px auto 0}
.sheet-hdr{padding:14px 20px 13px;border-bottom:1px solid var(--sep-l);display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-size:17px;font-weight:600;letter-spacing:-.02em}
.sheet-close{font-size:15px;color:var(--accent);background:none;border:none;font-family:var(--f);cursor:pointer;font-weight:500}

/* ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ */
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;padding:8px}
.emoji-btn{font-size:22px;padding:6px;border:none;background:none;cursor:pointer;border-radius:6px;transition:background .1s;text-align:center}
.emoji-btn:hover{background:var(--fill)}
.emoji-btn.on{background:var(--accent-l)}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:20px;height:20px;border:2px solid var(--sep-l);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite;display:inline-block;vertical-align:middle}
.toast{position:fixed;bottom:calc(var(--tab)+var(--sab)+14px);left:50%;transform:translateX(-50%);background:rgba(24,24,27,.9);backdrop-filter:blur(16px);border-radius:100px;padding:11px 22px;font:500 13.5px/1 var(--f);color:#fff;white-space:nowrap;z-index:999;opacity:0;transition:opacity .2s;pointer-events:none;box-shadow:var(--s2)}
.toast.on{opacity:1}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 24px;gap:10px;text-align:center;color:var(--t-3);font-size:15px}
.empty-state .ic{font-size:44px;margin-bottom:4px}
.seg-ctrl{display:flex;background:var(--bg-2);border-radius:var(--r);padding:3px;gap:2px}
.seg-opt{flex:1;padding:7px 12px;border-radius:8px;border:none;background:none;font:500 13px/1 var(--f);color:var(--t-3);cursor:pointer;text-align:center;transition:all .15s}
.seg-opt.on{background:var(--card);color:var(--t-1);box-shadow:0 1px 3px rgba(0,0,0,.08)}

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
@media print{
  @page{ size:A4 landscape; margin:10mm 8mm; }
  *{ -webkit-print-color-adjust:exact!important; print-color-adjust:exact!important; color-adjust:exact!important; }

  html,body{ height:auto!important; overflow:visible!important; background:#fff!important; padding:0!important; font-size:8.5pt; }

  /* Show report, hide everything else ‚Äî use body class set by printReport() */
  body.printing #app{ display:block!important; height:auto!important; overflow:visible!important; }
  body.printing #shell{ display:block!important; height:auto!important; overflow:visible!important; }
  body.printing .scroller{ display:block!important; overflow:visible!important; height:auto!important; padding:0!important; max-height:none!important; }
  body.printing .sidebar,
  body.printing .tabbar,
  body.printing .navbar,
  body.printing .sheet-bg,
  body.printing #rpt-actions-bar,
  body.printing #rpt-hint,
  body.printing .alert-bar{ display:none!important; }
  /* Force ALL .page hidden, then force rpt visible */
  body.printing .page{ display:none!important; }
  body.printing #page-rpt{ display:block!important; }

  /* Without body.printing fallback (browser direct print) */
  #app{ display:block!important; height:auto!important; overflow:visible!important; }
  #shell{ display:block!important; height:auto!important; overflow:visible!important; }
  .scroller{ display:block!important; overflow:visible!important; height:auto!important; padding:0!important; max-height:none!important; }
  .sidebar,.tabbar,.navbar,.sheet-bg,#rpt-actions-bar,#rpt-hint,.alert-bar{ display:none!important; }
  .page{ display:none!important; }
  #page-rpt{ display:block!important; }

  .pg-title{ font-size:16pt!important; padding:0 0 6pt!important; font-weight:700; }
  .gt-strip{ margin:0 0 8pt!important; border-radius:4pt!important; padding:8pt 10pt!important; box-shadow:none!important; }
  .gt-strip.confirmed{ background:#3B5BDB!important; }
  .gt-strip.forecast{ background:#7C3AED!important; }
  .gt-label{ font-size:6.5pt!important; }
  .gt-value{ font-size:10pt!important; }
  .rpt-card{ margin:0 0 10pt!important; break-inside:avoid; box-shadow:none!important; border:1px solid #d0d0d0!important; border-radius:4pt!important; overflow:visible!important; page-break-inside:avoid; }
  .rpt-yr-hdr{ background:#3B5BDB!important; padding:7pt 10pt!important; }
  .rpt-yr-hdr h3{ color:#fff!important; font-size:11pt!important; }
  .rpt-yr-hdr span{ color:rgba(255,255,255,.85)!important; font-size:9pt!important; }
  .rpt-scroll{ overflow:visible!important; max-width:none!important; width:100%!important; display:block!important; }
  .rtbl{ width:100%!important; table-layout:fixed!important; white-space:normal!important; border-collapse:collapse!important; }
  .rtbl th{ background:#f0f0f0!important; font-size:6.5pt!important; padding:3pt 4pt!important; text-align:right!important; font-weight:700; color:#333!important; border-bottom:1.5px solid #999!important; border-right:1px solid #ddd!important; }
  .rtbl th:first-child{ text-align:left!important; padding-left:6pt!important; }
  .rtbl td{ font-size:7pt!important; padding:3pt 4pt!important; text-align:right!important; border-bottom:0.5px solid #e0e0e0!important; border-right:0.5px solid #eee!important; white-space:nowrap!important; vertical-align:middle!important; }
  .rtbl td:first-child{ text-align:left!important; padding-left:6pt!important; font-size:7.5pt!important; font-weight:500; }
  .rtbl tr.total-row td{ background:#e8eeff!important; font-weight:700!important; border-top:1.5px solid #3B5BDB!important; }
  .rtbl col.c-mes{ width:11%!important; }
  .rtbl col.c-val{ width:6.5%!important; }
  .rtbl col.c-sub{ width:7%!important; }
  .rtbl col.c-pens{ width:6.5%!important; }
  .rtbl col.c-date{ width:9%!important; }
  .rtbl col.c-diff{ width:6.5%!important; }
  .rtbl col.c-pct{ width:5.5%!important; }
  .rtbl col.c-acc{ width:6.5%!important; }
  .rtbl col.c-fcst{ width:6.5%!important; }
  .neg{ color:#C0392B!important; }
  .recv{ color:#2E7D55!important; }
  .pct-ok{ color:#2E7D55!important; }
  .pct-bad{ color:#C0392B!important; }
  .pct-equal{ color:#3B5BDB!important; }
  .fcst-col{ color:#7C3AED!important; }
  .accord-col{ color:#2E7D55!important; }
  .subtotal-col{ font-weight:700!important; background:#fafafa!important; }
  .late-tag{ font-size:6pt!important; color:#C0392B!important; }
  #page-rpt::after{ content:'Gerenciamento de Pagamentos ‚Äî D√©cio & Bruna ‚Äî Impresso em ' attr(data-print-date); display:block; font-size:6pt; color:#999; text-align:right; padding-top:6pt; border-top:0.5px solid #ddd; margin-top:8pt; }
}
</style>
</head>
<body>

<!-- ‚ñë‚ñë LOCK SCREEN ‚ñë‚ñë -->
<!-- ‚ñë‚ñë SUPABASE SETUP SCREEN ‚ñë‚ñë -->
<div id="sb-setup-screen" style="display:none;position:fixed;inset:0;z-index:999;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;padding:32px 20px;gap:18px;overflow-y:auto">
  <div style="font-size:52px;line-height:1;margin-bottom:4px">üóÑÔ∏è</div>
  <div style="font-size:22px;font-weight:700;letter-spacing:-.03em;color:var(--t-1);text-align:center">Conectar ao Supabase</div>
  <div style="font-size:14px;color:var(--t-3);text-align:center;max-width:340px;line-height:1.7">
    Cole as credenciais do seu projeto Supabase.<br>Ficam salvas neste dispositivo e nunca<br>s√£o enviadas a terceiros.
  </div>
  <div style="width:100%;max-width:400px;display:flex;flex-direction:column;gap:12px">
    <div>
      <div style="font-size:11px;font-weight:700;letter-spacing:.07em;color:var(--t-3);margin-bottom:6px;text-transform:uppercase">Project URL</div>
      <input id="sb-url-inp" type="url" autocomplete="off" spellcheck="false"
        placeholder="https://xxxxxxxxxxx.supabase.co"
        style="width:100%;padding:12px 14px;border:1.5px solid var(--sep);border-radius:var(--r2);font:400 14px/1 var(--f);background:var(--card);color:var(--t-1);outline:none;transition:border-color .15s"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--sep)'">
    </div>
    <div>
      <div style="font-size:11px;font-weight:700;letter-spacing:.07em;color:var(--t-3);margin-bottom:6px;text-transform:uppercase">Anon / Public Key</div>
      <textarea id="sb-key-inp" rows="3" autocomplete="off" spellcheck="false"
        placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        style="width:100%;padding:12px 14px;border:1.5px solid var(--sep);border-radius:var(--r2);font:400 12px/1.5 var(--mono);background:var(--card);color:var(--t-1);outline:none;resize:none;transition:border-color .15s"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--sep)'"></textarea>
    </div>
    <div id="sb-setup-err" style="display:none;padding:11px 14px;background:var(--red-l);border-radius:var(--r);font-size:13px;color:var(--red);font-weight:500;line-height:1.5"></div>
    <button id="sb-connect-btn" onclick="sbConnect()"
      style="padding:14px;border:none;border-radius:var(--r2);background:var(--accent);color:#fff;font:600 15px/1 var(--f);cursor:pointer;transition:opacity .15s"
      onmousedown="this.style.opacity='.75'" onmouseup="this.style.opacity='1'">
      Conectar ‚Üí
    </button>
  </div>
  <div style="font-size:11px;color:var(--t-4);text-align:center;line-height:1.9;margin-top:4px">
    Credenciais salvas apenas no <strong>localStorage</strong> deste browser.<br>
    Nunca trafegam para nenhum servidor externo.
  </div>
</div>

<script>
/* Lock screen ‚Äî event delegation, sem onclick inline */
document.addEventListener('DOMContentLoaded', function() {
  var _input = '';
  var PIN = '191291';

  function dots() {
    for (var i = 0; i < 6; i++) {
      var d = document.getElementById('ld-' + i);
      if (!d) continue;
      d.classList.toggle('filled', i < _input.length);
      d.classList.remove('error');
    }
  }

  function check() {
    if (_input === PIN) {
      sessionStorage.setItem('sl-auth', '1');
      var ls = document.getElementById('lock-screen');
      ls.style.animation = 'lockUnlock .35s ease forwards';
      setTimeout(function() {
        ls.style.display = 'none';
        if (typeof _loadAppData === 'function') _loadAppData();
      }, 340);
    } else {
      for (var i = 0; i < 6; i++) {
        var d = document.getElementById('ld-' + i);
        if (d) d.classList.add('error');
      }
      var e = document.getElementById('lock-error');
      if (e) e.style.display = 'block';
      setTimeout(function() { _input = ''; dots(); }, 800);
    }
  }

  // Event delegation on the numpad container
  var ls = document.getElementById('lock-screen');
  if (ls) {
    ls.addEventListener('click', function(e) {
      var btn = e.target.closest('[data-key]');
      if (!btn) return;
      var k = btn.getAttribute('data-key');
      if (k === 'del') {
        _input = _input.slice(0, -1); dots();
      } else if (k === 'clear') {
        _input = ''; dots();
        var err = document.getElementById('lock-error');
        if (err) err.style.display = 'none';
      } else if (_input.length < 6) {
        _input += k; dots();
        if (_input.length === 6) setTimeout(check, 80);
      }
    });
  }

  // Keyboard support
  document.addEventListener('keydown', function(e) {
    var ls = document.getElementById('lock-screen');
    if (!ls || ls.style.display === 'none') return;
    if (e.key >= '0' && e.key <= '9' && _input.length < 6) {
      _input += e.key; dots();
      if (_input.length === 6) setTimeout(check, 80);
    } else if (e.key === 'Backspace') {
      _input = _input.slice(0, -1); dots();
    }
  });
});
</script>
<div id="lock-screen" style="
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(160deg,#1a1f3a 0%,#0f1220 60%,#1a1230 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 24px;
">
  <div style="text-align:center;margin-bottom:40px">
    <div style="margin-bottom:16px">
      <svg width="68" height="68" viewBox="0 0 68 68" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="68" height="68" rx="18" fill="url(#lg1)"/>
        <!-- Graduation cap -->
        <polygon points="34,16 54,26 34,36 14,26" fill="white" opacity="0.95"/>
        <path d="M46 30 L46 44 Q34 50 22 44 L22 30" fill="white" opacity="0.3"/>
        <path d="M46 30.5 L46 44 Q34 50.5 22 44 L22 30.5" fill="none" stroke="white" stroke-width="1.5" opacity="0.7"/>
        <!-- Tassel cord -->
        <line x1="54" y1="26" x2="54" y2="40" stroke="white" stroke-width="2" opacity="0.7"/>
        <circle cx="54" cy="42" r="2.5" fill="white" opacity="0.8"/>
        <!-- R$ symbol subtle -->
        <text x="34" y="47" font-family="'SF Mono',monospace" font-size="8.5" font-weight="700" fill="white" opacity="0.55" text-anchor="middle">R$</text>
        <defs>
          <linearGradient id="lg1" x1="0" y1="0" x2="68" y2="68" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#3B5BDB"/>
            <stop offset="100%" stop-color="#7C3AED"/>
          </linearGradient>
        </defs>
      </svg>
    </div>
    <div style="font-size:19px;font-weight:700;color:#fff;letter-spacing:-.02em;line-height:1.2">Gerenciamento de Pagamentos<br><span style="color:rgba(255,255,255,.7);font-weight:400">do D√©cio e da Bruna</span></div>
    <div style="font-size:13px;color:rgba(255,255,255,.35);margin-top:6px">Digite a senha para continuar</div>
  </div>

  <!-- PIN dots display -->
  <div id="lock-dots" style="display:flex;gap:14px;margin-bottom:36px">
    <div class="lock-dot" id="ld-0"></div>
    <div class="lock-dot" id="ld-1"></div>
    <div class="lock-dot" id="ld-2"></div>
    <div class="lock-dot" id="ld-3"></div>
    <div class="lock-dot" id="ld-4"></div>
    <div class="lock-dot" id="ld-5"></div>
  </div>

  <!-- Error message -->
  <div id="lock-error" style="
    display:none;font-size:13px;color:#ff6b6b;margin-bottom:20px;
    background:rgba(255,107,107,.12);padding:8px 20px;border-radius:100px;
    border:1px solid rgba(255,107,107,.2);
  ">Senha incorreta ‚Äî tente novamente</div>

  <!-- Numpad -->
  <div style="display:grid;grid-template-columns:repeat(3,72px);gap:12px">
    <button class="lock-key" data-key="1">1</button>
    <button class="lock-key" data-key="2">2</button>
    <button class="lock-key" data-key="3">3</button>
    <button class="lock-key" data-key="4">4</button>
    <button class="lock-key" data-key="5">5</button>
    <button class="lock-key" data-key="6">6</button>
    <button class="lock-key" data-key="7">7</button>
    <button class="lock-key" data-key="8">8</button>
    <button class="lock-key" data-key="9">9</button>
    <button class="lock-key lock-key-sm" data-key="clear" style="font-size:12px;color:rgba(255,255,255,.5)">LIMPAR</button>
    <button class="lock-key" data-key="0">0</button>
    <button class="lock-key lock-key-del" data-key="del">‚å´</button>
  </div>
</div>

<style>
.lock-dot{
  width:14px;height:14px;border-radius:50%;
  background:rgba(255,255,255,.15);
  border:2px solid rgba(255,255,255,.25);
  transition:all .15s cubic-bezier(.34,1.56,.64,1);
}
.lock-dot.filled{
  background:#fff;border-color:#fff;
  transform:scale(1.15);
  box-shadow:0 0 12px rgba(255,255,255,.5);
}
.lock-dot.error{
  background:#ff6b6b;border-color:#ff6b6b;
  animation:lockShake .4s ease;
}
.lock-key{
  width:72px;height:72px;border-radius:50%;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;font-size:24px;font-weight:400;
  font-family:'Inter',-apple-system,sans-serif;
  cursor:pointer;transition:all .1s;
  -webkit-tap-highlight-color:transparent;
  letter-spacing:0;
}
.lock-key:active,.lock-key:hover{
  background:rgba(255,255,255,.18);
  transform:scale(.92);
}
.lock-key-sm{font-size:11px!important;font-weight:500!important;color:rgba(255,255,255,.45)!important}
.lock-key-del{font-size:20px!important}
@keyframes lockShake{
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-8px)}
  40%{transform:translateX(8px)}
  60%{transform:translateX(-5px)}
  80%{transform:translateX(5px)}
}
@keyframes lockUnlock{
  0%{opacity:1;transform:scale(1)}
  50%{opacity:1;transform:scale(1.04)}
  100%{opacity:0;transform:scale(1.08);pointer-events:none}
}
</style>

<div id="app">

<!-- PHONE NAVBAR -->
<div class="navbar" id="navbar">
  <div class="navbar-title" id="nav-title">
    <span style="display:inline-flex;align-items:center;gap:7px">
      <svg width="22" height="22" viewBox="0 0 68 68" fill="none" style="border-radius:6px;flex-shrink:0"><rect width="68" height="68" rx="18" fill="url(#nlg)"/><polygon points="34,16 54,26 34,36 14,26" fill="white" opacity="0.95"/><path d="M46 30.5 L46 44 Q34 50.5 22 44 L22 30.5" fill="none" stroke="white" stroke-width="1.5" opacity="0.7"/><line x1="54" y1="26" x2="54" y2="40" stroke="white" stroke-width="2" opacity="0.7"/><circle cx="54" cy="42" r="2.5" fill="white" opacity="0.8"/><defs><linearGradient id="nlg" x1="0" y1="0" x2="68" y2="68" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#3B5BDB"/><stop offset="100%" stop-color="#7C3AED"/></linearGradient></defs></svg>
      <span id="nav-title-txt">Pagamentos</span>
    </span>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div class="yr-badge"><select id="yr-sel"></select></div>
    <button onclick="logout()" title="Sair / Bloquear" style="
      background:none;border:none;cursor:pointer;padding:6px;
      border-radius:8px;color:var(--t-3);display:flex;align-items:center;
      transition:background .15s;-webkit-tap-highlight-color:transparent;
    " onmouseover="this.style.background='var(--fill)'" onmouseout="this.style.background='none'">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
    </button>
            <button class="btn" style="background:var(--fill);color:var(--t-3);border:1.5px solid var(--sep);margin-top:8px;font-size:13px" onclick="sbDisconnect()">üîå&nbsp; Desconectar Supabase</button>
  </div>
</div>

<div id="shell">
<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<aside class="sidebar" id="sidebar">
  <div class="sb-brand">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <svg width="34" height="34" viewBox="0 0 68 68" fill="none" style="border-radius:10px;flex-shrink:0"><rect width="68" height="68" rx="18" fill="url(#sblg)"/><polygon points="34,16 54,26 34,36 14,26" fill="white" opacity="0.95"/><path d="M46 30.5 L46 44 Q34 50.5 22 44 L22 30.5" fill="none" stroke="white" stroke-width="1.5" opacity="0.7"/><line x1="54" y1="26" x2="54" y2="40" stroke="white" stroke-width="2" opacity="0.7"/><circle cx="54" cy="42" r="2.5" fill="white" opacity="0.8"/><text x="34" y="47" font-family="monospace" font-size="8.5" font-weight="700" fill="white" opacity="0.5" text-anchor="middle">R$</text><defs><linearGradient id="sblg" x1="0" y1="0" x2="68" y2="68" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#3B5BDB"/><stop offset="100%" stop-color="#7C3AED"/></linearGradient></defs></svg>
      <div>
        <div class="sb-app" style="font-size:13px;line-height:1.2">Gerenciamento de<br>Pagamentos</div>
        <div class="sb-sub" style="margin-top:3px">D√©cio &amp; Bruna ¬∑ Lara &amp; Chloe</div>
        <div id="sb-conn-status" onclick="showConnDiag()" title="Clique para diagn√≥stico"
             style="margin-top:6px;display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;cursor:pointer;background:var(--fill-2);color:var(--t-3);border:1px solid var(--sep-l)">
          <span id="sb-conn-dot" style="width:7px;height:7px;border-radius:50%;background:#aaa;flex-shrink:0"></span>
          <span id="sb-conn-label">Verificando‚Ä¶</span>
        </div>
      </div>
    </div>
  </div>
  <div class="sb-yr"><div class="yr-badge"><select id="yr-sel-sb"></select></div></div>
  <nav class="sb-nav">
    <button class="sb-item on" id="si-dash" onclick="nav('dash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>Dashboard<span id="sb-alert-badge" class="sb-badge" style="display:none">!</span></button>
    <button class="sb-item" id="si-txs" onclick="nav('txs')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>Transa√ß√µes</button>
    <button class="sb-item" id="si-add" onclick="nav('add')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Nova Transa√ß√£o</button>
    <button class="sb-item" id="si-rpt" onclick="nav('rpt')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>Relat√≥rio</button>
    <button class="sb-item" id="si-cfg" onclick="nav('cfg')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Configura√ß√µes</button>
  </nav>
  <div class="sb-spacer"></div>
  <div class="sb-foot" style="display:flex;align-items:center;justify-content:space-between">
    <span>v5.0 ‚Äî Local PWA</span>
    <button onclick="logout()" title="Bloquear" style="
      background:var(--fill);border:none;cursor:pointer;
      padding:5px 10px;border-radius:8px;font:500 11px/1 var(--f);
      color:var(--t-3);display:flex;align-items:center;gap:5px;transition:background .15s;
    ">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>Sair
    </button>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê SCROLLER ‚ïê‚ïê‚ïê -->
<div class="scroller" id="scroller">

<!-- ‚ñë‚ñë DASHBOARD ‚ñë‚ñë -->
<div class="page on" id="page-dash">
  <div class="pg-title">Dashboard</div>
  <div id="db-source-banner" style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:500;color:var(--t-3);padding:6px 14px;background:var(--fill-2);border-radius:var(--r);margin-bottom:8px">
    <span>üóÑÔ∏è</span><span id="db-source-text">Conectando ao Supabase‚Ä¶</span>
    <button onclick="forceRefresh()" style="margin-left:auto;border:none;background:var(--accent-l);color:var(--accent);border-radius:var(--r);padding:3px 10px;font:600 11px/1 var(--f);cursor:pointer">‚Üª Atualizar</button>
  </div>
  <div id="dash-alerts" class="alert-bar" style="display:none"></div>
  <div class="kpi-row" id="kpi-row"></div>
  <div id="accord-kpi-wrap"></div>
  <div id="fcst-kpi-wrap"></div>
  <div id="chart-area" style="margin-top:12px"></div>
  <div class="s-hdr"><span class="s-title">Recentes</span><span class="s-link" onclick="nav('txs')">Ver todas ‚Üí</span></div>
  <div class="card" id="recent-card"><div class="empty-state"><span class="spinner"></span></div></div>
  <div style="height:8px"></div>
</div>

<!-- ‚ñë‚ñë TRANSACTIONS ‚ñë‚ñë -->
<div class="page" id="page-txs">
  <div class="pg-title">Transa√ß√µes</div>
  <div id="tx-alerts" class="alert-bar" style="display:none"></div>
  <div class="search-wrap">
    <input class="search-input" id="tx-search" placeholder="üîç  Buscar por valor, nota, categoria‚Ä¶" oninput="onSearch()">
    <button class="search-clear" id="search-clear" onclick="clearSearch()">√ó</button>
  </div>
  <div class="filter-row">
    <select id="fil-type" class="filter-sel" onchange="renderTxList()">
      <option value="">Todos os tipos</option>
      <option value="PAID">Pago</option>
      <option value="RECEIVED">Recebido</option>
      <option value="FORECAST">‚óÜ Previs√£o</option>
    </select>
    <select id="fil-cat" class="filter-sel" onchange="renderTxList()">
      <option value="">Todas categorias</option>
    </select>
    <select id="fil-student" class="filter-sel" onchange="renderTxList()">
      <option value="">Todos alunos</option>
      <option value="Lara">Lara</option>
      <option value="Chloe">Chloe</option>
      <option value="Ambas">Ambas</option>
    </select>
  </div>
  <div id="tx-wrap" style="margin:4px 0"></div>
</div>

<!-- ‚ñë‚ñë ADD / EDIT ‚ñë‚ñë -->
<div class="page" id="page-add">
  <div class="pg-title" id="add-title">Nova Transa√ß√£o</div>

  <!-- DOCUMENTO ANEXADO -->
  <div class="form-section" style="margin-top:16px">
    <div class="form-label">üìé Documento</div>
    <div class="form-card" style="padding:14px 16px">
      <div id="doc-drop" class="doc-drop" onclick="document.getElementById('doc-file-input').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="onDocDrop(event)">
        <input type="file" id="doc-file-input" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" onchange="loadDocFile(event.target.files[0])">
        <div id="doc-idle"><div style="font-size:24px;margin-bottom:4px">üìÑ</div><div style="font-size:13px;font-weight:500;color:var(--t-2)">Toque para anexar arquivo</div><div style="font-size:11px;color:var(--t-3);margin-top:2px">PDF ¬∑ JPG ¬∑ PNG ¬∑ TXT ‚Äî at√© 15 MB</div></div>
        <div id="doc-file-info" style="display:none;align-items:center;gap:10px">
          <span id="doc-file-ic" style="font-size:24px">üìÑ</span>
          <div style="flex:1;min-width:0"><div id="doc-file-nm" style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--t-1)"></div><div id="doc-file-sz" style="font-size:11px;color:var(--t-3);margin-top:1px"></div></div>
          <button onclick="clearDocFile(event)" style="background:var(--fill);border:none;border-radius:100px;padding:5px 10px;font:500 12px/1 var(--f);color:var(--t-2);cursor:pointer;flex-shrink:0">Remover</button>
        </div>
      </div>
      <!-- Existing file banner when editing -->
      <div id="existing-file-banner" style="display:none;margin-top:10px;display:none">
        <div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--bg-2);border-radius:var(--r);border:1px solid var(--sep-l)">
          <span id="efb-ic" style="font-size:18px">üìé</span>
          <div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;color:var(--t-2)" id="efb-name">‚Äî</div><div style="font-size:10px;color:var(--t-3)" id="efb-meta"></div></div>
          <button onclick="downloadTxFile(S._existingFilePath)" style="border:none;background:var(--accent);color:#fff;border-radius:var(--r);padding:5px 10px;font:500 11px/1 var(--f);cursor:pointer;flex-shrink:0">‚¨á Ver</button>
          <button onclick="removeExistingFile()" style="border:none;background:var(--fill);color:var(--red);border-radius:var(--r);padding:5px 10px;font:500 11px/1 var(--f);cursor:pointer;flex-shrink:0">‚úï</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DADOS -->
  <div class="form-section" style="margin-top:20px">
    <div class="form-label">Dados</div>
    <div class="form-card">
      <input type="hidden" id="f-id">
      <div class="field">
        <span class="field-label">Valor (R$)</span>
        <input id="f-val" type="number" inputmode="decimal" step="0.01" placeholder="0,00">
      </div>
      <div class="field">
        <span class="field-label">Tipo</span>
        <select id="f-type" onchange="onTypeChange()">
          <option value="PAID">Sa√≠da (pago)</option>
          <option value="RECEIVED">Entrada (recebido)</option>
          <option value="FORECAST">‚óÜ Previs√£o futura</option>
        </select>
      </div>
      <div class="field">
        <span class="field-label">Categoria</span>
        <select id="f-cat"></select>
      </div>
      <div class="field">
        <span class="field-label">Parte</span>
        <select id="f-party"></select>
      </div>
    </div>
    <!-- Inline: criar nova parte -->
    <div class="party-inline">
      <input id="f-new-party" type="text" placeholder="Nova parte‚Ä¶ (ex: Av√≥)" maxlength="40" onkeydown="if(event.key==='Enter'){event.preventDefault();addPartyInline()}">
      <button onclick="addPartyInline()">+ Adicionar</button>
    </div>
  </div>

  <!-- Aluna -->
  <div class="form-section">
    <div class="form-label">Aluna</div>
    <div class="form-card">
      <div class="student-sel">
        <button class="student-btn on" id="sb-lara" onclick="setStudent('Lara')">üéí Lara</button>
        <button class="student-btn" id="sb-chloe" onclick="setStudent('Chloe')">üéí Chloe</button>
        <button class="student-btn" id="sb-both" onclick="setStudent('Ambas')">üëØ Ambas</button>
      </div>
      <input type="hidden" id="f-student" value="Ambas">
    </div>
  </div>

  <!-- Forecast notice -->
  <div class="fcst-notice" id="fcst-notice">
    <b>‚óÜ Previs√£o futura</b> ‚Äî este lan√ßamento <strong>n√£o entra nos totais realizados</strong>. Aparece em violeta separado dos valores pagos.
  </div>

  <!-- DATA FUTURA notice -->
  <div id="future-date-notice" style="display:none;background:var(--amber-l);border:1.5px solid rgba(217,119,6,.3);border-radius:var(--r2);padding:12px 14px;margin:12px 20px 0">
    <b style="color:var(--amber)">üìÖ Data futura detectada</b> ‚Äî tipo alterado para <strong>Previs√£o</strong> automaticamente.
  </div>

  <!-- REFER√äNCIA -->
  <div class="form-section">
    <div class="form-label">Refer√™ncia</div>
    <div class="form-card">
      <div class="field"><span class="field-label">Data pgto.</span><input id="f-date" type="date" onchange="onDateChange()"></div>
      <div class="field"><span class="field-label">Ano Letivo</span><select id="f-year"></select></div>
      <div class="field"><span class="field-label">M√™s</span>
        <select id="f-month">
          <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option>
          <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
          <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
          <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
      </div>
    </div>
  </div>

  <!-- DETALHES -->
  <div class="form-section">
    <div class="form-label">Detalhes</div>
    <div class="form-card">
      <div class="tog-field" onclick="document.getElementById('tog').classList.toggle('on')">
        <span class="tog-label">Recebido com atraso</span>
        <div class="toggle" id="tog"></div>
      </div>
      <div class="field tall"><span class="field-label">Notas</span><textarea id="f-notes" rows="2" placeholder="Observa√ß√µes‚Ä¶"></textarea></div>
      <div class="field"><span class="field-label">Tags</span><input id="f-tags" type="text" placeholder="opcional"></div>
    </div>
  </div>

  <div class="btns">
    <button class="btn primary" onclick="saveTx()">üíæ&nbsp; Salvar Transa√ß√£o</button>
    <button id="del-btn" class="btn destructive" style="display:none" onclick="deleteTx()">üóë&nbsp; Excluir Transa√ß√£o</button>
  </div>
  <div style="height:8px"></div>
</div>

<!-- ‚ñë‚ñë REPORTS ‚ñë‚ñë -->
<div class="page" id="page-rpt">
  <div class="pg-title">Relat√≥rio</div>
  <div id="rpt-actions-bar" style="display:flex;gap:8px;padding:12px 20px 4px;flex-wrap:wrap">
    <button class="pill-btn blue" onclick="printReport()">üñ®Ô∏è&nbsp; Imprimir / PDF</button>
    <button class="pill-btn gray" onclick="openEmailSheet()">‚úâÔ∏è&nbsp; Enviar por Email</button>
    <button class="pill-btn gray" onclick="exportCSV()">üì•&nbsp; CSV</button>
    <button class="pill-btn gray" id="btn-toggle-fcst" onclick="toggleFcstCols()" title="Mostrar/ocultar colunas de previs√£o">‚óÜ&nbsp; Previs√µes</button>
  </div>
  <div id="rpt-content"><div class="empty-state"><span class="spinner"></span></div></div>
  <div id="rpt-hint" style="padding:0 20px 20px;font-size:11px;color:var(--t-4);line-height:2">
    <span style="color:var(--red)">‚ñ† atraso</span> ‚Äî apenas ao lado da data &nbsp;¬∑&nbsp;
    <span style="color:var(--violet)">‚óÜ Previs√£o</span> ‚Äî n√£o entra nos totais &nbsp;¬∑&nbsp;
    <span style="color:var(--green)">Acordo</span> ‚Äî meta cobertura Pai
  </div>
</div>

<!-- ‚ñë‚ñë SETTINGS ‚ñë‚ñë -->
<div class="page" id="page-cfg">
  <div class="pg-title">Configura√ß√µes</div>

  <!-- Acordo Pai -->
  <div class="form-section">
    <div class="form-label">‚öñÔ∏è Acordo com o Pai</div>
    <div class="form-card">
      <div class="field">
        <span class="field-label">Tipo</span>
        <select id="cfg-accord-type" onchange="onAccordTypeChange()">
          <option value="pct">Percentual (%)</option>
          <option value="fixed">Valor fixo (R$)</option>
        </select>
      </div>
      <div class="field" id="cfg-accord-pct-row">
        <span class="field-label">Percentual</span>
        <input id="cfg-accord-pct" type="number" step="0.1" min="0" max="100" placeholder="50" style="max-width:80px">
        <span style="font-size:15px;color:var(--t-3);margin-left:-8px">%</span>
      </div>
      <div class="field" id="cfg-accord-val-row" style="display:none">
        <span class="field-label">Valor (R$)</span>
        <input id="cfg-accord-val" type="number" step="0.01" placeholder="2000,00">
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn primary" onclick="saveAccordConfig()">Salvar Acordo</button></div>
  </div>

  <!-- Gerar Previs√µes -->
  <div class="form-section">
    <div class="form-label">üîÆ Gerar Previs√µes Autom√°ticas</div>
    <div class="form-card" style="padding:16px">
      <p style="font-size:13px;color:var(--t-2);line-height:1.65;margin-bottom:12px">Gera previs√µes de <strong>Mensalidade</strong> e <strong>Pens√£o</strong> para os meses restantes do ano letivo atual.</p>
      <div class="field" style="margin:-16px -16px 12px;border-radius:0;background:var(--bg-2)">
        <span class="field-label">Tipo</span>
        <select id="gen-type" style="text-align:right">
          <option value="both">Mensalidade + Pens√£o</option>
          <option value="mensalidade">Apenas Mensalidade</option>
          <option value="pensao">Apenas Pens√£o</option>
        </select>
      </div>
      <div style="margin-bottom:12px">
        <div class="form-label" style="margin-bottom:8px">Base de valor</div>
        <div class="seg-ctrl">
          <button class="seg-opt on" id="gen-base-last" onclick="setGenBase('last')">√öltimo pago</button>
          <button class="seg-opt" id="gen-base-avg" onclick="setGenBase('avg')">M√©dia do ano</button>
        </div>
      </div>
      <button class="btn violet" style="border-radius:var(--r2)" onclick="generateForecasts()">‚óÜ&nbsp; Gerar Previs√µes</button>
    </div>
  </div>

  <!-- Backup -->
  <div class="form-section">
    <div class="form-label">üíæ Backup</div>
    <div class="form-card">
      <div class="list-row" onclick="exportJSON()">
        <div class="list-icon" style="background:var(--accent-l)">üíæ</div>
        <div class="list-label">Exportar backup JSON</div>
        <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="list-row" onclick="document.getElementById('imp-file').click()">
        <div class="list-icon" style="background:var(--green-l)">üìÇ</div>
        <div class="list-label">Importar backup JSON</div>
        <input type="file" id="imp-file" accept=".json" style="display:none" onchange="importJSON(event.target.files[0])">
        <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
    </div>
    <div id="imp-msg" style="display:none;margin-top:8px;padding:12px 14px;border-radius:var(--r);font-size:13px;font-weight:500;line-height:1.5"></div>
  </div>

  <!-- Partes -->
  <div class="form-section">
    <div class="form-label">üë• Partes</div>
    <div class="form-card" id="party-list-wrap"></div>
    <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="openPartySheet(null)">+ Nova Parte</button></div>
  </div>

  <!-- Categorias -->
  <div class="form-section">
    <div class="form-label">üè∑Ô∏è Categorias</div>
    <div class="form-card" id="cat-list-wrap"></div>
    <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="document.getElementById('cat-sheet').classList.add('open')">+ Nova Categoria</button></div>
  </div>

  <!-- Dados -->
  <div class="form-section">
    <div class="form-label">üìä Dados</div>
    <div class="form-card">
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--accent-l)">üìä</div><div class="list-label">Total transa√ß√µes</div><div class="list-value" id="stat-count">‚Äî</div></div>
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--orange-l)">üìÖ</div><div class="list-label">Anos com dados</div><div class="list-value" id="stat-years">‚Äî</div></div>
      <div class="list-row" style="cursor:default"><div class="list-icon" style="background:var(--violet-l)">üìé</div><div class="list-label">Arquivos IA armazenados</div><div class="list-value" id="stat-files">‚Äî</div></div>
      <div class="list-row" onclick="clearAll()"><div class="list-icon" style="background:var(--red-l)">‚ö†Ô∏è</div><div class="list-label" style="color:var(--red)">Apagar todos os dados</div><div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div></div>
    </div>
  </div>

  <div class="form-section" style="margin-bottom:20px">
    <div class="form-label">üì± Instalar no iPhone / iPad</div>
    <div class="form-card" style="padding:14px 16px">
      <p style="font-size:15px;color:var(--t-2);line-height:2.1">1. Abra no <strong>Safari</strong><br>2. Toque em <strong>‚¨ÜÔ∏è Compartilhar</strong><br>3. <strong>"Adicionar √† Tela de In√≠cio"</strong></p>
    </div>
  </div>
</div><!-- /page-cfg -->

</div><!-- /scroller -->
</div><!-- /shell -->

<!-- PHONE TABBAR -->
<div class="tabbar">
  <button class="tab on" id="t-dash" onclick="nav('dash')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>In√≠cio<span id="tb-alert-badge" class="tab-badge" style="display:none">!</span></button>
  <button class="tab" id="t-txs" onclick="nav('txs')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>Transa√ß√µes</button>
  <button class="tab" id="t-add" onclick="nav('add')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Novo</button>
  <button class="tab" id="t-rpt" onclick="nav('rpt')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>Relat√≥rio</button>
  <button class="tab" id="t-cfg" onclick="nav('cfg')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Config</button>
</div>
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê SHEETS ‚ïê‚ïê‚ïê -->
<!-- TX DETAIL SHEET -->
<div class="sheet-bg" id="tx-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title" id="sh-title">Transa√ß√£o</div><button class="sheet-close" onclick="closeSheet('tx-sheet')">Fechar</button></div>
    <div id="sh-body"></div>
  </div>
</div>

<!-- CAT SHEET -->
<div class="sheet-bg" id="cat-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title">Nova Categoria</div><button class="sheet-close" onclick="closeSheet('cat-sheet')">Cancelar</button></div>
    <div style="padding:16px">
      <div class="form-card">
        <div class="field"><span class="field-label">Chave</span><input id="nc-key" placeholder="ex: excursao"></div>
        <div class="field"><span class="field-label">Nome</span><input id="nc-label" placeholder="ex: Excurs√£o"></div>
        <div class="field"><span class="field-label">Cor</span><input id="nc-color" type="color" value="#3B5BDB" style="width:44px;height:30px;border:none;background:none;cursor:pointer;-webkit-appearance:none;padding:0;margin-left:auto"></div>
      </div>
      <div style="margin-top:12px"><button class="btn primary" onclick="saveCat()">Criar Categoria</button></div>
    </div>
  </div>
</div>

<!-- PARTY SHEET -->
<div class="sheet-bg" id="party-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr"><div class="sheet-title" id="ps-title">Nova Parte</div><button class="sheet-close" onclick="closeSheet('party-sheet')">Cancelar</button></div>
    <div style="padding:16px">
      <input type="hidden" id="ps-id">
      <div class="form-card" style="margin-bottom:12px">
        <div class="field"><span class="field-label">Nome</span><input id="ps-name" placeholder="ex: Av√≥, Tio‚Ä¶" maxlength="40"></div>
        <div class="field"><span class="field-label">Emoji</span>
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">
            <span id="ps-emoji-preview" style="font-size:22px">üë§</span>
            <button onclick="toggleEmojiPicker()" style="border:1px solid var(--sep);border-radius:var(--r);padding:5px 10px;background:var(--bg-2);font:500 12px/1 var(--f);cursor:pointer;color:var(--t-2)">Escolher</button>
          </div>
        </div>
      </div>
      <!-- Emoji Picker -->
      <div id="emoji-picker" style="display:none;background:var(--card);border:1px solid var(--sep-l);border-radius:var(--r2);margin-bottom:12px;overflow:hidden">
        <div style="padding:8px 12px;font-size:11px;font-weight:600;color:var(--t-3);border-bottom:1px solid var(--sep-l)">Escolher √≠cone</div>
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>
      <input type="hidden" id="ps-emoji" value="üë§">
      <button class="btn primary" onclick="saveParty()">Salvar Parte</button>
      <div id="ps-del-wrap" style="margin-top:8px;display:none"><button class="btn destructive" onclick="deleteParty()">Excluir Parte</button></div>
    </div>
  </div>
</div>

<!-- FORECAST CONVERT SHEET -->
<div class="sheet-bg" id="convert-sheet">
  <div class="sheet" style="max-height:90vh;overflow-y:auto">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title">‚ö° Converter em Pagamento</div>
      <button class="sheet-close" onclick="closeSheet('convert-sheet')">Cancelar</button>
    </div>
    <div style="padding:16px 16px 24px">

      <div id="conv-fcst-info" style="
        margin-bottom:16px;padding:12px 14px;
        background:var(--violet-l);border:1px solid var(--violet-d);
        border-radius:var(--r2);font-size:13px;color:var(--violet);
      "></div>

      <div class="form-card" style="margin-bottom:12px">
        <div class="field">
          <span class="field-label">Tipo</span>
          <select id="conv-type">
            <option value="PAID">Sa√≠da (pago)</option>
            <option value="RECEIVED">Entrada (recebido)</option>
          </select>
        </div>
        <div class="field">
          <span class="field-label">Valor (R$)</span>
          <input id="conv-val" type="number" step="0.01" inputmode="decimal" placeholder="0,00">
        </div>
        <div class="field">
          <span class="field-label">Data pagamento</span>
          <input id="conv-date" type="date">
        </div>
        <div class="field">
          <span class="field-label">Notas</span>
          <input id="conv-notes" type="text" placeholder="Opcional">
        </div>
        <div class="field" style="align-items:center">
          <span class="field-label">Atraso?</span>
          <div id="conv-tog" class="toggle" onclick="this.classList.toggle('on')" style="flex-shrink:0"></div>
        </div>
      </div>

      <!-- Comprovante -->
      <div style="margin-bottom:16px">
        <div class="form-label" style="padding:0 2px;margin-bottom:8px">üìé Comprovante</div>
        <div id="conv-doc-drop" class="doc-drop" onclick="document.getElementById('conv-file-input').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="onConvDocDrop(event)">
          <input type="file" id="conv-file-input" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" onchange="loadConvFile(event.target.files[0])">
          <div id="conv-doc-idle"><div style="font-size:20px;margin-bottom:3px">üìÑ</div><div style="font-size:12px;font-weight:500;color:var(--t-2)">Toque para anexar comprovante</div><div style="font-size:11px;color:var(--t-3)">PDF ¬∑ JPG ¬∑ PNG</div></div>
          <div id="conv-file-info" style="display:none;align-items:center;gap:10px">
            <span id="conv-file-ic" style="font-size:22px">üìÑ</span>
            <div style="flex:1;min-width:0">
              <div id="conv-file-nm" style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--t-1)"></div>
              <div id="conv-file-sz" style="font-size:11px;color:var(--t-3);margin-top:1px"></div>
            </div>
            <button onclick="clearConvFile(event)" style="background:var(--fill);border:none;border-radius:100px;padding:5px 10px;font:500 12px/1 var(--f);color:var(--t-2);cursor:pointer;flex-shrink:0">Remover</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="conv-id">
      <button class="btn green" style="width:100%" onclick="confirmConvert()">‚úÖ&nbsp; Confirmar Pagamento</button>
    </div>
  </div>
</div>

<!-- ‚ñë‚ñë EMAIL SHEET ‚ñë‚ñë -->
<div class="sheet-bg" id="email-sheet">
  <div class="sheet" style="max-height:85vh;overflow-y:auto">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title">‚úâÔ∏è Enviar Relat√≥rio por Email</div>
      <button class="sheet-close" onclick="closeSheet('email-sheet')">Cancelar</button>
    </div>
    <div style="padding:16px 16px 28px">

      <!-- Step 1: generate PDF -->
      <div id="email-step-1">
        <p style="font-size:13px;color:var(--t-2);line-height:1.6;margin-bottom:16px">
          O relat√≥rio ser√° gerado como PDF e voc√™ poder√° envi√°-lo pelo seu aplicativo de email preferido.
        </p>
        <div class="form-card" style="margin-bottom:16px">
          <div class="field">
            <span class="field-label">Destinat√°rio</span>
            <input id="email-to" type="email" inputmode="email" placeholder="email@exemplo.com" style="flex:1">
          </div>
          <div class="field">
            <span class="field-label">Assunto</span>
            <input id="email-subject" type="text" value="Relat√≥rio de Pagamentos" style="flex:1">
          </div>
          <div class="field">
            <span class="field-label">Mensagem</span>
            <input id="email-body" type="text" value="Segue o relat√≥rio de pagamentos em anexo." style="flex:1">
          </div>
        </div>

        <!-- PDF options -->
        <div style="margin-bottom:16px;padding:12px 14px;background:var(--bg-2);border-radius:var(--r);border:1px solid var(--sep-l)">
          <div style="font-size:12px;font-weight:600;color:var(--t-2);margin-bottom:10px">üìÑ Op√ß√µes do PDF</div>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--t-2);cursor:pointer;margin-bottom:8px">
            <input type="checkbox" id="email-hide-fcst" style="width:16px;height:16px;accent-color:var(--accent)">
            Ocultar colunas de previs√£o
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--t-2);cursor:pointer">
            <input type="checkbox" id="email-year-only" style="width:16px;height:16px;accent-color:var(--accent)">
            Apenas o ano selecionado (ignorar "Todos")
          </label>
        </div>

        <div id="email-gen-status" style="display:none;text-align:center;padding:16px;background:var(--accent-l);border-radius:var(--r);margin-bottom:16px;font-size:13px;color:var(--accent)">
          <span class="spinner" style="display:inline-block;margin-right:8px"></span>Gerando PDF‚Ä¶
        </div>

        <button class="btn primary" onclick="generateAndEmail()" id="email-gen-btn">
          üìß&nbsp; Enviar Relat√≥rio por Email
        </button>
      </div>

      <!-- Step 2: enviado com sucesso -->
      <div id="email-step-2" style="display:none">
        <div style="text-align:center;padding:20px 0">
          <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
          <div style="font-size:16px;font-weight:600;color:var(--t-1);margin-bottom:6px">Email enviado!</div>
          <div id="email-summary" style="font-size:13px;color:var(--t-2);line-height:1.6;margin-bottom:20px"></div>
          <button class="btn secondary" onclick="closeSheet('email-sheet')">Fechar</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê -->
<script>
'use strict';
/* ‚îÄ‚îÄ SUPABASE CREDENTIALS ‚îÄ‚îÄ embutidas diretamente no app ‚îÄ‚îÄ */
const SUPABASE_URL      = 'https://rrdxukcfdpacnixqhgsp.supabase.co';
const EMAILJS_SERVICE_ID  = 'service_8e4rkde';
const EMAILJS_TEMPLATE_ID = 'template_yfmczq7';
const EMAILJS_PUBLIC_KEY  = 'kFhXkHmfCWR6BHTa5';

const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZHh1a2NmZHBhY25peHFoZ3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNjk4NDEsImV4cCI6MjA4Nzg0NTg0MX0.n2fD3bqGoU62m8tKzfSRN2ofZcaEfZnTudyPS7Forck';
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCHOOL LEDGER v5 ‚Äî Engine
   IndexedDB v4: txs, cats, cfg, parties, ai_files
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ SUPABASE CLIENT ‚îÄ‚îÄ‚îÄ */
let _sb = null;  // Supabase client instance ‚Äî set by sbConnect()

// ‚îÄ‚îÄ Mapeamentos JS (camelCase) ‚Üî Postgres (snake_case) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function _txToRow(tx) {
  // Allowlist expl√≠cito ‚Äî APENAS colunas que existem na tabela transactions
  // Qualquer campo extra (fileData, fileName, fileType, createdAt, updatedAt...) √© ignorado
  const r = {
    amount:         Number(tx.amount),
    type:           tx.type,
    category_key:   tx.categoryKey,
    party_id:       tx.partyId   || null,
    party_legacy:   tx.party     || null,
    date:           tx.date,
    academic_year:  tx.academicYear,
    academic_month: tx.academicMonth,
    is_late:        !!tx.isLate,
    student:        tx.student   || 'Ambas',
    notes:          tx.notes     || null,
    tags:           tx.tags      || null,
    file_path:      tx.filePath  || null,   // Supabase Storage path
  };
  if (tx.id) r.id = tx.id;
  return r;
}

function _rowToTx(r) {
  return {
    id:            r.id,
    amount:        Number(r.amount),
    type:          r.type,
    categoryKey:   r.category_key,
    partyId:       r.party_id,
    party:         r.party_legacy,
    date:          r.date,
    academicYear:  r.academic_year,
    academicMonth: r.academic_month,
    isLate:        r.is_late,
    student:       r.student,
    notes:         r.notes,
    tags:          r.tags,
    filePath:      r.file_path || null,    // Supabase Storage path
    createdAt:     r.created_at,
    updatedAt:     r.updated_at,
  };
}

function _rowToCat(r)   { return { key: r.key, label: r.label, color: r.color, system: r.is_system }; }
function _rowToParty(r) { return { id: r.id, name: r.name, emoji: r.emoji, createdAt: r.created_at }; }

// ‚îÄ‚îÄ Abstra√ß√£o de DB ‚Äî o resto do app N√ÉO muda ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function dbAll(store) {
  if (store === 'txs') {
    const { data, error } = await _sb.from('transactions').select('*').order('date', { ascending: false });
    if (error) throw error;
    return data.map(_rowToTx);
  }
  if (store === 'cats') {
    const { data, error } = await _sb.from('categories').select('*').order('key');
    if (error) throw error;
    return data.map(_rowToCat);
  }
  if (store === 'parties') {
    const { data, error } = await _sb.from('parties').select('*').order('name');
    if (error) throw error;
    return data.map(_rowToParty);
  }
  if (store === 'cfg') {
    const { data, error } = await _sb.from('app_config').select('*');
    if (error) throw error;
    return data.map(r => ({ k: r.k, ...r.value }));
  }
  if (store === 'ai_files') {
    // Arquivos ficam no IndexedDB local ‚Äî n√£o v√£o ao Supabase
    return _idbAll();
  }
  return [];
}

async function dbGet(store, key) {
  if (store === 'cfg') {
    const { data, error } = await _sb.from('app_config').select('*').eq('k', key).maybeSingle();
    if (error) throw error;
    return data ? { k: data.k, ...data.value } : null;
  }
  if (store === 'txs') {
    const { data, error } = await _sb.from('transactions').select('*').eq('id', key).maybeSingle();
    if (error) throw error;
    return data ? _rowToTx(data) : null;
  }
  if (store === 'parties') {
    const { data, error } = await _sb.from('parties').select('*').eq('id', key).maybeSingle();
    if (error) throw error;
    return data ? _rowToParty(data) : null;
  }
  return null;
}

async function dbPut(store, val) {
  if (store === 'txs') {
    const row = _txToRow(val);
    if (row.id) {
      // UPDATE
      // Remove quaisquer campos que n√£o existem na tabela (prote√ß√£o extra)
      const VALID_COLS = ['id','amount','type','category_key','party_id','party_legacy','date','academic_year','academic_month','is_late','student','notes','tags','file_path'];
      Object.keys(row).forEach(k => { if(!VALID_COLS.includes(k)) delete row[k]; });
      console.log('dbPut UPDATE row:', JSON.stringify(row));
      const { data, error } = await _sb.from('transactions').update(row).eq('id', row.id).select('id').single();
      if (error) throw new Error(error.message + (error.details?' | '+error.details:'') + (error.hint?' | hint:'+error.hint:''));
      return data.id;
    } else {
      // INSERT
      // Remove quaisquer campos que n√£o existem na tabela (prote√ß√£o extra)
      const VALID_COLS = ['id','amount','type','category_key','party_id','party_legacy','date','academic_year','academic_month','is_late','student','notes','tags','file_path'];
      Object.keys(row).forEach(k => { if(!VALID_COLS.includes(k)) delete row[k]; });
      console.log('dbPut INSERT row:', JSON.stringify(row));
      const { data, error } = await _sb.from('transactions').insert(row).select('id').single();
      if (error) throw new Error(error.message + (error.details?' | '+error.details:'') + (error.hint?' | hint:'+error.hint:''));
      return data.id;
    }
  }
  if (store === 'cats') {
    const { error } = await _sb.from('categories').upsert({
      key: val.key, label: val.label, color: val.color, is_system: val.system || false
    }, { onConflict: 'key' });
    if (error) throw error;
    return val.key;
  }
  if (store === 'parties') {
    if (val.id) {
      const { data, error } = await _sb.from('parties')
        .upsert({ id: val.id, name: val.name, emoji: val.emoji || 'üë§' }, { onConflict: 'id' })
        .select('id').single();
      if (error) throw error;
      return data.id;
    } else {
      const { data, error } = await _sb.from('parties')
        .insert({ name: val.name, emoji: val.emoji || 'üë§' })
        .select('id').single();
      if (error) throw error;
      return data.id;
    }
  }
  if (store === 'cfg') {
    const { k, ...rest } = val;
    const { error } = await _sb.from('app_config')
      .upsert({ k, value: rest }, { onConflict: 'k' });
    if (error) throw error;
    return k;
  }
  if (store === 'ai_files') {
    return _idbPut(val);
  }
}

async function dbDel(store, key) {
  if (store === 'txs')     { const { error } = await _sb.from('transactions').delete().eq('id', key);      if (error) throw error; return; }
  if (store === 'cats')    { const { error } = await _sb.from('categories').delete().eq('key', key);       if (error) throw error; return; }
  if (store === 'parties') { const { error } = await _sb.from('parties').delete().eq('id', key);           if (error) throw error; return; }
  if (store === 'ai_files') { return _idbDel(key); }
}

async function dbClear(store) {
  // Apaga todos os registros de uma tabela
  const map = { txs:'transactions', cats:'categories', parties:'parties', cfg:'app_config' };
  const tbl = map[store]; if (!tbl) return;
  const pkCol = (store === 'cats') ? 'key' : (store === 'cfg') ? 'k' : 'id';
  // neq trick: deleta onde pk != valor imposs√≠vel (= todos os rows)
  const { error } = await _sb.from(tbl).delete().neq(pkCol, store === 'txs' ? -1 : '__never__');
  if (error) console.error('dbClear', store, error);
}

// ‚îÄ‚îÄ IndexedDB LOCAL ‚Äî apenas para arquivos anexados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/* ‚îÄ‚îÄ‚îÄ SUPABASE STORAGE ‚Äî arquivos anexados ficam na nuvem ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Bucket: "attachments" (criado no Supabase Storage)
   Path:   attachments/tx-{txId}-{timestamp}.{ext}
   A tabela transactions guarda file_path (text) em vez de file_id (integer)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const _BUCKET = 'attachments';

async function _openIDB() { /* Supabase Storage ‚Äî sem IndexedDB necess√°rio */ }

// Upload: recebe File object, devolve { path, name, size, type, ext }
async function _storageUpload(file, txId) {
  const ext = file.name.split('.').pop().toLowerCase();
  const path = `tx-${txId||'new'}-${Date.now()}.${ext}`;

  // Tenta upload ‚Äî se o bucket n√£o existir, cria e tenta de novo
  let { error } = await _sb.storage.from(_BUCKET).upload(path, file, {
    contentType: file.type, upsert: true
  });

  if (error && error.message === 'Bucket not found') {
    // Cria o bucket automaticamente
    const { error: bucketErr } = await _sb.storage.createBucket(_BUCKET, {
      public: false, allowedMimeTypes: ['image/*','application/pdf','text/plain'],
      fileSizeLimit: 20971520 // 20 MB
    });
    if (bucketErr && !bucketErr.message.includes('already exists')) {
      throw new Error('N√£o foi poss√≠vel criar o bucket: ' + bucketErr.message);
    }
    // Tenta o upload novamente
    const retry = await _sb.storage.from(_BUCKET).upload(path, file, {
      contentType: file.type, upsert: true
    });
    error = retry.error;
  }

  if (error) throw new Error('Upload falhou: ' + error.message);
  return { path, name: file.name, size: file.size, type: file.type, ext };
}

// Download: devolve URL p√∫blica assinada (1 hora)
async function _storageGetUrl(path) {
  const { data, error } = await _sb.storage.from(_BUCKET).createSignedUrl(path, 3600);
  if (error) throw new Error('URL falhou: ' + error.message);
  return data.signedUrl;
}

// Download como base64 (para preview inline)
async function _storageDownload(path) {
  const { data, error } = await _sb.storage.from(_BUCKET).download(path);
  if (error) throw new Error('Download falhou: ' + error.message);
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result); // base64 dataURL
    reader.onerror = rej;
    reader.readAsDataURL(data);
  });
}

// Delete
async function _storageDelete(path) {
  const { error } = await _sb.storage.from(_BUCKET).remove([path]);
  if (error) console.warn('Storage delete falhou:', error.message);
}

// Compatibilidade: dbAll/dbGet/dbPut/dbDel para 'ai_files' agora s√£o no-ops
// (o caminho do arquivo fica em transactions.file_path diretamente)
function _idbAll()  { return Promise.resolve([]); }
function _idbGet(k) { return Promise.resolve(null); }
function _idbPut(v) { return Promise.resolve(null); }
function _idbDel(k) { return Promise.resolve(); }

// ‚îÄ‚îÄ Supabase setup / connect / disconnect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sbConnect() {
  const url = ($('sb-url-inp').value || '').trim().replace(/\/+$/, '');
  const key = ($('sb-key-inp').value || '').trim();
  const errEl = $('sb-setup-err');
  const btn   = $('sb-connect-btn');
  errEl.style.display = 'none';

  if (!url.startsWith('https://')) {
    errEl.textContent = '‚ùå URL inv√°lida ‚Äî deve come√ßar com https://';
    errEl.style.display = 'block'; return;
  }
  if (key.length < 100) {
    errEl.textContent = '‚ùå Anon key inv√°lida ou incompleta.';
    errEl.style.display = 'block'; return;
  }

  btn.textContent = 'Conectando‚Ä¶'; btn.disabled = true;
  try {
    _sb = supabase.createClient(url, key, {
      auth: { persistSession: false, autoRefreshToken: false },
      realtime: { params: { eventsPerSecond: -1 } },
      global: { fetch: (input, init) => {
        if (init?.headers instanceof Headers) {
          init = { ...init, headers: Object.fromEntries(init.headers.entries()) };
        }
        return fetch(input, init);
      }}
    });
    // Test connection with a lightweight query
    const { error } = await _sb.from('categories').select('key').limit(1);
    if (error) throw new Error(error.message);

    localStorage.setItem('sb-url', url);
    localStorage.setItem('sb-key', key);
    $('sb-setup-screen').style.display = 'none';
    await _bootApp();
  } catch (e) {
    errEl.textContent = '‚ùå Conex√£o falhou: ' + (e.message || e) + '\nVerifique URL e anon key.';
    errEl.style.display = 'block';
    btn.textContent = 'Conectar ‚Üí'; btn.disabled = false;
    _sb = null;
  }
}

function sbDisconnect() {
  if (!confirm('Desconectar do Supabase? O app reconectar√° automaticamente na pr√≥xima abertura.')) return;
  localStorage.removeItem('sb-url');
  localStorage.removeItem('sb-key');
  sessionStorage.removeItem('sl-auth');
  location.reload();
}

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
const S = { year: new Date().getFullYear(), tab:'dash', cats:[], parties:[], editId:null, genBase:'last', accord:{type:'pct',pct:50,val:0}, fcstVisible:true, hiddenCats:new Set(), hiddenFcstCats:new Set(), hiddenFunding:new Set(), _pendingFile:null, _existingFilePath:null, _removeFile:false, _convFile:null };
const MO = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MF = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CAT_PAID  = ['mensalidade','matricula','material','uniforme','extra'];
const CAT_RECV  = ['pensao'];
const CAT_ORDER = [...CAT_PAID,'pensao'];
const TODAY = new Date().toISOString().split('T')[0];
/* Forecast chart uses lighter pastel versions */
const FCST_COLORS = { mensalidade:'#818CF8', matricula:'#FB923C', material:'#2DD4BF', uniforme:'#A78BFA', extra:'#34D399', pensao:'#F87171' };

/* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
const brl    = v => Math.abs(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const brlFmt = v => 'R$\u202F' + brl(v);  // full format for lists/reports
const brlK   = v => 'R$\u202F' + (Math.abs(v||0) >= 10000 ? (v/1000).toFixed(0)+'k' : Math.round(Math.abs(v||0)).toLocaleString('pt-BR')); // dashboard: no decimals, K only for large
const fmtD   = iso => { if(!iso)return '‚Äî'; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
const $      = id => document.getElementById(id);
const isFuture = iso => iso && iso > TODAY;

function toast(msg, ms=2800){ const t=$('toast'); t.textContent=msg; t.classList.add('on'); clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('on'),ms); }
function catInfo(k){ return S.cats.find(c=>c.key===k)||{key:k,label:k,color:'#8E8E93'}; }
function catEmoji(k){ return {mensalidade:'üè´',matricula:'üìù',material:'üìö',uniforme:'üëï',extra:'üé≠',pensao:'üí∞'}[k]||'üìå'; }
function closeSheet(id){ $(id).classList.remove('open'); }

function partyLabel(tx){
  if(tx.partyId){ const p=S.parties.find(p=>Number(p.id)===Number(tx.partyId)); if(p) return (p.emoji?p.emoji+' ':'')+p.name; }
  const m={Me:'üë§ D√©cio',Father:'üë® Pai (D√©cio)',School:'üè´ Escola',Store:'üè™ Loja',Other:'üë• Outro'};
  return m[tx.party]||tx.party||'‚Äî';
}

function getAccordTarget(subtotal){
  const a = S.accord;
  if(a.type==='pct') return subtotal * (a.pct/100);
  return a.val || 0;
}

/* ‚îÄ‚îÄ‚îÄ ALERTS: find overdue forecasts ‚îÄ‚îÄ‚îÄ */
async function getOverdueForecasts(){
  const all = await dbAll('txs');
  return all.filter(r => r.type==='FORECAST' && r.date && r.date <= TODAY);
}

async function renderAlerts(containerId){
  const overdues = await getOverdueForecasts();
  const filtered = (S.year==='all') ? overdues : overdues.filter(r=>r.academicYear===S.year);
  const wrap = $(containerId); if(!wrap) return;
  // update badges
  const count = filtered.length;
  [$('tb-alert-badge'),$('sb-alert-badge')].forEach(el=>{ if(el){ el.style.display=count?'inline':'none'; el.textContent=count||''; } });
  if(!count){ wrap.style.display='none'; wrap.innerHTML=''; return; }
  wrap.style.display='block';
  wrap.innerHTML = filtered.slice(0,3).map(r => `
    <div class="alert-item" onclick="openConvertSheet(${r.id})">
      <div class="alert-icon">‚ö°</div>
      <div class="alert-body">
        <div class="alert-title">Previs√£o vencida ‚Äî converter em pagamento</div>
        <div class="alert-desc">${catInfo(r.categoryKey).label} ¬∑ ${fmtD(r.date)} ¬∑ ${brlFmt(r.amount)}</div>
      </div>
      <div class="alert-cta">Converter ‚Üí</div>
    </div>`).join('') +
    (filtered.length > 3 ? `<div style="padding:8px 14px;font-size:12px;color:var(--t-3)">+${filtered.length-3} outras previs√µes vencidas</div>` : '');
}

/* ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ */
function nav(tab){
  S.tab=tab;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('on'));
  $('page-'+tab).classList.add('on');
  const tb=$('t-'+tab); if(tb) tb.classList.add('on');
  const si=$('si-'+tab); if(si) si.classList.add('on');
  if(tab !== 'txs') $('scroller').scrollTop=0;
  const hideYr = tab==='rpt'||tab==='cfg';
  const navYr = document.querySelector('.navbar .yr-badge'); if(navYr) navYr.style.display = hideYr?'none':'flex';
  const titles={dash:'Pagamentos',txs:'Transa√ß√µes',add:S.editId?'Editar':'Nova Transa√ß√£o',rpt:'Relat√≥rio',cfg:'Configura√ß√µes'};
  const titleEl=$('nav-title-txt')||$('nav-title');
  if(titleEl) titleEl.textContent=titles[tab]||'';
  if(tab==='dash'){ renderDash(); }
  if(tab==='txs') { renderTxList(); renderAlerts('tx-alerts'); }
  if(tab==='add' && !S.editId) resetForm();
  if(tab==='rpt') renderReport();
  if(tab==='cfg') renderCfg();
}

/* ‚îÄ‚îÄ‚îÄ YEAR FILTER ‚îÄ‚îÄ‚îÄ */
async function initYearFilter(){
  const rows = await dbAll('txs');
  const now  = new Date().getFullYear();
  let years = [...new Set(rows.map(r=>r.academicYear))].filter(Boolean);
  if(!years.includes(now)) years.push(now);
  years.sort((a,b)=>a-b);

  const opts = `<option value="all">Todos os anos</option>`+years.map(y=>`<option value="${y}">${y===now?y+' (atual)':y}</option>`).join('');
  const onChange = e => {
    S.year = e.target.value==='all' ? 'all' : +e.target.value;
    ['yr-sel','yr-sel-sb'].forEach(id=>{ const s=$(id); if(s) s.value=String(S.year); });
    if(S.tab==='dash') renderDash();
    if(S.tab==='txs')  renderTxList();
    if(S.tab==='rpt')  renderReport();
  };

  [$('yr-sel'),$('yr-sel-sb')].forEach(sel=>{ if(!sel) return; sel.innerHTML=opts; sel.value=String(now); sel.onchange=onChange; });

  const fy=$('f-year');
  if(fy){ fy.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); fy.value=now; }
  S.year=now;
}

/* ‚îÄ‚îÄ‚îÄ CALC SUMMARY ‚îÄ‚îÄ‚îÄ */
async function calcSummary(year){
  const rows = await dbAll('txs');
  const txs  = (year==='all'?rows:rows.filter(r=>r.academicYear===year)).filter(r=>r.type!=='FORECAST');
  const paid  = txs.filter(r=>r.type==='PAID').reduce((a,r)=>a+r.amount,0);
  const recv  = txs.filter(r=>r.type==='RECEIVED').reduce((a,r)=>a+r.amount,0);
  const late  = txs.filter(r=>r.isLate).length;
  const byCat = {};
  txs.forEach(r=>{ byCat[r.categoryKey]=(byCat[r.categoryKey]||0)+r.amount; });
  const byMonth = Array.from({length:12},()=>({}));
  txs.forEach(r=>{ const m=r.academicMonth-1; byMonth[m][r.categoryKey]=(byMonth[m][r.categoryKey]||0)+r.amount; });
  return {paid,recv,deficit:paid-recv,late,byCat,byMonth};
}

/* ‚îÄ‚îÄ‚îÄ CALC FORECAST ‚îÄ‚îÄ‚îÄ */
async function calcForecast(year){
  const rows = await dbAll('txs');
  const txs  = (year==='all'?rows:rows.filter(r=>r.academicYear===year)).filter(r=>r.type==='FORECAST');
  const total=txs.reduce((a,r)=>a+r.amount,0), count=txs.length;
  const byCat={}, byMonth=Array(12).fill(null).map(()=>({}));
  txs.forEach(r=>{ byCat[r.categoryKey]=(byCat[r.categoryKey]||0)+r.amount; byMonth[r.academicMonth-1][r.categoryKey]=(byMonth[r.academicMonth-1][r.categoryKey]||0)+r.amount; });
  return {total,count,byCat,byMonth};
}

/* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
async function renderDash(){
  // Show data source banner
  const banner = $('db-source-banner');
  const bannerTxt = $('db-source-text');
  if(bannerTxt){
    bannerTxt.textContent = '‚úÖ Supabase ¬∑ atualizado ' + new Date().toLocaleTimeString('pt-BR');
  }
  const [d,fc] = await Promise.all([calcSummary(S.year),calcForecast(S.year)]);
  const yrL = S.year==='all'?'Todos':S.year;

  // Accord
  const a = S.accord;
  const subtotal = (d.byCat.mensalidade||0)+(d.byCat.matricula||0)+(d.byCat.material||0)+(d.byCat.extra||0);
  const accordTarget = getAccordTarget(subtotal);
  const accordReal   = d.recv;
  const accordDiff   = accordReal - accordTarget;
  const accordPct    = subtotal>0?(accordReal/subtotal*100).toFixed(1):0;
  const agreedPct    = a.type==='pct'?a.pct:subtotal>0?(a.val/subtotal*100).toFixed(1):0;

  $('kpi-row').innerHTML=`
    <div class="kpi blue"><div class="kpi-label">Pago ‚Äî ${yrL}</div><div class="kpi-value">${brlK(d.paid)}</div><div class="kpi-sub">${brlFmt(d.paid)}</div></div>
    <div class="kpi green"><div class="kpi-label">Pens√£o ‚Äî ${yrL}</div><div class="kpi-value">${brlK(d.recv)}</div><div class="kpi-sub">${d.late} com atraso</div></div>
    <div class="kpi ${d.deficit>0?'red':'green'}"><div class="kpi-label">D√©ficit ‚Äî ${yrL}</div><div class="kpi-value">${d.deficit>0?'‚Äì':''}${brlK(d.deficit)}</div><div class="kpi-sub">descoberto</div></div>`;

  $('accord-kpi-wrap').innerHTML = accordTarget>0 ? `
    <div style="padding:12px 20px 0"><div style="font-size:10px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.07em">‚öñÔ∏è Acordo com o Pai</div></div>
    <div class="kpi-row" style="padding-top:6px">
      <div class="kpi green"><div class="kpi-label">Meta acordo</div><div class="kpi-value">${brlK(accordTarget)}</div><div class="kpi-sub">${a.type==='pct'?agreedPct+'% do subtotal':'Valor fixo acordado'}</div></div>
      <div class="kpi ${accordDiff>=0?'green':'red'}"><div class="kpi-label">Desvio acordo</div><div class="kpi-value">${accordDiff>=0?'+':'-'}${brlK(Math.abs(accordDiff))}</div><div class="kpi-sub">${accordPct}% real vs ${agreedPct}% meta</div></div>
    </div>` : '';

  const fw=$('fcst-kpi-wrap');
  if(fc.count>0){
    const topF=Object.entries(fc.byCat).sort((a,b)=>b[1]-a[1])[0];
    fw.innerHTML=`
      <div style="padding:12px 20px 0"><div style="font-size:10px;font-weight:600;color:var(--violet);text-transform:uppercase;letter-spacing:.07em">‚óÜ Previs√µes Futuras</div></div>
      <div class="kpi-row" style="padding-top:6px">
        <div class="kpi violet fcst-kpi"><div class="kpi-label">‚óÜ Total Previsto</div><div class="kpi-value">${brlK(fc.total)}</div><div class="kpi-sub">${fc.count} lan√ßamento${fc.count>1?'s':''}</div></div>
        ${topF?`<div class="kpi violet fcst-kpi"><div class="kpi-label">‚óÜ Maior Previs√£o</div><div class="kpi-value" style="font-size:16px">${catInfo(topF[0]).label}</div><div class="kpi-sub">${brlK(topF[1])}</div></div>`:''}
      </div>`;
  } else fw.innerHTML='';

  requestAnimationFrame(()=>requestAnimationFrame(()=>drawCharts(d,fc)));
  await renderAlerts('dash-alerts');

  const allRows = await dbAll('txs');
  const recent  = (S.year==='all'?allRows:allRows.filter(r=>r.academicYear===S.year))
    .sort((a,b)=> b.id - a.id ).slice(0,5);
  $('recent-card').innerHTML = recent.length ? recent.map(txHTML).join('') : '<div class="empty-state"><div class="ic">üì≠</div>Sem transa√ß√µes</div>';
}

/* ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ */
function drawCharts(d,fc){
  const bc=d.byCat||{};
  const gt=Object.values(bc).reduce((a,v)=>a+v,0);
  const def=d.paid-d.recv;
  const hasFcst=fc&&fc.count>0;

  $('chart-area').innerHTML=`
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">Vis√£o Geral ‚Äî ${S.year==='all'?'Todos os anos':S.year}</div>
      <div style="display:flex;gap:10px">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv1" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Financiamento</div>
          <div id="pie1-leg" style="width:100%;display:flex;flex-direction:column;gap:4px"></div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv2" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Categorias</div>
          <div id="pie2-leg" style="width:100%;display:flex;flex-direction:column;gap:4px"></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">Despesas Realizadas por M√™s</div>
      <canvas id="cv3" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px" id="leg-confirmed">
        ${CAT_ORDER.map(k=>{const hi=S.hiddenCats.has(k);return`<div class="leg-item leg-toggle${hi?' leg-off':''}" onclick="toggleCat('${k}','confirmed')"><div class="leg-swatch" style="background:${catInfo(k).color}"></div><span>${catInfo(k).label}</span></div>`;}).join('')}
      </div>
    </div>
    ${hasFcst?`<div class="card" style="margin:0 20px 12px;padding:16px;border-left:3px solid var(--violet)">
      <div class="chart-title" style="color:var(--violet)">‚óÜ Previs√µes por Categoria / M√™s</div>
      <canvas id="cv4" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px" id="leg-forecast">
        ${CAT_ORDER.map(k=>{const hi=S.hiddenFcstCats.has(k);return`<div class="leg-item leg-toggle${hi?' leg-off':''}" onclick="toggleCat('${k}','forecast')"><div class="leg-swatch" style="background:${FCST_COLORS[k]||'#ccc'}"></div><span>${catInfo(k).label}</span></div>`;}).join('')}
      </div>
    </div>`:''}`;

  drawDonut1(def, d.recv, d.paid);
  // Build donut2 respecting hidden cats
  drawDonut2(bc, gt);
  barChart('cv3',d);
  if(hasFcst) barForecast('cv4',fc);
}

function drawDonut1(def, recv, paid){
  const cv=$('cv1'); if(!cv) return;
  // Cache for re-render
  cv._d1={def,recv,paid};

  const slices=[
    {key:'decio', v:S.hiddenFunding.has('decio')?0:def,  c:'#3B5BDB', label:'D√©cio & Bruna'},
    {key:'pai',   v:S.hiddenFunding.has('pai')  ?0:recv, c:'#C0392B', label:'Pai'},
  ];
  const visPaid=slices.reduce((a,s)=>a+s.v,0);
  const totalLabel=brlK(visPaid||paid).replace('R$\u202F','');
  donut('cv1', slices, 'Total', totalLabel, 110);

  const leg=$('pie1-leg'); if(!leg) return;
  leg.innerHTML=slices.map(s=>{
    const hidden=S.hiddenFunding.has(s.key);
    const pct=paid>0&&!hidden?Math.round(s.v/paid*100)+'%':'‚Äî';
    return `<div class="leg-item leg-toggle${hidden?' leg-off':''}" onclick="toggleFunding('${s.key}')">
      <div class="leg-swatch" style="background:${s.c}"></div>
      <span>${s.label}</span>
      <span class="leg-pct">${pct}</span>
    </div>`;
  }).join('');
}

function drawDonut2(bc, gt){
  // Compute visible total (excluding hidden cats)
  const visSlices=CAT_ORDER.map(k=>({k,v:S.hiddenCats.has(k)?0:(bc[k]||0),c:catInfo(k).color}));
  const visGt=visSlices.reduce((a,s)=>a+s.v,0);
  const totalLabel=brlK(visGt||Object.values(bc).reduce((a,v)=>a+v,0)).replace('R$\u202F','');
  donut('cv2',visSlices,'Total',totalLabel,110);
  // Cache for re-render on toggle
  const cv=$('cv2'); if(cv){ cv._bcData=bc; cv._gtData=gt; }
  // Render legend
  $('pie2-leg').innerHTML=CAT_ORDER.map(k=>{
    const v=bc[k]||0; if(!v) return '';
    const hidden=S.hiddenCats.has(k);
    const visTotal=visGt||1;
    const p=hidden?'‚Äî':((v/visTotal*100).toFixed(0)+'%');
    return `<div class="leg-item leg-toggle${hidden?' leg-off':''}" onclick="toggleCatDonut('${k}')" title="Clique para mostrar/ocultar">
      <div class="leg-swatch" style="background:${catInfo(k).color}"></div>
      <span>${catInfo(k).label}</span>
      <span class="leg-pct">${p}</span>
    </div>`;
  }).join('');
}

function donut(id,slices,lbl,val,SZ){
  const c=$(id); if(!c)return;
  const dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=SZ*dpr; c.height=SZ*dpr; c.style.width=SZ+'px'; c.style.height=SZ+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const cx=SZ/2,cy=SZ/2,R=SZ/2-7,r=SZ/2-23;
  const tot=slices.reduce((a,s)=>a+(s.v||0),0); if(!tot)return;
  let a=-Math.PI/2;
  slices.forEach(s=>{ if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a,a+sw); ctx.closePath(); ctx.fillStyle=s.c; ctx.fill(); a+=sw; });
  a=-Math.PI/2;
  slices.forEach(s=>{ if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.arc(cx,cy,R,a,a+sw); ctx.strokeStyle='#FAFAF9'; ctx.lineWidth=2.5; ctx.stroke(); a+=sw; });
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fillStyle='#FFF'; ctx.fill();
  ctx.textAlign='center';
  ctx.fillStyle='#71717A'; ctx.font=`500 8px Inter,sans-serif`; ctx.fillText(lbl,cx,cy-5);
  ctx.fillStyle='#000'; ctx.font=`600 11px 'SF Mono','Menlo','Consolas',monospace`; ctx.fillText(val,cx,cy+7);
}

/* ‚îÄ‚îÄ‚îÄ CATEGORY TOGGLE IN CHARTS ‚îÄ‚îÄ‚îÄ */
function toggleFunding(key){
  if(S.hiddenFunding.has(key)) S.hiddenFunding.delete(key); else S.hiddenFunding.add(key);
  const cv=$('cv1');
  if(cv && cv._d1) drawDonut1(cv._d1.def, cv._d1.recv, cv._d1.paid);
}

function toggleCatDonut(k){
  // Toggle in hiddenCats (shared with bar chart)
  if(S.hiddenCats.has(k)) S.hiddenCats.delete(k); else S.hiddenCats.add(k);
  // Re-render donut2
  const cv=$('cv2');
  if(cv && cv._bcData!=null) drawDonut2(cv._bcData, cv._gtData);
  // Re-render bar chart too (same hiddenCats)
  const cv3=$('cv3');
  if(cv3 && cv3._dData) barChart('cv3', cv3._dData);
  // Update leg-confirmed badges
  const legEl=$('leg-confirmed');
  if(legEl) legEl.querySelectorAll('.leg-toggle').forEach(el=>{
    const key=el.getAttribute('onclick').match(/'([^']+)'/)[1];
    el.classList.toggle('leg-off', S.hiddenCats.has(key));
  });
}

function toggleCat(k, kind){
  const set = kind==='forecast' ? S.hiddenFcstCats : S.hiddenCats;
  if(set.has(k)) set.delete(k); else set.add(k);
  // Re-render legends in place
  const legId = kind==='forecast'?'leg-forecast':'leg-confirmed';
  const legEl=$(legId);
  if(legEl){
    legEl.querySelectorAll('.leg-toggle').forEach(el=>{
      const key=el.getAttribute('onclick').match(/'([^']+)'/)[1];
      el.classList.toggle('leg-off', set.has(key));
    });
  }
  // Redraw the appropriate bar chart
  if(kind==='forecast'){
    const cv=$('cv4'); if(cv&&cv._fcData) barForecast('cv4',cv._fcData);
  } else {
    const cv=$('cv3'); if(cv&&cv._dData) barChart('cv3',cv._dData);
    // Also sync donut2 since it shares hiddenCats
    const cv2=$('cv2');
    if(cv2&&cv2._bcData!=null) drawDonut2(cv2._bcData, cv2._gtData);
  }
}

function barChart(id,d){
  const c=$(id); if(!c)return;
  c._dData=d; // cache for re-render on toggle
  const par=c.parentElement, W=Math.max((par?(par.getBoundingClientRect().width||par.offsetWidth):320)-32,200);
  const H=100,dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const visibleOrder=CAT_ORDER.filter(k=>!S.hiddenCats.has(k));
  const data=(d.byMonth||[]).map(m=>visibleOrder.map(k=>m[k]||0));
  const cols=visibleOrder.map(k=>catInfo(k).color);
  const pL=32,pB=16,pT=6,pR=2,cW=W-pL-pR,cH=H-pT-pB;
  const maxV=Math.max(...data.map(r=>r.reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/2000)*2000||2000;
  for(let i=0;i<=3;i++){ const y=pT+cH*(1-i/3); ctx.strokeStyle='rgba(0,0,0,.05)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke(); ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7px 'SF Mono','Menlo',monospace`; ctx.fillText((scale/3*i/1000).toFixed(0)+'k',pL-3,y+3); }
  const mW=cW/12,bW=mW*.72,bOff=(mW-bW)/2;
  c._bars=[];
  data.forEach((cats,mi)=>{ const gx=pL+mi*mW+bOff; let yBase=pT+cH; const tot=cats.reduce((a,b)=>a+b,0); cats.forEach((v,ci)=>{ if(!v)return; const bH=Math.max(1,(v/scale)*cH); yBase-=bH; ctx.fillStyle=cols[ci]; ctx.fillRect(gx,yBase,bW,bH); }); ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi],pL+mi*mW+mW/2,H-2); c._bars.push({x:gx,y:pT,w:bW,h:pT+cH,mi,tot,cats:visibleOrder.map((k,i)=>({k,v:cats[i]}))}); });
  attachBarTooltip(c,'confirmed');
}

function barForecast(id,fc){
  const c=$(id); if(!c)return;
  c._fcData=fc; // cache for re-render on toggle
  const par=c.parentElement, W=Math.max((par?(par.getBoundingClientRect().width||par.offsetWidth):320)-32,200);
  const H=110,dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const rawData=fc.byMonth||Array(12).fill(null).map(()=>({}));
  const visibleOrder=CAT_ORDER.filter(k=>!S.hiddenFcstCats.has(k));
  const data=rawData.map(m=>{ const r={}; visibleOrder.forEach(k=>{ r[k]=m[k]||0; }); return r; });
  const pL=32,pB=16,pT=6,pR=2,cW=W-pL-pR,cH=H-pT-pB;
  const maxV=Math.max(...data.map(m=>Object.values(m).reduce((a,b)=>a+b,0)),1);
  const scale=Math.ceil(maxV/1000)*1000||1000;
  for(let i=0;i<=2;i++){ const y=pT+cH*(1-i/2); ctx.strokeStyle='rgba(124,58,237,.08)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke(); ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7px 'SF Mono','Menlo',monospace`; ctx.fillText((scale/2*i/1000).toFixed(0)+'k',pL-3,y+3); }
  const mW=cW/12,bW=mW*.72,bOff=(mW-bW)/2;
  c._bars=[];
  data.forEach((cats,mi)=>{
    const gx=pL+mi*mW+bOff; let yBase=pT+cH; const tot=Object.values(cats).reduce((a,b)=>a+b,0);
    visibleOrder.forEach(k=>{ const v=cats[k]||0; if(!v)return; const bH=Math.max(1,(v/scale)*cH); yBase-=bH; ctx.fillStyle=FCST_COLORS[k]||'#aaa'; ctx.fillRect(gx,yBase,bW,bH); });
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi],pL+mi*mW+mW/2,H-2);
    c._bars.push({x:gx,y:pT,w:bW,h:pT+cH,mi,tot,cats});
  });
  attachBarTooltip(c,'forecast');
}

function attachBarTooltip(canvas, kind){
  // Remove previous listener
  if(canvas._tipHandler) canvas.removeEventListener('click',canvas._tipHandler);
  if(canvas._tipHandlerMove) canvas.removeEventListener('mousemove',canvas._tipHandlerMove);

  // Shared tooltip element
  let tip=document.getElementById('chart-tooltip');
  if(!tip){
    tip=document.createElement('div'); tip.id='chart-tooltip';
    tip.style.cssText='position:fixed;z-index:9999;background:rgba(15,15,20,.88);color:#fff;border-radius:10px;padding:10px 14px;font:500 12px/1.5 var(--f);pointer-events:none;display:none;min-width:130px;box-shadow:0 4px 20px rgba(0,0,0,.3);backdrop-filter:blur(8px)';
    document.body.appendChild(tip);
  }

  const show=(e)=>{
    const rect=canvas.getBoundingClientRect();
    const dpr=Math.min(window.devicePixelRatio||1,2);
    const mx=(e.clientX-rect.left);
    const my=(e.clientY-rect.top);
    const bar=(canvas._bars||[]).find(b=>mx>=b.x&&mx<=b.x+b.w);
    if(!bar||!bar.tot){ tip.style.display='none'; return; }
    const lines=[];
    if(kind==='confirmed'){
      // cats is array of {k,v} objects (only visible cats)
      if(Array.isArray(bar.cats)){
        bar.cats.forEach(({k,v})=>{ if(v>0) lines.push(`<span style="color:${catInfo(k).color}">‚ñ†</span> ${catInfo(k).label}: <b>${brl(v)}</b>`); });
      }
    } else {
      // cats is object {k:v} for all visible forecast cats
      Object.entries(bar.cats||{}).forEach(([k,v])=>{ if(v>0) lines.push(`<span style="color:${FCST_COLORS[k]||'#aaa'}">‚ñ†</span> ${catInfo(k).label}: <b>‚âà${brl(v)}</b>`); });
    }
    tip.innerHTML=`<div style="font-size:11px;opacity:.7;margin-bottom:5px">${MF[bar.mi]} ‚Äî ${kind==='forecast'?'Previs√µes':'Realizadas'}</div>${lines.join('<br>')}${bar.tot?`<div style="margin-top:6px;border-top:1px solid rgba(255,255,255,.15);padding-top:5px;font-weight:700">Total: ${kind==='forecast'?'‚âà':''}${brl(bar.tot)}</div>`:''}`;
    // Position tooltip: above cursor, avoid edge
    const tx=Math.min(e.clientX+8, window.innerWidth-160);
    const ty=Math.max(e.clientY-tip.offsetHeight-12, 8);
    tip.style.left=tx+'px'; tip.style.top=ty+'px'; tip.style.display='block';
  };

  const hide=()=>{ tip.style.display='none'; };

  canvas._tipHandler=show;
  canvas._tipHandlerMove=show;
  canvas.style.cursor='pointer';
  canvas.addEventListener('click', show);
  canvas.addEventListener('mousemove', show);
  canvas.addEventListener('mouseleave', hide);
}

/* ‚îÄ‚îÄ‚îÄ TX LIST ‚îÄ‚îÄ‚îÄ */
function txHTML(r){
  const ci=catInfo(r.categoryKey);
  const isFcst=r.type==='FORECAST';
  const out=r.type==='PAID';
  const pLabel=partyLabel(r);
  const isOverdue=isFcst&&r.date<=TODAY;
  const student=r.student&&r.student!=='Ambas'?`<span class="student-badge">${r.student}</span>`:'';
  const hasDoc=r.filePath?`<span title="Documento anexado" style="font-size:12px;color:var(--accent);margin-left:4px">üìé</span>`:'';
  return `<div class="list-row${isFcst?' row-fcst':''}" onclick="openTxSheet(${r.id})">
    <div class="list-icon" style="background:${isFcst?'var(--violet-l)':ci.color+'1A'}">${isFcst?'‚óÜ':catEmoji(r.categoryKey)}</div>
    <div class="list-body">
      <div class="list-name">${ci.label}${isFcst?'<span class="fcst-badge">PREV</span>':''}${isOverdue?'<span class="alert-badge">VENCIDA</span>':''}${student}${hasDoc}</div>
      <div class="tx-sub">${fmtD(r.date)} ¬∑ ${MO[r.academicMonth-1]}/${r.academicYear} ¬∑ ${pLabel}</div>
      ${r.notes?`<div class="tx-sub" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:240px">${r.notes}</div>`:''}
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div class="tx-amount ${isFcst?'fcst':out?'out':'in'}">${isFcst?'‚âà':out?'‚Äì':'+'}${brl(r.amount)}</div>
      ${(!isFcst&&r.isLate)?`<div class="tx-late">‚ñ† atraso</div>`:''}
      ${isOverdue?`<div class="tx-alert">‚ö° converter</div>`:''}
    </div>
  </div>`;
}

async function renderTxList(){
  const search = ($('tx-search').value||'').toLowerCase().trim();
  const type   = $('fil-type').value;
  const cat    = $('fil-cat').value;
  const student= $('fil-student').value;
  const allRows= await dbAll('txs');
  let rows = S.year==='all' ? allRows : allRows.filter(r=>r.academicYear===S.year);
  if(type)    rows=rows.filter(r=>r.type===type);
  if(cat)     rows=rows.filter(r=>r.categoryKey===cat);
  if(student) rows=rows.filter(r=>r.student===student||(student==='Ambas'&&(!r.student||r.student==='Ambas')));
  if(search)  rows=rows.filter(r=>{
    const ci=catInfo(r.categoryKey);
    return brl(r.amount).includes(search)||
      (r.notes||'').toLowerCase().includes(search)||
      ci.label.toLowerCase().includes(search)||
      partyLabel(r).toLowerCase().includes(search)||
      fmtD(r.date).includes(search)||
      (r.student||'').toLowerCase().includes(search);
  });
  rows.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const w=$('tx-wrap');
  if(!rows.length){ w.innerHTML='<div class="empty-state"><div class="ic">üì≠</div>Nenhuma transa√ß√£o encontrada</div>'; return; }
  // Group by month
  const groups={};
  rows.forEach(r=>{ const k=`${r.academicYear}-${String(r.academicMonth).padStart(2,'0')}`; (groups[k]=groups[k]||[]).push(r); });
  const sortedKeys=Object.keys(groups).sort((a,b)=>b.localeCompare(a));
  const nowKey = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
  w.innerHTML=sortedKeys.map(k=>{
    const [yr,mo]=k.split('-');
    const isCurrent = k===nowKey;
    return `<div id="txmonth-${k}" style="padding:8px 20px 4px;font-size:11px;font-weight:600;color:${isCurrent?'var(--accent)':'var(--t-3)'};letter-spacing:.05em;text-transform:uppercase">${isCurrent?'‚óè ':''} ${MF[+mo-1]} ${yr}</div>
    <div class="card" style="margin:0 20px 10px${isCurrent?';border-color:rgba(59,91,219,.2)':''}">${groups[k].map(txHTML).join('')}</div>`;
  }).join('');

  // Scroll to current month after paint ‚Äî only on initial nav, not on filter change
  if(!search && !type && !cat && !student){
    requestAnimationFrame(()=>{
      const el=$('txmonth-'+nowKey);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  }
}

function onSearch(){ $('search-clear').classList.toggle('show', !!$('tx-search').value); renderTxList(); }
function clearSearch(){ $('tx-search').value=''; $('search-clear').classList.remove('show'); renderTxList(); }

async function openTxSheet(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  const ci=catInfo(r.categoryKey);
  const isFcst=r.type==='FORECAST', out=r.type==='PAID';
  const pLabel=partyLabel(r);
  const isOverdue=isFcst&&r.date<=TODAY;
  $('sh-title').textContent=ci.label+(isFcst?' ‚óÜ':'')+(r.filePath?' üìé':'');
  const shRow=(l,v)=>`<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 20px;border-bottom:.5px solid var(--sep-l)"><span style="font-size:14px;color:var(--t-3)">${l}</span><span style="font-size:14px;font-weight:500;text-align:right;max-width:60%">${v}</span></div>`;

  // Build document section HTML ‚Äî filled in async below
  const docSectionId = 'sh-doc-'+id;

  $('sh-body').innerHTML=`
    <div style="text-align:center;padding:20px 0 14px">
      <div style="font-size:44px;margin-bottom:8px">${isFcst?'‚óÜ':catEmoji(r.categoryKey)}</div>
      <div style="font:600 28px/1 var(--mono);color:${isFcst?'var(--violet)':out?'var(--red)':'var(--green)'}">${isFcst?'‚âà':out?'‚Äì':'+'}${brlFmt(r.amount)}</div>
      <div style="font-size:13px;color:var(--t-2);margin-top:6px">${ci.label}${isFcst?' <span style="color:var(--violet);font-weight:600">Previs√£o</span>':''}${r.student&&r.student!=='Ambas'?` ¬∑ <span style="font-weight:600">${r.student}</span>`:''}</div>
      ${isOverdue?`<div style="margin-top:8px;padding:6px 14px;background:var(--amber-l);border-radius:100px;display:inline-block;font-size:12px;font-weight:600;color:var(--amber)">‚ö° Previs√£o vencida ‚Äî converter</div>`:''}
    </div>
    <div style="margin:0 20px;background:var(--bg-2);border-radius:12px;overflow:hidden">
      ${shRow('Data pagamento',r.isLate?`${fmtD(r.date)}<br><span style="font-size:10px;color:var(--red);font-weight:700">‚ñ† Recebido com atraso</span>`:fmtD(r.date))}
      ${shRow('Per√≠odo',MF[r.academicMonth-1]+' / '+r.academicYear)}
      ${shRow('Tipo',isFcst?'Previs√£o futura':out?'Pago (sa√≠da)':'Recebido')}
      ${shRow('Parte',pLabel)}
      ${r.student?shRow('Aluna',r.student):''}
      ${r.notes?shRow('Notas',r.notes):''}
    </div>
    ${r.filePath ? `<div id="${docSectionId}" style="margin:12px 20px 0;border-radius:var(--r2);border:1.5px solid var(--sep-l);overflow:hidden;background:var(--card)">
      <div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-2);border-bottom:1px solid var(--sep-l)">
        <span id="${docSectionId}-ic" style="font-size:20px">üìé</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--t-2)" id="${docSectionId}-name">Carregando‚Ä¶</div>
          <div style="font-size:11px;color:var(--t-3);margin-top:1px" id="${docSectionId}-meta"></div>
        </div>
        <button id="${docSectionId}-dl" onclick="downloadTxFile('${r.filePath}')" class="pill-btn blue" style="padding:7px 12px;font-size:12px">‚¨á Baixar</button>
      </div>
      <div id="${docSectionId}-preview" style="max-height:320px;overflow-y:auto"></div>
    </div>` : ''}
    <div style="padding:16px;display:flex;flex-direction:column;gap:10px">
      ${isOverdue?`<button class="btn amber" onclick="openConvertSheet(${r.id});closeSheet('tx-sheet')">‚ö°&nbsp; Converter em Pagamento</button>`:''}
      <button class="btn primary" onclick="editTx(${r.id});closeSheet('tx-sheet')">‚úèÔ∏è&nbsp; Editar</button>
      <button class="btn secondary" onclick="copyTx(${r.id});closeSheet('tx-sheet')">üìã&nbsp; Copiar / Duplicar</button>
      <button class="btn destructive" onclick="if(confirm('Excluir esta transa√ß√£o?'))delTxById(${r.id})">üóë&nbsp; Excluir</button>
    </div>`;

  $('tx-sheet').classList.add('open');

  // Async: load and render attached document from Supabase Storage
  if(r.filePath){
    try{
      const ext = r.filePath.split('.').pop().toLowerCase();
      const icMap={pdf:'üìÑ',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',txt:'üìù'};
      const ic=$(docSectionId+'-ic'); if(ic) ic.textContent=icMap[ext]||'üìé';
      const nm=$(docSectionId+'-name'); if(nm) nm.textContent=r.filePath.split('/').pop();
      const mt=$(docSectionId+'-meta'); if(mt) mt.textContent='Carregando‚Ä¶';
      const pv=$(docSectionId+'-preview');
      // Download from Supabase Storage
      const dataUrl = await _storageDownload(r.filePath);
      if(mt) mt.textContent=ext.toUpperCase()+' ¬∑ via Supabase Storage';
      if(pv){
        if(ext==='pdf'){
          pv.innerHTML=`<embed src="${dataUrl}" type="application/pdf" style="width:100%;height:300px;border:none">`;
        } else if(['jpg','jpeg','png'].includes(ext)){
          pv.innerHTML=`<img src="${dataUrl}" style="width:100%;max-height:300px;object-fit:contain;display:block;padding:8px">`;
        } else if(ext==='txt'){
          const raw=atob(dataUrl.split(',')[1]||'');
          pv.innerHTML=`<pre style="font:400 11px/1.6 var(--mono);padding:12px;white-space:pre-wrap;word-break:break-word;color:var(--t-2);max-height:260px;overflow-y:auto">${raw.replace(/</g,'&lt;').substring(0,3000)}${raw.length>3000?'\n‚Ä¶':''}</pre>`;
        }
      }
    }catch(e){ console.warn('Doc load error:',e); }
  }
}

async function downloadTxFile(filePath){
  if(!filePath){ toast('‚ùå Arquivo n√£o encontrado'); return; }
  try{
    toast('‚¨á Baixando‚Ä¶');
    const dataUrl = await _storageDownload(filePath);
    const ext = filePath.split('.').pop().toLowerCase();
    const name = filePath.split('/').pop();
    const a=document.createElement('a');
    a.href=dataUrl; a.download=name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    toast('‚úÖ Download conclu√≠do');
  }catch(e){ toast('‚ùå Erro ao baixar: '+e.message); }
}

/* ‚îÄ‚îÄ‚îÄ DOC UPLOAD (sem IA ‚Äî s√≥ armazenamento) ‚îÄ‚îÄ‚îÄ */
function resetDocUpload(){
  const inp=$('doc-file-input'); if(inp) inp.value='';
  const idle=$('doc-idle'), info=$('doc-file-info');
  if(idle) idle.style.display='block';
  if(info) info.style.display='none';
}

function onDocDrop(e){ e.preventDefault(); $('doc-drop').classList.remove('drag'); const f=e.dataTransfer.files[0]; if(f) loadDocFile(f); }

async function loadDocFile(f){
  if(!f)return;
  const ext=(f.name.split('.').pop()||'').toLowerCase();
  if(!['pdf','jpg','jpeg','png','txt'].includes(ext)){toast('‚ùå Use PDF, JPG, PNG ou TXT');return;}
  if(f.size>15*1024*1024){toast('‚ùå Arquivo > 15 MB');return;}
  const icMap={pdf:'üìÑ',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',txt:'üìù'};
  $('doc-idle').style.display='none';
  $('doc-file-info').style.display='flex';
  $('doc-file-ic').textContent=icMap[ext]||'üìé';
  $('doc-file-nm').textContent=f.name;
  $('doc-file-sz').textContent=(f.size/1024).toFixed(1)+' KB';
  // Guardar refer√™ncia ao File ‚Äî ser√° uploadado ao salvar a transa√ß√£o
  S._pendingFile = f;
  toast('üìé Arquivo pronto ‚Äî ser√° enviado ao salvar');
}

function clearDocFile(e){
  e.stopPropagation();
  S._pendingFile=null;
  resetDocUpload();
}

function removeExistingFile(){
  S._existingFilePath=null;
  S._removeFile=true; // flag to clear fileId on save
  const banner=$('existing-file-banner'); if(banner) banner.style.display='none';
  toast('üìé Documento removido ‚Äî salve para confirmar');
}

async function delTxById(id){
  await dbDel('txs',id); closeSheet('tx-sheet'); toast('üóë Exclu√≠do');
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

/* ‚îÄ‚îÄ‚îÄ COPY TX ‚îÄ‚îÄ‚îÄ */
async function copyTx(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r) return;
  // Check for exact duplicate (same type, amount, date, party/partyId)
  const dup=rows.find(x=>x.id!==id && x.amount===r.amount && x.type===r.type && x.date===r.date && (x.partyId===r.partyId && x.party===r.party));
  if(dup){ toast('‚ö†Ô∏è Transa√ß√£o id√™ntica j√° existe!',3500); return; }
  // Clone without id (so new id is assigned), clear date to force review
  const clone={...r}; delete clone.id;
  clone.notes=(clone.notes?clone.notes+' ':'')+' (c√≥pia)';
  clone.createdAt=new Date().toISOString(); clone.updatedAt=new Date().toISOString();
  S.editId=null;
  S.copyFrom=clone;
  nav('add');
}

/* ‚îÄ‚îÄ‚îÄ CONVERT FORECAST SHEET ‚îÄ‚îÄ‚îÄ */
async function openConvertSheet(id){
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  $('conv-id').value=id;
  $('conv-date').value=TODAY;
  $('conv-val').value=r.amount;
  $('conv-type').value=r.categoryKey==='pensao'?'RECEIVED':'PAID';
  $('conv-notes').value=r.notes||'';
  $('conv-tog').classList.remove('on');
  // Info banner
  const ci=catInfo(r.categoryKey);
  $('conv-fcst-info').innerHTML=`‚óÜ <b>${ci.label}</b> ¬∑ ${MF[r.academicMonth-1]}/${r.academicYear} ¬∑ Prev. ‚âà${brl(r.amount)}`;
  // Reset file upload
  S._convFile=null;
  $('conv-file-input').value='';
  $('conv-doc-idle').style.display='block';
  $('conv-file-info').style.display='none';
  $('convert-sheet').classList.add('open');
}

async function confirmConvert(){
  const id=+$('conv-id').value;
  const date=$('conv-date').value; if(!date){toast('‚ö†Ô∏è Informe a data');return;}
  const amount=parseFloat($('conv-val').value); if(!amount||isNaN(amount)){toast('‚ö†Ô∏è Informe o valor');return;}
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  const updated={
    ...r,
    type:$('conv-type').value,
    date, amount,
    isLate:$('conv-tog').classList.contains('on'),
    notes:$('conv-notes').value||r.notes,
    updatedAt:new Date().toISOString()
  };
  // Upload file to Supabase Storage if one was selected
  if(S._convFile){
    try{
      const meta = await _storageUpload(S._convFile, r.id);
      updated.filePath = meta.path;
    }catch(e){ toast('‚ö†Ô∏è Arquivo n√£o enviado: '+e.message); }
    S._convFile = null;
  }
  await dbPut('txs',updated);
  closeSheet('convert-sheet');
  toast('‚úÖ Convertida em pagamento!');
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

function onConvDocDrop(e){ e.preventDefault(); $('conv-doc-drop').classList.remove('drag'); const f=e.dataTransfer.files[0]; if(f) loadConvFile(f); }

async function loadConvFile(f){
  if(!f)return;
  const ext=(f.name.split('.').pop()||'').toLowerCase();
  if(!['pdf','jpg','jpeg','png','txt'].includes(ext)){toast('‚ùå Use PDF, JPG, PNG ou TXT');return;}
  if(f.size>15*1024*1024){toast('‚ùå Arquivo > 15 MB');return;}
  const icMap={pdf:'üìÑ',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',txt:'üìù'};
  $('conv-doc-idle').style.display='none';
  $('conv-file-info').style.display='flex';
  $('conv-file-ic').textContent=icMap[ext]||'üìé';
  $('conv-file-nm').textContent=f.name;
  $('conv-file-sz').textContent=(f.size/1024).toFixed(1)+' KB';
  // Guardar refer√™ncia ‚Äî ser√° uploadado ao confirmar convers√£o
  S._convFile = f;
  toast('üìé Arquivo pronto ‚Äî ser√° enviado ao confirmar');
}

function clearConvFile(e){
  e.stopPropagation();
  S._convFile=null;
  $('conv-file-input').value='';
  $('conv-doc-idle').style.display='block';
  $('conv-file-info').style.display='none';
}

/* ‚îÄ‚îÄ‚îÄ STUDENT SELECTOR ‚îÄ‚îÄ‚îÄ */
function setStudent(v){
  $('f-student').value=v;
  ['lara','chloe','both'].forEach(k=>$('sb-'+k).classList.remove('on'));
  const map={Lara:'lara',Chloe:'chloe',Ambas:'both'};
  if(map[v]) $('sb-'+map[v]).classList.add('on');
}

/* ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ */
function onTypeChange(){
  const v=$('f-type').value;
  $('fcst-notice').classList.toggle('show',v==='FORECAST');
}

function onDateChange(){
  const d=$('f-date').value;
  if(!d) return;
  const notice=$('future-date-notice');
  if(isFuture(d)){
    $('f-type').value='FORECAST'; onTypeChange();
    notice.style.display='block';
  } else {
    notice.style.display='none';
    // Only reset if it was auto-set
    if($('f-type').value==='FORECAST' && notice.style.display==='none'){
      // Don't force-change back ‚Äî user may have intentionally chosen FORECAST
    }
  }
}

async function resetForm(){
  S.editId=null;
  S._pendingFile=null;
  S._existingFilePath=null;
  S._removeFile=false;
  // Clear doc upload UI
  resetDocUpload();
  const banner=$('existing-file-banner'); if(banner) banner.style.display='none';
  const clone=S.copyFrom; S.copyFrom=null;

  $('f-id').value=''; $('f-notes').value=''; $('f-tags').value='';
  $('fcst-notice').classList.remove('show');
  $('future-date-notice').style.display='none';
  $('del-btn').style.display='none';
  $('add-title').textContent='Nova Transa√ß√£o';
  $('tog').classList.remove('on');

  if(clone){
    $('f-val').value=clone.amount;
    $('f-type').value=clone.type; onTypeChange();
    $('f-date').value=clone.date||TODAY;
    const fy=$('f-year'); if(fy) fy.value=clone.academicYear;
    $('f-month').value=clone.academicMonth;
    $('f-notes').value=clone.notes||'';
    $('f-tags').value=clone.tags||'';
    setStudent(clone.student||'Ambas');
    if(clone.isLate) $('tog').classList.add('on');
    await refreshPartySelect();
    if(clone.categoryKey) $('f-cat').value=clone.categoryKey;
    if(clone.partyId) $('f-party').value=String(clone.partyId);
    else if(clone.party) $('f-party').value=clone.party;
    toast('üìã Transa√ß√£o copiada ‚Äî revise e salve');
  } else {
    $('f-val').value='';
    $('f-type').value='PAID'; onTypeChange();
    $('f-date').value=TODAY;
    const yr=(S.year==='all')?new Date().getFullYear():S.year;
    const fy=$('f-year'); if(fy) fy.value=yr;
    $('f-month').value=new Date().getMonth()+1;
    setStudent('Ambas');
    await refreshPartySelect();
    if(S.cats.length) $('f-cat').value=S.cats[0].key;
  }
}

async function editTx(id){
  S.editId=id; nav('add');
  const rows=await dbAll('txs');
  const r=rows.find(r=>r.id===id); if(!r)return;
  $('f-id').value=r.id; $('f-val').value=r.amount;
  $('f-type').value=r.type; onTypeChange();
  $('f-cat').value=r.categoryKey;
  $('f-date').value=r.date;
  const fy=$('f-year'); if(fy) fy.value=r.academicYear;
  $('f-month').value=r.academicMonth;
  $('f-notes').value=r.notes||''; $('f-tags').value=r.tags||'';
  if(r.isLate) $('tog').classList.add('on');
  $('del-btn').style.display='flex';
  $('add-title').textContent='Editar Transa√ß√£o';
  setStudent(r.student||'Ambas');
  await refreshPartySelect();
  if(r.partyId) $('f-party').value=String(r.partyId);
  else if(r.party) $('f-party').value=r.party;
  $('future-date-notice').style.display='none';

  // Show existing file banner if tx has attached document
  S._existingFilePath = r.filePath || null;
  const banner = $('existing-file-banner');
  if(r.filePath && banner){
    banner.style.display='block';
    const ext = r.filePath.split('.').pop().toLowerCase();
    const icMap={pdf:'üìÑ',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',txt:'üìù'};
    if($('efb-ic'))   $('efb-ic').textContent   = icMap[ext]||'üìé';
    if($('efb-name')) $('efb-name').textContent = r.filePath.split('/').pop();
    if($('efb-meta')) $('efb-meta').textContent = ext.toUpperCase()+' ¬∑ Supabase Storage';
  } else if(banner){
    banner.style.display='none';
  }
}

async function saveTx(){
  const amount=parseFloat($('f-val').value);
  if(!amount||isNaN(amount)){toast('‚ö†Ô∏è Informe o valor');return;}
  const date=$('f-date').value; if(!date){toast('‚ö†Ô∏è Informe a data');return;}

  // Bot√£o de salvar ‚Äî feedback visual imediato
  const saveBtn = document.querySelector('#add-page button[onclick*="saveTx"]') ||
                  document.querySelector('button[onclick="saveTx()"]');
  if(saveBtn){ saveBtn.disabled=true; saveBtn.textContent='Salvando‚Ä¶'; }
  const _restoreBtn = ()=>{ if(saveBtn){ saveBtn.disabled=false; saveBtn.textContent='Salvar'; } };

  try {
    // Step 1: form values
    const partyVal=$('f-party').value;
    const partyId=/^\d+$/.test(partyVal)?+partyVal:null;
    const type=$('f-type').value;
    const cat=$('f-cat').value;
    const student=($('f-student')&&$('f-student').value)||'Ambas';
    const academicYear  = +($('f-year')  && $('f-year').value)  || +date.slice(0,4);
    const academicMonth = +($('f-month') && $('f-month').value) || +date.slice(5,7);

    console.log('[saveTx] values:', {amount,date,type,cat,partyId,partyVal,academicYear,academicMonth});

    if(!cat){ toast('‚ö†Ô∏è Selecione uma categoria'); _restoreBtn(); return; }
    if(!type){ toast('‚ö†Ô∏è Selecione o tipo'); _restoreBtn(); return; }
    if(!academicYear || !academicMonth){ toast('‚ö†Ô∏è Ano/M√™s inv√°lido'); _restoreBtn(); return; }

    // Step 2: duplicate check
    if(!S.editId){
      const existing=await dbAll('txs');
      const dup=existing.find(x=>
        Math.abs(x.amount-amount)<0.01 && x.type===type && x.date===date &&
        x.categoryKey===cat
      );
      if(dup){toast('‚ö†Ô∏è Transa√ß√£o id√™ntica j√° existe!',4000); _restoreBtn(); return;}
    }

    // Step 3: build tx object
    const tx={
      amount, type, categoryKey:cat,
      partyId: partyId||null,
      party:   partyId ? null : (partyVal||null),
      date, academicYear, academicMonth,
      isLate:!!($('tog')&&$('tog').classList.contains('on')),
      student,
      notes:($('f-notes')&&$('f-notes').value)||null,
      tags:($('f-tags')&&$('f-tags').value)||null,
    };
    if(S.editId) tx.id=S.editId;

    // Step 4: file handling
    if(S._pendingFile){
      try{
        const meta = await _storageUpload(S._pendingFile, S.editId||'new');
        tx.filePath = meta.path;
        if(S._existingFilePath) await _storageDelete(S._existingFilePath);
      }catch(fe){ console.warn('[saveTx] file upload failed:', fe); toast('‚ö†Ô∏è Arquivo n√£o enviado: '+fe.message); }
    } else if(S.editId && !S._removeFile){
      const existing = await dbAll('txs');
      const orig = existing.find(x => x.id === S.editId);
      if(orig?.filePath) tx.filePath = orig.filePath;
    } else if(S._removeFile && S._existingFilePath){
      await _storageDelete(S._existingFilePath).catch(()=>{});
      tx.filePath = null;
    }

    // Step 5: save to Supabase
    const row = _txToRow(tx);
    console.log('[saveTx] sending row:', JSON.stringify(row));
    const savedId = await dbPut('txs', tx);
    console.log('[saveTx] saved id:', savedId);

    S._pendingFile=null; S._removeFile=false; S._existingFilePath=null;
    _restoreBtn();
    toast(S.editId?'‚úÖ Atualizado!':'‚úÖ Salvo!');
    S.editId=null;
    await initYearFilter();
    nav('txs');
  } catch(e) {
    _restoreBtn();
    console.error('[saveTx] ERRO COMPLETO:', e);
    const msg = e?.message || e?.error_description || JSON.stringify(e) || 'Erro desconhecido';
    toast('‚ùå ' + msg, 10000);
  }
}

async function deleteTx(){
  if(!S.editId)return;
  if(!confirm('Excluir esta transa√ß√£o?'))return;
  await dbDel('txs',S.editId); toast('üóë Exclu√≠do'); S.editId=null;
  await initYearFilter(); nav('txs');
}

/* ‚îÄ‚îÄ‚îÄ PARTIES CRUD ‚îÄ‚îÄ‚îÄ */
async function loadParties(){ S.parties=await dbAll('parties'); }

async function refreshPartySelect(){
  await loadParties();
  const sel=$('f-party'); if(!sel)return;
  const cur=sel.value; sel.innerHTML='';
  [['Me','üë§ Eu (legado)'],['Father','üë® Pai'],['School','üè´ Escola'],['Store','üè™ Loja'],['Other','üë• Outro']].forEach(([v,l])=>{ const o=document.createElement('option'); o.value=v; o.textContent=l; sel.appendChild(o); });
  S.parties.forEach(p=>{ const o=document.createElement('option'); o.value=String(p.id); o.textContent=(p.emoji||'üë§')+' '+p.name; sel.appendChild(o); });
  if(cur) sel.value=cur;
}

async function addPartyInline(){
  const inp=$('f-new-party'), name=inp.value.trim();
  if(!name){toast('‚ö†Ô∏è Digite o nome');return;}
  await loadParties();
  if(S.parties.find(p=>p.name.toLowerCase()===name.toLowerCase())){toast('‚ö†Ô∏è Parte j√° existe');return;}
  const newId=await dbPut('parties',{name,emoji:'üë§',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
  inp.value=''; toast(`‚úÖ "${name}" adicionado`);
  await refreshPartySelect();
  $('f-party').value=String(newId);
}

/* ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ */
const EMOJI_SET=['üë§','üë®','üë©','üë¥','üëµ','üë¶','üëß','üßë','üë∂','ü§±','üë™','üë®‚Äçüë©‚Äçüëß','üë®‚Äçüë©‚Äçüë¶','üè´','üè†','üè™','üè¶','üè•','üé≠','üéí','üìö','üìù','üí∞','üí≥','üéì','‚≠ê','üåü','‚ú®','ü§ù','üèÜ','üéØ','üìå','üìé','üîë','üèÖ','üå∫','üå∏','ü¶ã','üê£','üåà'];

function toggleEmojiPicker(){
  const ep=$('emoji-picker');
  if(ep.style.display==='none'||!ep.style.display){
    if(!ep.querySelector('.emoji-btn')){
      $('emoji-grid').innerHTML=EMOJI_SET.map(e=>`<button class="emoji-btn" onclick="selectEmoji('${e}')">${e}</button>`).join('');
    }
    ep.style.display='block';
  } else {
    ep.style.display='none';
  }
}

function selectEmoji(e){
  $('ps-emoji').value=e;
  $('ps-emoji-preview').textContent=e;
  document.querySelectorAll('.emoji-btn').forEach(b=>b.classList.toggle('on',b.textContent===e));
  $('emoji-picker').style.display='none';
}

async function openPartySheet(editId){
  await loadParties();
  // editId may arrive as number (from JS call) or string (from onclick attr)
  const id = (editId !== null && editId !== undefined && editId !== '') ? Number(editId) : null;
  $('ps-id').value = (id != null) ? String(id) : '';
  $('ps-title').textContent = id ? 'Editar Parte' : 'Nova Parte';
  $('ps-del-wrap').style.display = id ? 'block' : 'none';
  $('emoji-picker').style.display = 'none';
  if(id){
    // Compare as numbers ‚Äî IDB autoIncrement returns numbers
    const p = S.parties.find(p => Number(p.id) === id);
    if(p){
      $('ps-name').value = p.name;
      $('ps-emoji').value = p.emoji || 'üë§';
      $('ps-emoji-preview').textContent = p.emoji || 'üë§';
    } else {
      toast('‚ö†Ô∏è Parte n√£o encontrada');
      return;
    }
  } else {
    $('ps-name').value = '';
    $('ps-emoji').value = 'üë§';
    $('ps-emoji-preview').textContent = 'üë§';
  }
  $('party-sheet').classList.add('open');
}

async function saveParty(){
  const name = $('ps-name').value.trim();
  if(!name){ toast('‚ö†Ô∏è Informe o nome da parte'); return; }
  const emoji  = $('ps-emoji').value || 'üë§';
  const rawId  = $('ps-id').value;
  const editId = rawId ? Number(rawId) : null;
  const rec    = { name, emoji, updatedAt: new Date().toISOString() };
  if(editId) rec.id = editId;
  else rec.createdAt = new Date().toISOString();
  await dbPut('parties', rec);
  toast(editId ? '‚úÖ Parte atualizada!' : '‚úÖ Parte criada!');
  closeSheet('party-sheet');
  await loadParties(); await refreshPartySelect(); renderCfg();
}

async function deleteParty(){
  const rawId = $('ps-id').value;
  if(!rawId){ toast('‚ö†Ô∏è Nenhuma parte selecionada'); return; }
  const editId = Number(rawId);
  if(!editId || isNaN(editId)){ toast('‚ö†Ô∏è ID inv√°lido'); return; }
  if(!confirm('Excluir esta parte?')) return;
  try{
    await dbDel('parties', editId);
    toast('üóë Parte removida');
    closeSheet('party-sheet');
    await loadParties(); await refreshPartySelect(); renderCfg();
  } catch(e){
    console.error('deleteParty:', e);
    toast('‚ùå Erro: ' + (e.message || e));
  }
}

/* ‚îÄ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Columns: M√™s | Mensalidade | Matr√≠cula | Material | Uniforme | Extra | SUBTOTAL | Pens√£o | Data Pgto | Diferen√ßa | %Pai | Acordo | ‚óÜPrev.Pago | ‚óÜPrev.Recv
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function renderReport(){
  const allRows=await dbAll('txs');
  const accord=S.accord;
  let years;
  if(S.year==='all') years=[...new Set(allRows.map(r=>r.academicYear))].filter(Boolean).sort((a,b)=>a-b);
  else years=[S.year];
  if(!years.length){$('rpt-content').innerHTML='<div class="empty-state"><div class="ic">üìã</div>Sem dados</div>';return;}

  let html='', gP=0, gR=0, gFcstP=0, gFcstR=0;

  for(const yr of years){
    const yrTxs=allRows.filter(r=>r.academicYear===yr);
    const confirmed=yrTxs.filter(r=>r.type!=='FORECAST');
    const forecasts=yrTxs.filter(r=>r.type==='FORECAST');

    const byMonth={};      // paid cats per month
    const pensaoByM={};    // recv per month
    const lateByM={};      // late flag per month
    const payDateByM={};   // latest payment date per month
    const fcstPaidByM={};  // forecast paid per month (per cat)
    const fcstRecvByM={};  // forecast recv per month

    confirmed.filter(r=>r.type==='PAID').forEach(r=>{
      const m=r.academicMonth;
      if(!byMonth[m]) byMonth[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};
      if(byMonth[m][r.categoryKey]!==undefined) byMonth[m][r.categoryKey]+=r.amount;
    });
    confirmed.filter(r=>r.categoryKey==='pensao'&&r.type==='RECEIVED').forEach(r=>{
      const m=r.academicMonth;
      pensaoByM[m]=(pensaoByM[m]||0)+r.amount;
      if(r.isLate) lateByM[m]=true;
      if(!payDateByM[m]||r.date>payDateByM[m]) payDateByM[m]=r.date;
    });
    forecasts.filter(r=>r.type==='FORECAST'&&r.categoryKey!=='pensao').forEach(r=>{
      const m=r.academicMonth;
      if(!fcstPaidByM[m]) fcstPaidByM[m]={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0};
      if(fcstPaidByM[m][r.categoryKey]!==undefined) fcstPaidByM[m][r.categoryKey]+=r.amount;
    });
    forecasts.filter(r=>r.type==='FORECAST'&&r.categoryKey==='pensao').forEach(r=>{
      const m=r.academicMonth;
      fcstRecvByM[m]=(fcstRecvByM[m]||0)+r.amount;
    });

    let rowsHtml='';
    let tot={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0,sub:0,recv:0,diff:0};
    let yrFcstP=0, yrFcstR=0;

    for(let m=1;m<=12;m++){
      const cats=byMonth[m]||{};
      const recv=pensaoByM[m]||0;
      const late=lateByM[m]||false;
      const payD=payDateByM[m];
      const fcP=fcstPaidByM[m]||{};
      const fcR=fcstRecvByM[m]||0;
      const sub=(cats.mensalidade||0)+(cats.matricula||0)+(cats.material||0)+(cats.uniforme||0)+(cats.extra||0);
      const diff=sub-recv;
      const pct=sub>0?(recv/sub*100):0;
      const accordTarget=getAccordTarget(sub);
      const accordDiff=recv-accordTarget;

      if(S.year==='all'&&sub===0&&recv===0&&Object.values(fcP).every(v=>v===0)&&!fcR) continue;

      tot.mensalidade+=(cats.mensalidade||0); tot.matricula+=(cats.matricula||0);
      tot.material+=(cats.material||0); tot.uniforme+=(cats.uniforme||0);
      tot.extra+=(cats.extra||0); tot.sub+=sub; tot.recv+=recv; tot.diff+=diff;
      const fcPtot=Object.values(fcP).reduce((a,b)=>a+b,0);
      yrFcstP+=fcPtot; yrFcstR+=fcR;
      // per-cat forecast totals
      if(!tot.fcst) tot.fcst={mensalidade:0,matricula:0,material:0,uniforme:0,extra:0,pensao:0};
      ['mensalidade','matricula','material','uniforme','extra'].forEach(k=>{ tot.fcst[k]+=(fcP[k]||0); });
      tot.fcst.pensao+=fcR;

      const dateCell=recv>0?`${fmtD(payD||'')}${late?`<span class="late-tag">‚ñ† atraso</span>`:''}`:'‚Äî';
      let pctClass='';
      if(accordTarget>0){
        const diff2=pct-(accordTarget/sub*100);
        if(diff2>0.5) pctClass='pct-ok';
        else if(diff2<-0.5) pctClass='pct-bad';
        else pctClass='pct-equal';
      }
      const pctCell=sub>0?`<span class="${pctClass}">${pct.toFixed(1)}%</span>`:'‚Äî';
      const accordCell=accordTarget>0?`<span class="${recv>=accordTarget?'recv':'neg'}">${brl(accordTarget)}</span>`:'‚Äî';
      const fc=v=>v?`<span class="fcst-col">‚âà${brl(v)}</span>`:`<span style="color:var(--t-5)">‚Äî</span>`;

      rowsHtml+=`<tr>
        <td>${MF[m-1]}</td>
        <td class="r">${cats.mensalidade?brl(cats.mensalidade):'‚Äî'}</td>
        <td class="r">${cats.matricula?brl(cats.matricula):'‚Äî'}</td>
        <td class="r">${cats.material?brl(cats.material):'‚Äî'}</td>
        <td class="r">${cats.uniforme?brl(cats.uniforme):'‚Äî'}</td>
        <td class="r">${cats.extra?brl(cats.extra):'‚Äî'}</td>
        <td class="r subtotal-col">${sub?brl(sub):'‚Äî'}</td>
        <td class="r recv">${recv?brl(recv):'‚Äî'}</td>
        <td class="r" style="min-width:100px">${dateCell}</td>
        <td class="r ${diff>0?'neg':'recv'}">${diff!==0?(diff>0?'‚Äì':'+')+brl(Math.abs(diff)):'‚Äî'}</td>
        <td class="r">${pctCell}</td>
        <td class="r accord-col">${accordCell}</td>
        <td class="r fcst-group">${fc(fcP.mensalidade)}</td>
        <td class="r fcst-group">${fc(fcP.matricula)}</td>
        <td class="r fcst-group">${fc(fcP.material)}</td>
        <td class="r fcst-group">${fc(fcP.uniforme)}</td>
        <td class="r fcst-group">${fc(fcP.extra)}</td>
        <td class="r fcst-group" style="border-left:1px solid rgba(124,58,237,.15)">${fc(fcPtot)}</td>
        <td class="r fcst-group">${fc(fcR)}</td>
      </tr>`;
    }

    gP+=tot.sub; gR+=tot.recv; gFcstP+=yrFcstP; gFcstR+=yrFcstR;
    const tPct=tot.sub>0?(tot.recv/tot.sub*100).toFixed(1)+'%':'‚Äî';
    const tAccord=getAccordTarget(tot.sub);

    html+=`<div class="rpt-card">
      <div class="rpt-yr-hdr"><h3>${yr}</h3><span>${brl(tot.sub)}</span></div>
      <div class="rpt-scroll"><table class="rtbl">
      <colgroup>
        <col class="c-mes"><col class="c-val"><col class="c-val"><col class="c-val"><col class="c-val"><col class="c-val">
        <col class="c-sub"><col class="c-pens"><col class="c-date"><col class="c-diff"><col class="c-pct">
        <col class="c-acc">
        <col class="c-fcst fcst-group"><col class="c-fcst fcst-group"><col class="c-fcst fcst-group"><col class="c-fcst fcst-group"><col class="c-fcst fcst-group">
        <col class="c-fcst fcst-group"><col class="c-fcst fcst-group">
      </colgroup>
      <thead>
        <tr>
          <th rowspan="2">M√™s</th><th rowspan="2">Mensalidade</th><th rowspan="2">Matr√≠cula</th><th rowspan="2">Material</th><th rowspan="2">Uniforme</th><th rowspan="2">Extra</th>
          <th class="subtotal-col" rowspan="2" style="border-left:2px solid rgba(255,255,255,.2)">Subtotal</th>
          <th rowspan="2">Pens√£o</th><th rowspan="2">Data Pgto</th><th rowspan="2">Diferen√ßa</th><th rowspan="2">% Pai</th>
          <th class="accord-h" rowspan="2">Acordado</th>
          <th class="fcst-h fcst-group" colspan="5" style="text-align:center;border-left:1px solid rgba(124,58,237,.2)">‚óÜ Prev. Pago (por categoria)</th>
          <th class="fcst-h fcst-group" colspan="2" style="text-align:center">‚óÜ Prev. Totais</th>
        </tr>
        <tr>
          <th class="fcst-h fcst-group" style="font-weight:500;border-left:1px solid rgba(124,58,237,.15)">Mensalidade</th>
          <th class="fcst-h fcst-group" style="font-weight:500">Matr√≠cula</th>
          <th class="fcst-h fcst-group" style="font-weight:500">Material</th>
          <th class="fcst-h fcst-group" style="font-weight:500">Uniforme</th>
          <th class="fcst-h fcst-group" style="font-weight:500">Extra</th>
          <th class="fcst-h fcst-group" style="font-weight:700;border-left:1px solid rgba(124,58,237,.2)">Total Pago</th>
          <th class="fcst-h fcst-group" style="font-weight:700">Pens√£o Recv.</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}
        <tr class="total-row">
          <td>TOTAL ${yr}</td>
          <td class="r">${brl(tot.mensalidade)}</td>
          <td class="r">${tot.matricula?brl(tot.matricula):'‚Äî'}</td>
          <td class="r">${tot.material?brl(tot.material):'‚Äî'}</td>
          <td class="r">${tot.uniforme?brl(tot.uniforme):'‚Äî'}</td>
          <td class="r">${tot.extra?brl(tot.extra):'‚Äî'}</td>
          <td class="r subtotal-col">${brl(tot.sub)}</td>
          <td class="r recv">${brl(tot.recv)}</td><td class="r">‚Äî</td>
          <td class="r neg">‚Äì${brl(Math.abs(tot.diff))}</td>
          <td class="r ${tPct!=='‚Äî'?((tot.recv/tot.sub)>=(tAccord/tot.sub||.5)?'pct-ok':'pct-bad'):''}">${tPct}</td>
          <td class="r accord-col">${tAccord?brl(tAccord):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${tot.fcst?.mensalidade?'‚âà'+brl(tot.fcst.mensalidade):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${tot.fcst?.matricula?'‚âà'+brl(tot.fcst.matricula):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${tot.fcst?.material?'‚âà'+brl(tot.fcst.material):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${tot.fcst?.uniforme?'‚âà'+brl(tot.fcst.uniforme):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${tot.fcst?.extra?'‚âà'+brl(tot.fcst.extra):'‚Äî'}</td>
          <td class="r fcst-col fcst-group" style="border-left:1px solid rgba(124,58,237,.15)">${yrFcstP?'‚âà'+brl(yrFcstP):'‚Äî'}</td>
          <td class="r fcst-col fcst-group">${yrFcstR?'‚âà'+brl(yrFcstR):'‚Äî'}</td>
        </tr>
      </tbody></table></div>
    </div>`;
  }

  const gD=gP-gR, gPct=gP>0?(gR/gP*100).toFixed(1):0;
  const gtHtml=`<div class="gt-strip confirmed">
    <div class="gt-cell"><div class="gt-label">Total Pago</div><div class="gt-value">${brl(gP)}</div></div>
    <div class="gt-cell"><div class="gt-label">Pens√£o Recebida</div><div class="gt-value warn">${brl(gR)}</div></div>
    <div class="gt-cell"><div class="gt-label">D√©ficit</div><div class="gt-value danger">‚Äì${brl(gD)}</div></div>
    <div class="gt-cell"><div class="gt-label">Cobertura Pai</div><div class="gt-value warn">${gPct}%</div></div>
  </div>`;
  const fcHtml=(gFcstP+gFcstR)>0?`<div class="gt-strip forecast">
    <div class="gt-cell"><div class="gt-label">‚óÜ Prev. Pago</div><div class="gt-value">‚âà${brl(gFcstP)}</div></div>
    <div class="gt-cell"><div class="gt-label">‚óÜ Prev. Recebido</div><div class="gt-value">‚âà${brl(gFcstR)}</div></div>
    <div class="gt-cell"><div class="gt-label">‚óÜ Total Previsto</div><div class="gt-value">‚âà${brl(gFcstP+gFcstR)}</div></div>
    <div class="gt-cell"><div class="gt-label">Lan√ßamentos</div><div class="gt-value">${allRows.filter(r=>r.type==='FORECAST'&&(S.year==='all'||r.academicYear===S.year)).length}</div></div>
  </div>`:'';
  $('rpt-content').innerHTML=gtHtml+fcHtml+html;
  // Reapply forecast column visibility state
  if(!S.fcstVisible){
    document.querySelectorAll('.fcst-group').forEach(el=>{ el.style.display='none'; });
  }
}

/* ‚îÄ‚îÄ‚îÄ FORECAST COLUMNS TOGGLE ‚îÄ‚îÄ‚îÄ */
function toggleFcstCols(){
  S.fcstVisible = !S.fcstVisible;
  const btn=$('btn-toggle-fcst');
  document.querySelectorAll('.fcst-group').forEach(el=>{
    el.style.display = S.fcstVisible ? '' : 'none';
  });
  if(btn){
    btn.classList.toggle('violet', S.fcstVisible);
    btn.classList.toggle('gray', !S.fcstVisible);
    btn.textContent = S.fcstVisible ? '‚óÜ Ocultar Prev.' : '‚óÜ Previs√µes';
  }
}

/* ‚îÄ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ‚îÄ */
function logout(){
  sessionStorage.removeItem('sl-auth');
  const ls=$('lock-screen');
  ls.style.animation='';
  ls.style.display='flex';
  // Reset pin state
  _lockInput='';
  updateLockDots();
  $('lock-error').style.display='none';
  toast('üîí Sess√£o encerrada');
}

/* ‚îÄ‚îÄ‚îÄ EMAIL REPORT ‚îÄ‚îÄ‚îÄ */
let _emailPdfBlob=null, _emailMailto='';

function openEmailSheet(){
  $('email-step-1').style.display='block';
  $('email-step-2').style.display='none';
  $('email-gen-status').style.display='none';
  $('email-gen-btn').disabled=false;
  _emailPdfBlob=null;
  const yr=S.year==='all'?new Date().getFullYear():S.year;
  $('email-subject').value=`Relat√≥rio de Pagamentos ${yr}`;
  $('email-body').value=`Ol√°,\n\nSegue em anexo o relat√≥rio de pagamentos do Col√©gio Objectivo ‚Äî ${yr}.\n\nAtenciosamente,\nGerenciamento de Pagamentos`;
  $('email-sheet').classList.add('open');
}

async function generateAndEmail(){
  const to = $('email-to').value.trim();
  if(!to){ toast('‚ö†Ô∏è Informe o destinat√°rio'); return; }

  const btn = $('email-gen-btn');
  btn.disabled = true;
  $('email-gen-status').style.display = 'block';
  $('email-gen-status').innerHTML = '<span class="spinner" style="display:inline-block;margin-right:8px"></span>Gerando relat√≥rio‚Ä¶';

  try {
    // ‚îÄ‚îÄ Garantir que o relat√≥rio est√° renderizado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(S.tab !== 'rpt'){ nav('rpt'); await new Promise(r=>setTimeout(r,600)); }
    if(!$('rpt-content').querySelector('.rpt-card')){ await renderReport(); await new Promise(r=>setTimeout(r,400)); }

    const hideFcst = $('email-hide-fcst').checked;
    if(hideFcst) document.querySelectorAll('.fcst-group').forEach(el=>el.style.display='none');
    await new Promise(r=>setTimeout(r,100));

    // ‚îÄ‚îÄ Construir conte√∫do do relat√≥rio em texto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const yr = S.year==='all' ? 'Todos os anos' : S.year;
    const now = new Date().toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

    // Extract table data as readable text
    const rows = [...$('rpt-content').querySelectorAll('tr')];
    const tableText = rows.map(r =>
      [...r.querySelectorAll('th,td')].map(c=>c.textContent.trim()).filter(Boolean).join(' | ')
    ).filter(Boolean).join('
');

    // Restore fcst
    if(hideFcst && S.fcstVisible) document.querySelectorAll('.fcst-group').forEach(el=>el.style.display='');

    // ‚îÄ‚îÄ Enviar via EmailJS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $('email-gen-status').innerHTML = '<span class="spinner" style="display:inline-block;margin-right:8px"></span>Enviando email‚Ä¶';

    emailjs.init(EMAILJS_PUBLIC_KEY);

    const subject = $('email-subject').value || `Relat√≥rio de Pagamentos ${yr}`;
    const bodyNote = $('email-body').value || 'Segue o relat√≥rio de pagamentos.';

    const result = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      to_email:       to,
      month_year:     yr,
      report_content: `${bodyNote}

Gerado em: ${now}
Ano: ${yr}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${tableText}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Enviado automaticamente pelo app Gerenciamento de Pagamentos D&B.`
    });

    if(result.status !== 200) throw new Error('EmailJS retornou status ' + result.status);

    // ‚îÄ‚îÄ Sucesso ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $('email-gen-status').style.display = 'none';
    $('email-step-1').style.display = 'none';
    $('email-step-2').style.display = 'block';
    $('email-summary').innerHTML = `Email enviado para <b>${to}</b><br>Assunto: <i>${subject}</i>`;
    toast('‚úÖ Email enviado com sucesso!');

  } catch(e) {
    console.error('EmailJS error:', e);
    $('email-gen-status').style.display = 'none';
    btn.disabled = false;
    toast('‚ùå Erro ao enviar: ' + (e?.text || e?.message || String(e)), 8000);
  }
}

function openMailtoLink(){ /* mantido para compatibilidade */ }

async function printReport(){
  // Navigate to report tab so it's rendered and visible
  if(S.tab !== 'rpt'){
    nav('rpt');
    await new Promise(r=>setTimeout(r,400));
  } else if(!$('rpt-content').querySelector('.rpt-card')){
    await renderReport();
    await new Promise(r=>setTimeout(r,300));
  }
  $('page-rpt').setAttribute('data-print-date', new Date().toLocaleDateString('pt-BR'));
  // Add body class that print CSS uses to ensure correct page visibility
  document.body.classList.add('printing');
  await new Promise(r=>setTimeout(r,100));
  window.print();
  // Remove class after print dialog closes
  setTimeout(()=>document.body.classList.remove('printing'), 1000);
}

async function exportCSV(){
  const rows=await dbAll('txs');
  const txs=rows.filter(r=>S.year==='all'||r.academicYear===S.year).sort((a,b)=>b.date.localeCompare(a.date));
  const hdr='Data,Tipo,Previs√£o,Categoria,Parte,Aluna,Valor,Atraso,Ano,Mes,Notas,Tags';
  const lines=txs.map(r=>[r.date,r.type,r.type==='FORECAST'?'Sim':'N√£o',r.categoryKey,partyLabel(r),r.student||'',r.amount,r.isLate?'Sim':'N√£o',r.academicYear,r.academicMonth,`"${(r.notes||'').replace(/"/g,'""')}"`,r.tags||''].join(','));
  const blob=new Blob(['\uFEFF'+[hdr,...lines].join('\r\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`ledger-${S.year}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('üì• CSV exportado!');
}

/* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
async function renderCfg(){
  const [cats,rows,parties,aiFiles]=[await dbAll('cats'),await dbAll('txs'),await dbAll('parties'),await dbAll('ai_files')];
  S.cats=cats; S.parties=parties;
  const years=[...new Set(rows.map(r=>r.academicYear))].filter(Boolean).sort((a,b)=>a-b);

  $('party-list-wrap').innerHTML=S.parties.length
    ? S.parties.map(p=>`<div class="list-row">
        <div class="list-icon" style="background:var(--accent-l);font-size:18px">${p.emoji||'üë§'}</div>
        <div class="list-body"><div class="list-name">${p.name}</div><div class="tx-sub">${p.emoji||'üë§'}</div></div>
        <button onclick="openPartySheet(${p.id})" style="border:none;background:none;color:var(--accent);font-size:17px;padding:6px 10px;cursor:pointer">‚úèÔ∏è</button>
      </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-3)">Nenhuma parte cadastrada</div>';

  $('cat-list-wrap').innerHTML=cats.length
    ? cats.map(c=>`<div class="list-row" id="cat-row-${c.key}">
        <label title="Alterar cor" style="cursor:pointer;position:relative;flex-shrink:0">
          <div class="list-icon" style="background:${c.color}1A;border:2px solid ${c.color};transition:transform .15s" onmouseenter="this.style.transform='scale(1.15)'" onmouseleave="this.style.transform=''">
            <div style="width:14px;height:14px;border-radius:4px;background:${c.color}"></div>
          </div>
          <input type="color" value="${c.color}" title="Alterar cor"
            style="position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer"
            oninput="previewCatColor('${c.key}',this.value)"
            onchange="saveCatColor('${c.key}',this.value)">
        </label>
        <div class="list-body">
          <div class="list-name">${c.label}${c.system?'<span style="font-size:10px;color:var(--t-4);background:var(--fill);border-radius:6px;padding:2px 6px;margin-left:6px;font-weight:400">sistema</span>':''}</div>
          <div class="tx-sub" style="font-family:var(--mono)">${c.color}</div>
        </div>
        ${!c.system?`<button onclick="delCat('${c.key}')" style="border:none;background:none;color:var(--red);font-size:17px;padding:6px 10px;cursor:pointer">üóë</button>`:''}
      </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-3)">Nenhuma categoria</div>';

  $('stat-count').textContent=rows.length+' transa√ß√µes';
  $('stat-years').textContent=years.length?years.join(', '):'‚Äî';
  $('stat-files').textContent=aiFiles.length+' arquivo'+( aiFiles.length!==1?'s':'' );

  // Accord config UI
  const a=S.accord;
  $('cfg-accord-type').value=a.type||'pct';
  $('cfg-accord-pct').value=a.pct||50;
  $('cfg-accord-val').value=a.val||0;
  onAccordTypeChange();
  populateCatSelects();
}

function onAccordTypeChange(){
  const t=$('cfg-accord-type').value;
  $('cfg-accord-pct-row').style.display=t==='pct'?'flex':'none';
  $('cfg-accord-val-row').style.display=t==='fixed'?'flex':'none';
}

async function saveAccordConfig(){
  const type=$('cfg-accord-type').value;
  const pct=parseFloat($('cfg-accord-pct').value)||50;
  const val=parseFloat($('cfg-accord-val').value)||0;
  S.accord={type,pct,val};
  await dbPut('cfg',{k:'accord',type,pct,val});
  toast('‚úÖ Acordo salvo!');
  if(S.tab==='dash') renderDash();
  if(S.tab==='rpt')  renderReport();
}

async function loadAccordConfig(){
  const rec=await dbGet('cfg','accord');
  if(rec) S.accord={type:rec.type||'pct',pct:rec.pct||50,val:rec.val||0};
}

/* ‚îÄ‚îÄ‚îÄ GENERATE FORECASTS ‚îÄ‚îÄ‚îÄ */
let _genBase='last';
function setGenBase(v){
  _genBase=v;
  $('gen-base-last').classList.toggle('on',v==='last');
  $('gen-base-avg').classList.toggle('on',v==='avg');
}

async function generateForecasts(){
  const genType=$('gen-type').value;
  const now=new Date(); const curYear=now.getFullYear(); const curMonth=now.getMonth()+1;
  const all=await dbAll('txs');
  const yrTxs=all.filter(r=>r.academicYear===curYear);

  async function getBaseValue(catKey){
    const paid=yrTxs.filter(r=>r.categoryKey===catKey&&r.type!=='FORECAST'&&(catKey==='pensao'?r.type==='RECEIVED':r.type==='PAID'));
    if(!paid.length) return null;
    if(_genBase==='last'){
      const sorted=paid.sort((a,b)=>b.date.localeCompare(a.date));
      return sorted[0].amount;
    }
    return paid.reduce((s,r)=>s+r.amount,0)/paid.length;
  }

  const cats=[];
  if(genType==='both'||genType==='mensalidade') cats.push({key:'mensalidade',type:'PAID'});
  if(genType==='both'||genType==='pensao')     cats.push({key:'pensao',type:'RECEIVED'});

  // Resolve party ids
  const decio = S.parties.find(p=>p.name==='D√©cio e Bruna');
  const father = S.parties.find(p=>p.name==='Pai')||null;

  let created=0, skipped=0;
  for(const {key,type} of cats){
    const baseAmt=await getBaseValue(key);
    if(!baseAmt){toast(`‚ö†Ô∏è Sem hist√≥rico para ${key}`);continue;}

    // Party assignment: mensalidade ‚Üí D√©cio e Bruna, pens√£o ‚Üí Father legacy
    const partyId = key==='pensao' ? (father?.id||null) : (decio?.id||null);
    const partyStr = key==='pensao' ? (father?null:'Father') : (decio?null:'Me');

    for(let m=curMonth+1;m<=12;m++){
      const exists=all.find(r=>r.type==='FORECAST'&&r.categoryKey===key&&r.academicYear===curYear&&r.academicMonth===m);
      if(exists){skipped++;continue;}
      const date=`${curYear}-${String(m).padStart(2,'0')}-05`;
      await dbPut('txs',{
        amount:Math.round(baseAmt*100)/100, type:'FORECAST', categoryKey:key,
        partyId, party: partyId ? null : partyStr,
        date, academicYear:curYear, academicMonth:m,
        isLate:false, student:'Ambas',
        notes:`${catInfo(key).label} ${MF[m-1]}/${curYear} (previs√£o auto)`,
        tags:`${key},forecast,auto`,
        createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
      });
      created++;
    }
  }
  toast(`‚óÜ ${created} previs√£o(√µes) criada(s)${skipped?`, ${skipped} j√° existia(m)`:''}`);
  await initYearFilter();
  if(S.tab==='dash') renderDash();
  if(S.tab==='txs')  renderTxList();
}

function populateCatSelects(){
  ['f-cat','fil-cat'].forEach(id=>{
    const s=$(id); if(!s)return;
    const cur=s.value;
    s.innerHTML=id==='fil-cat'?'<option value="">Todas categorias</option>':'';
    S.cats.forEach(c=>{ const o=document.createElement('option'); o.value=c.key; o.textContent=c.label; s.appendChild(o); });
    if(cur) s.value=cur;
  });
}

async function loadCats(){ S.cats=await dbAll('cats'); populateCatSelects(); }

async function saveCat(){
  const key=($('nc-key').value||'').trim().toLowerCase().replace(/\s+/g,'_');
  const label=($('nc-label').value||'').trim();
  const color=$('nc-color').value;
  if(!key||!label){toast('‚ö†Ô∏è Preencha chave e nome');return;}
  await dbPut('cats',{key,label,color,system:false});
  toast('‚úÖ Categoria criada!'); closeSheet('cat-sheet');
  $('nc-key').value=''; $('nc-label').value='';
  await loadCats(); renderCfg();
}

async function delCat(key){
  if(!confirm(`Excluir categoria "${key}"?`))return;
  await dbDel('cats',key); await loadCats(); renderCfg();
}

/* Live-preview color while dragging the picker */
function previewCatColor(key, color){
  const row = $('cat-row-'+key); if(!row) return;
  const icon  = row.querySelector('.list-icon');
  const swatch= row.querySelector('.list-icon div');
  const sub   = row.querySelector('.tx-sub');
  if(icon)  { icon.style.background=color+'1A'; icon.style.borderColor=color; }
  if(swatch){ swatch.style.background=color; }
  if(sub)   { sub.textContent=color; }
}

/* Persist color on picker close */
async function saveCatColor(key, color){
  const cat = S.cats.find(c=>c.key===key); if(!cat) return;
  cat.color = color;
  await dbPut('cats', cat);
  await loadCats();
  toast(`üé® Cor de "${cat.label}" atualizada`);
  // Refresh charts/dashboard if visible
  if(S.tab==='dash') renderDash();
  if(S.tab==='rpt')  renderReport();
}

async function clearAll(){
  if(!confirm('‚ö†Ô∏è Apagar TODOS os dados do Supabase? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  try {
    await _sb.from('transactions').delete().gte('id', 0);
    await _sb.from('parties').delete().gte('id', 0);
    await _sb.from('app_config').delete().neq('k', '__never__');
    await _sb.from('categories').delete().neq('key', '__never__');
    toast('üóë Todos os dados apagados');
    S.cats = []; S.parties = [];
    await initYearFilter();
    renderDash();
  } catch(e) {
    toast('‚ùå Erro ao apagar: ' + e.message);
  }
}

/* ‚îÄ‚îÄ‚îÄ JSON EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ */
async function exportJSON(){
  const [txs,cats,parties]=[await dbAll('txs'),await dbAll('cats'),await dbAll('parties')];
  const cfg=await dbGet('cfg','accord');
  const payload={meta:{version:'5.0',school:'Col√©gio Objectivo',exportedAt:new Date().toISOString()},config:{accord:cfg||{}},categories:cats,parties,transactions:txs};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`school-ledger-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('üíæ Backup exportado!');
}

async function importJSON(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const p=JSON.parse(e.target.result);
      if(!Array.isArray(p.transactions)) throw new Error('"transactions" ausente');
      if(!confirm(`Importar ${p.transactions.length} transa√ß√µes? Os dados atuais ser√£o substitu√≠dos.`))return;
      await dbClear('txs');
      for(const tx of p.transactions){
        // Strip old IndexedDB file fields that don't exist in Supabase schema
        delete tx.fileData; delete tx.fileName; delete tx.fileType;
        await dbPut('txs',tx);
      }
      if(Array.isArray(p.categories)) for(const c of p.categories) await dbPut('cats',c);
      if(Array.isArray(p.parties))    for(const pt of p.parties)   await dbPut('parties',pt);
      if(p.config?.accord) await dbPut('cfg',{k:'accord',...p.config.accord});
      const msg=$('imp-msg');
      msg.textContent=`‚úÖ ${p.transactions.length} transa√ß√µes importadas!`;
      msg.style.cssText='display:block;background:var(--green-l);color:var(--green);border-radius:var(--r);padding:12px 14px;font-size:13px;font-weight:500';
      await loadAccordConfig(); await loadCats(); await loadParties(); await initYearFilter();
      renderCfg(); toast('‚úÖ Importa√ß√£o conclu√≠da!',3500);
    }catch(err){
      const msg=$('imp-msg');
      msg.textContent='‚ùå Erro: '+err.message;
      msg.style.cssText='display:block;background:var(--red-l);color:var(--red);border-radius:var(--r);padding:12px 14px;font-size:13px;font-weight:500';
    }
  };
  reader.readAsText(file);
}

/* ‚îÄ‚îÄ‚îÄ SEED DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function seedIfEmpty(){
  // Check if data already exists in Supabase
  const { count, error } = await _sb.from('transactions').select('*', { count: 'exact', head: true });
  if (error) { console.error('seedIfEmpty check failed:', error); return; }
  if (count > 0) return;  // already has data

  const MF_SEED = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  // ‚îÄ‚îÄ Categorias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CATS = [
    {key:'mensalidade',label:'Mensalidade',       color:'#3B5BDB',is_system:true},
    {key:'pensao',     label:'Pens√£o Aliment√≠cia', color:'#C0392B',is_system:true},
    {key:'matricula',  label:'Matr√≠cula',          color:'#C05C1A',is_system:true},
    {key:'material',   label:'Material',           color:'#1A7F7A',is_system:true},
    {key:'uniforme',   label:'Uniforme',           color:'#6B4FBB',is_system:true},
    {key:'extra',      label:'Extra',              color:'#2E7D55',is_system:true},
  ];
  await _sb.from('categories').upsert(CATS, { onConflict: 'key' });

  // ‚îÄ‚îÄ Partes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const { data: p1 } = await _sb.from('parties').insert({name:'D√©cio e Bruna',emoji:'üë®‚Äçüë©‚Äçüëß'}).select('id').single();
  const { data: p2 } = await _sb.from('parties').insert({name:'Pai',           emoji:'üë®'}).select('id').single();
  const meId     = p1.id;
  const fatherId = p2.id;

  // ‚îÄ‚îÄ Acordo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  await _sb.from('app_config').upsert({k:'accord', value:{type:'pct',pct:50,val:0}}, {onConflict:'k'});

  // ‚îÄ‚îÄ Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tx = (o) => ({
    party_id:      o.party === 'Me' ? meId : fatherId,
    party_legacy:  o.party,
    student:       o.student || 'Ambas',
    is_late:       o.isLate || false,
    notes:         o.notes || null,
    tags:          o.tags  || null,
    ...o,
    category_key:  o.categoryKey,
    date:          o.date,
    academic_year: o.academicYear,
    academic_month:o.academicMonth,
  });
  // Remove JS-only fields before sending to Supabase
  const clean = (o) => {
    const r = tx(o);
    delete r.party; delete r.categoryKey; delete r.date;
    delete r.academicYear; delete r.academicMonth; delete r.isLate;
    return r;
  };

  // ‚îÄ‚îÄ Transa√ß√µes 2025 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const amounts_m25 = [4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.40];
  const txs2025 = [];

  // Mensalidades
  for(let i=0;i<12;i++) txs2025.push(clean({amount:amounts_m25[i],type:'PAID',categoryKey:'mensalidade',party:'Me',date:`2025-${String(i+1).padStart(2,'0')}-05`,academicYear:2025,academicMonth:i+1,notes:`Mensalidade ${MF_SEED[i]}/2025`,tags:'mensalidade'}));
  // Matr√≠cula
  txs2025.push(clean({amount:4256.88,type:'PAID',categoryKey:'matricula',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,notes:'Matr√≠cula anual 2025',tags:'matricula'}));
  // Material
  for(const [m,d] of [[1,'2025-01-05'],[4,'2025-04-05'],[7,'2025-07-05'],[9,'2025-09-05']])
    txs2025.push(clean({amount:724.50,type:'PAID',categoryKey:'material',party:'Me',date:d,academicYear:2025,academicMonth:m,notes:`Material ${MF_SEED[m-1]}/2025`,tags:'material'}));
  // Extra
  txs2025.push(clean({amount:1084.23,type:'PAID',categoryKey:'extra',party:'Me',date:'2025-01-05',academicYear:2025,academicMonth:1,notes:'Extra Jan/2025',tags:'extra'}));
  // Pens√£o 2025
  const p25=[[1,'2025-01-05',2000,false],[2,'2025-02-05',2000,false],[3,'2025-03-05',2000,false],[4,'2025-04-05',2000,false],[5,'2025-05-06',1000,true],[6,'2025-06-05',2000,false],[7,'2025-07-03',1000,false],[7,'2025-07-17',1000,true],[8,'2025-08-05',2000,false],[9,'2025-09-05',2000,false],[10,'2025-10-04',2000,false],[11,'2025-11-05',2000,false],[11,'2025-11-22',1500,true],[12,'2025-12-05',3500,false]];
  for(const[m,d,amt,late] of p25) txs2025.push(clean({amount:amt,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:d,academicYear:2025,academicMonth:m,isLate:late,notes:`Pens√£o ${MF_SEED[m-1]}/2025`,tags:'pensao'}));

  await _sb.from('transactions').insert(txs2025);

  // ‚îÄ‚îÄ Transa√ß√µes 2026 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const txs2026 = [];
  // Mensalidades pagas
  for(const [m,d] of [[1,'2026-01-05'],[2,'2026-02-05']])
    txs2026.push(clean({amount:5666.85,type:'PAID',categoryKey:'mensalidade',party:'Me',date:d,academicYear:2026,academicMonth:m,notes:`Mensalidade ${MF_SEED[m-1]}/2026`,tags:'mensalidade'}));
  txs2026.push(clean({amount:2778.76,type:'PAID',categoryKey:'mensalidade',party:'Me',date:'2026-02-27',academicYear:2026,academicMonth:3,student:'Lara',notes:'Mensalidade Mar/2026 ‚Äî Lara (PDF)',tags:'mensalidade'}));
  // Matr√≠cula, material, extra
  txs2026.push(clean({amount:1491.29,type:'PAID',categoryKey:'matricula',party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,notes:'Matr√≠cula 2026',tags:'matricula'}));
  txs2026.push(clean({amount:1047.33,type:'PAID',categoryKey:'material', party:'Me',date:'2026-01-05',academicYear:2026,academicMonth:1,notes:'Material Jan/2026',tags:'material'}));
  txs2026.push(clean({amount:1503.41,type:'PAID',categoryKey:'extra',    party:'Me',date:'2026-02-05',academicYear:2026,academicMonth:2,notes:'Excurs√£o parcela 1 (entrada)',tags:'extra,excursao'}));
  // Pens√£o recebida
  txs2026.push(clean({amount:2000,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-01-12',academicYear:2026,academicMonth:1,isLate:true,notes:'Pens√£o Jan/2026 ‚Äî com atraso',tags:'pensao'}));
  txs2026.push(clean({amount:2500,type:'RECEIVED',categoryKey:'pensao',party:'Father',date:'2026-02-07',academicYear:2026,academicMonth:2,isLate:true,notes:'Pens√£o Fev/2026 ‚Äî com atraso',tags:'pensao'}));
  // Previs√µes mensalidade Mar-Dez
  for(let i=2;i<12;i++){ const m=i+1; txs2026.push(clean({amount:5666.85,type:'FORECAST',categoryKey:'mensalidade',party:'Me',date:`2026-${String(m).padStart(2,'0')}-05`,academicYear:2026,academicMonth:m,notes:`Mensalidade ${MF_SEED[i]}/2026 (previs√£o)`,tags:'mensalidade,forecast'})); }
  // Previs√µes pens√£o Mar-Dez
  for(let i=2;i<12;i++){ const m=i+1; txs2026.push(clean({amount:2000,type:'FORECAST',categoryKey:'pensao',party:'Father',date:`2026-${String(m).padStart(2,'0')}-10`,academicYear:2026,academicMonth:m,notes:`Pens√£o ${MF_SEED[i]}/2026 (previs√£o)`,tags:'pensao,forecast'})); }
  // Previs√µes excurs√£o Mar-Ago
  for(let i=2;i<8;i++){  const m=i+1; txs2026.push(clean({amount:429,type:'FORECAST',categoryKey:'extra',party:'Me',date:`2026-${String(m).padStart(2,'0')}-05`,academicYear:2026,academicMonth:m,notes:`Excurs√£o ${MF_SEED[i]}/2026 (previs√£o)`,tags:'extra,excursao,forecast'})); }

  await _sb.from('transactions').insert(txs2026);
  console.log('‚úÖ Seed data inserted into Supabase');
}
/* ‚îÄ‚îÄ‚îÄ SHEET CLOSE ON BG ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll('.sheet-bg').forEach(bg=>bg.addEventListener('click',e=>{ if(e.target===bg) bg.classList.remove('open'); }));

/* ‚îÄ‚îÄ‚îÄ MIGRATION: party 'Me' ‚Üí parte real "D√©cio e Bruna" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Cria (ou localiza) a parte "D√©cio e Bruna" na store parties,
   depois reescreve TODOS os txs com party:'Me' para usar o
   partyId correto. Roda toda vez que o app abre ‚Äî √© idempotente.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function migratePartyMe(){
  // Ensure parties are loaded
  await loadParties();

  // Find or create "D√©cio e Bruna" party
  let party = S.parties.find(p => p.name === 'D√©cio e Bruna');
  if(!party){
    const newId = await dbPut('parties', {
      name: 'D√©cio e Bruna', emoji: 'üë®‚Äçüë©',
      createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
    });
    await loadParties();
    party = S.parties.find(p => p.id === newId) || S.parties.find(p => p.name === 'D√©cio e Bruna');
  }
  if(!party) return;

  // Rewrite every tx that still has party:'Me' and no partyId
  const all = await dbAll('txs');
  const toFix = all.filter(r => r.party === 'Me' && !r.partyId);
  for(const tx of toFix){
    await dbPut('txs', {
      ...tx,
      partyId: party.id,
      party: null,
      // strip stale fields that don't exist in Supabase
      fileData: undefined, fileName: undefined, fileType: undefined,
    });
  }
  if(toFix.length) console.log(`[migration] ${toFix.length} txs migrated ‚Üí D√©cio e Bruna (id ${party.id})`);

  // Also fix seed default party in generateForecasts references
  await loadParties();
}


/* ‚îÄ‚îÄ‚îÄ SUPABASE CONNECTION DIAGNOSTICS ‚îÄ‚îÄ‚îÄ */
async function checkSupabaseConn() {
  const el    = $('sb-conn-status');
  const dot   = $('sb-conn-dot');
  const label = $('sb-conn-label');
  if(!el) return;

  try {
    const t0 = Date.now();
    const { data, error, count } = await _sb
      .from('transactions')
      .select('*', { count: 'exact', head: true });
    if(error) throw error;
    const ms = Date.now() - t0;
    el.dataset.state = 'ok';
    label.textContent = `Supabase ¬∑ ${count ?? '?'} tx ¬∑ ${ms}ms`;
    // Also update dashboard banner
    const bt = $('db-source-text');
    if(bt) bt.textContent = `‚úÖ Supabase online ¬∑ ${count ?? '?'} transa√ß√µes ¬∑ ${ms}ms`;
  } catch(e) {
    el.dataset.state = 'err';
    label.textContent = 'Sem conex√£o';
    console.warn('[conn check]', e.message);
    const bt = $('db-source-text');
    if(bt) bt.textContent = '‚ùå Sem conex√£o com Supabase ‚Äî dados podem estar desatualizados';
  }
}

function showConnDiag() {
  const url = SUPABASE_URL || localStorage.getItem('sb-url') || '?';
  const proj = url.match(/https:\/\/([^.]+)/)?.[1] || url;
  _sb.from('transactions').select('*', { count:'exact', head:true }).then(({ count, error }) => {
    if(error) {
      alert('‚ùå ERRO DE CONEX√ÉO\n\n' + error.message + '\n\nProjeto: ' + proj);
    } else {
      _sb.from('transactions').select('id,date,amount').order('date', {ascending:false}).limit(3)
        .then(({ data }) => {
          const recent = (data||[]).map(r => `  ‚Ä¢ R$ ${r.amount} em ${r.date}`).join('\n') || '  (nenhuma)';
          alert(
            '‚úÖ CONECTADO AO SUPABASE\n' +
            '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
            'Projeto: ' + proj + '\n' +
            'Total de transa√ß√µes: ' + count + '\n\n' +
            '√öltimas transa√ß√µes no banco:\n' + recent + '\n\n' +
            'Se este n√∫mero divergir do que voc√™ v√™ na tela,\n' +
            'recarregue a p√°gina (puxe para baixo no celular).'
          );
        });
    }
  });
}


/* ‚îÄ‚îÄ‚îÄ CACHE CLEAR ‚îÄ‚îÄ‚îÄ */
async function clearAppCache() {
  if (!confirm('Limpar cache do app e recarregar?\nOs dados do Supabase n√£o ser√£o afetados.')) return;
  toast('üóëÔ∏è Limpando cache‚Ä¶');
  try {
    // 1. Apaga todos os caches do Service Worker
    if ('caches' in window) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
    // 2. Manda mensagem para o SW limpar o cache dele tamb√©m
    if (navigator.serviceWorker?.controller) {
      navigator.serviceWorker.controller.postMessage('CLEAR_CACHE');
    }
    // 3. Desregistra o Service Worker atual para for√ßar reinstala√ß√£o limpa
    if (navigator.serviceWorker) {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
    }
    // 4. Limpa localStorage de dados antigos (mant√©m credenciais Supabase)
    const sbUrl = localStorage.getItem('sb-url');
    const sbKey = localStorage.getItem('sb-key');
    localStorage.clear();
    if (sbUrl) localStorage.setItem('sb-url', sbUrl);
    if (sbKey) localStorage.setItem('sb-key', sbKey);
    // 5. Recarrega for√ßando busca na rede
    toast('‚úÖ Cache limpo! Recarregando‚Ä¶');
    setTimeout(() => location.reload(true), 800);
  } catch(e) {
    toast('‚ö†Ô∏è ' + e.message);
    location.reload(true);
  }
}


async function forceRefresh() {
  toast('üîÑ Buscando dados do Supabase‚Ä¶');
  // Force reload all data from Supabase
  await loadCats();
  await loadParties();
  await initYearFilter();
  await renderDash();
  if(S.tab==='txs') renderTxList();
  checkSupabaseConn();
  toast('‚úÖ Dados atualizados do Supabase!');
}

/* ‚îÄ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ‚îÄ */
// LOCK_PIN and _lockInput declared in inline script above

function lockKey(digit){
  if(_lockInput.length >= 6) return;
  _lockInput += digit;
  updateLockDots();
  if(_lockInput.length === 6) setTimeout(checkLockPin, 80);
}
function lockDel(){
  if(!_lockInput.length) return;
  _lockInput = _lockInput.slice(0,-1);
  updateLockDots();
}
function lockClear(){
  _lockInput = '';
  updateLockDots();
  $('lock-error').style.display='none';
}
// function updateLockDots( moved to inline script
function checkLockPin(){
  if(_lockInput === LOCK_PIN){
    sessionStorage.setItem('sl-auth','1');
    const ls=$('lock-screen');
    ls.style.animation='lockUnlock .35s ease forwards';
    setTimeout(()=>{
      ls.style.display='none';
      // Carrega dados do app ap√≥s autentica√ß√£o bem-sucedida
      _loadAppData();
    },340);
  } else {
    for(let i=0;i<6;i++) $('ld-'+i).classList.add('error');
    $('lock-error').style.display='block';
    setTimeout(()=>{
      _lockInput='';
      updateLockDots();
    }, 800);
  }
}

/* ‚îÄ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ‚îÄ */
// Desregistra qualquer Service Worker existente ‚Äî o SW causava conflito com o Supabase SDK
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => {
    regs.forEach(r => r.unregister());
  });
  // Limpa todos os caches do SW
  if ('caches' in window) {
    caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  }
}

/* ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ */
async function _bootApp() {
  // Inicializa EmailJS
  if(typeof emailjs !== 'undefined') emailjs.init(EMAILJS_PUBLIC_KEY);

  // ‚îÄ‚îÄ Auth gate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Se j√° autenticado nesta sess√£o, esconde a lock e carrega o app
  if (sessionStorage.getItem('sl-auth') === '1') {
    $('lock-screen').style.display = 'none';
    await _loadAppData();
  }
  // Se n√£o autenticado, fica na lock screen e aguarda ‚Äî _loadAppData()
  // ser√° chamado pelo checkLockPin() ap√≥s senha correta
}

async function _loadAppData() {
  await seedIfEmpty();
  await migratePartyMe();
  await loadAccordConfig();
  await loadCats();
  await loadParties();
  await initYearFilter();
  renderDash();
}

async function boot() {
  // ‚îÄ‚îÄ Auto-connect usando credenciais embutidas no script ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Se SUPABASE_URL e SUPABASE_ANON_KEY estiverem definidos no config,
  // conecta diretamente sem mostrar a tela de setup.
  // Credenciais embutidas no topo do script ‚Äî sempre dispon√≠veis
  const url = SUPABASE_URL;
  const key = SUPABASE_ANON_KEY;

  if (url && key) {
    try {
      _sb = supabase.createClient(url, key, {
        auth: { persistSession: false, autoRefreshToken: false },
        realtime: { params: { eventsPerSecond: -1 } },
        global: { fetch: (input, init) => {
          // Remove headers que causam DataCloneError com Service Worker
          if (init?.headers instanceof Headers) {
            init = { ...init, headers: Object.fromEntries(init.headers.entries()) };
          }
          return fetch(input, init);
        }}
      });
      const { error } = await _sb.from('categories').select('key').limit(1);
      if (error) throw error;
      // For√ßa reload do schema cache do PostgREST (evita erro file_data stale)
      try { await _sb.rpc('reload_schema'); } catch(_){} // ignora se n√£o existir
      $('sb-setup-screen').style.display = 'none';
      await _bootApp();
      checkSupabaseConn(); // update connection indicator
      return;
    } catch (e) {
      console.error('Supabase connection failed:', e.message);
      // Mostra tela de setup manual como fallback
      $('sb-setup-screen').style.display = 'flex';
      const errEl = $('sb-setup-err');
      if (errEl) { errEl.textContent = '‚ùå Conex√£o autom√°tica falhou: ' + e.message; errEl.style.display = 'block'; }
      _sb = null;
    }
  } else {
    // Sem config ‚Üí mostra tela de setup manual
    $('sb-setup-screen').style.display = 'flex';
  }
}
window.addEventListener('load', boot);
</script>
</body>
</html>
