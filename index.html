<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ledger">
<meta name="theme-color" content="#FAFAF9">
<title>School Ledger</title>
<link rel="manifest" href="./manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHOOL LEDGER v4 â€” Warm Neutral Â· Inter Â· iPad-first
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#FAFAF9; --bg-2:#F5F4F2; --card:#FFFFFF;
  --sep:rgba(0,0,0,.10); --sep-light:rgba(0,0,0,.06);
  --fill:rgba(0,0,0,.055); --fill-2:rgba(0,0,0,.035);
  --accent:#3B5BDB; --accent-l:rgba(59,91,219,.10); --accent-2:#2F4AC0;
  --green:#2E7D55; --green-l:rgba(46,125,85,.10);
  --red:#C0392B;   --red-l:rgba(192,57,43,.10);
  --orange:#C05C1A;--orange-l:rgba(192,92,26,.10);
  --purple:#6B4FBB;--purple-l:rgba(107,79,187,.10);
  --teal:#1A7F7A;  --teal-l:rgba(26,127,122,.10);
  --violet:#7C3AED;--violet-l:rgba(124,58,237,.09);--violet-d:rgba(124,58,237,.22);
  --t-primary:#18181B; --t-body:#3F3F46; --t-muted:#71717A;
  --t-faint:#A1A1AA; --t-disabled:#D4D4D8;
  --f:'Inter',-apple-system,'Helvetica Neue',sans-serif;
  --f-mono:'SF Mono','Menlo','Consolas',monospace;
  --sat:env(safe-area-inset-top,44px);
  --sab:env(safe-area-inset-bottom,34px);
  --r:10px; --r2:14px; --r3:18px;
  --tab:49px; --sidebar:230px;
  --s0:0 1px 2px rgba(0,0,0,.04);
  --s1:0 1px 3px rgba(0,0,0,.06),0 1px 8px rgba(0,0,0,.04);
  --s2:0 2px 8px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.05);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{font-family:var(--f);font-size:16px;line-height:1.5;background:var(--bg);color:var(--t-primary);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;padding-top:var(--sat);letter-spacing:-.01em}

/* â”€â”€ SCAFFOLD â”€â”€ */
#app{display:flex;flex-direction:column;height:100%}
#shell{display:flex;flex:1;overflow:hidden}
.scroller{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--tab) + var(--sab) + 20px)}
.scroller::-webkit-scrollbar{display:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR â€” iPad (â‰¥768px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  display:none;width:var(--sidebar);flex-shrink:0;
  background:rgba(250,250,249,.97);border-right:1px solid var(--sep-light);
  flex-direction:column;
  padding:16px 0 calc(var(--sab) + 12px);
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.sb-brand{padding:12px 18px 18px;border-bottom:1px solid var(--sep-light);margin-bottom:8px}
.sb-app{font-size:15px;font-weight:700;letter-spacing:-.03em}
.sb-sub{font-size:11px;color:var(--t-muted);margin-top:1px}
.sb-yr{padding:8px 12px 6px}
.sb-nav{display:flex;flex-direction:column;gap:2px;padding:4px 10px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r);border:none;background:none;cursor:pointer;font:500 14px/1 var(--f);color:var(--t-muted);letter-spacing:-.01em;text-align:left;width:100%;transition:background .12s,color .12s}
.sb-item:hover{background:var(--fill-2);color:var(--t-body)}
.sb-item.on{background:var(--accent-l);color:var(--accent)}
.sb-item svg{width:18px;height:18px;flex-shrink:0}
.sb-spacer{flex:1}
.sb-foot{padding:12px 18px 0;border-top:1px solid var(--sep-light);font-size:11px;color:var(--t-faint)}

/* iPad breakpoint */
@media(min-width:768px){
  .sidebar{display:flex}
  .tabbar{display:none!important}
  .navbar{display:none!important}
  .scroller{padding-bottom:calc(var(--sab) + 24px)!important}
  .pg-title{padding:24px 28px 4px!important;font-size:32px!important}
  .form-section{margin-left:28px!important;margin-right:28px!important}
  .card{margin-left:28px!important;margin-right:28px!important}
  .kpi-row{padding:16px 28px 4px!important;flex-wrap:wrap}
  .kpi{min-width:160px!important}
  .btns{padding:18px 28px 4px!important}
  .s-hdr{padding:20px 28px 10px!important}
  #rpt-actions-bar,#rpt-hint{padding-left:28px!important;padding-right:28px!important}
  .toast{bottom:28px}
  /* Center modal sheets on iPad */
  .sheet-bg{align-items:center;justify-content:center}
  .sheet{border-radius:var(--r3)!important;max-width:520px;width:92vw;animation:ipad-sheet .22s ease!important}
  @keyframes ipad-sheet{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
}

/* â”€â”€ NAV BAR (phone) â”€â”€ */
.navbar{display:flex;align-items:center;justify-content:space-between;padding:11px 20px;flex-shrink:0;min-height:48px;background:rgba(250,250,249,.95);backdrop-filter:saturate(180%) blur(24px);-webkit-backdrop-filter:saturate(180%) blur(24px);border-bottom:1px solid var(--sep-light)}
.navbar-title{font-size:16px;font-weight:600;letter-spacing:-.02em}
.yr-badge{display:flex;align-items:center;background:var(--accent);border-radius:100px;padding:5px 12px 5px 14px;cursor:pointer;gap:2px}
.yr-badge select{appearance:none;background:none;border:none;outline:none;font:600 14px/1 var(--f);color:#fff;cursor:pointer;letter-spacing:.01em}
.yr-badge select option{background:#fff;color:var(--t-primary)}
.yr-badge::after{content:'â–¾';color:rgba(255,255,255,.7);font-size:11px;pointer-events:none}

/* â”€â”€ PAGES â”€â”€ */
.pg-title{font-size:30px;font-weight:700;letter-spacing:-.04em;color:var(--t-primary);padding:18px 20px 2px;line-height:1.1}
.page{display:none}
.page.on{display:block;animation:pgfade .18s ease}
@keyframes pgfade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TAB BAR (phone) â”€â”€ */
.tabbar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab) + var(--sab));padding-bottom:var(--sab);background:rgba(250,250,249,.96);backdrop-filter:saturate(180%) blur(24px);-webkit-backdrop-filter:saturate(180%) blur(24px);border-top:1px solid var(--sep-light);display:flex;z-index:100}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding-top:5px;cursor:pointer;border:none;background:none;font:500 9.5px/1 var(--f);color:var(--t-faint);letter-spacing:.02em;text-transform:uppercase;transition:color .15s}
.tab.on{color:var(--accent)}
.tab svg{width:24px;height:24px}

/* â”€â”€ KPI â”€â”€ */
.kpi-row{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:16px 20px 4px;scrollbar-width:none}
.kpi-row::-webkit-scrollbar{display:none}
.kpi{min-width:150px;flex-shrink:0;background:var(--card);border-radius:var(--r2);padding:15px 16px;box-shadow:var(--s1);border:1px solid var(--sep-light)}
.kpi-label{font-size:10.5px;font-weight:500;color:var(--t-muted);margin-bottom:7px;text-transform:uppercase;letter-spacing:.06em}
.kpi-value{font:600 21px/1 var(--f-mono);letter-spacing:-.02em}
.kpi-sub{font-size:11px;color:var(--t-faint);margin-top:5px;line-height:1.4;font-weight:400}
.kpi.blue .kpi-value{color:var(--accent)}
.kpi.green .kpi-value{color:var(--green)}
.kpi.red .kpi-value{color:var(--red)}
.kpi.ora .kpi-value{color:var(--orange)}
.kpi.violet .kpi-value{color:var(--violet)}
.kpi.fcst-kpi{border-left:3px solid var(--violet)}

/* â”€â”€ SECTION HEADER â”€â”€ */
.s-hdr{display:flex;align-items:baseline;justify-content:space-between;padding:22px 20px 10px}
.s-title{font-size:18px;font-weight:700;letter-spacing:-.03em}
.s-link{font-size:14px;color:var(--accent);cursor:pointer;font-weight:500}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border-radius:var(--r2);margin:0 20px;box-shadow:var(--s1);overflow:hidden;border:1px solid var(--sep-light)}
.card+.card{margin-top:12px}

/* â”€â”€ LIST ROW â”€â”€ */
.list-row{display:flex;align-items:center;gap:14px;padding:12px 16px;border-bottom:1px solid var(--sep-light);min-height:48px;cursor:pointer;transition:background .12s}
.list-row:last-child{border-bottom:none}
.list-row:active{background:var(--fill-2)}
.list-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.list-label{font-size:15px;font-weight:400;flex:1;color:var(--t-body)}
.list-value{font-size:14px;color:var(--t-muted);font-weight:400}
.list-chevron{color:var(--t-disabled);flex-shrink:0}
.list-chevron svg{width:12px;height:12px}
.list-body{flex:1;min-width:0}
.list-name{font-size:15px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--t-body)}

/* â”€â”€ TX ROWS â”€â”€ */
.tx-sub{font-size:12px;color:var(--t-muted);margin-top:2px;line-height:1.4}
.tx-amount{font:600 15px/1 var(--f-mono);letter-spacing:-.02em}
.tx-amount.out{color:var(--red)}
.tx-amount.in{color:var(--green)}
.tx-amount.fcst{color:var(--violet);opacity:.7}
.tx-late{font-size:10px;color:var(--red);font-weight:600;margin-top:3px;letter-spacing:.02em}
.row-fcst{opacity:.65}
.fcst-badge{display:inline-block;font-size:9px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;color:var(--violet);background:var(--violet-l);border:1px solid var(--violet-d);border-radius:4px;padding:1px 5px;vertical-align:middle;margin-left:5px}

/* â”€â”€ CHARTS â”€â”€ */
.chart-title{font-size:11px;font-weight:600;color:var(--t-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:16px}
.donut-name{font-size:11px;font-weight:500;color:var(--t-muted);letter-spacing:.02em}
.leg-item{display:flex;align-items:center;gap:7px;font-size:10.5px;color:var(--t-muted)}
.leg-swatch{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.leg-pct{font:500 10px/1 var(--f-mono);margin-left:auto;color:var(--t-primary)}

/* â”€â”€ FORM â”€â”€ */
.form-section{margin:20px 20px 0}
.form-label{font-size:11px;font-weight:600;color:var(--t-muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;padding:0 2px}
.form-card{background:var(--card);border-radius:var(--r2);overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-light)}
.field{display:flex;align-items:center;gap:12px;padding:0 16px;border-bottom:1px solid var(--sep-light);min-height:46px}
.field:last-child{border-bottom:none}
.field-label{font-size:15px;font-weight:400;min-width:100px;flex-shrink:0;color:var(--t-body)}
.field input,.field select,.field textarea{flex:1;border:none;background:none;outline:none;font:400 15px/1 var(--f);color:var(--t-primary);text-align:right;-webkit-appearance:none;letter-spacing:-.01em}
.field input::placeholder{color:var(--t-disabled)}
.field select option{text-align:left}
.field.tall{align-items:flex-start;padding:12px 16px}
.field.tall .field-label{font-size:13px;color:var(--t-muted);font-weight:500;padding-top:2px;min-width:auto}
.field.tall textarea{text-align:left;resize:none;line-height:1.5;padding:0;font-size:14px}
/* Inline party add */
.party-inline{display:flex;gap:8px;padding:10px 16px;background:var(--bg-2);border-top:1px solid var(--sep-light)}
.party-inline input{flex:1;border:1.5px solid var(--sep);border-radius:var(--r);padding:8px 10px;font:400 13px/1 var(--f);color:var(--t-primary);background:var(--card);outline:none;-webkit-appearance:none}
.party-inline input:focus{border-color:var(--accent)}
.party-inline button{flex-shrink:0;padding:8px 14px;border-radius:var(--r);border:none;background:var(--accent);color:#fff;font:500 13px/1 var(--f);cursor:pointer}
/* Toggle */
.tog-field{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--sep-light);min-height:46px;cursor:pointer}
.tog-label{font-size:15px;font-weight:400;color:var(--t-body)}
.toggle{width:51px;height:31px;border-radius:16px;background:var(--t-disabled);position:relative;flex-shrink:0;transition:background .2s;cursor:pointer}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;left:2px;top:2px;width:27px;height:27px;border-radius:50%;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:transform .22s cubic-bezier(.34,1.12,.64,1)}
.toggle.on::after{transform:translateX(20px)}
/* Forecast notice */
.fcst-notice{background:var(--violet-l);border:1.5px dashed var(--violet-d);border-radius:var(--r2);padding:12px 14px;margin:12px 20px 0;display:none}
.fcst-notice.show{display:block}
.fcst-notice b{color:var(--violet)}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;border-radius:var(--r2);font:600 15px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s,transform .1s}
.btn:active{opacity:.8;transform:scale(.99)}
.btn.primary{background:var(--accent);color:#fff}
.btn.destructive{background:var(--red-l);color:var(--red)}
.btn.secondary{background:var(--fill);color:var(--t-body)}
.btns{display:flex;flex-direction:column;gap:10px;padding:18px 20px 4px}
.pill-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:100px;font:500 14px/1 var(--f);border:none;cursor:pointer;letter-spacing:-.01em;transition:opacity .15s;white-space:nowrap}
.pill-btn:active{opacity:.75}
.pill-btn:disabled{opacity:.35;cursor:default}
.pill-btn.blue{background:var(--accent);color:#fff}
.pill-btn.gray{background:var(--fill);color:var(--t-body)}
.pill-btn.green{background:var(--green);color:#fff}

/* â”€â”€ AI SECTION â”€â”€ */
.ai-drop{border:1.5px dashed var(--sep);border-radius:var(--r);background:var(--bg-2);padding:22px 16px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px}
.ai-drop.drag{border-color:var(--accent);background:var(--accent-l)}
.ai-drop.filled{border-style:solid;border-color:var(--green);background:var(--green-l)}
.ai-result{display:none;background:var(--green-l);border:1px solid rgba(46,125,85,.25);border-radius:var(--r);padding:12px 14px;margin-top:12px}
@keyframes aiFlash{0%{background:rgba(46,125,85,.15)}100%{background:transparent}}
.ai-hi{animation:aiFlash 2.5s ease forwards}

/* â”€â”€ REPORTS â”€â”€ */
.rpt-card{background:var(--card);border-radius:var(--r2);margin:0 20px 14px;overflow:hidden;box-shadow:var(--s1);border:1px solid var(--sep-light)}
.rpt-yr-hdr{background:var(--accent);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.rpt-yr-hdr h3{font-size:16px;font-weight:700;letter-spacing:-.02em}
.rpt-yr-hdr span{font:500 13px/1 var(--f-mono);opacity:.8}
.rpt-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.rtbl{width:100%;border-collapse:collapse;white-space:nowrap}
.rtbl th{padding:9px 12px;text-align:right;font-size:10px;font-weight:600;color:var(--t-muted);text-transform:uppercase;letter-spacing:.06em;background:var(--bg-2);border-bottom:1px solid var(--sep-light)}
.rtbl th:first-child{text-align:left;padding-left:16px}
.rtbl td{padding:9px 12px;text-align:right;border-bottom:1px solid var(--sep-light);font:400 12px/1.4 var(--f-mono);color:var(--t-muted);letter-spacing:-.01em;vertical-align:top}
.rtbl td:first-child{text-align:left;font:500 13px/1 var(--f);color:var(--t-body);padding-left:16px;letter-spacing:-.01em}
.rtbl tr:last-child td{border-bottom:none}
.rtbl tr.total-row td{background:rgba(59,91,219,.05);font-weight:700;color:var(--t-primary);border-top:1px solid rgba(59,91,219,.18)}
.r{text-align:right!important}
.neg{color:var(--red)!important}
.recv{color:var(--green)!important}
.pct-ok{color:var(--green)!important;font-weight:600}
/* Late tag â€” ONLY beside date */
.late-tag{display:block;font-size:9.5px;font-weight:700;color:var(--red);letter-spacing:.03em;margin-top:3px;white-space:nowrap}
/* Forecast col */
.fcst-col{color:var(--violet)!important;font-style:italic}
/* Grand totals */
.gt-strip{border-radius:var(--r2);margin:0 20px 12px;padding:16px 18px;display:grid;grid-template-columns:1fr 1fr;gap:14px;box-shadow:var(--s2)}
.gt-strip.confirmed{background:var(--accent)}
.gt-strip.forecast{background:var(--violet)}
.gt-cell{text-align:center}
.gt-label{font-size:9.5px;font-weight:600;color:rgba(255,255,255,.65);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px}
.gt-value{font:600 16px/1 var(--f-mono);color:#fff;letter-spacing:-.02em}
.gt-value.warn{color:#FBBF24}
.gt-value.danger{color:#FCA5A5}

/* â”€â”€ BOTTOM SHEET â”€â”€ */
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:400;display:none;align-items:flex-end}
.sheet-bg.open{display:flex;animation:bgfade .2s ease}
@keyframes bgfade{from{opacity:0}to{opacity:1}}
.sheet{background:var(--card);border-radius:18px 18px 0 0;width:100%;max-height:92vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 calc(var(--sab)+8px);animation:sheetup .3s cubic-bezier(.34,1.12,.64,1);border-top:1px solid var(--sep-light)}
@keyframes sheetup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-grip{width:36px;height:4px;background:var(--sep);border-radius:2px;margin:10px auto 0}
.sheet-hdr{padding:14px 20px 13px;border-bottom:1px solid var(--sep-light);display:flex;align-items:center;justify-content:space-between}
.sheet-title{font-size:17px;font-weight:600;letter-spacing:-.02em}
.sheet-close{font-size:15px;color:var(--accent);background:none;border:none;font-family:var(--f);cursor:pointer;font-weight:500;padding:0}

/* â”€â”€ MISC â”€â”€ */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:20px;height:20px;border:2px solid var(--sep-light);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite;display:inline-block;vertical-align:middle}
.toast{position:fixed;bottom:calc(var(--tab)+var(--sab)+14px);left:50%;transform:translateX(-50%);background:rgba(24,24,27,.9);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:100px;padding:11px 22px;font:500 13.5px/1 var(--f);color:#fff;white-space:nowrap;z-index:999;opacity:0;transition:opacity .2s;pointer-events:none;letter-spacing:-.01em;box-shadow:var(--s2)}
.toast.on{opacity:1}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 24px;gap:10px;text-align:center;color:var(--t-muted);font-size:15px}
.empty-state .ic{font-size:44px;margin-bottom:4px}

/* â”€â”€ PRINT â”€â”€ */
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  html,body{height:auto!important;overflow:visible!important;background:#fff!important;padding:0!important;font-size:10pt}
  #app{display:block!important;height:auto!important;overflow:visible!important}
  #shell{display:block!important}
  .sidebar,.tabbar,.navbar,.sheet-bg,#rpt-actions-bar,.page:not(#page-rpt){display:none!important}
  .scroller{overflow:visible!important;height:auto!important;padding:0!important;display:block!important}
  #page-rpt{display:block!important}
  .pg-title{font-size:22pt!important;padding:0 0 8pt!important}
  .rpt-card{margin:0 0 12pt!important;break-inside:avoid;box-shadow:none!important;border:1px solid #ccc;border-radius:6pt}
  .rpt-yr-hdr{background:#3B5BDB!important;padding:9pt 12pt}
  .rpt-yr-hdr h3,.rpt-yr-hdr span{color:#fff!important}
  .rtbl th{background:#f4f4f5!important;font-size:8pt;padding:5pt 8pt}
  .rtbl td{font-size:8pt;padding:5pt 8pt}
  .rtbl tr.total-row td{background:rgba(59,91,219,.07)!important}
  .gt-strip.confirmed{background:#3B5BDB!important;margin:0 0 10pt!important;border-radius:6pt!important;padding:10pt!important}
  .gt-strip.forecast{background:#7C3AED!important;margin:0 0 12pt!important;border-radius:6pt!important;padding:10pt!important}
  #rpt-hint{padding-left:0!important;font-size:8pt;color:#666}
  @page{margin:14mm 12mm}
}
</style>
</head>
<body>
<div id="app">

<!-- PHONE NAVBAR -->
<div class="navbar" id="navbar">
  <div class="navbar-title" id="nav-title">School Ledger</div>
  <div class="yr-badge" id="nav-yr"><select id="yr-sel"></select></div>
</div>

<div id="shell">

<!-- â•â•â• IPAD SIDEBAR â•â•â• -->
<aside class="sidebar" id="sidebar">
  <div class="sb-brand">
    <div class="sb-app">School Ledger</div>
    <div class="sb-sub">ColÃ©gio Objectivo Â· Lara &amp; Chloe</div>
  </div>
  <div class="sb-yr"><div class="yr-badge"><select id="yr-sel-sb"></select></div></div>
  <nav class="sb-nav">
    <button class="sb-item on" id="si-dash" onclick="nav('dash')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>Dashboard
    </button>
    <button class="sb-item" id="si-txs" onclick="nav('txs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>TransaÃ§Ãµes
    </button>
    <button class="sb-item" id="si-add" onclick="nav('add')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Nova TransaÃ§Ã£o
    </button>
    <button class="sb-item" id="si-rpt" onclick="nav('rpt')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>RelatÃ³rio
    </button>
    <button class="sb-item" id="si-cfg" onclick="nav('cfg')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>ConfiguraÃ§Ãµes
    </button>
  </nav>
  <div class="sb-spacer"></div>
  <div class="sb-foot">v4.0 &mdash; Local PWA</div>
</aside>

<!-- â•â•â• SCROLL AREA â•â•â• -->
<div class="scroller" id="scroller">

  <!-- â–‘â–‘â–‘ DASHBOARD â–‘â–‘â–‘ -->
  <div class="page on" id="page-dash">
    <div class="pg-title">Dashboard</div>
    <div class="kpi-row" id="kpi-row"></div>
    <div id="fcst-kpi-wrap"></div>
    <div id="chart-area" style="margin-top:12px"></div>
    <div class="s-hdr"><span class="s-title">Recentes</span><span class="s-link" onclick="nav('txs')">Ver todas â†’</span></div>
    <div class="card" id="recent-card"><div class="empty-state"><span class="spinner"></span></div></div>
    <div style="height:8px"></div>
  </div>

  <!-- â–‘â–‘â–‘ TRANSACTIONS â–‘â–‘â–‘ -->
  <div class="page" id="page-txs">
    <div class="pg-title">TransaÃ§Ãµes</div>
    <div style="display:flex;gap:8px;padding:12px 20px 4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none">
      <select id="fil-type" onchange="renderTxList()" style="background:var(--card);border:1px solid var(--sep-light);border-radius:100px;padding:7px 16px;font:500 13px/1 var(--f);color:var(--t-body);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:var(--s0)">
        <option value="">Todos os tipos</option>
        <option value="PAID">Pago</option>
        <option value="RECEIVED">Recebido</option>
        <option value="FORECAST">â—† PrevisÃ£o</option>
      </select>
      <select id="fil-cat" onchange="renderTxList()" style="background:var(--card);border:1px solid var(--sep-light);border-radius:100px;padding:7px 16px;font:500 13px/1 var(--f);color:var(--t-body);outline:none;-webkit-appearance:none;flex-shrink:0;cursor:pointer;box-shadow:var(--s0)">
        <option value="">Todas categorias</option>
      </select>
    </div>
    <div id="tx-wrap" style="margin:4px 0"></div>
  </div>

  <!-- â–‘â–‘â–‘ ADD / EDIT â–‘â–‘â–‘ -->
  <div class="page" id="page-add">
    <div class="pg-title" id="add-title">Nova TransaÃ§Ã£o</div>

    <!-- AI Local -->
    <div class="form-section">
      <div class="form-label">âœ¦ Preencher com IA Local</div>
      <div class="form-card" style="padding:14px 16px">
        <p style="font-size:12px;color:var(--t-muted);line-height:1.65;margin-bottom:10px">AnÃ¡lise local Â· sem API Â· compatÃ­vel com Safari/iOS.<br>Envie PDF, imagem ou TXT de boleto/comprovante.</p>
        <div id="ai-drop" class="ai-drop"
             onclick="document.getElementById('ai-file').click()"
             ondragover="event.preventDefault();this.classList.add('drag')"
             ondragleave="this.classList.remove('drag')"
             ondrop="onAiDrop(event)">
          <input type="file" id="ai-file" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" onchange="loadAiFile(event.target.files[0])">
          <div id="ai-idle">
            <div style="font-size:30px;margin-bottom:6px">ğŸ“„</div>
            <div style="font-size:14px;font-weight:500;color:var(--t-body)">Toque para escolher arquivo</div>
            <div style="font-size:12px;color:var(--t-muted);margin-top:3px">Boleto Â· Comprovante Â· PDF Â· Imagem Â· TXT</div>
          </div>
          <div id="ai-file-info" style="display:none;align-items:center;gap:12px">
            <span id="ai-file-ic" style="font-size:28px"></span>
            <div style="flex:1;text-align:left;min-width:0">
              <div id="ai-file-nm" style="font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
              <div id="ai-file-sz" style="font-size:12px;color:var(--t-muted);margin-top:2px"></div>
            </div>
            <button onclick="clearAiFile(event)" style="background:var(--fill);border:none;border-radius:100px;padding:6px 12px;font:500 13px/1 var(--f);color:var(--t-body);cursor:pointer;flex-shrink:0">Remover</button>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <button id="ai-run-btn" class="pill-btn blue" disabled onclick="runAI()">
            <span id="ai-run-ic">âœ¦</span>&nbsp;<span id="ai-run-txt">Interpretar com IA</span>
          </button>
          <span id="ai-status" style="font-size:12px;color:var(--t-muted)"></span>
        </div>
        <div class="ai-result" id="ai-result">
          <div style="display:flex;gap:10px">
            <span style="font-size:20px">âœ…</span>
            <div><div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:3px">Campos preenchidos</div><div id="ai-summary" style="font-size:12px;color:var(--t-body);line-height:1.5"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS -->
    <div class="form-section" style="margin-top:20px">
      <div class="form-label">Dados</div>
      <div class="form-card">
        <input type="hidden" id="f-id">
        <div class="field">
          <span class="field-label">Valor (R$)</span>
          <input id="f-val" type="number" inputmode="decimal" step="0.01" placeholder="0,00">
        </div>
        <div class="field">
          <span class="field-label">Tipo</span>
          <select id="f-type" onchange="onTypeChange()">
            <option value="PAID">SaÃ­da (pago)</option>
            <option value="RECEIVED">Entrada (recebido)</option>
            <option value="FORECAST">â—† PrevisÃ£o futura</option>
          </select>
        </div>
        <div class="field">
          <span class="field-label">Categoria</span>
          <select id="f-cat"></select>
        </div>
        <div class="field">
          <span class="field-label">Parte</span>
          <select id="f-party"></select>
        </div>
      </div>
      <!-- Inline: criar nova parte -->
      <div class="party-inline">
        <input id="f-new-party" type="text" placeholder="Nova parteâ€¦ (ex: AvÃ³)" maxlength="40"
               onkeydown="if(event.key==='Enter'){event.preventDefault();addPartyInline()}">
        <button onclick="addPartyInline()">+ Adicionar</button>
      </div>
    </div>

    <!-- Forecast notice -->
    <div class="fcst-notice" id="fcst-notice">
      <b>â—† PrevisÃ£o futura</b> â€” este lanÃ§amento <strong>nÃ£o entra nos totais realizados</strong>.
      Aparece em violeta como previsÃ£o, separado dos valores pagos.
    </div>

    <!-- REFERÃŠNCIA -->
    <div class="form-section">
      <div class="form-label">ReferÃªncia</div>
      <div class="form-card">
        <div class="field">
          <span class="field-label">Data</span>
          <input id="f-date" type="date">
        </div>
        <div class="field">
          <span class="field-label">Ano Letivo</span>
          <select id="f-year"></select>
        </div>
        <div class="field">
          <span class="field-label">MÃªs</span>
          <select id="f-month">
            <option value="1">Janeiro</option><option value="2">Fevereiro</option>
            <option value="3">MarÃ§o</option><option value="4">Abril</option>
            <option value="5">Maio</option><option value="6">Junho</option>
            <option value="7">Julho</option><option value="8">Agosto</option>
            <option value="9">Setembro</option><option value="10">Outubro</option>
            <option value="11">Novembro</option><option value="12">Dezembro</option>
          </select>
        </div>
      </div>
    </div>

    <!-- DETALHES -->
    <div class="form-section">
      <div class="form-label">Detalhes</div>
      <div class="form-card">
        <div class="tog-field" onclick="document.getElementById('tog').classList.toggle('on')">
          <span class="tog-label">Recebido com atraso â– </span>
          <div class="toggle" id="tog"></div>
        </div>
        <div class="field tall">
          <span class="field-label">Notas</span>
          <textarea id="f-notes" rows="2" placeholder="ObservaÃ§Ãµesâ€¦"></textarea>
        </div>
        <div class="field">
          <span class="field-label">Tags</span>
          <input id="f-tags" type="text" placeholder="opcional">
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="btn primary" onclick="saveTx()">ğŸ’¾&nbsp; Salvar TransaÃ§Ã£o</button>
      <button id="del-btn" class="btn destructive" style="display:none" onclick="deleteTx()">ğŸ—‘&nbsp; Excluir TransaÃ§Ã£o</button>
    </div>
    <div style="height:8px"></div>
  </div>

  <!-- â–‘â–‘â–‘ REPORTS â–‘â–‘â–‘ -->
  <div class="page" id="page-rpt">
    <div class="pg-title">RelatÃ³rio</div>
    <div id="rpt-actions-bar" style="display:flex;gap:8px;padding:12px 20px 4px;flex-wrap:wrap">
      <button class="pill-btn blue" onclick="printReport()">ğŸ–¨ï¸&nbsp; Imprimir / PDF</button>
      <button class="pill-btn gray" onclick="exportCSV()">ğŸ“¥&nbsp; Exportar CSV</button>
    </div>
    <div id="rpt-content"><div class="empty-state"><span class="spinner"></span></div></div>
    <div id="rpt-hint" style="padding:0 20px 20px;font-size:11px;color:var(--t-faint);line-height:1.9">
      <strong style="color:var(--red)">â–  atraso</strong> exibido apenas ao lado da data de pagamento&nbsp;Â·&nbsp;
      <strong style="color:var(--violet)">â—† PrevisÃ£o</strong> nÃ£o entra nos totais realizados&nbsp;Â·&nbsp;
      PDF: Imprimir â†’ Salvar como PDF
    </div>
  </div>

  <!-- â–‘â–‘â–‘ SETTINGS â–‘â–‘â–‘ -->
  <div class="page" id="page-cfg">
    <div class="pg-title">ConfiguraÃ§Ãµes</div>

    <div class="form-section">
      <div class="form-label">Backup</div>
      <div class="form-card">
        <div class="list-row" onclick="exportJSON()">
          <div class="list-icon" style="background:var(--accent-l)">ğŸ’¾</div>
          <div class="list-label">Exportar backup JSON</div>
          <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
        </div>
        <div class="list-row" onclick="document.getElementById('imp-file').click()">
          <div class="list-icon" style="background:var(--green-l)">ğŸ“‚</div>
          <div class="list-label">Importar backup JSON</div>
          <input type="file" id="imp-file" accept=".json" style="display:none" onchange="importJSON(event.target.files[0])">
          <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
        </div>
      </div>
      <div id="imp-msg" style="display:none;margin-top:8px;padding:12px 14px;border-radius:var(--r);font-size:13px;font-weight:500;line-height:1.5"></div>
    </div>

    <!-- PARTES CRUD -->
    <div class="form-section">
      <div class="form-label">Partes</div>
      <div class="form-card" id="party-list-wrap"></div>
      <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="openPartySheet(null)">+ Nova Parte</button></div>
    </div>

    <!-- CATEGORIAS -->
    <div class="form-section">
      <div class="form-label">Categorias</div>
      <div class="form-card" id="cat-list-wrap"></div>
      <div style="margin-top:8px"><button class="btn secondary" style="border-radius:var(--r2)" onclick="document.getElementById('cat-sheet').classList.add('open')">+ Nova Categoria</button></div>
    </div>

    <!-- STATS -->
    <div class="form-section">
      <div class="form-label">Dados</div>
      <div class="form-card">
        <div class="list-row" style="cursor:default">
          <div class="list-icon" style="background:var(--accent-l)">ğŸ“Š</div>
          <div class="list-label">Total de transaÃ§Ãµes</div>
          <div class="list-value" id="stat-count">â€”</div>
        </div>
        <div class="list-row" style="cursor:default">
          <div class="list-icon" style="background:var(--orange-l)">ğŸ“…</div>
          <div class="list-label">Anos com dados</div>
          <div class="list-value" id="stat-years">â€”</div>
        </div>
        <div class="list-row" style="cursor:default">
          <div class="list-icon" style="background:var(--green-l)">ğŸ“±</div>
          <div class="list-label">Armazenamento</div>
          <div class="list-value">Local (iPhone/iPad)</div>
        </div>
        <div class="list-row" onclick="clearAll()">
          <div class="list-icon" style="background:var(--red-l)">âš ï¸</div>
          <div class="list-label" style="color:var(--red)">Apagar todos os dados</div>
          <div class="list-chevron"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
        </div>
      </div>
    </div>

    <div class="form-section" style="margin-bottom:20px">
      <div class="form-label">Instalar no iPhone / iPad</div>
      <div class="form-card" style="padding:14px 16px">
        <p style="font-size:15px;color:var(--t-body);line-height:2.1">
          1. Abra no <strong>Safari</strong><br>
          2. Toque em <strong>â¬†ï¸ Compartilhar</strong><br>
          3. Toque em <strong>"Adicionar Ã  Tela de InÃ­cio"</strong><br>
          4. Toque em <strong>Adicionar</strong>
        </p>
      </div>
    </div>
  </div><!-- /page-cfg -->

</div><!-- /scroller -->
</div><!-- /shell -->

<!-- PHONE TAB BAR -->
<div class="tabbar">
  <button class="tab on" id="t-dash" onclick="nav('dash')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>InÃ­cio
  </button>
  <button class="tab" id="t-txs" onclick="nav('txs')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>TransaÃ§Ãµes
  </button>
  <button class="tab" id="t-add" onclick="nav('add')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Novo
  </button>
  <button class="tab" id="t-rpt" onclick="nav('rpt')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="15" y2="17"/></svg>RelatÃ³rio
  </button>
  <button class="tab" id="t-cfg" onclick="nav('cfg')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Config
  </button>
</div>
</div><!-- /app -->

<!-- TX DETAIL SHEET -->
<div class="sheet-bg" id="tx-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title" id="sh-title">TransaÃ§Ã£o</div>
      <button class="sheet-close" onclick="closeSheet('tx-sheet')">Fechar</button>
    </div>
    <div id="sh-body"></div>
  </div>
</div>

<!-- CAT SHEET -->
<div class="sheet-bg" id="cat-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title">Nova Categoria</div>
      <button class="sheet-close" onclick="closeSheet('cat-sheet')">Cancelar</button>
    </div>
    <div style="padding:16px">
      <div class="form-card">
        <div class="field"><span class="field-label">Chave</span><input id="nc-key" placeholder="ex: excursao"></div>
        <div class="field"><span class="field-label">Nome</span><input id="nc-label" placeholder="ex: ExcursÃ£o"></div>
        <div class="field"><span class="field-label">Cor</span><input id="nc-color" type="color" value="#3B5BDB" style="width:44px;height:30px;border:none;background:none;cursor:pointer;-webkit-appearance:none;padding:0;margin-left:auto"></div>
      </div>
      <div style="margin-top:12px"><button class="btn primary" onclick="saveCat()">Criar Categoria</button></div>
    </div>
  </div>
</div>

<!-- PARTY SHEET -->
<div class="sheet-bg" id="party-sheet">
  <div class="sheet">
    <div class="sheet-grip"></div>
    <div class="sheet-hdr">
      <div class="sheet-title" id="ps-title">Nova Parte</div>
      <button class="sheet-close" onclick="closeSheet('party-sheet')">Cancelar</button>
    </div>
    <div style="padding:16px">
      <input type="hidden" id="ps-id">
      <div class="form-card">
        <div class="field"><span class="field-label">Nome</span><input id="ps-name" placeholder="ex: AvÃ³, Escolaâ€¦" maxlength="40"></div>
        <div class="field"><span class="field-label">Emoji</span><input id="ps-emoji" placeholder="ğŸ‘¤" maxlength="4" style="max-width:60px"></div>
      </div>
      <div style="margin-top:12px"><button class="btn primary" onclick="saveParty()">Salvar Parte</button></div>
      <div id="ps-del-wrap" style="margin-top:8px;display:none"><button class="btn destructive" onclick="deleteParty()">Excluir Parte</button></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHOOL LEDGER v4 â€” JavaScript
   IndexedDB v3: adds 'parties' store, preserves existing data
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ INDEXEDDB â”€â”€â”€ */
const DB_NAME = 'school-ledger';
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, 3);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('txs'))     d.createObjectStore('txs',     { keyPath: 'id', autoIncrement: true });
      if (!d.objectStoreNames.contains('cats'))    d.createObjectStore('cats',    { keyPath: 'key' });
      if (!d.objectStoreNames.contains('cfg'))     d.createObjectStore('cfg',     { keyPath: 'k' });
      if (!d.objectStoreNames.contains('parties')) d.createObjectStore('parties', { keyPath: 'id', autoIncrement: true });
    };
    req.onsuccess = e => { db = e.target.result; res(); };
    req.onerror   = e => rej(e.target.error);
  });
}

const dbAll   = s     => new Promise((res, rej) => { const r = db.transaction(s,'readonly').objectStore(s).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbGet   = (s,k) => new Promise((res, rej) => { const r = db.transaction(s,'readonly').objectStore(s).get(k); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbPut   = (s,v) => new Promise((res, rej) => { const r = db.transaction(s,'readwrite').objectStore(s).put(v); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
const dbDel   = (s,k) => new Promise((res, rej) => { const r = db.transaction(s,'readwrite').objectStore(s).delete(k); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
const dbClear = s     => new Promise((res, rej) => { const r = db.transaction(s,'readwrite').objectStore(s).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });

/* â”€â”€â”€ STATE â”€â”€â”€ */
const S = { year: new Date().getFullYear(), tab: 'dash', cats: [], parties: [], editId: null };
const MO = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MF = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const CAT_ORDER = ['mensalidade','matricula','material','uniforme','extra','pensao'];

/* â”€â”€â”€ HELPERS â”€â”€â”€ */
const brl  = v => Math.abs(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const brlK = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : Math.round(v||0).toString();
const fmtD = iso => { if (!iso) return 'â€”'; const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`; };
const $    = id => document.getElementById(id);

function toast(msg, ms=2800) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('on'), ms);
}

function catInfo(k) { return S.cats.find(c => c.key === k) || { key: k, label: k, color: '#8E8E93' }; }
function catEmoji(k) { return { mensalidade:'ğŸ«', matricula:'ğŸ“', material:'ğŸ“š', uniforme:'ğŸ‘•', extra:'ğŸ­', pensao:'ğŸ’°' }[k] || 'ğŸ“Œ'; }
function closeSheet(id) { $(id).classList.remove('open'); }

/* Resolve party name â€” supports v4 partyId and v3 legacy string */
function partyLabel(tx) {
  if (tx.partyId) {
    const p = S.parties.find(p => p.id === tx.partyId);
    if (p) return (p.emoji ? p.emoji + ' ' : '') + p.name;
  }
  const legMap = { Me: 'Eu', Father: 'Pai', School: 'Escola', Store: 'Loja', Other: 'Outro' };
  return legMap[tx.party] || tx.party || 'â€”';
}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€ */
function nav(tab) {
  S.tab = tab;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('on'));
  $('page-' + tab).classList.add('on');
  const tb = $('t-' + tab); if (tb) tb.classList.add('on');
  const si = $('si-' + tab); if (si) si.classList.add('on');
  $('scroller').scrollTop = 0;
  const hideYr = tab === 'rpt' || tab === 'cfg';
  $('nav-yr').style.display = hideYr ? 'none' : 'flex';
  $('nav-title').textContent = { dash:'School Ledger', txs:'TransaÃ§Ãµes', add: S.editId?'Editar':'Nova TransaÃ§Ã£o', rpt:'RelatÃ³rio', cfg:'ConfiguraÃ§Ãµes' }[tab] || '';
  if (tab === 'dash') renderDash();
  if (tab === 'txs')  renderTxList();
  if (tab === 'add' && !S.editId) resetForm();
  if (tab === 'rpt')  renderReport();
  if (tab === 'cfg')  renderCfg();
}

/* â”€â”€â”€ YEAR FILTER â€” syncs phone + sidebar â”€â”€â”€ */
async function initYearFilter() {
  const rows = await dbAll('txs');
  let years = [...new Set(rows.map(r => r.academicYear))].filter(Boolean).sort((a,b)=>a-b);
  const now = new Date().getFullYear();
  if (!years.includes(now)) years.push(now);
  years.sort((a,b) => a-b);

  function buildOpts() {
    return `<option value="all">Todos os anos</option>` +
      years.map(y => `<option value="${y}">${y === now ? y + ' (atual)' : y}</option>`).join('');
  }

  const onChange = e => {
    S.year = e.target.value === 'all' ? 'all' : +e.target.value;
    ['yr-sel','yr-sel-sb'].forEach(id => { const s=$(id); if(s) s.value = String(S.year); });
    if (S.tab === 'dash') renderDash();
    if (S.tab === 'txs')  renderTxList();
    if (S.tab === 'rpt')  renderReport();
  };

  const sel = $('yr-sel');
  sel.innerHTML = buildOpts();
  sel.value = String(now);
  sel.onchange = onChange;

  const selSb = $('yr-sel-sb');
  if (selSb) { selSb.innerHTML = buildOpts(); selSb.value = String(now); selSb.onchange = onChange; }

  const fy = $('f-year');
  if (fy) { fy.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join(''); fy.value = now; }

  S.year = now;
}

/* â”€â”€â”€ CALC SUMMARY â€” confirmed only (excludes FORECAST) â”€â”€â”€ */
async function calcSummary(year) {
  const rows = await dbAll('txs');
  const txs = (year === 'all' ? rows : rows.filter(r => r.academicYear === year))
               .filter(r => r.type !== 'FORECAST');
  const paid  = txs.filter(r => r.type === 'PAID').reduce((a,r) => a + r.amount, 0);
  const recv  = txs.filter(r => r.type === 'RECEIVED').reduce((a,r) => a + r.amount, 0);
  const late  = txs.filter(r => r.isLate).length;
  const byCat = {};
  txs.forEach(r => { byCat[r.categoryKey] = (byCat[r.categoryKey]||0) + r.amount; });
  const byMonth = Array.from({length:12}, () => ({}));
  txs.forEach(r => { const m = r.academicMonth-1; byMonth[m][r.categoryKey] = (byMonth[m][r.categoryKey]||0) + r.amount; });
  return { paid, recv, deficit: paid-recv, late, byCat, byMonth };
}

/* â”€â”€â”€ CALC FORECAST â€” only type=FORECAST â”€â”€â”€ */
async function calcForecast(year) {
  const rows = await dbAll('txs');
  const txs = (year === 'all' ? rows : rows.filter(r => r.academicYear === year))
               .filter(r => r.type === 'FORECAST');
  const total   = txs.reduce((a,r) => a + r.amount, 0);
  const count   = txs.length;
  const byCat   = {};
  txs.forEach(r => { byCat[r.categoryKey] = (byCat[r.categoryKey]||0) + r.amount; });
  const byMonth = Array(12).fill(0);
  txs.forEach(r => { byMonth[r.academicMonth-1] += r.amount; });
  return { total, count, byCat, byMonth };
}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
async function renderDash() {
  const [d, fc] = await Promise.all([calcSummary(S.year), calcForecast(S.year)]);
  const pct = d.paid > 0 ? (d.recv/d.paid*100).toFixed(1) : 0;
  const yrL = S.year === 'all' ? 'Todos os anos' : S.year;

  $('kpi-row').innerHTML = `
    <div class="kpi blue"><div class="kpi-label">Pago â€” ${yrL}</div><div class="kpi-value">R$&thinsp;${brlK(d.paid)}</div><div class="kpi-sub">${brl(d.paid)}</div></div>
    <div class="kpi green"><div class="kpi-label">PensÃ£o â€” ${yrL}</div><div class="kpi-value">R$&thinsp;${brlK(d.recv)}</div><div class="kpi-sub">${pct}% coberto Â· ${d.late} atr.</div></div>
    <div class="kpi red"><div class="kpi-label">DÃ©ficit â€” ${yrL}</div><div class="kpi-value">â€“R$&thinsp;${brlK(d.deficit)}</div><div class="kpi-sub">descoberto</div></div>
    <div class="kpi ora"><div class="kpi-label">Maior custo</div><div class="kpi-value" style="font-size:16px">${(()=>{const top=Object.entries(d.byCat).filter(([k])=>k!=='pensao').sort((a,b)=>b[1]-a[1])[0];return top?catInfo(top[0]).label:'â€”';})()}</div><div class="kpi-sub">${yrL}</div></div>`;

  const fw = $('fcst-kpi-wrap');
  if (fc.count > 0) {
    const topF = Object.entries(fc.byCat).sort((a,b) => b[1]-a[1])[0];
    fw.innerHTML = `
      <div style="padding:12px 20px 0"><div style="font-size:10px;font-weight:600;color:var(--violet);text-transform:uppercase;letter-spacing:.07em">â—† PrevisÃµes Futuras</div></div>
      <div class="kpi-row" style="padding-top:6px">
        <div class="kpi violet fcst-kpi"><div class="kpi-label">â—† Total Previsto</div><div class="kpi-value">R$&thinsp;${brlK(fc.total)}</div><div class="kpi-sub">${fc.count} lanÃ§amento${fc.count>1?'s':''}</div></div>
        ${topF ? `<div class="kpi violet fcst-kpi"><div class="kpi-label">â—† Maior PrevisÃ£o</div><div class="kpi-value" style="font-size:16px">${catInfo(topF[0]).label}</div><div class="kpi-sub">R$&thinsp;${brlK(topF[1])}</div></div>` : ''}
      </div>`;
  } else {
    fw.innerHTML = '';
  }

  requestAnimationFrame(() => requestAnimationFrame(() => drawCharts(d, fc)));

  const allRows = await dbAll('txs');
  const recent = (S.year === 'all' ? allRows : allRows.filter(r => r.academicYear === S.year))
    .sort((a,b) => b.date.localeCompare(a.date) || b.id-a.id).slice(0,5);
  $('recent-card').innerHTML = recent.length
    ? recent.map(txHTML).join('')
    : '<div class="empty-state"><div class="ic">ğŸ“­</div>Sem transaÃ§Ãµes</div>';
}

/* â”€â”€â”€ CHARTS â”€â”€â”€ */
function drawCharts(d, fc) {
  const bc = d.byCat || {};
  const gt = Object.values(bc).reduce((a,v) => a+v, 0);
  const def = d.paid - d.recv;
  const p0 = d.paid > 0 ? (def/d.paid*100).toFixed(1) : 0;
  const p1 = d.paid > 0 ? (d.recv/d.paid*100).toFixed(1) : 0;
  const hasFcst = fc && fc.count > 0;

  $('chart-area').innerHTML = `
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">VisÃ£o Geral â€” ${S.year==='all'?'Todos os anos':S.year}</div>
      <div style="display:flex;gap:10px">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv1" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Financiamento</div>
          <div style="width:100%;display:flex;flex-direction:column;gap:4px">
            <div class="leg-item"><div class="leg-swatch" style="background:#3B5BDB"></div>Eu<span class="leg-pct">${p0}%</span></div>
            <div class="leg-item"><div class="leg-swatch" style="background:#C0392B"></div>Pai<span class="leg-pct">${p1}%</span></div>
          </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px">
          <canvas id="cv2" style="width:110px;height:110px"></canvas>
          <div class="donut-name">Categorias</div>
          <div id="pie2-leg" style="width:100%;display:flex;flex-direction:column;gap:4px"></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin:0 20px 12px;padding:16px">
      <div class="chart-title">Despesas Realizadas por MÃªs</div>
      <canvas id="cv3" style="width:100%;display:block"></canvas>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
        ${CAT_ORDER.map(k=>`<div class="leg-item"><div class="leg-swatch" style="background:${catInfo(k).color}"></div><span>${catInfo(k).label}</span></div>`).join('')}
      </div>
    </div>
    ${hasFcst ? `
    <div class="card" style="margin:0 20px 12px;padding:16px;border-left:3px solid var(--violet)">
      <div class="chart-title" style="color:var(--violet)">â—† PrevisÃµes por MÃªs</div>
      <canvas id="cv4" style="width:100%;display:block"></canvas>
    </div>` : ''}`;

  donut('cv1', [{v:def,c:'#3B5BDB'},{v:d.recv,c:'#C0392B'}], 'Total', brlK(d.paid), 110);
  donut('cv2', CAT_ORDER.map(k => ({v:bc[k]||0, c:catInfo(k).color})), 'Total', brlK(gt), 110);
  $('pie2-leg').innerHTML = CAT_ORDER.map(k => {
    const v = bc[k]||0; if (!v) return '';
    const p = gt > 0 ? (v/gt*100).toFixed(0) : 0;
    return `<div class="leg-item"><div class="leg-swatch" style="background:${catInfo(k).color}"></div>${catInfo(k).label}<span class="leg-pct">${p}%</span></div>`;
  }).join('');
  barChart('cv3', d);
  if (hasFcst) barForecast('cv4', fc);
}

function donut(id, slices, lbl, val, SZ) {
  const c = $(id); if (!c) return;
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  c.width = SZ*dpr; c.height = SZ*dpr; c.style.width = SZ+'px'; c.style.height = SZ+'px';
  const ctx = c.getContext('2d'); ctx.scale(dpr, dpr);
  const cx=SZ/2, cy=SZ/2, R=SZ/2-7, r=SZ/2-23;
  const tot = slices.reduce((a,s) => a+(s.v||0), 0); if (!tot) return;
  let a = -Math.PI/2;
  slices.forEach(s => { if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a,a+sw); ctx.closePath(); ctx.fillStyle=s.c; ctx.fill(); a+=sw; });
  a = -Math.PI/2;
  slices.forEach(s => { if(!s.v)return; const sw=s.v/tot*Math.PI*2; ctx.beginPath(); ctx.arc(cx,cy,R,a,a+sw); ctx.strokeStyle='#FAFAF9'; ctx.lineWidth=2.5; ctx.stroke(); a+=sw; });
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fillStyle='#FFF'; ctx.fill();
  ctx.textAlign='center';
  ctx.fillStyle='#71717A'; ctx.font=`500 8px Inter,sans-serif`; ctx.fillText(lbl, cx, cy-5);
  ctx.fillStyle='#000';    ctx.font=`600 11px 'SF Mono','Menlo','Consolas',monospace`; ctx.fillText(val, cx, cy+7);
}

function barChart(id, d) {
  const c = $(id); if (!c) return;
  const par = c.parentElement;
  const W = Math.max((par ? (par.getBoundingClientRect().width||par.offsetWidth) : 320) - 32, 200);
  const H=100, dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const data = (d.byMonth||[]).map(m => CAT_ORDER.map(k => m[k]||0));
  const cols = CAT_ORDER.map(k => catInfo(k).color);
  const pL=30,pB=16,pT=6,pR=2, cW=W-pL-pR, cH=H-pT-pB;
  const maxV = Math.max(...data.map(r => r.reduce((a,b)=>a+b,0)), 1);
  const scale = Math.ceil(maxV/2000)*2000 || 2000;
  for (let i=0;i<=3;i++) {
    const y = pT+cH*(1-i/3);
    ctx.strokeStyle='rgba(0,0,0,.05)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke();
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7.5px 'SF Mono','Menlo','Consolas',monospace`; ctx.fillText(brlK(scale/3*i), pL-3, y+3);
  }
  const mW=cW/12, bW=mW*.72, bOff=(mW-bW)/2;
  data.forEach((cats,mi) => {
    const gx=pL+mi*mW+bOff; let yBase=pT+cH;
    cats.forEach((v,ci) => { if(!v)return; const bH=Math.max(1,(v/scale)*cH); yBase-=bH; ctx.fillStyle=cols[ci]; ctx.fillRect(gx,yBase,bW,bH); });
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi], pL+mi*mW+mW/2, H-2);
  });
}

function barForecast(id, fc) {
  const c = $(id); if (!c) return;
  const par = c.parentElement;
  const W = Math.max((par ? (par.getBoundingClientRect().width||par.offsetWidth) : 320) - 32, 200);
  const H=80, dpr=Math.min(window.devicePixelRatio||1,2);
  c.width=W*dpr; c.height=H*dpr; c.style.width=W+'px'; c.style.height=H+'px';
  const ctx=c.getContext('2d'); ctx.scale(dpr,dpr);
  const data = fc.byMonth || Array(12).fill(0);
  const pL=30,pB=16,pT=6,pR=2, cW=W-pL-pR, cH=H-pT-pB;
  const maxV = Math.max(...data, 1);
  const scale = Math.ceil(maxV/1000)*1000 || 1000;
  for (let i=0;i<=2;i++) {
    const y = pT+cH*(1-i/2);
    ctx.strokeStyle='rgba(124,58,237,.08)'; ctx.lineWidth=.6; ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+cW,y); ctx.stroke();
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='right'; ctx.font=`7.5px 'SF Mono','Menlo','Consolas',monospace`; ctx.fillText(brlK(scale/2*i), pL-3, y+3);
  }
  const mW=cW/12, bW=mW*.72, bOff=(mW-bW)/2;
  data.forEach((v,mi) => {
    if (v>0) { const bH=Math.max(1,(v/scale)*cH); ctx.fillStyle='rgba(124,58,237,.55)'; ctx.fillRect(pL+mi*mW+bOff, pT+cH-bH, bW, bH); }
    ctx.fillStyle='#A1A1AA'; ctx.textAlign='center'; ctx.font=`7px Inter,sans-serif`; ctx.fillText(MO[mi], pL+mi*mW+mW/2, H-2);
  });
}

/* â”€â”€â”€ TX LIST â”€â”€â”€ */
function txHTML(r) {
  const ci = catInfo(r.categoryKey);
  const isFcst = r.type === 'FORECAST';
  const out = r.type === 'PAID';
  const pLabel = partyLabel(r);
  return `<div class="list-row${isFcst?' row-fcst':''}" onclick="openTxSheet(${r.id})">
    <div class="list-icon" style="background:${isFcst ? 'var(--violet-l)' : ci.color+'1A'}">${isFcst ? 'â—†' : catEmoji(r.categoryKey)}</div>
    <div class="list-body">
      <div class="list-name">${ci.label}${isFcst ? '<span class="fcst-badge">PREV</span>' : ''}</div>
      <div class="tx-sub">${fmtD(r.date)} Â· ${MO[r.academicMonth-1]}/${r.academicYear} Â· ${pLabel}</div>
      ${r.notes ? `<div class="tx-sub" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px">${r.notes}</div>` : ''}
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div class="tx-amount ${isFcst?'fcst':out?'out':'in'}">${isFcst?'â‰ˆ':out?'â€“':'+'}${brlK(r.amount)}</div>
      ${(!isFcst && r.isLate) ? `<div class="tx-late">â–  atraso</div>` : ''}
    </div>
  </div>`;
}

async function renderTxList() {
  const type = $('fil-type').value, cat = $('fil-cat').value;
  const allRows = await dbAll('txs');
  let rows = S.year === 'all' ? allRows : allRows.filter(r => r.academicYear === S.year);
  if (type) rows = rows.filter(r => r.type === type);
  if (cat)  rows = rows.filter(r => r.categoryKey === cat);
  rows.sort((a,b) => b.date.localeCompare(a.date) || b.id-a.id);
  const w = $('tx-wrap');
  if (!rows.length) { w.innerHTML = '<div class="empty-state"><div class="ic">ğŸ“­</div>Nenhuma transaÃ§Ã£o</div>'; return; }
  w.innerHTML = `<div class="card" style="margin:0 20px 16px;overflow:hidden">${rows.map(txHTML).join('')}</div>`;
}

async function openTxSheet(id) {
  const rows = await dbAll('txs');
  const r = rows.find(r => r.id === id); if (!r) return;
  const ci = catInfo(r.categoryKey);
  const isFcst = r.type === 'FORECAST';
  const out = r.type === 'PAID';
  const pLabel = partyLabel(r);
  $('sh-title').textContent = ci.label + (isFcst ? ' â—†' : '');
  const shRow = (l, v) => `<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px 20px;border-bottom:.5px solid var(--sep-light)"><span style="font-size:15px;color:var(--t-body)">${l}</span><span style="font-size:15px;font-weight:500;text-align:right;max-width:60%">${v}</span></div>`;
  $('sh-body').innerHTML = `
    <div style="text-align:center;padding:20px 0 14px">
      <div style="font-size:44px;margin-bottom:8px">${isFcst ? 'â—†' : catEmoji(r.categoryKey)}</div>
      <div style="font:600 30px/1 var(--f-mono);color:${isFcst?'var(--violet)':out?'var(--red)':'var(--green)'}">${isFcst?'â‰ˆ':out?'â€“':'+'}R$&nbsp;${brl(r.amount)}</div>
      <div style="font-size:13px;color:var(--t-body);margin-top:6px">${ci.label}${isFcst?' &nbsp;<span style="color:var(--violet);font-weight:600">PrevisÃ£o</span>':''}</div>
    </div>
    <div style="margin:0 20px;background:var(--bg-2);border-radius:12px;overflow:hidden">
      ${shRow('Data pagamento', r.isLate
        ? `${fmtD(r.date)}<br><span style="font-size:10px;color:var(--red);font-weight:700">â–  Recebido com atraso</span>`
        : fmtD(r.date))}
      ${shRow('PerÃ­odo', MF[r.academicMonth-1] + ' / ' + r.academicYear)}
      ${shRow('Tipo', isFcst ? 'PrevisÃ£o futura' : out ? 'Pago (saÃ­da)' : 'Recebido')}
      ${shRow('Parte', pLabel)}
      ${r.notes ? shRow('Notas', r.notes) : ''}
      ${r.tags  ? shRow('Tags',  r.tags)  : ''}
    </div>
    <div style="padding:16px;display:flex;flex-direction:column;gap:10px">
      <button class="btn primary" onclick="editTx(${r.id});closeSheet('tx-sheet')">âœï¸  Editar</button>
      <button class="btn destructive" onclick="if(confirm('Excluir esta transaÃ§Ã£o?'))delTxById(${r.id})">ğŸ—‘  Excluir</button>
    </div>`;
  $('tx-sheet').classList.add('open');
}

async function delTxById(id) {
  await dbDel('txs', id);
  closeSheet('tx-sheet');
  toast('ğŸ—‘ ExcluÃ­do');
  await initYearFilter();
  if (S.tab === 'dash') renderDash();
  if (S.tab === 'txs')  renderTxList();
}

/* â”€â”€â”€ FORM â”€â”€â”€ */
function onTypeChange() {
  const v = $('f-type').value;
  $('fcst-notice').classList.toggle('show', v === 'FORECAST');
}

async function resetForm() {
  S.editId = null;
  $('f-id').value = ''; $('f-val').value = ''; $('f-notes').value = ''; $('f-tags').value = '';
  $('f-type').value = 'PAID'; onTypeChange();
  $('f-date').value = new Date().toISOString().split('T')[0];
  const yr = (S.year === 'all') ? new Date().getFullYear() : S.year;
  const fy = $('f-year'); if (fy) fy.value = yr;
  $('f-month').value = new Date().getMonth() + 1;
  $('tog').classList.remove('on');
  $('del-btn').style.display = 'none';
  $('add-title').textContent = 'Nova TransaÃ§Ã£o';
  await refreshPartySelect();
  if (S.cats.length) $('f-cat').value = S.cats[0].key;
  resetAI();
}

async function editTx(id) {
  S.editId = id;
  nav('add');
  const rows = await dbAll('txs');
  const r = rows.find(r => r.id === id); if (!r) return;
  $('f-id').value = r.id; $('f-val').value = r.amount;
  $('f-type').value = r.type; onTypeChange();
  $('f-cat').value = r.categoryKey;
  $('f-date').value = r.date;
  const fy = $('f-year'); if (fy) fy.value = r.academicYear;
  $('f-month').value = r.academicMonth;
  $('f-notes').value = r.notes || ''; $('f-tags').value = r.tags || '';
  if (r.isLate) $('tog').classList.add('on');
  $('del-btn').style.display = 'flex';
  $('add-title').textContent = 'Editar TransaÃ§Ã£o';
  await refreshPartySelect();
  // Resolve party: prefer partyId (v4), fallback to legacy string (v3)
  if (r.partyId) {
    $('f-party').value = String(r.partyId);
  } else if (r.party) {
    $('f-party').value = r.party;
  }
}

async function saveTx() {
  const amount = parseFloat($('f-val').value);
  if (!amount || isNaN(amount)) { toast('âš ï¸ Informe o valor'); return; }
  const date = $('f-date').value; if (!date) { toast('âš ï¸ Informe a data'); return; }
  const partyVal = $('f-party').value;
  const partyId  = /^\d+$/.test(partyVal) ? +partyVal : null;
  const tx = {
    amount, type: $('f-type').value, categoryKey: $('f-cat').value,
    partyId, party: partyId ? null : partyVal,
    date, academicYear: +$('f-year').value, academicMonth: +$('f-month').value,
    isLate: $('tog').classList.contains('on'),
    notes: $('f-notes').value, tags: $('f-tags').value,
    updatedAt: new Date().toISOString()
  };
  if (S.editId) { tx.id = S.editId; } else { tx.createdAt = new Date().toISOString(); }
  await dbPut('txs', tx);
  toast(S.editId ? 'âœ… Atualizado!' : 'âœ… Salvo!');
  S.editId = null;
  await initYearFilter();
  nav('txs');
}

async function deleteTx() {
  if (!S.editId) return;
  if (!confirm('Excluir esta transaÃ§Ã£o?')) return;
  await dbDel('txs', S.editId);
  toast('ğŸ—‘ ExcluÃ­do');
  S.editId = null;
  await initYearFilter();
  nav('txs');
}

/* â”€â”€â”€ PARTIES CRUD â”€â”€â”€ */
async function loadParties() { S.parties = await dbAll('parties'); }

async function refreshPartySelect() {
  await loadParties();
  const sel = $('f-party'); if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '';
  // Legacy options (backward-compatible with v3 data)
  [['Me','ğŸ‘¤ Eu'],['Father','ğŸ‘¨ Pai'],['School','ğŸ« Escola'],['Store','ğŸª Loja'],['Other','ğŸ‘¥ Outro']].forEach(([v,l]) => {
    const o = document.createElement('option'); o.value = v; o.textContent = l; sel.appendChild(o);
  });
  // Dynamic parties from DB
  S.parties.forEach(p => {
    const o = document.createElement('option');
    o.value = String(p.id);
    o.textContent = (p.emoji || 'ğŸ‘¤') + ' ' + p.name;
    sel.appendChild(o);
  });
  if (cur) sel.value = cur;
}

async function addPartyInline() {
  const inp = $('f-new-party');
  const name = inp.value.trim();
  if (!name) { toast('âš ï¸ Digite o nome'); return; }
  if (S.parties.find(p => p.name.toLowerCase() === name.toLowerCase())) { toast('âš ï¸ Parte jÃ¡ existe'); return; }
  const newId = await dbPut('parties', { name, emoji: 'ğŸ‘¤', createdAt: new Date().toISOString() });
  inp.value = '';
  toast(`âœ… "${name}" adicionado`);
  await refreshPartySelect();
  $('f-party').value = String(newId);
}

function openPartySheet(editId) {
  $('ps-id').value = editId || '';
  $('ps-title').textContent = editId ? 'Editar Parte' : 'Nova Parte';
  $('ps-del-wrap').style.display = editId ? 'block' : 'none';
  if (editId) {
    const p = S.parties.find(p => p.id === editId);
    if (p) { $('ps-name').value = p.name; $('ps-emoji').value = p.emoji || 'ğŸ‘¤'; }
  } else {
    $('ps-name').value = ''; $('ps-emoji').value = 'ğŸ‘¤';
  }
  $('party-sheet').classList.add('open');
}

async function saveParty() {
  const name = $('ps-name').value.trim();
  if (!name) { toast('âš ï¸ Informe o nome'); return; }
  const emoji  = $('ps-emoji').value.trim() || 'ğŸ‘¤';
  const editId = $('ps-id').value ? +$('ps-id').value : null;
  const rec    = { name, emoji, updatedAt: new Date().toISOString() };
  if (editId) { rec.id = editId; } else { rec.createdAt = new Date().toISOString(); }
  await dbPut('parties', rec);
  toast(editId ? 'âœ… Parte atualizada!' : 'âœ… Parte criada!');
  closeSheet('party-sheet');
  await loadParties();
  await refreshPartySelect();
  renderCfg();
}

async function deleteParty() {
  const editId = +$('ps-id').value;
  if (!editId) return;
  if (!confirm('Excluir esta parte?')) return;
  await dbDel('parties', editId);
  toast('ğŸ—‘ Parte removida');
  closeSheet('party-sheet');
  await loadParties();
  await refreshPartySelect();
  renderCfg();
}

/* â”€â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Rules implemented:
   â€¢ Specific year â†’ always show all 12 months (even zero rows)
   â€¢ "Todos" â†’ only years with data in DB
   â€¢ Late tag ONLY next to Data Pagamento â€” NOT in % Pai column
   â€¢ FORECAST type shown in dedicated column, excluded from confirmed totals
   â€¢ Grand total strip (confirmed, blue) + Forecast strip (violet)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderReport() {
  const allRows = await dbAll('txs');
  let years;
  if (S.year === 'all') {
    years = [...new Set(allRows.map(r => r.academicYear))].filter(Boolean).sort((a,b)=>a-b);
  } else {
    years = [S.year];
  }
  if (!years.length) {
    $('rpt-content').innerHTML = '<div class="empty-state"><div class="ic">ğŸ“‹</div>Sem dados para exibir</div>';
    return;
  }

  let html = '', gP = 0, gR = 0, gFcst = 0;

  for (const yr of years) {
    const yrTxs      = allRows.filter(r => r.academicYear === yr);
    const confirmed  = yrTxs.filter(r => r.type !== 'FORECAST');
    const forecasts  = yrTxs.filter(r => r.type === 'FORECAST');

    // Aggregate confirmed paid by category + received pensÃ£o
    const byMonth   = {}; // { [month]: { mensalidade, matricula, ... } }
    const pensaoByM = {}; // { [month]: total pensÃ£o received }
    const lateByM   = {}; // { [month]: bool }
    const payDateByM= {}; // { [month]: date string (last pensÃ£o date recorded) }

    confirmed.filter(r => r.type === 'PAID').forEach(r => {
      const m = r.academicMonth;
      if (!byMonth[m]) byMonth[m] = { mensalidade:0, matricula:0, material:0, uniforme:0, extra:0 };
      if (byMonth[m][r.categoryKey] !== undefined) byMonth[m][r.categoryKey] += r.amount;
    });
    confirmed.filter(r => r.categoryKey === 'pensao').forEach(r => {
      const m = r.academicMonth;
      pensaoByM[m] = (pensaoByM[m]||0) + r.amount;
      if (r.isLate) lateByM[m] = true;
      // Track latest payment date per month for display
      if (!payDateByM[m] || r.date > payDateByM[m]) payDateByM[m] = r.date;
    });

    // Aggregate forecast by month
    const fcstByM = {};
    forecasts.forEach(r => { fcstByM[r.academicMonth] = (fcstByM[r.academicMonth]||0) + r.amount; });

    let rowsHtml = '';
    let tot = { mensalidade:0, matricula:0, material:0, extra:0, sub:0, recv:0, diff:0 };
    let yrFcst = 0;

    for (let m = 1; m <= 12; m++) {
      const cats   = byMonth[m]  || {};
      const recv   = pensaoByM[m]|| 0;
      const late   = lateByM[m]  || false;
      const payD   = payDateByM[m];
      const fcstAmt= fcstByM[m]  || 0;
      const sub    = (cats.mensalidade||0)+(cats.matricula||0)+(cats.material||0)+(cats.uniforme||0)+(cats.extra||0);
      const diff   = sub - recv;
      const pct    = sub > 0 ? (recv/sub*100) : 0;

      // In "all-years" mode, skip completely empty months
      if (S.year === 'all' && sub === 0 && recv === 0 && fcstAmt === 0) continue;

      tot.mensalidade += cats.mensalidade||0;
      tot.matricula   += cats.matricula||0;
      tot.material    += cats.material||0;
      tot.extra       += cats.extra||0;
      tot.sub  += sub; tot.recv += recv; tot.diff += diff;
      yrFcst   += fcstAmt;

      // Date cell: late tag appears ONLY here â€” never in % Pai column
      const dateCell = recv > 0
        ? `${fmtD(payD||'')}${late ? `<span class="late-tag">â–  atraso</span>` : ''}`
        : 'â€”';

      // % Pai â€” clean, no late indicator
      const pctCls = pct === 0 ? '' : pct < 50 ? 'neg' : 'pct-ok';
      const pctCell = sub > 0 ? `<span class="${pctCls}">${pct.toFixed(1)}%</span>` : 'â€”';

      rowsHtml += `<tr>
        <td>${MF[m-1]}</td>
        <td class="r">${cats.mensalidade ? brl(cats.mensalidade) : 'â€”'}</td>
        <td class="r">${cats.matricula   ? brl(cats.matricula)   : 'â€”'}</td>
        <td class="r">${cats.material    ? brl(cats.material)    : 'â€”'}</td>
        <td class="r">${cats.extra       ? brl(cats.extra)       : 'â€”'}</td>
        <td class="r recv">${recv ? brl(recv) : 'â€”'}</td>
        <td class="r" style="min-width:120px">${dateCell}</td>
        <td class="r ${diff > 0 ? 'neg' : 'recv'}">${diff !== 0 ? (diff>0?'â€“':'+') + brl(Math.abs(diff)) : 'â€”'}</td>
        <td class="r">${pctCell}</td>
        <td class="r fcst-col">${fcstAmt ? 'â‰ˆ' + brl(fcstAmt) : '<span style="color:var(--t-disabled)">â€”</span>'}</td>
      </tr>`;
    }

    gP += tot.sub; gR += tot.recv; gFcst += yrFcst;

    const tPct = tot.sub > 0 ? (tot.recv/tot.sub*100).toFixed(1) + '%' : 'â€”';
    html += `
      <div class="rpt-card">
        <div class="rpt-yr-hdr"><h3>${yr}</h3><span>R$&nbsp;${brl(tot.sub)}</span></div>
        <div class="rpt-scroll">
          <table class="rtbl">
            <thead><tr>
              <th>MÃªs</th>
              <th>Mensalidade</th>
              <th>MatrÃ­cula</th>
              <th>Material</th>
              <th>Extra</th>
              <th>PensÃ£o</th>
              <th>Data Pagamento</th>
              <th>DiferenÃ§a</th>
              <th>% Pai</th>
              <th style="color:var(--violet)">â—† Prev.</th>
            </tr></thead>
            <tbody>
              ${rowsHtml}
              <tr class="total-row">
                <td>TOTAL ${yr}</td>
                <td class="r">${brl(tot.mensalidade)}</td>
                <td class="r">${tot.matricula ? brl(tot.matricula) : 'â€”'}</td>
                <td class="r">${tot.material  ? brl(tot.material)  : 'â€”'}</td>
                <td class="r">${tot.extra     ? brl(tot.extra)     : 'â€”'}</td>
                <td class="r recv">${brl(tot.recv)}</td>
                <td class="r">â€”</td>
                <td class="r neg">â€“${brl(Math.abs(tot.diff))}</td>
                <td class="r ${tot.sub>0 ? (tot.recv/tot.sub)<.5?'neg':'pct-ok' : ''}">${tPct}</td>
                <td class="r fcst-col">${yrFcst ? 'â‰ˆ' + brl(yrFcst) : 'â€”'}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>`;
  }

  const gD = gP - gR;
  const gPct = gP > 0 ? (gR/gP*100).toFixed(1) : 0;

  const gtHtml = `<div class="gt-strip confirmed">
    <div class="gt-cell"><div class="gt-label">Total Pago</div><div class="gt-value">${brl(gP)}</div></div>
    <div class="gt-cell"><div class="gt-label">PensÃ£o Recebida</div><div class="gt-value warn">${brl(gR)}</div></div>
    <div class="gt-cell"><div class="gt-label">DÃ©ficit</div><div class="gt-value danger">â€“${brl(gD)}</div></div>
    <div class="gt-cell"><div class="gt-label">Cobertura Pai</div><div class="gt-value warn">${gPct}%</div></div>
  </div>`;

  const fcstHtml = gFcst > 0 ? `<div class="gt-strip forecast">
    <div class="gt-cell"><div class="gt-label">â—† Total Previsto</div><div class="gt-value">â‰ˆ${brl(gFcst)}</div></div>
    <div class="gt-cell"><div class="gt-label">NÃ£o contabilizado</div><div class="gt-value" style="font-size:11px;opacity:.75">nos totais realizados</div></div>
    <div class="gt-cell"><div class="gt-label">LanÃ§amentos</div><div class="gt-value">${allRows.filter(r=>r.type==='FORECAST'&&(S.year==='all'||r.academicYear===S.year)).length}</div></div>
  </div>` : '';

  $('rpt-content').innerHTML = gtHtml + fcstHtml + html;
}

function printReport() {
  if (!$('rpt-content').querySelector('.rpt-card')) {
    renderReport().then(() => setTimeout(() => window.print(), 400));
  } else {
    window.print();
  }
}

async function exportCSV() {
  const rows = await dbAll('txs');
  const txs = rows.filter(r => S.year==='all' || r.academicYear===S.year)
                  .sort((a,b) => b.date.localeCompare(a.date));
  const hdr = 'Data,Tipo,PrevisÃ£o,Categoria,Parte,Valor,Atraso,Ano,Mes,Notas,Tags';
  const lines = txs.map(r => [
    r.date, r.type, r.type==='FORECAST'?'Sim':'NÃ£o',
    r.categoryKey, partyLabel(r), r.amount,
    r.isLate?'Sim':'NÃ£o', r.academicYear, r.academicMonth,
    `"${(r.notes||'').replace(/"/g,'""')}"`, r.tags||''
  ].join(','));
  const blob = new Blob(['\uFEFF'+ [hdr,...lines].join('\r\n')], { type:'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob), a = document.createElement('a');
  a.href = url; a.download = `ledger-${S.year}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ“¥ CSV exportado!');
}

/* â”€â”€â”€ SETTINGS â”€â”€â”€ */
async function renderCfg() {
  const [cats, rows, parties] = await Promise.all([dbAll('cats'), dbAll('txs'), dbAll('parties')]);
  S.cats = cats; S.parties = parties;
  const years = [...new Set(rows.map(r => r.academicYear))].filter(Boolean).sort((a,b)=>a-b);

  // Party list
  $('party-list-wrap').innerHTML = parties.length
    ? parties.map(p => `
        <div class="list-row">
          <div class="list-icon" style="background:var(--accent-l);font-size:18px">${p.emoji||'ğŸ‘¤'}</div>
          <div class="list-body"><div class="list-name">${p.name}</div></div>
          <button onclick="openPartySheet(${p.id})" style="border:none;background:none;color:var(--accent);font-size:17px;padding:6px 10px;cursor:pointer" title="Editar">âœï¸</button>
        </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-muted)">Nenhuma parte cadastrada ainda</div>';

  // Category list
  $('cat-list-wrap').innerHTML = cats.length
    ? cats.map(c => `
        <div class="list-row">
          <div class="list-icon" style="background:${c.color}1A"><div style="width:14px;height:14px;border-radius:4px;background:${c.color}"></div></div>
          <div class="list-body"><div class="list-name">${c.label}</div><div class="tx-sub" style="font-family:var(--f-mono)">${c.key}</div></div>
          ${!c.system
            ? `<button onclick="delCat('${c.key}')" style="border:none;background:none;color:var(--red);font-size:17px;padding:6px 10px;cursor:pointer" title="Excluir">ğŸ—‘</button>`
            : `<span style="font-size:11px;color:var(--t-muted);background:var(--bg-2);border-radius:8px;padding:3px 8px">Sistema</span>`}
        </div>`).join('')
    : '<div style="padding:14px 16px;font-size:14px;color:var(--t-muted)">Nenhuma categoria</div>';

  $('stat-count').textContent = rows.length + ' transaÃ§Ãµes';
  $('stat-years').textContent = years.length ? years.join(', ') : 'â€”';
  populateCatSelects();
}

function populateCatSelects() {
  ['f-cat','fil-cat'].forEach(id => {
    const s = $(id); if (!s) return;
    const cur = s.value;
    s.innerHTML = id === 'fil-cat' ? '<option value="">Todas categorias</option>' : '';
    S.cats.forEach(c => { const o=document.createElement('option'); o.value=c.key; o.textContent=c.label; s.appendChild(o); });
    if (cur) s.value = cur;
  });
}

async function loadCats() { S.cats = await dbAll('cats'); populateCatSelects(); }

async function saveCat() {
  const key   = $('nc-key').value.trim().toLowerCase().replace(/\s+/g,'_');
  const label = $('nc-label').value.trim();
  const color = $('nc-color').value;
  if (!key || !label) { toast('âš ï¸ Preencha chave e nome'); return; }
  await dbPut('cats', { key, label, color, system: false });
  toast('âœ… Categoria criada!');
  closeSheet('cat-sheet');
  $('nc-key').value = ''; $('nc-label').value = '';
  await loadCats(); renderCfg();
}

async function delCat(key) {
  if (!confirm(`Excluir categoria "${key}"?`)) return;
  await dbDel('cats', key); await loadCats(); renderCfg();
}

async function clearAll() {
  if (!confirm('Apagar TODOS os dados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) return;
  await dbClear('txs');
  await initYearFilter();
  renderCfg();
  toast('ğŸ—‘ Todos os dados removidos');
}

/* â”€â”€â”€ JSON EXPORT / IMPORT â”€â”€â”€ */
async function exportJSON() {
  const [txs, cats, parties] = await Promise.all([dbAll('txs'), dbAll('cats'), dbAll('parties')]);
  const payload = { meta: { version:'4.0', school:'ColÃ©gio Objectivo', exportedAt: new Date().toISOString() }, categories: cats, parties, transactions: txs };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob), a = document.createElement('a');
  a.href = url; a.download = `school-ledger-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('ğŸ’¾ Backup exportado!');
}

async function importJSON(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const p = JSON.parse(e.target.result);
      if (!Array.isArray(p.transactions)) throw new Error('"transactions" deve ser um array');
      if (!confirm(`Importar ${p.transactions.length} transaÃ§Ãµes? Os dados atuais serÃ£o substituÃ­dos.`)) return;
      await dbClear('txs');
      for (const tx of p.transactions) await dbPut('txs', tx);
      if (Array.isArray(p.categories)) for (const c of p.categories) await dbPut('cats', c);
      if (Array.isArray(p.parties))    for (const pt of p.parties)   await dbPut('parties', pt);
      const msg = $('imp-msg');
      msg.textContent = `âœ… ${p.transactions.length} transaÃ§Ãµes importadas com sucesso!`;
      msg.style.display = 'block';
      await loadCats(); await loadParties(); await initYearFilter();
      renderCfg();
      toast('âœ… ImportaÃ§Ã£o concluÃ­da!', 3500);
    } catch(err) {
      const msg = $('imp-msg');
      msg.textContent = 'âŒ Erro: ' + err.message;
      msg.style.display = 'block';
    }
  };
  reader.readAsText(file);
}

/* â”€â”€â”€ AI â€” LOCAL HEURISTIC PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Zero API Â· Zero internet Â· 100% local Â· Safari/iOS safe.
   Accepts PDF (read as text), TXT, and images (filename heuristic).
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _aiFile = null, _aiText = null, _aiMime = null;

function resetAI() {
  _aiFile = null; _aiText = null; _aiMime = null;
  $('ai-file').value = '';
  $('ai-idle').style.display = 'block';
  $('ai-file-info').style.display = 'none';
  const btn = $('ai-run-btn'); btn.disabled = true; btn.style.cssText = '';
  $('ai-run-ic').textContent = 'âœ¦'; $('ai-run-txt').textContent = 'Interpretar com IA';
  $('ai-status').textContent = '';
  $('ai-result').style.display = 'none';
  document.querySelectorAll('.ai-hi').forEach(e => e.classList.remove('ai-hi'));
}

function onAiDrop(e) {
  e.preventDefault(); $('ai-drop').classList.remove('drag');
  const f = e.dataTransfer.files[0]; if (f) loadAiFile(f);
}

function loadAiFile(f) {
  if (!f) return;
  const ext = (f.name.split('.').pop()||'').toLowerCase();
  const allowed = ['pdf','jpg','jpeg','png','txt'];
  if (!allowed.includes(ext)) { toast('âŒ Use PDF, JPG, PNG ou TXT'); return; }
  if (f.size > 10*1024*1024) { toast('âŒ Arquivo > 10 MB'); return; }
  _aiFile = f; _aiMime = f.type;
  $('ai-idle').style.display = 'none';
  $('ai-file-info').style.display = 'flex';
  $('ai-file-ic').textContent = {pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',txt:'ğŸ“'}[ext]||'ğŸ“';
  $('ai-file-nm').textContent = f.name;
  $('ai-file-sz').textContent = (f.size/1024).toFixed(1) + ' KB';
  $('ai-run-btn').disabled = false;
  // Pre-read text for PDF/TXT
  if (ext === 'txt' || ext === 'pdf') {
    const reader = new FileReader(); reader.onload = ev => { _aiText = ev.target.result; }; reader.readAsText(f, 'utf-8');
  }
}
function clearAiFile(e) { e.stopPropagation(); resetAI(); }

async function runAI() {
  if (!_aiFile) { toast('âš ï¸ Selecione um arquivo'); return; }
  const btn = $('ai-run-btn'); btn.disabled = true;
  $('ai-run-ic').innerHTML = '<span class="spinner"></span>';
  $('ai-run-txt').textContent = 'Analisandoâ€¦';
  $('ai-status').textContent = 'Processando localmenteâ€¦';
  await new Promise(r => setTimeout(r, 40)); // yield for spinner paint
  try {
    const result = localAIParse(_aiText || '', _aiFile.name, _aiFile.size);
    applyAI(result);
  } catch(err) {
    toast('âŒ ' + err.message, 4000);
    btn.disabled = false;
    $('ai-run-ic').textContent = 'âœ¦'; $('ai-run-txt').textContent = 'Tentar novamente';
    $('ai-status').textContent = '';
  }
}

function localAIParse(text, filename, fileSize) {
  const t = text || '';
  const fn = (filename || '').toLowerCase();

  // â”€â”€ Amount â”€â”€
  let amount = null;
  const amtBR = t.match(/R\$\s*([\d.]+,\d{2})/);
  if (amtBR) amount = parseFloat(amtBR[1].replace(/\./g,'').replace(',','.'));
  if (!amount) { const m = t.match(/(\d{1,3}(?:\.\d{3})*,\d{2})/); if(m) amount = parseFloat(m[1].replace(/\./g,'').replace(',','.')); }
  if (!amount) { const m = t.match(/(\d+[,.]\d{2})/); if(m) amount = parseFloat(m[1].replace(',','.')); }

  // â”€â”€ Date â”€â”€
  let date = null;
  const dISO = t.match(/(\d{4}-\d{2}-\d{2})/); if(dISO) date = dISO[1];
  if (!date) { const dBR = t.match(/(\d{2})\/(\d{2})\/(\d{4})/); if(dBR) date = `${dBR[3]}-${dBR[2]}-${dBR[1]}`; }
  if (!date) date = new Date().toISOString().split('T')[0];
  const dObj = new Date(date + 'T12:00:00');
  const academicYear  = dObj.getFullYear();
  const academicMonth = dObj.getMonth() + 1;

  // â”€â”€ Category â”€â”€
  let categoryKey = 'extra', maxW = 0;
  const rules = [
    { k:'mensalidade', p:/mensalidade|parcela\s*mensal|monthly|mensais/, w:3 },
    { k:'pensao',      p:/pensÃ£o|pensao|alimentos|alimentar|pensÃ£o\s*alimentÃ­cia/, w:3 },
    { k:'matricula',   p:/matr[Ã­i]cula|rematricula|enrollment/, w:3 },
    { k:'material',    p:/material|livro|apostila|kit\s*didÃ¡tico/, w:2 },
    { k:'uniforme',    p:/uniforme|fardamento/, w:2 },
    { k:'extra',       p:/excurs[Ã£a]o|extra|atividade|viagem|passeio/, w:1 },
  ];
  rules.forEach(({k,p,w}) => { if ((p.test(t) || p.test(fn)) && w > maxW) { maxW = w; categoryKey = k; } });

  // â”€â”€ Type & Party â”€â”€
  let type = 'PAID', party = 'Me';
  if (categoryKey === 'pensao') { type = 'RECEIVED'; party = 'Father'; }
  else if (/recebido|crÃ©dito|entrada|credit/i.test(t)) type = 'RECEIVED';

  // â”€â”€ isLate â”€â”€
  const isLate = /atraso|atrasado|vencido|overdue|apÃ³s\s*vencimento/i.test(t);

  // â”€â”€ Confidence â”€â”€
  let hits = 0;
  if (amount && amount > 10) hits++;
  if (maxW >= 2) hits++;
  if (/\d{2}\/\d{2}\/\d{4}|\d{4}-\d{2}-\d{2}/.test(t)) hits++;
  const confidence = hits >= 3 ? 'high' : hits >= 2 ? 'medium' : 'low';

  // â”€â”€ Summary note â”€â”€
  const lines = t.split(/\n/).map(l=>l.trim()).filter(l=>l.length>6&&l.length<90);
  const notes = lines.length ? lines[0].substring(0,80) : `Arquivo: ${filename}`;

  return { amount: amount||0, type, categoryKey, party, isLate, date, academicYear, academicMonth, notes, tags: categoryKey, confidence,
    summary: `${catInfo(categoryKey).label}${amount?' â€” R$ '+brl(amount):''} (${fmtD(date)})` };
}

function applyAI(d) {
  const btn = $('ai-run-btn'); btn.disabled = false;
  btn.style.background = 'var(--green)'; btn.style.color = '#fff';
  $('ai-run-ic').textContent = 'âœ“'; $('ai-run-txt').textContent = 'Preenchido';
  const cf = d.confidence || 'medium';
  const cfC = { high:'var(--green)', medium:'var(--orange)', low:'var(--red)' };
  $('ai-status').innerHTML = `<span style="color:${cfC[cf]};font-weight:600">â— ${{high:'Alta confianÃ§a',medium:'Verificar campos',low:'Revisar tudo'}[cf]}</span>`;
  $('ai-summary').textContent = d.summary || 'Documento analisado.';
  $('ai-result').style.display = 'flex';
  const catKey = (d.party==='Father' && d.type==='RECEIVED') ? 'pensao' : (d.categoryKey||'');
  const fieldMap = [
    ['f-val', d.amount?.toString()], ['f-type', d.type], ['f-cat', catKey],
    ['f-party', d.party], ['f-date', d.date],
    ['f-year', d.academicYear?.toString()], ['f-month', d.academicMonth?.toString()],
    ['f-notes', d.notes], ['f-tags', d.tags]
  ];
  fieldMap.forEach(([id,v], i) => {
    if (v == null || v === '') return;
    setTimeout(() => {
      const el = $(id); if (!el) return;
      if (el.tagName === 'SELECT') { const opt = [...el.options].find(o => o.value===String(v)); if(opt) el.value = opt.value; }
      else el.value = v;
      el.classList.add('ai-hi');
      setTimeout(() => el.classList.remove('ai-hi'), 3000);
    }, i*70);
  });
  if (d.isLate) setTimeout(() => $('tog').classList.add('on'), 600);
}

/* â”€â”€â”€ SEED DATA (first run only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   2025: confirmed transactions with mensalidades, pensÃ£o, etc.
   2026 Janâ€“Feb: confirmed
   2026 Marâ€“Dez mensalidades: FORECAST
   2026 ExcursÃ£o Marâ€“Ago: FORECAST (moved from extras)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function seedIfEmpty() {
  const existing = await dbAll('txs'); if (existing.length > 0) return;

  const CATS = [
    { key:'mensalidade', label:'Mensalidade',       color:'#3B5BDB', system:true },
    { key:'pensao',      label:'PensÃ£o AlimentÃ­cia', color:'#C0392B', system:true },
    { key:'matricula',   label:'MatrÃ­cula',           color:'#C05C1A', system:true },
    { key:'material',    label:'Material',             color:'#1A7F7A', system:true },
    { key:'uniforme',    label:'Uniforme',             color:'#6B4FBB', system:true },
    { key:'extra',       label:'Extra',               color:'#2E7D55', system:true },
  ];
  for (const c of CATS) await dbPut('cats', c);

  let id = 1;
  const mk = o => ({ id: id++, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), ...o });

  /* â”€ 2025 mensalidades â”€ */
  const m25 = [4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.41,4998.40];
  for (let i=0; i<12; i++)
    await dbPut('txs', mk({ amount:m25[i], type:'PAID', categoryKey:'mensalidade', party:'Me', date:`2025-${String(i+1).padStart(2,'0')}-05`, academicYear:2025, academicMonth:i+1, isLate:false, notes:`Mensalidade ${MF[i]}/2025`, tags:'mensalidade' }));

  /* â”€ 2025 matrÃ­cula â”€ */
  await dbPut('txs', mk({ amount:4256.88, type:'PAID', categoryKey:'matricula', party:'Me', date:'2025-01-05', academicYear:2025, academicMonth:1, isLate:false, notes:'MatrÃ­cula anual 2025', tags:'matricula' }));

  /* â”€ 2025 material â”€ */
  for (const [m,d] of [[1,'2025-01-05'],[4,'2025-04-05'],[7,'2025-07-05'],[9,'2025-09-05']])
    await dbPut('txs', mk({ amount:724.50, type:'PAID', categoryKey:'material', party:'Me', date:d, academicYear:2025, academicMonth:m, isLate:false, notes:`Material ${MF[m-1]}/2025`, tags:'material' }));

  /* â”€ 2025 extra â”€ */
  await dbPut('txs', mk({ amount:1084.23, type:'PAID', categoryKey:'extra', party:'Me', date:'2025-01-05', academicYear:2025, academicMonth:1, isLate:false, notes:'Extra Jan/2025', tags:'extra' }));

  /* â”€ 2025 pensÃ£o â”€ */
  const p25 = [[1,'2025-01-05',2000,false],[2,'2025-02-05',2000,false],[3,'2025-03-05',2000,false],[4,'2025-04-05',2000,false],[5,'2025-05-06',1000,true],[6,'2025-06-05',2000,false],[7,'2025-07-03',1000,false],[7,'2025-07-17',1000,true],[8,'2025-08-05',2000,false],[9,'2025-09-05',2000,false],[10,'2025-10-04',2000,false],[11,'2025-11-05',2000,false],[11,'2025-11-22',1500,true],[12,'2025-12-05',3500,false]];
  for (const [m,d,amt,late] of p25)
    await dbPut('txs', mk({ amount:amt, type:'RECEIVED', categoryKey:'pensao', party:'Father', date:d, academicYear:2025, academicMonth:m, isLate:late, notes:`PensÃ£o ${MF[m-1]}/2025`, tags:'pensao' }));

  /* â”€ 2026 confirmed â”€ */
  for (const [m,d] of [[1,'2026-01-05'],[2,'2026-02-05']])
    await dbPut('txs', mk({ amount:5666.85, type:'PAID', categoryKey:'mensalidade', party:'Me', date:d, academicYear:2026, academicMonth:m, isLate:false, notes:`Mensalidade ${MF[m-1]}/2026`, tags:'mensalidade' }));
  await dbPut('txs', mk({ amount:1491.29, type:'PAID', categoryKey:'matricula', party:'Me', date:'2026-01-05', academicYear:2026, academicMonth:1, isLate:false, notes:'MatrÃ­cula 2026', tags:'matricula' }));
  await dbPut('txs', mk({ amount:1047.33, type:'PAID', categoryKey:'material',  party:'Me', date:'2026-01-05', academicYear:2026, academicMonth:1, isLate:false, notes:'Material Jan/2026', tags:'material' }));
  // ExcursÃ£o parcela 1 â€” confirmada (Jan)
  await dbPut('txs', mk({ amount:1503.41, type:'PAID', categoryKey:'extra', party:'Me', date:'2026-02-05', academicYear:2026, academicMonth:2, isLate:false, notes:'ExcursÃ£o parcela 1 (entrada)', tags:'extra,excursao' }));
  // PensÃ£o 2026
  await dbPut('txs', mk({ amount:2000, type:'RECEIVED', categoryKey:'pensao', party:'Father', date:'2026-01-12', academicYear:2026, academicMonth:1, isLate:true,  notes:'PensÃ£o Jan/2026 â€” com atraso', tags:'pensao' }));
  await dbPut('txs', mk({ amount:2500, type:'RECEIVED', categoryKey:'pensao', party:'Father', date:'2026-02-07', academicYear:2026, academicMonth:2, isLate:true,  notes:'PensÃ£o Fev/2026 â€” com atraso', tags:'pensao' }));

  /* â”€ 2026 FORECAST: Mensalidades Marâ€“Dez â”€ */
  for (let i=2; i<12; i++) {
    const m = i+1;
    await dbPut('txs', mk({ amount:5666.85, type:'FORECAST', categoryKey:'mensalidade', party:'Me', date:`2026-${String(m).padStart(2,'0')}-05`, academicYear:2026, academicMonth:m, isLate:false, notes:`Mensalidade ${MF[i]}/2026 (previsÃ£o)`, tags:'mensalidade,forecast' }));
  }

  /* â”€ 2026 FORECAST: ExcursÃ£o parcelas Marâ€“Ago â”€ */
  for (let i=2; i<8; i++) {
    const m = i+1;
    await dbPut('txs', mk({ amount:429, type:'FORECAST', categoryKey:'extra', party:'Me', date:`2026-${String(m).padStart(2,'0')}-05`, academicYear:2026, academicMonth:m, isLate:false, notes:`ExcursÃ£o ${MF[i]}/2026 (previsÃ£o)`, tags:'extra,excursao,forecast' }));
  }
}

/* â”€â”€â”€ SHEET CLOSE ON BG TAP â”€â”€â”€ */
document.querySelectorAll('.sheet-bg').forEach(bg =>
  bg.addEventListener('click', e => { if (e.target === bg) bg.classList.remove('open'); })
);

/* â”€â”€â”€ SERVICE WORKER â”€â”€â”€ */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(() => {});

/* â”€â”€â”€ BOOT â”€â”€â”€ */
async function boot() {
  await openDB();
  await seedIfEmpty();
  await loadCats();
  await loadParties();
  await initYearFilter();
  renderDash();
}
window.addEventListener('load', boot);
</script>
</body>
</html>
